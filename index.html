<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Presentacion de la tarea #1</title>
  <link rel="stylesheet" href="reveal.js/css/reveal.css"/>
  <link rel="stylesheet" href="reveal.js/css/theme/solarized.css" id="theme">
  <!--Add support for earlier versions of Internet Explorer -->
	<!--[if lt IE 9]>
	<script src="lib/js/html5shiv.js"></script>
	<![endif]-->

</head>
<body>
    <div class="reveal">
      <!--   Todos los slides van aqui -->
      <div class="slides">

        <section>
        <section id="1st-slide">
          <h1>Datos Personales</h1>
          <a href="#" class="navigate-down">
            <img data-src="img/arrow-down-icon-png-4.png" alt="Down arrow" width="100" height="100"/>
          </a>
        </section>
          <section>
            <h1>Nombre Completo</h1>
            <p>Giampiero Specogna</p>
        </section>
        <section>
          <h1>Matrícula</h1>
          <p>20152778</p>
        </section>
        <section>
          <h1>Teléfono</h1>
          <h3>Celular</h3>
          <p>829-826-8073</p>
        </section>
        <section>
          <h1>Email</h1>
          <p>giampi_12@hotmail.com</p>
          <p align="center">o</p>
          <p>20152778@itla.edu.do</p>
          <a href="#/1st-slide">
              <img data-src="img/arrow-up-01-128.png" alt="up arrow" width="100" height="100"/>
          </a>
        </section>
      </section>
      <section>
        <section>
          <h1>HTML</h1>
        </section>
        <section>
          <h1>Definición</h1>
          <p align="center">
            sigla en inglés de HyperText Markup Language (lenguaje de marcas de hipertexto),
             hace referencia al lenguaje de marcado para la elaboración de páginas web.
             Es un estándar que sirve de referencia del software que conecta con la elaboración de páginas web en sus diferentes versiones,
             define una estructura básica y un código (denominado código HTML) para la definición de contenido de una página web,
             como texto, imágenes, videos, juegos, entre otros.
          </p>
        </section>

        <section id="html">
          <table style="font-size:50%">
            <tr>
              <th colspan="2" align="center" style="font-size:58px">Versiones existentes de HTML</th>
            </tr>
            <tr>
              <th>Nombre</th>
              <th align="center">Breve descripción</th>
            </tr>
            <tr>
              <td>HTML 2.0</td>
              <td>
                Cuando se produjo la explosión de Internet el estándar de HTML
                que circulaba era el 2.0 (establecido en noviembre del 95),
                de modo que cualquier navegador
                que encontremos será capaz de interpretarlo.
              </td>
            </tr>
            <tr>
              <td>HTML 3.0 y 3.2</td>
              <td>
                Aunque la versión 2.0 cumplía bien el objetivo para el que se creó,
                carecía de herramientas
                para tener un control mínimamente complejo de los documentos.
                Por estos problemas, el IETF  comenzó a elaborar el borrador del HTML 3.0,
                que resultó ser demasiado grande para la época,
                lo que dificultó su aceptación en el mercado.
              </td>
            </tr>
            <tr>
              <td>HTML 4.0</td>
              <td>
                En julio de 1997 se presenta el borrador de este estándar.
                Por fin se estandarizan los marcos (frames),
                las hojas de estilo y los scripts (entre otras cosas).
                El 17 de diciembre de 1997 dicho borrador fue finalmente aprobado.
              </td>
            </tr>
            <tr>
              <td>HTML 5.0</td>
              <td>
                Es la quinta revisión importante del lenguaje básico de la World Wide Web,HTML.
                 HTML 5 especifica dos variantes de sintaxis para HTML: un clásico HTML (text/html),
                 la variante conocida como HTML5 y una variante XHTML conocida como sintaxis XHTML5 que
                  deberá ser servida como XML (XHTML) (application/xhtml+xml).
                 Esta es la primera vez que HTML y XHTML se han desarrollado en paralelo.
              </td>
            </tr>

          </table>
        </section>
      </section>

      <section id="css">

        <section>
          <h1>CSS</h1>
        </section>
        <section>
          <h1>Definición</h1>
          <p>
            Es un lenguaje de diseño gráfico para definir y crear la presentación de un
            documento estructurado escrito en un lenguaje de marcado .
            Es muy usado para establecer el diseño visual de las páginas web,
             e interfaces de usuario escritas en HTML o XHTML; el lenguaje
             puede ser aplicado a cualquier documento XML, incluyendo XHTML, SVG, XUL, RSS, etcétera.
          </p>
        </section>
        <section>
          <h1>Ejemplo en código</h1>
          <pre>
            <code class="css"  data-trim>
              body{
                background-image: url(somepicture.png);
                background-color: transparent;
                font-family: Verdana;
              }
              #some-slide{
                margin: 0, auto;

              }
              .div{
                color: lightblue;
              }

          </code>
        </pre>
        </section>
      </section>

      <section id="javascript">
        <section>
          <h1>JavaScript</h1>
        </section>
        <section>
          <h1>Definición</h1>
          <p>
             es un lenguaje de diseño interpretado, dialecto del estándar ECMAScript.
             Se define como orientado a objetos,
             basado en prototipos, imperativo, débilmente tipado y dinámico.
          </p>
        </section>
        <section>
          <h2>Prototipos en JavaScript</h2>
          <p>
            La idea de la herencia basada en prototipos JavaScript es definir un objeto (el objeto “padre” o prototipo) donde se aloja toda la información común que comparten todos los objetos de ese tipo (los objetos “hijos”).
            De esta manera se evita que cada objeto repita las propiedades
            y métodos comunes, lo cual ahorra memoria y agiliza la ejecución.
          </p>
        </section>
        <section>
          <h1>Esquema</h1>
          <img src="img/prototype.png" alt="diagrama de prototipo"/>
        </section>
        <section>
          <h1>Ejemplo en código</h1>
          <pre><code>
            window.alert(5 + 6);
            document.write("Esto es una prueba, this is a test");
            document.getElementById("demo").innerHTML = "Hello Dolly."
          </code></pre>
        </section>
        <section>
          <h1>JSON</h1>
        </section>
        <section>
          <h1>Definición</h1>
          <p>
            Es un formato liviano de intercambio de información.
            Es fácil para los humanos leerlo y escribirlo. Es fácil para las
            máquinas convertirlo y generarlo. Está basado en un subset de programación
            javascript de la 3<sup>era</sup> edición de diciembre de 1999. Utiliza convenciones
            que son familiares para los programadores de la familia de lenguajes derivados de C.
          </p>
        </section>
        <section>
          <h1>DOM</h1>
          </section>
          <section>
            <h1>Definición</h1>
            <p>
              Es una interfaz de programación para documentos HTML, XML y SVG.
              provee una representación estructurada del documento como si fuese
              un árbol.
            </p>
          </section>
          <section>
            <h2>Historia</h2>
            <p style="font-size:75%">
              A principios de los años 90, la mayoría de usuarios que se conectaban
               a Internet lo hacían con módems a una velocidad máxima de 28.8 kbps.
               En esa época, empezaban a desarrollarse las primeras aplicaciones
               web y por tanto, las páginas web comenzaban a incluir formularios complejos.
            </p>
            <p style="font-size:75%">
              Brendan Eich, un programador que trabajaba en Netscape, pensó que
              podría solucionar este problema adaptando otras tecnologías existentes
              (como ScriptEase) al navegador Netscape Navigator 2.0, que iba a
               lanzarse en 1995. Inicialmente, Eich denominó a su lenguaje LiveScript.
            </p>
          </section>
          <section>
            <h2>Historia(Cont)</h2>
            <p>
              La primera versión de JavaScript fue un completo éxito y Netscape
               Navigator 3.0 ya incorporaba la siguiente versión del lenguaje,
                la versión 1.1. Al mismo tiempo, Microsoft lanzó JScript con
                su navegador Internet Explorer 3. JScript era una copia de
              JavaScript al que le cambiaron el nombre para evitar problemas legales.
            </p>
          </section>
      </section>


      <section id="canvas">
        <section>
          <h1>Canvas</h1>
        </section>
        <section>
          <h1>Definición</h1>
          <p>
            El elemento HTML &lt;canvas&gt; es usado para dibujar gráficas
            en una página web.
          </p>
        </section>
        <section>
          <h1>Ejemplo</h1>
          </pre>
          <pre>
            <code data-trim>
              var c = document.getElementById("myCanvas");
              var ctx = c.getContext("2d");
              ctx.moveTo(0,0);
              ctx.lineTo(200,100);
              ctx.stroke();
          </code>
        </pre>
        </section>

      </section>

      <section id="diferencias">
        <section>
          <h1>Diferencias entre HTML 4 y HTML5</h1>
          <ul>
            <li>sintáxis</li>
            <li>la sentencia doctype</li>
            <li>Nuevos elementos</li>
            <li>Nuevos atributos</li>
          </ul>
        </section>

      </section>

      <section id="local-storage">
        <section>
          <h1>Local Storage</h1>
        </section>
        <section>
          <h1>Definición</h1>
          <p>
            Con el almacenamiento local, las aplicaciones web pueden almacenar
            información localmente en el navegador del usuario.
          </p>
          <p>
          El almacenamiento local almacena los datos sin fecha de expiración.
          </p>
        </section>
      </section>

      <section id="session-storage">
        <section>
          <h1>Session Storage</h1>
        </section>
        <section>
          <h1>Definición</h1>
          <p>
            El session storage hace la misma función de almacenamiento que
            el localStorage, pero solo almacena información para una única sesión.
          </p>
        </section>
      </section>

      <section id="consola-nav">
        <section>
          <h1>Consola de un Navegador</h1>
        </section>
        <section>
          <h1>Definición</h1>
          <p>
            una poderosa herramienta creada para desarrolladores, usuarios avanzados o cualquier persona.
            Muestra mensajes de información, error o alerta que se reciben al hacer las peticiones para cargar desde la red los elementos incluidos en las páginas.
            Además incluye inspectores o verdaderos depuradores de código.
          </p>
        </section>

      </section>

      <section id="video">
        <section>
          <h1>Video acerca de AJAX</h1>
          <iframe width="560" height="315" src="https://www.youtube.com/embed/RDo3hBL1rfA" frameborder="0" allowfullscreen>

          </iframe
        </section>
      </section>






    </div>
  </div>
    <script src="reveal.js/lib/js/head.min.js"></script>
	<script src="data:application/octet-stream;base64,LyohDQogKiByZXZlYWwuanMNCiAqIGh0dHA6Ly9sYWIuaGFraW0uc2UvcmV2ZWFsLWpzDQogKiBNSVQgbGljZW5zZWQNCiAqDQogKiBDb3B5cmlnaHQgKEMpIDIwMTYgSGFraW0gRWwgSGF0dGFiLCBodHRwOi8vaGFraW0uc2UNCiAqLw0KKGZ1bmN0aW9uKCByb290LCBmYWN0b3J5ICkgew0KCWlmKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKSB7DQoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4NCgkJZGVmaW5lKCBmdW5jdGlvbigpIHsNCgkJCXJvb3QuUmV2ZWFsID0gZmFjdG9yeSgpOw0KCQkJcmV0dXJuIHJvb3QuUmV2ZWFsOw0KCQl9ICk7DQoJfSBlbHNlIGlmKCB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgKSB7DQoJCS8vIE5vZGUuIERvZXMgbm90IHdvcmsgd2l0aCBzdHJpY3QgQ29tbW9uSlMuDQoJCW1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOw0KCX0gZWxzZSB7DQoJCS8vIEJyb3dzZXIgZ2xvYmFscy4NCgkJcm9vdC5SZXZlYWwgPSBmYWN0b3J5KCk7DQoJfQ0KfSggdGhpcywgZnVuY3Rpb24oKSB7DQoNCgkndXNlIHN0cmljdCc7DQoNCgl2YXIgUmV2ZWFsOw0KDQoJLy8gVGhlIHJldmVhbC5qcyB2ZXJzaW9uDQoJdmFyIFZFUlNJT04gPSAnMy40LjAnOw0KDQoJdmFyIFNMSURFU19TRUxFQ1RPUiA9ICcuc2xpZGVzIHNlY3Rpb24nLA0KCQlIT1JJWk9OVEFMX1NMSURFU19TRUxFQ1RPUiA9ICcuc2xpZGVzPnNlY3Rpb24nLA0KCQlWRVJUSUNBTF9TTElERVNfU0VMRUNUT1IgPSAnLnNsaWRlcz5zZWN0aW9uLnByZXNlbnQ+c2VjdGlvbicsDQoJCUhPTUVfU0xJREVfU0VMRUNUT1IgPSAnLnNsaWRlcz5zZWN0aW9uOmZpcnN0LW9mLXR5cGUnLA0KCQlVQSA9IG5hdmlnYXRvci51c2VyQWdlbnQsDQoNCgkJLy8gQ29uZmlndXJhdGlvbiBkZWZhdWx0cywgY2FuIGJlIG92ZXJyaWRkZW4gYXQgaW5pdGlhbGl6YXRpb24gdGltZQ0KCQljb25maWcgPSB7DQoNCgkJCS8vIFRoZSAibm9ybWFsIiBzaXplIG9mIHRoZSBwcmVzZW50YXRpb24sIGFzcGVjdCByYXRpbyB3aWxsIGJlIHByZXNlcnZlZA0KCQkJLy8gd2hlbiB0aGUgcHJlc2VudGF0aW9uIGlzIHNjYWxlZCB0byBmaXQgZGlmZmVyZW50IHJlc29sdXRpb25zDQoJCQl3aWR0aDogOTYwLA0KCQkJaGVpZ2h0OiA3MDAsDQoNCgkJCS8vIEZhY3RvciBvZiB0aGUgZGlzcGxheSBzaXplIHRoYXQgc2hvdWxkIHJlbWFpbiBlbXB0eSBhcm91bmQgdGhlIGNvbnRlbnQNCgkJCW1hcmdpbjogMC4wNCwNCg0KCQkJLy8gQm91bmRzIGZvciBzbWFsbGVzdC9sYXJnZXN0IHBvc3NpYmxlIHNjYWxlIHRvIGFwcGx5IHRvIGNvbnRlbnQNCgkJCW1pblNjYWxlOiAwLjIsDQoJCQltYXhTY2FsZTogMi4wLA0KDQoJCQkvLyBEaXNwbGF5IGNvbnRyb2xzIGluIHRoZSBib3R0b20gcmlnaHQgY29ybmVyDQoJCQljb250cm9sczogdHJ1ZSwNCg0KCQkJLy8gRGlzcGxheSBhIHByZXNlbnRhdGlvbiBwcm9ncmVzcyBiYXINCgkJCXByb2dyZXNzOiB0cnVlLA0KDQoJCQkvLyBEaXNwbGF5IHRoZSBwYWdlIG51bWJlciBvZiB0aGUgY3VycmVudCBzbGlkZQ0KCQkJc2xpZGVOdW1iZXI6IGZhbHNlLA0KDQoJCQkvLyBQdXNoIGVhY2ggc2xpZGUgY2hhbmdlIHRvIHRoZSBicm93c2VyIGhpc3RvcnkNCgkJCWhpc3Rvcnk6IGZhbHNlLA0KDQoJCQkvLyBFbmFibGUga2V5Ym9hcmQgc2hvcnRjdXRzIGZvciBuYXZpZ2F0aW9uDQoJCQlrZXlib2FyZDogdHJ1ZSwNCg0KCQkJLy8gT3B0aW9uYWwgZnVuY3Rpb24gdGhhdCBibG9ja3Mga2V5Ym9hcmQgZXZlbnRzIHdoZW4gcmV0dW5pbmcgZmFsc2UNCgkJCWtleWJvYXJkQ29uZGl0aW9uOiBudWxsLA0KDQoJCQkvLyBFbmFibGUgdGhlIHNsaWRlIG92ZXJ2aWV3IG1vZGUNCgkJCW92ZXJ2aWV3OiB0cnVlLA0KDQoJCQkvLyBWZXJ0aWNhbCBjZW50ZXJpbmcgb2Ygc2xpZGVzDQoJCQljZW50ZXI6IHRydWUsDQoNCgkJCS8vIEVuYWJsZXMgdG91Y2ggbmF2aWdhdGlvbiBvbiBkZXZpY2VzIHdpdGggdG91Y2ggaW5wdXQNCgkJCXRvdWNoOiB0cnVlLA0KDQoJCQkvLyBMb29wIHRoZSBwcmVzZW50YXRpb24NCgkJCWxvb3A6IGZhbHNlLA0KDQoJCQkvLyBDaGFuZ2UgdGhlIHByZXNlbnRhdGlvbiBkaXJlY3Rpb24gdG8gYmUgUlRMDQoJCQlydGw6IGZhbHNlLA0KDQoJCQkvLyBSYW5kb21pemVzIHRoZSBvcmRlciBvZiBzbGlkZXMgZWFjaCB0aW1lIHRoZSBwcmVzZW50YXRpb24gbG9hZHMNCgkJCXNodWZmbGU6IGZhbHNlLA0KDQoJCQkvLyBUdXJucyBmcmFnbWVudHMgb24gYW5kIG9mZiBnbG9iYWxseQ0KCQkJZnJhZ21lbnRzOiB0cnVlLA0KDQoJCQkvLyBGbGFncyBpZiB0aGUgcHJlc2VudGF0aW9uIGlzIHJ1bm5pbmcgaW4gYW4gZW1iZWRkZWQgbW9kZSwNCgkJCS8vIGkuZS4gY29udGFpbmVkIHdpdGhpbiBhIGxpbWl0ZWQgcG9ydGlvbiBvZiB0aGUgc2NyZWVuDQoJCQllbWJlZGRlZDogZmFsc2UsDQoNCgkJCS8vIEZsYWdzIGlmIHdlIHNob3VsZCBzaG93IGEgaGVscCBvdmVybGF5IHdoZW4gdGhlIHF1ZXN0aW9uLW1hcmsNCgkJCS8vIGtleSBpcyBwcmVzc2VkDQoJCQloZWxwOiB0cnVlLA0KDQoJCQkvLyBGbGFncyBpZiBpdCBzaG91bGQgYmUgcG9zc2libGUgdG8gcGF1c2UgdGhlIHByZXNlbnRhdGlvbiAoYmxhY2tvdXQpDQoJCQlwYXVzZTogdHJ1ZSwNCg0KCQkJLy8gRmxhZ3MgaWYgc3BlYWtlciBub3RlcyBzaG91bGQgYmUgdmlzaWJsZSB0byBhbGwgdmlld2Vycw0KCQkJc2hvd05vdGVzOiBmYWxzZSwNCg0KCQkJLy8gTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIGF1dG9tYXRpY2FsbHkgcHJvY2VlZGluZyB0byB0aGUNCgkJCS8vIG5leHQgc2xpZGUsIGRpc2FibGVkIHdoZW4gc2V0IHRvIDAsIHRoaXMgdmFsdWUgY2FuIGJlIG92ZXJ3cml0dGVuDQoJCQkvLyBieSB1c2luZyBhIGRhdGEtYXV0b3NsaWRlIGF0dHJpYnV0ZSBvbiB5b3VyIHNsaWRlcw0KCQkJYXV0b1NsaWRlOiAwLA0KDQoJCQkvLyBTdG9wIGF1dG8tc2xpZGluZyBhZnRlciB1c2VyIGlucHV0DQoJCQlhdXRvU2xpZGVTdG9wcGFibGU6IHRydWUsDQoNCgkJCS8vIFVzZSB0aGlzIG1ldGhvZCBmb3IgbmF2aWdhdGlvbiB3aGVuIGF1dG8tc2xpZGluZyAoZGVmYXVsdHMgdG8gbmF2aWdhdGVOZXh0KQ0KCQkJYXV0b1NsaWRlTWV0aG9kOiBudWxsLA0KDQoJCQkvLyBFbmFibGUgc2xpZGUgbmF2aWdhdGlvbiB2aWEgbW91c2Ugd2hlZWwNCgkJCW1vdXNlV2hlZWw6IGZhbHNlLA0KDQoJCQkvLyBBcHBseSBhIDNEIHJvbGwgdG8gbGlua3Mgb24gaG92ZXINCgkJCXJvbGxpbmdMaW5rczogZmFsc2UsDQoNCgkJCS8vIEhpZGVzIHRoZSBhZGRyZXNzIGJhciBvbiBtb2JpbGUgZGV2aWNlcw0KCQkJaGlkZUFkZHJlc3NCYXI6IHRydWUsDQoNCgkJCS8vIE9wZW5zIGxpbmtzIGluIGFuIGlmcmFtZSBwcmV2aWV3IG92ZXJsYXkNCgkJCXByZXZpZXdMaW5rczogZmFsc2UsDQoNCgkJCS8vIEV4cG9zZXMgdGhlIHJldmVhbC5qcyBBUEkgdGhyb3VnaCB3aW5kb3cucG9zdE1lc3NhZ2UNCgkJCXBvc3RNZXNzYWdlOiB0cnVlLA0KDQoJCQkvLyBEaXNwYXRjaGVzIGFsbCByZXZlYWwuanMgZXZlbnRzIHRvIHRoZSBwYXJlbnQgd2luZG93IHRocm91Z2ggcG9zdE1lc3NhZ2UNCgkJCXBvc3RNZXNzYWdlRXZlbnRzOiBmYWxzZSwNCg0KCQkJLy8gRm9jdXNlcyBib2R5IHdoZW4gcGFnZSBjaGFuZ2VzIHZpc2liaWxpdHkgdG8gZW5zdXJlIGtleWJvYXJkIHNob3J0Y3V0cyB3b3JrDQoJCQlmb2N1c0JvZHlPblBhZ2VWaXNpYmlsaXR5Q2hhbmdlOiB0cnVlLA0KDQoJCQkvLyBUcmFuc2l0aW9uIHN0eWxlDQoJCQl0cmFuc2l0aW9uOiAnc2xpZGUnLCAvLyBub25lL2ZhZGUvc2xpZGUvY29udmV4L2NvbmNhdmUvem9vbQ0KDQoJCQkvLyBUcmFuc2l0aW9uIHNwZWVkDQoJCQl0cmFuc2l0aW9uU3BlZWQ6ICdkZWZhdWx0JywgLy8gZGVmYXVsdC9mYXN0L3Nsb3cNCg0KCQkJLy8gVHJhbnNpdGlvbiBzdHlsZSBmb3IgZnVsbCBwYWdlIHNsaWRlIGJhY2tncm91bmRzDQoJCQliYWNrZ3JvdW5kVHJhbnNpdGlvbjogJ2ZhZGUnLCAvLyBub25lL2ZhZGUvc2xpZGUvY29udmV4L2NvbmNhdmUvem9vbQ0KDQoJCQkvLyBQYXJhbGxheCBiYWNrZ3JvdW5kIGltYWdlDQoJCQlwYXJhbGxheEJhY2tncm91bmRJbWFnZTogJycsIC8vIENTUyBzeW50YXgsIGUuZy4gImEuanBnIg0KDQoJCQkvLyBQYXJhbGxheCBiYWNrZ3JvdW5kIHNpemUNCgkJCXBhcmFsbGF4QmFja2dyb3VuZFNpemU6ICcnLCAvLyBDU1Mgc3ludGF4LCBlLmcuICIzMDAwcHggMjAwMHB4Ig0KDQoJCQkvLyBBbW91bnQgb2YgcGl4ZWxzIHRvIG1vdmUgdGhlIHBhcmFsbGF4IGJhY2tncm91bmQgcGVyIHNsaWRlIHN0ZXANCgkJCXBhcmFsbGF4QmFja2dyb3VuZEhvcml6b250YWw6IG51bGwsDQoJCQlwYXJhbGxheEJhY2tncm91bmRWZXJ0aWNhbDogbnVsbCwNCg0KCQkJLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIHBhZ2VzIGEgc2luZ2xlIHNsaWRlIGNhbiBleHBhbmQgb250byB3aGVuIHByaW50aW5nDQoJCQkvLyB0byBQREYsIHVubGltaXRlZCBieSBkZWZhdWx0DQoJCQlwZGZNYXhQYWdlc1BlclNsaWRlOiBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksDQoNCgkJCS8vIE51bWJlciBvZiBzbGlkZXMgYXdheSBmcm9tIHRoZSBjdXJyZW50IHRoYXQgYXJlIHZpc2libGUNCgkJCXZpZXdEaXN0YW5jZTogMywNCg0KCQkJLy8gU2NyaXB0IGRlcGVuZGVuY2llcyB0byBsb2FkDQoJCQlkZXBlbmRlbmNpZXM6IFtdDQoNCgkJfSwNCg0KCQkvLyBGbGFncyBpZiBSZXZlYWwuaW5pdGlhbGl6ZSgpIGhhcyBiZWVuIGNhbGxlZA0KCQlpbml0aWFsaXplZCA9IGZhbHNlLA0KDQoJCS8vIEZsYWdzIGlmIHJldmVhbC5qcyBpcyBsb2FkZWQgKGhhcyBkaXNwYXRjaGVkIHRoZSAncmVhZHknIGV2ZW50KQ0KCQlsb2FkZWQgPSBmYWxzZSwNCg0KCQkvLyBGbGFncyBpZiB0aGUgb3ZlcnZpZXcgbW9kZSBpcyBjdXJyZW50bHkgYWN0aXZlDQoJCW92ZXJ2aWV3ID0gZmFsc2UsDQoNCgkJLy8gSG9sZHMgdGhlIGRpbWVuc2lvbnMgb2Ygb3VyIG92ZXJ2aWV3IHNsaWRlcywgaW5jbHVkaW5nIG1hcmdpbnMNCgkJb3ZlcnZpZXdTbGlkZVdpZHRoID0gbnVsbCwNCgkJb3ZlcnZpZXdTbGlkZUhlaWdodCA9IG51bGwsDQoNCgkJLy8gVGhlIGhvcml6b250YWwgYW5kIHZlcnRpY2FsIGluZGV4IG9mIHRoZSBjdXJyZW50bHkgYWN0aXZlIHNsaWRlDQoJCWluZGV4aCwNCgkJaW5kZXh2LA0KDQoJCS8vIFRoZSBwcmV2aW91cyBhbmQgY3VycmVudCBzbGlkZSBIVE1MIGVsZW1lbnRzDQoJCXByZXZpb3VzU2xpZGUsDQoJCWN1cnJlbnRTbGlkZSwNCg0KCQlwcmV2aW91c0JhY2tncm91bmQsDQoNCgkJLy8gU2xpZGVzIG1heSBob2xkIGEgZGF0YS1zdGF0ZSBhdHRyaWJ1dGUgd2hpY2ggd2UgcGljayB1cCBhbmQgYXBwbHkNCgkJLy8gYXMgYSBjbGFzcyB0byB0aGUgYm9keS4gVGhpcyBsaXN0IGNvbnRhaW5zIHRoZSBjb21iaW5lZCBzdGF0ZSBvZg0KCQkvLyBhbGwgY3VycmVudCBzbGlkZXMuDQoJCXN0YXRlID0gW10sDQoNCgkJLy8gVGhlIGN1cnJlbnQgc2NhbGUgb2YgdGhlIHByZXNlbnRhdGlvbiAoc2VlIHdpZHRoL2hlaWdodCBjb25maWcpDQoJCXNjYWxlID0gMSwNCg0KCQkvLyBDU1MgdHJhbnNmb3JtIHRoYXQgaXMgY3VycmVudGx5IGFwcGxpZWQgdG8gdGhlIHNsaWRlcyBjb250YWluZXIsDQoJCS8vIHNwbGl0IGludG8gdHdvIGdyb3Vwcw0KCQlzbGlkZXNUcmFuc2Zvcm0gPSB7IGxheW91dDogJycsIG92ZXJ2aWV3OiAnJyB9LA0KDQoJCS8vIENhY2hlZCByZWZlcmVuY2VzIHRvIERPTSBlbGVtZW50cw0KCQlkb20gPSB7fSwNCg0KCQkvLyBGZWF0dXJlcyBzdXBwb3J0ZWQgYnkgdGhlIGJyb3dzZXIsIHNlZSAjY2hlY2tDYXBhYmlsaXRpZXMoKQ0KCQlmZWF0dXJlcyA9IHt9LA0KDQoJCS8vIENsaWVudCBpcyBhIG1vYmlsZSBkZXZpY2UsIHNlZSAjY2hlY2tDYXBhYmlsaXRpZXMoKQ0KCQlpc01vYmlsZURldmljZSwNCg0KCQkvLyBDbGllbnQgaXMgYSBkZXNrdG9wIENocm9tZSwgc2VlICNjaGVja0NhcGFiaWxpdGllcygpDQoJCWlzQ2hyb21lLA0KDQoJCS8vIFRocm90dGxlcyBtb3VzZSB3aGVlbCBuYXZpZ2F0aW9uDQoJCWxhc3RNb3VzZVdoZWVsU3RlcCA9IDAsDQoNCgkJLy8gRGVsYXlzIHVwZGF0ZXMgdG8gdGhlIFVSTCBkdWUgdG8gYSBDaHJvbWUgdGh1bWJuYWlsZXIgYnVnDQoJCXdyaXRlVVJMVGltZW91dCA9IDAsDQoNCgkJLy8gRmxhZ3MgaWYgdGhlIGludGVyYWN0aW9uIGV2ZW50IGxpc3RlbmVycyBhcmUgYm91bmQNCgkJZXZlbnRzQXJlQm91bmQgPSBmYWxzZSwNCg0KCQkvLyBUaGUgY3VycmVudCBhdXRvLXNsaWRlIGR1cmF0aW9uDQoJCWF1dG9TbGlkZSA9IDAsDQoNCgkJLy8gQXV0byBzbGlkZSBwcm9wZXJ0aWVzDQoJCWF1dG9TbGlkZVBsYXllciwNCgkJYXV0b1NsaWRlVGltZW91dCA9IDAsDQoJCWF1dG9TbGlkZVN0YXJ0VGltZSA9IC0xLA0KCQlhdXRvU2xpZGVQYXVzZWQgPSBmYWxzZSwNCg0KCQkvLyBIb2xkcyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudGx5IG9uZ29pbmcgdG91Y2ggaW5wdXQNCgkJdG91Y2ggPSB7DQoJCQlzdGFydFg6IDAsDQoJCQlzdGFydFk6IDAsDQoJCQlzdGFydFNwYW46IDAsDQoJCQlzdGFydENvdW50OiAwLA0KCQkJY2FwdHVyZWQ6IGZhbHNlLA0KCQkJdGhyZXNob2xkOiA0MA0KCQl9LA0KDQoJCS8vIEhvbGRzIGluZm9ybWF0aW9uIGFib3V0IHRoZSBrZXlib2FyZCBzaG9ydGN1dHMNCgkJa2V5Ym9hcmRTaG9ydGN1dHMgPSB7DQoJCQknTiAgLCAgU1BBQ0UnOgkJCSdOZXh0IHNsaWRlJywNCgkJCSdQJzoJCQkJCSdQcmV2aW91cyBzbGlkZScsDQoJCQknJiM4NTkyOyAgLCAgSCc6CQknTmF2aWdhdGUgbGVmdCcsDQoJCQknJiM4NTk0OyAgLCAgTCc6CQknTmF2aWdhdGUgcmlnaHQnLA0KCQkJJyYjODU5MzsgICwgIEsnOgkJJ05hdmlnYXRlIHVwJywNCgkJCScmIzg1OTU7ICAsICBKJzoJCSdOYXZpZ2F0ZSBkb3duJywNCgkJCSdIb21lJzoJCQkJCSdGaXJzdCBzbGlkZScsDQoJCQknRW5kJzoJCQkJCSdMYXN0IHNsaWRlJywNCgkJCSdCICAsICAuJzoJCQkJJ1BhdXNlJywNCgkJCSdGJzoJCQkJCSdGdWxsc2NyZWVuJywNCgkJCSdFU0MsIE8nOgkJCQknU2xpZGUgb3ZlcnZpZXcnDQoJCX07DQoNCgkvKioNCgkgKiBTdGFydHMgdXAgdGhlIHByZXNlbnRhdGlvbiBpZiB0aGUgY2xpZW50IGlzIGNhcGFibGUuDQoJICovDQoJZnVuY3Rpb24gaW5pdGlhbGl6ZSggb3B0aW9ucyApIHsNCg0KCQkvLyBNYWtlIHN1cmUgd2Ugb25seSBpbml0aWFsaXplIG9uY2UNCgkJaWYoIGluaXRpYWxpemVkID09PSB0cnVlICkgcmV0dXJuOw0KDQoJCWluaXRpYWxpemVkID0gdHJ1ZTsNCg0KCQljaGVja0NhcGFiaWxpdGllcygpOw0KDQoJCWlmKCAhZmVhdHVyZXMudHJhbnNmb3JtczJkICYmICFmZWF0dXJlcy50cmFuc2Zvcm1zM2QgKSB7DQoJCQlkb2N1bWVudC5ib2R5LnNldEF0dHJpYnV0ZSggJ2NsYXNzJywgJ25vLXRyYW5zZm9ybXMnICk7DQoNCgkJCS8vIFNpbmNlIEpTIHdvbid0IGJlIHJ1bm5pbmcgYW55IGZ1cnRoZXIsIHdlIGxvYWQgYWxsIGxhenkNCgkJCS8vIGxvYWRpbmcgZWxlbWVudHMgdXBmcm9udA0KCQkJdmFyIGltYWdlcyA9IHRvQXJyYXkoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAnaW1nJyApICksDQoJCQkJaWZyYW1lcyA9IHRvQXJyYXkoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAnaWZyYW1lJyApICk7DQoNCgkJCXZhciBsYXp5TG9hZGFibGUgPSBpbWFnZXMuY29uY2F0KCBpZnJhbWVzICk7DQoNCgkJCWZvciggdmFyIGkgPSAwLCBsZW4gPSBsYXp5TG9hZGFibGUubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7DQoJCQkJdmFyIGVsZW1lbnQgPSBsYXp5TG9hZGFibGVbaV07DQoJCQkJaWYoIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCAnZGF0YS1zcmMnICkgKSB7DQoJCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAnc3JjJywgZWxlbWVudC5nZXRBdHRyaWJ1dGUoICdkYXRhLXNyYycgKSApOw0KCQkJCQllbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSggJ2RhdGEtc3JjJyApOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gSWYgdGhlIGJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IGNvcmUgZmVhdHVyZXMgd2Ugd29uJ3QgYmUNCgkJCS8vIHVzaW5nIEphdmFTY3JpcHQgdG8gY29udHJvbCB0aGUgcHJlc2VudGF0aW9uDQoJCQlyZXR1cm47DQoJCX0NCg0KCQkvLyBDYWNoZSByZWZlcmVuY2VzIHRvIGtleSBET00gZWxlbWVudHMNCgkJZG9tLndyYXBwZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAnLnJldmVhbCcgKTsNCgkJZG9tLnNsaWRlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICcucmV2ZWFsIC5zbGlkZXMnICk7DQoNCgkJLy8gRm9yY2UgYSBsYXlvdXQgd2hlbiB0aGUgd2hvbGUgcGFnZSwgaW5jbCBmb250cywgaGFzIGxvYWRlZA0KCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggJ2xvYWQnLCBsYXlvdXQsIGZhbHNlICk7DQoNCgkJdmFyIHF1ZXJ5ID0gUmV2ZWFsLmdldFF1ZXJ5SGFzaCgpOw0KDQoJCS8vIERvIG5vdCBhY2NlcHQgbmV3IGRlcGVuZGVuY2llcyB2aWEgcXVlcnkgY29uZmlnIHRvIGF2b2lkDQoJCS8vIHRoZSBwb3RlbnRpYWwgb2YgbWFsaWNpb3VzIHNjcmlwdCBpbmplY3Rpb24NCgkJaWYoIHR5cGVvZiBxdWVyeVsnZGVwZW5kZW5jaWVzJ10gIT09ICd1bmRlZmluZWQnICkgZGVsZXRlIHF1ZXJ5WydkZXBlbmRlbmNpZXMnXTsNCg0KCQkvLyBDb3B5IG9wdGlvbnMgb3ZlciB0byBvdXIgY29uZmlnIG9iamVjdA0KCQlleHRlbmQoIGNvbmZpZywgb3B0aW9ucyApOw0KCQlleHRlbmQoIGNvbmZpZywgcXVlcnkgKTsNCg0KCQkvLyBIaWRlIHRoZSBhZGRyZXNzIGJhciBpbiBtb2JpbGUgYnJvd3NlcnMNCgkJaGlkZUFkZHJlc3NCYXIoKTsNCg0KCQkvLyBMb2FkcyB0aGUgZGVwZW5kZW5jaWVzIGFuZCBjb250aW51ZXMgdG8gI3N0YXJ0KCkgb25jZSBkb25lDQoJCWxvYWQoKTsNCg0KCX0NCg0KCS8qKg0KCSAqIEluc3BlY3QgdGhlIGNsaWVudCB0byBzZWUgd2hhdCBpdCdzIGNhcGFibGUgb2YsIHRoaXMNCgkgKiBzaG91bGQgb25seSBoYXBwZW5zIG9uY2UgcGVyIHJ1bnRpbWUuDQoJICovDQoJZnVuY3Rpb24gY2hlY2tDYXBhYmlsaXRpZXMoKSB7DQoNCgkJaXNNb2JpbGVEZXZpY2UgPSAvKGlwaG9uZXxpcG9kfGlwYWR8YW5kcm9pZCkvZ2kudGVzdCggVUEgKTsNCgkJaXNDaHJvbWUgPSAvY2hyb21lL2kudGVzdCggVUEgKSAmJiAhL2VkZ2UvaS50ZXN0KCBVQSApOw0KDQoJCXZhciB0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICk7DQoNCgkJZmVhdHVyZXMudHJhbnNmb3JtczNkID0gJ1dlYmtpdFBlcnNwZWN0aXZlJyBpbiB0ZXN0RWxlbWVudC5zdHlsZSB8fA0KCQkJCQkJCQknTW96UGVyc3BlY3RpdmUnIGluIHRlc3RFbGVtZW50LnN0eWxlIHx8DQoJCQkJCQkJCSdtc1BlcnNwZWN0aXZlJyBpbiB0ZXN0RWxlbWVudC5zdHlsZSB8fA0KCQkJCQkJCQknT1BlcnNwZWN0aXZlJyBpbiB0ZXN0RWxlbWVudC5zdHlsZSB8fA0KCQkJCQkJCQkncGVyc3BlY3RpdmUnIGluIHRlc3RFbGVtZW50LnN0eWxlOw0KDQoJCWZlYXR1cmVzLnRyYW5zZm9ybXMyZCA9ICdXZWJraXRUcmFuc2Zvcm0nIGluIHRlc3RFbGVtZW50LnN0eWxlIHx8DQoJCQkJCQkJCSdNb3pUcmFuc2Zvcm0nIGluIHRlc3RFbGVtZW50LnN0eWxlIHx8DQoJCQkJCQkJCSdtc1RyYW5zZm9ybScgaW4gdGVzdEVsZW1lbnQuc3R5bGUgfHwNCgkJCQkJCQkJJ09UcmFuc2Zvcm0nIGluIHRlc3RFbGVtZW50LnN0eWxlIHx8DQoJCQkJCQkJCSd0cmFuc2Zvcm0nIGluIHRlc3RFbGVtZW50LnN0eWxlOw0KDQoJCWZlYXR1cmVzLnJlcXVlc3RBbmltYXRpb25GcmFtZU1ldGhvZCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCB3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lOw0KCQlmZWF0dXJlcy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSB0eXBlb2YgZmVhdHVyZXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lTWV0aG9kID09PSAnZnVuY3Rpb24nOw0KDQoJCWZlYXR1cmVzLmNhbnZhcyA9ICEhZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2NhbnZhcycgKS5nZXRDb250ZXh0Ow0KDQoJCS8vIFRyYW5zaXRpb25zIGluIHRoZSBvdmVydmlldyBhcmUgZGlzYWJsZWQgaW4gZGVza3RvcCBhbmQNCgkJLy8gU2FmYXJpIGR1ZSB0byBsYWcNCgkJZmVhdHVyZXMub3ZlcnZpZXdUcmFuc2l0aW9ucyA9ICEvVmVyc2lvblwvW1xkXC5dKy4qU2FmYXJpLy50ZXN0KCBVQSApOw0KDQoJCS8vIEZsYWdzIGlmIHdlIHNob3VsZCB1c2Ugem9vbSBpbnN0ZWFkIG9mIHRyYW5zZm9ybSB0byBzY2FsZQ0KCQkvLyB1cCBzbGlkZXMuIFpvb20gcHJvZHVjZXMgY3Jpc3BlciByZXN1bHRzIGJ1dCBoYXMgYSBsb3Qgb2YNCgkJLy8geGJyb3dzZXIgcXVpcmtzIHNvIHdlIG9ubHkgdXNlIGl0IGluIHdoaXRlbHNpdGVkIGJyb3dzZXJzLg0KCQlmZWF0dXJlcy56b29tID0gJ3pvb20nIGluIHRlc3RFbGVtZW50LnN0eWxlICYmICFpc01vYmlsZURldmljZSAmJg0KCQkJCQkJKCBpc0Nocm9tZSB8fCAvVmVyc2lvblwvW1xkXC5dKy4qU2FmYXJpLy50ZXN0KCBVQSApICk7DQoNCgl9DQoNCiAgICAvKioNCiAgICAgKiBMb2FkcyB0aGUgZGVwZW5kZW5jaWVzIG9mIHJldmVhbC5qcy4gRGVwZW5kZW5jaWVzIGFyZQ0KICAgICAqIGRlZmluZWQgdmlhIHRoZSBjb25maWd1cmF0aW9uIG9wdGlvbiAnZGVwZW5kZW5jaWVzJw0KICAgICAqIGFuZCB3aWxsIGJlIGxvYWRlZCBwcmlvciB0byBzdGFydGluZy9iaW5kaW5nIHJldmVhbC5qcy4NCiAgICAgKiBTb21lIGRlcGVuZGVuY2llcyBtYXkgaGF2ZSBhbiAnYXN5bmMnIGZsYWcsIGlmIHNvIHRoZXkNCiAgICAgKiB3aWxsIGxvYWQgYWZ0ZXIgcmV2ZWFsLmpzIGhhcyBiZWVuIHN0YXJ0ZWQgdXAuDQogICAgICovDQoJZnVuY3Rpb24gbG9hZCgpIHsNCg0KCQl2YXIgc2NyaXB0cyA9IFtdLA0KCQkJc2NyaXB0c0FzeW5jID0gW10sDQoJCQlzY3JpcHRzVG9QcmVsb2FkID0gMDsNCg0KCQkvLyBDYWxsZWQgb25jZSBzeW5jaHJvbm91cyBzY3JpcHRzIGZpbmlzaCBsb2FkaW5nDQoJCWZ1bmN0aW9uIHByb2NlZWQoKSB7DQoJCQlpZiggc2NyaXB0c0FzeW5jLmxlbmd0aCApIHsNCgkJCQkvLyBMb2FkIGFzeW5jaHJvbm91cyBzY3JpcHRzDQoJCQkJaGVhZC5qcy5hcHBseSggbnVsbCwgc2NyaXB0c0FzeW5jICk7DQoJCQl9DQoNCgkJCXN0YXJ0KCk7DQoJCX0NCg0KCQlmdW5jdGlvbiBsb2FkU2NyaXB0KCBzICkgew0KCQkJaGVhZC5yZWFkeSggcy5zcmMubWF0Y2goIC8oW1x3XGRfXC1dKilcLj9qcyR8W15cXFwvXSokL2kgKVswXSwgZnVuY3Rpb24oKSB7DQoJCQkJLy8gRXh0ZW5zaW9uIG1heSBjb250YWluIGNhbGxiYWNrIGZ1bmN0aW9ucw0KCQkJCWlmKCB0eXBlb2Ygcy5jYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJyApIHsNCgkJCQkJcy5jYWxsYmFjay5hcHBseSggdGhpcyApOw0KCQkJCX0NCg0KCQkJCWlmKCAtLXNjcmlwdHNUb1ByZWxvYWQgPT09IDAgKSB7DQoJCQkJCXByb2NlZWQoKTsNCgkJCQl9DQoJCQl9KTsNCgkJfQ0KDQoJCWZvciggdmFyIGkgPSAwLCBsZW4gPSBjb25maWcuZGVwZW5kZW5jaWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrICkgew0KCQkJdmFyIHMgPSBjb25maWcuZGVwZW5kZW5jaWVzW2ldOw0KDQoJCQkvLyBMb2FkIGlmIHRoZXJlJ3Mgbm8gY29uZGl0aW9uIG9yIHRoZSBjb25kaXRpb24gaXMgdHJ1dGh5DQoJCQlpZiggIXMuY29uZGl0aW9uIHx8IHMuY29uZGl0aW9uKCkgKSB7DQoJCQkJaWYoIHMuYXN5bmMgKSB7DQoJCQkJCXNjcmlwdHNBc3luYy5wdXNoKCBzLnNyYyApOw0KCQkJCX0NCgkJCQllbHNlIHsNCgkJCQkJc2NyaXB0cy5wdXNoKCBzLnNyYyApOw0KCQkJCX0NCg0KCQkJCWxvYWRTY3JpcHQoIHMgKTsNCgkJCX0NCgkJfQ0KDQoJCWlmKCBzY3JpcHRzLmxlbmd0aCApIHsNCgkJCXNjcmlwdHNUb1ByZWxvYWQgPSBzY3JpcHRzLmxlbmd0aDsNCg0KCQkJLy8gTG9hZCBzeW5jaHJvbm91cyBzY3JpcHRzDQoJCQloZWFkLmpzLmFwcGx5KCBudWxsLCBzY3JpcHRzICk7DQoJCX0NCgkJZWxzZSB7DQoJCQlwcm9jZWVkKCk7DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIFN0YXJ0cyB1cCByZXZlYWwuanMgYnkgYmluZGluZyBpbnB1dCBldmVudHMgYW5kIG5hdmlnYXRpbmcNCgkgKiB0byB0aGUgY3VycmVudCBVUkwgZGVlcGxpbmsgaWYgdGhlcmUgaXMgb25lLg0KCSAqLw0KCWZ1bmN0aW9uIHN0YXJ0KCkgew0KDQoJCS8vIE1ha2Ugc3VyZSB3ZSd2ZSBnb3QgYWxsIHRoZSBET00gZWxlbWVudHMgd2UgbmVlZA0KCQlzZXR1cERPTSgpOw0KDQoJCS8vIExpc3RlbiB0byBtZXNzYWdlcyBwb3N0ZWQgdG8gdGhpcyB3aW5kb3cNCgkJc2V0dXBQb3N0TWVzc2FnZSgpOw0KDQoJCS8vIFByZXZlbnQgdGhlIHNsaWRlcyBmcm9tIGJlaW5nIHNjcm9sbGVkIG91dCBvZiB2aWV3DQoJCXNldHVwU2Nyb2xsUHJldmVudGlvbigpOw0KDQoJCS8vIFJlc2V0cyBhbGwgdmVydGljYWwgc2xpZGVzIHNvIHRoYXQgb25seSB0aGUgZmlyc3QgaXMgdmlzaWJsZQ0KCQlyZXNldFZlcnRpY2FsU2xpZGVzKCk7DQoNCgkJLy8gVXBkYXRlcyB0aGUgcHJlc2VudGF0aW9uIHRvIG1hdGNoIHRoZSBjdXJyZW50IGNvbmZpZ3VyYXRpb24gdmFsdWVzDQoJCWNvbmZpZ3VyZSgpOw0KDQoJCS8vIFJlYWQgdGhlIGluaXRpYWwgaGFzaA0KCQlyZWFkVVJMKCk7DQoNCgkJLy8gVXBkYXRlIGFsbCBiYWNrZ3JvdW5kcw0KCQl1cGRhdGVCYWNrZ3JvdW5kKCB0cnVlICk7DQoNCgkJLy8gTm90aWZ5IGxpc3RlbmVycyB0aGF0IHRoZSBwcmVzZW50YXRpb24gaXMgcmVhZHkgYnV0IHVzZSBhIDFtcw0KCQkvLyB0aW1lb3V0IHRvIGVuc3VyZSBpdCdzIG5vdCBmaXJlZCBzeW5jaHJvbm91c2x5IGFmdGVyICNpbml0aWFsaXplKCkNCgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7DQoJCQkvLyBFbmFibGUgdHJhbnNpdGlvbnMgbm93IHRoYXQgd2UncmUgbG9hZGVkDQoJCQlkb20uc2xpZGVzLmNsYXNzTGlzdC5yZW1vdmUoICduby10cmFuc2l0aW9uJyApOw0KDQoJCQlsb2FkZWQgPSB0cnVlOw0KDQoJCQlkb20ud3JhcHBlci5jbGFzc0xpc3QuYWRkKCAncmVhZHknICk7DQoNCgkJCWRpc3BhdGNoRXZlbnQoICdyZWFkeScsIHsNCgkJCQknaW5kZXhoJzogaW5kZXhoLA0KCQkJCSdpbmRleHYnOiBpbmRleHYsDQoJCQkJJ2N1cnJlbnRTbGlkZSc6IGN1cnJlbnRTbGlkZQ0KCQkJfSApOw0KCQl9LCAxICk7DQoNCgkJLy8gU3BlY2lhbCBzZXR1cCBhbmQgY29uZmlnIGlzIHJlcXVpcmVkIHdoZW4gcHJpbnRpbmcgdG8gUERGDQoJCWlmKCBpc1ByaW50aW5nUERGKCkgKSB7DQoJCQlyZW1vdmVFdmVudExpc3RlbmVycygpOw0KDQoJCQkvLyBUaGUgZG9jdW1lbnQgbmVlZHMgdG8gaGF2ZSBsb2FkZWQgZm9yIHRoZSBQREYgbGF5b3V0DQoJCQkvLyBtZWFzdXJlbWVudHMgdG8gYmUgYWNjdXJhdGUNCgkJCWlmKCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnICkgew0KCQkJCXNldHVwUERGKCk7DQoJCQl9DQoJCQllbHNlIHsNCgkJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggJ2xvYWQnLCBzZXR1cFBERiApOw0KCQkJfQ0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBGaW5kcyBhbmQgc3RvcmVzIHJlZmVyZW5jZXMgdG8gRE9NIGVsZW1lbnRzIHdoaWNoIGFyZQ0KCSAqIHJlcXVpcmVkIGJ5IHRoZSBwcmVzZW50YXRpb24uIElmIGEgcmVxdWlyZWQgZWxlbWVudCBpcw0KCSAqIG5vdCBmb3VuZCwgaXQgaXMgY3JlYXRlZC4NCgkgKi8NCglmdW5jdGlvbiBzZXR1cERPTSgpIHsNCg0KCQkvLyBQcmV2ZW50IHRyYW5zaXRpb25zIHdoaWxlIHdlJ3JlIGxvYWRpbmcNCgkJZG9tLnNsaWRlcy5jbGFzc0xpc3QuYWRkKCAnbm8tdHJhbnNpdGlvbicgKTsNCg0KCQkvLyBCYWNrZ3JvdW5kIGVsZW1lbnQNCgkJZG9tLmJhY2tncm91bmQgPSBjcmVhdGVTaW5nbGV0b25Ob2RlKCBkb20ud3JhcHBlciwgJ2RpdicsICdiYWNrZ3JvdW5kcycsIG51bGwgKTsNCg0KCQkvLyBQcm9ncmVzcyBiYXINCgkJZG9tLnByb2dyZXNzID0gY3JlYXRlU2luZ2xldG9uTm9kZSggZG9tLndyYXBwZXIsICdkaXYnLCAncHJvZ3Jlc3MnLCAnPHNwYW4+PC9zcGFuPicgKTsNCgkJZG9tLnByb2dyZXNzYmFyID0gZG9tLnByb2dyZXNzLnF1ZXJ5U2VsZWN0b3IoICdzcGFuJyApOw0KDQoJCS8vIEFycm93IGNvbnRyb2xzDQoJCWNyZWF0ZVNpbmdsZXRvbk5vZGUoIGRvbS53cmFwcGVyLCAnYXNpZGUnLCAnY29udHJvbHMnLA0KCQkJJzxidXR0b24gY2xhc3M9Im5hdmlnYXRlLWxlZnQiIGFyaWEtbGFiZWw9InByZXZpb3VzIHNsaWRlIj48L2J1dHRvbj4nICsNCgkJCSc8YnV0dG9uIGNsYXNzPSJuYXZpZ2F0ZS1yaWdodCIgYXJpYS1sYWJlbD0ibmV4dCBzbGlkZSI+PC9idXR0b24+JyArDQoJCQknPGJ1dHRvbiBjbGFzcz0ibmF2aWdhdGUtdXAiIGFyaWEtbGFiZWw9ImFib3ZlIHNsaWRlIj48L2J1dHRvbj4nICsNCgkJCSc8YnV0dG9uIGNsYXNzPSJuYXZpZ2F0ZS1kb3duIiBhcmlhLWxhYmVsPSJiZWxvdyBzbGlkZSI+PC9idXR0b24+JyApOw0KDQoJCS8vIFNsaWRlIG51bWJlcg0KCQlkb20uc2xpZGVOdW1iZXIgPSBjcmVhdGVTaW5nbGV0b25Ob2RlKCBkb20ud3JhcHBlciwgJ2RpdicsICdzbGlkZS1udW1iZXInLCAnJyApOw0KDQoJCS8vIEVsZW1lbnQgY29udGFpbmluZyBub3RlcyB0aGF0IGFyZSB2aXNpYmxlIHRvIHRoZSBhdWRpZW5jZQ0KCQlkb20uc3BlYWtlck5vdGVzID0gY3JlYXRlU2luZ2xldG9uTm9kZSggZG9tLndyYXBwZXIsICdkaXYnLCAnc3BlYWtlci1ub3RlcycsIG51bGwgKTsNCgkJZG9tLnNwZWFrZXJOb3Rlcy5zZXRBdHRyaWJ1dGUoICdkYXRhLXByZXZlbnQtc3dpcGUnLCAnJyApOw0KCQlkb20uc3BlYWtlck5vdGVzLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJzAnICk7DQoNCgkJLy8gT3ZlcmxheSBncmFwaGljIHdoaWNoIGlzIGRpc3BsYXllZCBkdXJpbmcgdGhlIHBhdXNlZCBtb2RlDQoJCWNyZWF0ZVNpbmdsZXRvbk5vZGUoIGRvbS53cmFwcGVyLCAnZGl2JywgJ3BhdXNlLW92ZXJsYXknLCBudWxsICk7DQoNCgkJLy8gQ2FjaGUgcmVmZXJlbmNlcyB0byBlbGVtZW50cw0KCQlkb20uY29udHJvbHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAnLnJldmVhbCAuY29udHJvbHMnICk7DQoNCgkJZG9tLndyYXBwZXIuc2V0QXR0cmlidXRlKCAncm9sZScsICdhcHBsaWNhdGlvbicgKTsNCg0KCQkvLyBUaGVyZSBjYW4gYmUgbXVsdGlwbGUgaW5zdGFuY2VzIG9mIGNvbnRyb2xzIHRocm91Z2hvdXQgdGhlIHBhZ2UNCgkJZG9tLmNvbnRyb2xzTGVmdCA9IHRvQXJyYXkoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoICcubmF2aWdhdGUtbGVmdCcgKSApOw0KCQlkb20uY29udHJvbHNSaWdodCA9IHRvQXJyYXkoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoICcubmF2aWdhdGUtcmlnaHQnICkgKTsNCgkJZG9tLmNvbnRyb2xzVXAgPSB0b0FycmF5KCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCAnLm5hdmlnYXRlLXVwJyApICk7DQoJCWRvbS5jb250cm9sc0Rvd24gPSB0b0FycmF5KCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCAnLm5hdmlnYXRlLWRvd24nICkgKTsNCgkJZG9tLmNvbnRyb2xzUHJldiA9IHRvQXJyYXkoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoICcubmF2aWdhdGUtcHJldicgKSApOw0KCQlkb20uY29udHJvbHNOZXh0ID0gdG9BcnJheSggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggJy5uYXZpZ2F0ZS1uZXh0JyApICk7DQoNCgkJZG9tLnN0YXR1c0RpdiA9IGNyZWF0ZVN0YXR1c0RpdigpOw0KCX0NCg0KCS8qKg0KCSAqIENyZWF0ZXMgYSBoaWRkZW4gZGl2IHdpdGggcm9sZSBhcmlhLWxpdmUgdG8gYW5ub3VuY2UgdGhlDQoJICogY3VycmVudCBzbGlkZSBjb250ZW50LiBIaWRlIHRoZSBkaXYgb2ZmLXNjcmVlbiB0byBtYWtlIGl0DQoJICogYXZhaWxhYmxlIG9ubHkgdG8gQXNzaXN0aXZlIFRlY2hub2xvZ2llcy4NCgkgKg0KCSAqIEByZXR1cm4ge0hUTUxFbGVtZW50fQ0KCSAqLw0KCWZ1bmN0aW9uIGNyZWF0ZVN0YXR1c0RpdigpIHsNCg0KCQl2YXIgc3RhdHVzRGl2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoICdhcmlhLXN0YXR1cy1kaXYnICk7DQoJCWlmKCAhc3RhdHVzRGl2ICkgew0KCQkJc3RhdHVzRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKTsNCgkJCXN0YXR1c0Rpdi5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7DQoJCQlzdGF0dXNEaXYuc3R5bGUuaGVpZ2h0ID0gJzFweCc7DQoJCQlzdGF0dXNEaXYuc3R5bGUud2lkdGggPSAnMXB4JzsNCgkJCXN0YXR1c0Rpdi5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOw0KCQkJc3RhdHVzRGl2LnN0eWxlLmNsaXAgPSAncmVjdCggMXB4LCAxcHgsIDFweCwgMXB4ICknOw0KCQkJc3RhdHVzRGl2LnNldEF0dHJpYnV0ZSggJ2lkJywgJ2FyaWEtc3RhdHVzLWRpdicgKTsNCgkJCXN0YXR1c0Rpdi5zZXRBdHRyaWJ1dGUoICdhcmlhLWxpdmUnLCAncG9saXRlJyApOw0KCQkJc3RhdHVzRGl2LnNldEF0dHJpYnV0ZSggJ2FyaWEtYXRvbWljJywndHJ1ZScgKTsNCgkJCWRvbS53cmFwcGVyLmFwcGVuZENoaWxkKCBzdGF0dXNEaXYgKTsNCgkJfQ0KCQlyZXR1cm4gc3RhdHVzRGl2Ow0KDQoJfQ0KDQoJLyoqDQoJICogQ29udmVydHMgdGhlIGdpdmVuIEhUTUwgZWxlbWVudCBpbnRvIGEgc3RyaW5nIG9mIHRleHQNCgkgKiB0aGF0IGNhbiBiZSBhbm5vdW5jZWQgdG8gYSBzY3JlZW4gcmVhZGVyLiBIaWRkZW4NCgkgKiBlbGVtZW50cyBhcmUgZXhjbHVkZWQuDQoJICovDQoJZnVuY3Rpb24gZ2V0U3RhdHVzVGV4dCggbm9kZSApIHsNCg0KCQl2YXIgdGV4dCA9ICcnOw0KDQoJCS8vIFRleHQgbm9kZQ0KCQlpZiggbm9kZS5ub2RlVHlwZSA9PT0gMyApIHsNCgkJCXRleHQgKz0gbm9kZS50ZXh0Q29udGVudDsNCgkJfQ0KCQkvLyBFbGVtZW50IG5vZGUNCgkJZWxzZSBpZiggbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsNCg0KCQkJdmFyIGlzQXJpYUhpZGRlbiA9IG5vZGUuZ2V0QXR0cmlidXRlKCAnYXJpYS1oaWRkZW4nICk7DQoJCQl2YXIgaXNEaXNwbGF5SGlkZGVuID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIG5vZGUgKVsnZGlzcGxheSddID09PSAnbm9uZSc7DQoJCQlpZiggaXNBcmlhSGlkZGVuICE9PSAndHJ1ZScgJiYgIWlzRGlzcGxheUhpZGRlbiApIHsNCg0KCQkJCXRvQXJyYXkoIG5vZGUuY2hpbGROb2RlcyApLmZvckVhY2goIGZ1bmN0aW9uKCBjaGlsZCApIHsNCgkJCQkJdGV4dCArPSBnZXRTdGF0dXNUZXh0KCBjaGlsZCApOw0KCQkJCX0gKTsNCg0KCQkJfQ0KDQoJCX0NCg0KCQlyZXR1cm4gdGV4dDsNCg0KCX0NCg0KCS8qKg0KCSAqIENvbmZpZ3VyZXMgdGhlIHByZXNlbnRhdGlvbiBmb3IgcHJpbnRpbmcgdG8gYSBzdGF0aWMNCgkgKiBQREYuDQoJICovDQoJZnVuY3Rpb24gc2V0dXBQREYoKSB7DQoNCgkJdmFyIHNsaWRlU2l6ZSA9IGdldENvbXB1dGVkU2xpZGVTaXplKCB3aW5kb3cuaW5uZXJXaWR0aCwgd2luZG93LmlubmVySGVpZ2h0ICk7DQoNCgkJLy8gRGltZW5zaW9ucyBvZiB0aGUgUERGIHBhZ2VzDQoJCXZhciBwYWdlV2lkdGggPSBNYXRoLmZsb29yKCBzbGlkZVNpemUud2lkdGggKiAoIDEgKyBjb25maWcubWFyZ2luICkgKSwNCgkJCXBhZ2VIZWlnaHQgPSBNYXRoLmZsb29yKCBzbGlkZVNpemUuaGVpZ2h0ICogKCAxICsgY29uZmlnLm1hcmdpbiAgKSApOw0KDQoJCS8vIERpbWVuc2lvbnMgb2Ygc2xpZGVzIHdpdGhpbiB0aGUgcGFnZXMNCgkJdmFyIHNsaWRlV2lkdGggPSBzbGlkZVNpemUud2lkdGgsDQoJCQlzbGlkZUhlaWdodCA9IHNsaWRlU2l6ZS5oZWlnaHQ7DQoNCgkJLy8gTGV0IHRoZSBicm93c2VyIGtub3cgd2hhdCBwYWdlIHNpemUgd2Ugd2FudCB0byBwcmludA0KCQlpbmplY3RTdHlsZVNoZWV0KCAnQHBhZ2V7c2l6ZTonKyBwYWdlV2lkdGggKydweCAnKyBwYWdlSGVpZ2h0ICsncHg7IG1hcmdpbjogMDt9JyApOw0KDQoJCS8vIExpbWl0IHRoZSBzaXplIG9mIGNlcnRhaW4gZWxlbWVudHMgdG8gdGhlIGRpbWVuc2lvbnMgb2YgdGhlIHNsaWRlDQoJCWluamVjdFN0eWxlU2hlZXQoICcucmV2ZWFsIHNlY3Rpb24+aW1nLCAucmV2ZWFsIHNlY3Rpb24+dmlkZW8sIC5yZXZlYWwgc2VjdGlvbj5pZnJhbWV7bWF4LXdpZHRoOiAnKyBzbGlkZVdpZHRoICsncHg7IG1heC1oZWlnaHQ6Jysgc2xpZGVIZWlnaHQgKydweH0nICk7DQoNCgkJZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCAncHJpbnQtcGRmJyApOw0KCQlkb2N1bWVudC5ib2R5LnN0eWxlLndpZHRoID0gcGFnZVdpZHRoICsgJ3B4JzsNCgkJZG9jdW1lbnQuYm9keS5zdHlsZS5oZWlnaHQgPSBwYWdlSGVpZ2h0ICsgJ3B4JzsNCg0KCQkvLyBBZGQgZWFjaCBzbGlkZSdzIGluZGV4IGFzIGF0dHJpYnV0ZXMgb24gaXRzZWxmLCB3ZSBuZWVkIHRoZXNlDQoJCS8vIGluZGljZXMgdG8gZ2VuZXJhdGUgc2xpZGUgbnVtYmVycyBiZWxvdw0KCQl0b0FycmF5KCBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBIT1JJWk9OVEFMX1NMSURFU19TRUxFQ1RPUiApICkuZm9yRWFjaCggZnVuY3Rpb24oIGhzbGlkZSwgaCApIHsNCgkJCWhzbGlkZS5zZXRBdHRyaWJ1dGUoICdkYXRhLWluZGV4LWgnLCBoICk7DQoNCgkJCWlmKCBoc2xpZGUuY2xhc3NMaXN0LmNvbnRhaW5zKCAnc3RhY2snICkgKSB7DQoJCQkJdG9BcnJheSggaHNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICdzZWN0aW9uJyApICkuZm9yRWFjaCggZnVuY3Rpb24oIHZzbGlkZSwgdiApIHsNCgkJCQkJdnNsaWRlLnNldEF0dHJpYnV0ZSggJ2RhdGEtaW5kZXgtaCcsIGggKTsNCgkJCQkJdnNsaWRlLnNldEF0dHJpYnV0ZSggJ2RhdGEtaW5kZXgtdicsIHYgKTsNCgkJCQl9ICk7DQoJCQl9DQoJCX0gKTsNCg0KCQkvLyBTbGlkZSBhbmQgc2xpZGUgYmFja2dyb3VuZCBsYXlvdXQNCgkJdG9BcnJheSggZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggU0xJREVTX1NFTEVDVE9SICkgKS5mb3JFYWNoKCBmdW5jdGlvbiggc2xpZGUgKSB7DQoNCgkJCS8vIFZlcnRpY2FsIHN0YWNrcyBhcmUgbm90IGNlbnRyZWQgc2luY2UgdGhlaXIgc2VjdGlvbg0KCQkJLy8gY2hpbGRyZW4gd2lsbCBiZQ0KCQkJaWYoIHNsaWRlLmNsYXNzTGlzdC5jb250YWlucyggJ3N0YWNrJyApID09PSBmYWxzZSApIHsNCgkJCQkvLyBDZW50ZXIgdGhlIHNsaWRlIGluc2lkZSBvZiB0aGUgcGFnZSwgZ2l2aW5nIHRoZSBzbGlkZSBzb21lIG1hcmdpbg0KCQkJCXZhciBsZWZ0ID0gKCBwYWdlV2lkdGggLSBzbGlkZVdpZHRoICkgLyAyLA0KCQkJCQl0b3AgPSAoIHBhZ2VIZWlnaHQgLSBzbGlkZUhlaWdodCApIC8gMjsNCg0KCQkJCXZhciBjb250ZW50SGVpZ2h0ID0gc2xpZGUuc2Nyb2xsSGVpZ2h0Ow0KCQkJCXZhciBudW1iZXJPZlBhZ2VzID0gTWF0aC5tYXgoIE1hdGguY2VpbCggY29udGVudEhlaWdodCAvIHBhZ2VIZWlnaHQgKSwgMSApOw0KDQoJCQkJLy8gQWRoZXJlIHRvIGNvbmZpZ3VyZWQgcGFnZXMgcGVyIHNsaWRlIGxpbWl0DQoJCQkJbnVtYmVyT2ZQYWdlcyA9IE1hdGgubWluKCBudW1iZXJPZlBhZ2VzLCBjb25maWcucGRmTWF4UGFnZXNQZXJTbGlkZSApOw0KDQoJCQkJLy8gQ2VudGVyIHNsaWRlcyB2ZXJ0aWNhbGx5DQoJCQkJaWYoIG51bWJlck9mUGFnZXMgPT09IDEgJiYgY29uZmlnLmNlbnRlciB8fCBzbGlkZS5jbGFzc0xpc3QuY29udGFpbnMoICdjZW50ZXInICkgKSB7DQoJCQkJCXRvcCA9IE1hdGgubWF4KCAoIHBhZ2VIZWlnaHQgLSBjb250ZW50SGVpZ2h0ICkgLyAyLCAwICk7DQoJCQkJfQ0KDQoJCQkJLy8gV3JhcCB0aGUgc2xpZGUgaW4gYSBwYWdlIGVsZW1lbnQgYW5kIGhpZGUgaXRzIG92ZXJmbG93DQoJCQkJLy8gc28gdGhhdCBubyBwYWdlIGV2ZXIgZmxvd3Mgb250byBhbm90aGVyDQoJCQkJdmFyIHBhZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApOw0KCQkJCXBhZ2UuY2xhc3NOYW1lID0gJ3BkZi1wYWdlJzsNCgkJCQlwYWdlLnN0eWxlLmhlaWdodCA9ICggcGFnZUhlaWdodCAqIG51bWJlck9mUGFnZXMgKSArICdweCc7DQoJCQkJc2xpZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIHBhZ2UsIHNsaWRlICk7DQoJCQkJcGFnZS5hcHBlbmRDaGlsZCggc2xpZGUgKTsNCg0KCQkJCS8vIFBvc2l0aW9uIHRoZSBzbGlkZSBpbnNpZGUgb2YgdGhlIHBhZ2UNCgkJCQlzbGlkZS5zdHlsZS5sZWZ0ID0gbGVmdCArICdweCc7DQoJCQkJc2xpZGUuc3R5bGUudG9wID0gdG9wICsgJ3B4JzsNCgkJCQlzbGlkZS5zdHlsZS53aWR0aCA9IHNsaWRlV2lkdGggKyAncHgnOw0KDQoJCQkJaWYoIHNsaWRlLnNsaWRlQmFja2dyb3VuZEVsZW1lbnQgKSB7DQoJCQkJCXBhZ2UuaW5zZXJ0QmVmb3JlKCBzbGlkZS5zbGlkZUJhY2tncm91bmRFbGVtZW50LCBzbGlkZSApOw0KCQkJCX0NCg0KCQkJCS8vIEluamVjdCBub3RlcyBpZiBgc2hvd05vdGVzYCBpcyBlbmFibGVkDQoJCQkJaWYoIGNvbmZpZy5zaG93Tm90ZXMgKSB7DQoNCgkJCQkJLy8gQXJlIHRoZXJlIG5vdGVzIGZvciB0aGlzIHNsaWRlPw0KCQkJCQl2YXIgbm90ZXMgPSBnZXRTbGlkZU5vdGVzKCBzbGlkZSApOw0KCQkJCQlpZiggbm90ZXMgKSB7DQoNCgkJCQkJCXZhciBub3Rlc1NwYWNpbmcgPSA4Ow0KCQkJCQkJdmFyIG5vdGVzTGF5b3V0ID0gdHlwZW9mIGNvbmZpZy5zaG93Tm90ZXMgPT09ICdzdHJpbmcnID8gY29uZmlnLnNob3dOb3RlcyA6ICdpbmxpbmUnOw0KCQkJCQkJdmFyIG5vdGVzRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICk7DQoJCQkJCQlub3Rlc0VsZW1lbnQuY2xhc3NMaXN0LmFkZCggJ3NwZWFrZXItbm90ZXMnICk7DQoJCQkJCQlub3Rlc0VsZW1lbnQuY2xhc3NMaXN0LmFkZCggJ3NwZWFrZXItbm90ZXMtcGRmJyApOw0KCQkJCQkJbm90ZXNFbGVtZW50LnNldEF0dHJpYnV0ZSggJ2RhdGEtbGF5b3V0Jywgbm90ZXNMYXlvdXQgKTsNCgkJCQkJCW5vdGVzRWxlbWVudC5pbm5lckhUTUwgPSBub3RlczsNCg0KCQkJCQkJaWYoIG5vdGVzTGF5b3V0ID09PSAnc2VwYXJhdGUtcGFnZScgKSB7DQoJCQkJCQkJcGFnZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggbm90ZXNFbGVtZW50LCBwYWdlLm5leHRTaWJsaW5nICk7DQoJCQkJCQl9DQoJCQkJCQllbHNlIHsNCgkJCQkJCQlub3Rlc0VsZW1lbnQuc3R5bGUubGVmdCA9IG5vdGVzU3BhY2luZyArICdweCc7DQoJCQkJCQkJbm90ZXNFbGVtZW50LnN0eWxlLmJvdHRvbSA9IG5vdGVzU3BhY2luZyArICdweCc7DQoJCQkJCQkJbm90ZXNFbGVtZW50LnN0eWxlLndpZHRoID0gKCBwYWdlV2lkdGggLSBub3Rlc1NwYWNpbmcqMiApICsgJ3B4JzsNCgkJCQkJCQlwYWdlLmFwcGVuZENoaWxkKCBub3Rlc0VsZW1lbnQgKTsNCgkJCQkJCX0NCg0KCQkJCQl9DQoNCgkJCQl9DQoNCgkJCQkvLyBJbmplY3Qgc2xpZGUgbnVtYmVycyBpZiBgc2xpZGVOdW1iZXJzYCBhcmUgZW5hYmxlZA0KCQkJCWlmKCBjb25maWcuc2xpZGVOdW1iZXIgKSB7DQoJCQkJCXZhciBzbGlkZU51bWJlckggPSBwYXJzZUludCggc2xpZGUuZ2V0QXR0cmlidXRlKCAnZGF0YS1pbmRleC1oJyApLCAxMCApICsgMSwNCgkJCQkJCXNsaWRlTnVtYmVyViA9IHBhcnNlSW50KCBzbGlkZS5nZXRBdHRyaWJ1dGUoICdkYXRhLWluZGV4LXYnICksIDEwICkgKyAxOw0KDQoJCQkJCXZhciBudW1iZXJFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2RpdicgKTsNCgkJCQkJbnVtYmVyRWxlbWVudC5jbGFzc0xpc3QuYWRkKCAnc2xpZGUtbnVtYmVyJyApOw0KCQkJCQludW1iZXJFbGVtZW50LmNsYXNzTGlzdC5hZGQoICdzbGlkZS1udW1iZXItcGRmJyApOw0KCQkJCQludW1iZXJFbGVtZW50LmlubmVySFRNTCA9IGZvcm1hdFNsaWRlTnVtYmVyKCBzbGlkZU51bWJlckgsICcuJywgc2xpZGVOdW1iZXJWICk7DQoJCQkJCXBhZ2UuYXBwZW5kQ2hpbGQoIG51bWJlckVsZW1lbnQgKTsNCgkJCQl9DQoJCQl9DQoNCgkJfSApOw0KDQoJCS8vIFNob3cgYWxsIGZyYWdtZW50cw0KCQl0b0FycmF5KCBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBTTElERVNfU0VMRUNUT1IgKyAnIC5mcmFnbWVudCcgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBmcmFnbWVudCApIHsNCgkJCWZyYWdtZW50LmNsYXNzTGlzdC5hZGQoICd2aXNpYmxlJyApOw0KCQl9ICk7DQoNCgkJLy8gTm90aWZ5IHN1YnNjcmliZXJzIHRoYXQgdGhlIFBERiBsYXlvdXQgaXMgZ29vZCB0byBnbw0KCQlkaXNwYXRjaEV2ZW50KCAncGRmLXJlYWR5JyApOw0KDQoJfQ0KDQoJLyoqDQoJICogVGhpcyBpcyBhbiB1bmZvcnR1bmF0ZSBuZWNlc3NpdHkuIFNvbWUgYWN0aW9ucyDigJMgc3VjaCBhcw0KCSAqIGFuIGlucHV0IGZpZWxkIGJlaW5nIGZvY3VzZWQgaW4gYW4gaWZyYW1lIG9yIHVzaW5nIHRoZQ0KCSAqIGtleWJvYXJkIHRvIGV4cGFuZCB0ZXh0IHNlbGVjdGlvbiBiZXlvbmQgdGhlIGJvdW5kcyBvZg0KCSAqIGEgc2xpZGUg4oCTIGNhbiB0cmlnZ2VyIG91ciBjb250ZW50IHRvIGJlIHB1c2hlZCBvdXQgb2Ygdmlldy4NCgkgKiBUaGlzIHNjcm9sbGluZyBjYW4gbm90IGJlIHByZXZlbnRlZCBieSBoaWRpbmcgb3ZlcmZsb3cgaW4NCgkgKiBDU1MgKHdlIGFscmVhZHkgZG8pIHNvIHdlIGhhdmUgdG8gcmVzb3J0IHRvIHJlcGVhdGVkbHkNCgkgKiBjaGVja2luZyBpZiB0aGUgc2xpZGVzIGhhdmUgYmVlbiBvZmZzZXQgOigNCgkgKi8NCglmdW5jdGlvbiBzZXR1cFNjcm9sbFByZXZlbnRpb24oKSB7DQoNCgkJc2V0SW50ZXJ2YWwoIGZ1bmN0aW9uKCkgew0KCQkJaWYoIGRvbS53cmFwcGVyLnNjcm9sbFRvcCAhPT0gMCB8fCBkb20ud3JhcHBlci5zY3JvbGxMZWZ0ICE9PSAwICkgew0KCQkJCWRvbS53cmFwcGVyLnNjcm9sbFRvcCA9IDA7DQoJCQkJZG9tLndyYXBwZXIuc2Nyb2xsTGVmdCA9IDA7DQoJCQl9DQoJCX0sIDEwMDAgKTsNCg0KCX0NCg0KCS8qKg0KCSAqIENyZWF0ZXMgYW4gSFRNTCBlbGVtZW50IGFuZCByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIGl0Lg0KCSAqIElmIHRoZSBlbGVtZW50IGFscmVhZHkgZXhpc3RzIHRoZSBleGlzdGluZyBpbnN0YW5jZSB3aWxsDQoJICogYmUgcmV0dXJuZWQuDQoJICoNCgkgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBjb250YWluZXINCgkgKiBAcGFyYW0ge3N0cmluZ30gdGFnbmFtZQ0KCSAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc25hbWUNCgkgKiBAcGFyYW0ge3N0cmluZ30gaW5uZXJIVE1MDQoJICoNCgkgKiBAcmV0dXJuIHtIVE1MRWxlbWVudH0NCgkgKi8NCglmdW5jdGlvbiBjcmVhdGVTaW5nbGV0b25Ob2RlKCBjb250YWluZXIsIHRhZ25hbWUsIGNsYXNzbmFtZSwgaW5uZXJIVE1MICkgew0KDQoJCS8vIEZpbmQgYWxsIG5vZGVzIG1hdGNoaW5nIHRoZSBkZXNjcmlwdGlvbg0KCQl2YXIgbm9kZXMgPSBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbCggJy4nICsgY2xhc3NuYW1lICk7DQoNCgkJLy8gQ2hlY2sgYWxsIG1hdGNoZXMgdG8gZmluZCBvbmUgd2hpY2ggaXMgYSBkaXJlY3QgY2hpbGQgb2YNCgkJLy8gdGhlIHNwZWNpZmllZCBjb250YWluZXINCgkJZm9yKCB2YXIgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKyApIHsNCgkJCXZhciB0ZXN0Tm9kZSA9IG5vZGVzW2ldOw0KCQkJaWYoIHRlc3ROb2RlLnBhcmVudE5vZGUgPT09IGNvbnRhaW5lciApIHsNCgkJCQlyZXR1cm4gdGVzdE5vZGU7DQoJCQl9DQoJCX0NCg0KCQkvLyBJZiBubyBub2RlIHdhcyBmb3VuZCwgY3JlYXRlIGl0IG5vdw0KCQl2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIHRhZ25hbWUgKTsNCgkJbm9kZS5jbGFzc0xpc3QuYWRkKCBjbGFzc25hbWUgKTsNCgkJaWYoIHR5cGVvZiBpbm5lckhUTUwgPT09ICdzdHJpbmcnICkgew0KCQkJbm9kZS5pbm5lckhUTUwgPSBpbm5lckhUTUw7DQoJCX0NCgkJY29udGFpbmVyLmFwcGVuZENoaWxkKCBub2RlICk7DQoNCgkJcmV0dXJuIG5vZGU7DQoNCgl9DQoNCgkvKioNCgkgKiBDcmVhdGVzIHRoZSBzbGlkZSBiYWNrZ3JvdW5kIGVsZW1lbnRzIGFuZCBhcHBlbmRzIHRoZW0NCgkgKiB0byB0aGUgYmFja2dyb3VuZCBjb250YWluZXIuIE9uZSBlbGVtZW50IGlzIGNyZWF0ZWQgcGVyDQoJICogc2xpZGUgbm8gbWF0dGVyIGlmIHRoZSBnaXZlbiBzbGlkZSBoYXMgdmlzaWJsZSBiYWNrZ3JvdW5kLg0KCSAqLw0KCWZ1bmN0aW9uIGNyZWF0ZUJhY2tncm91bmRzKCkgew0KDQoJCXZhciBwcmludE1vZGUgPSBpc1ByaW50aW5nUERGKCk7DQoNCgkJLy8gQ2xlYXIgcHJpb3IgYmFja2dyb3VuZHMNCgkJZG9tLmJhY2tncm91bmQuaW5uZXJIVE1MID0gJyc7DQoJCWRvbS5iYWNrZ3JvdW5kLmNsYXNzTGlzdC5hZGQoICduby10cmFuc2l0aW9uJyApOw0KDQoJCS8vIEl0ZXJhdGUgb3ZlciBhbGwgaG9yaXpvbnRhbCBzbGlkZXMNCgkJdG9BcnJheSggZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggSE9SSVpPTlRBTF9TTElERVNfU0VMRUNUT1IgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBzbGlkZWggKSB7DQoNCgkJCXZhciBiYWNrZ3JvdW5kU3RhY2sgPSBjcmVhdGVCYWNrZ3JvdW5kKCBzbGlkZWgsIGRvbS5iYWNrZ3JvdW5kICk7DQoNCgkJCS8vIEl0ZXJhdGUgb3ZlciBhbGwgdmVydGljYWwgc2xpZGVzDQoJCQl0b0FycmF5KCBzbGlkZWgucXVlcnlTZWxlY3RvckFsbCggJ3NlY3Rpb24nICkgKS5mb3JFYWNoKCBmdW5jdGlvbiggc2xpZGV2ICkgew0KDQoJCQkJY3JlYXRlQmFja2dyb3VuZCggc2xpZGV2LCBiYWNrZ3JvdW5kU3RhY2sgKTsNCg0KCQkJCWJhY2tncm91bmRTdGFjay5jbGFzc0xpc3QuYWRkKCAnc3RhY2snICk7DQoNCgkJCX0gKTsNCg0KCQl9ICk7DQoNCgkJLy8gQWRkIHBhcmFsbGF4IGJhY2tncm91bmQgaWYgc3BlY2lmaWVkDQoJCWlmKCBjb25maWcucGFyYWxsYXhCYWNrZ3JvdW5kSW1hZ2UgKSB7DQoNCgkJCWRvbS5iYWNrZ3JvdW5kLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9ICd1cmwoIicgKyBjb25maWcucGFyYWxsYXhCYWNrZ3JvdW5kSW1hZ2UgKyAnIiknOw0KCQkJZG9tLmJhY2tncm91bmQuc3R5bGUuYmFja2dyb3VuZFNpemUgPSBjb25maWcucGFyYWxsYXhCYWNrZ3JvdW5kU2l6ZTsNCg0KCQkJLy8gTWFrZSBzdXJlIHRoZSBiZWxvdyBwcm9wZXJ0aWVzIGFyZSBzZXQgb24gdGhlIGVsZW1lbnQgLSB0aGVzZSBwcm9wZXJ0aWVzIGFyZQ0KCQkJLy8gbmVlZGVkIGZvciBwcm9wZXIgdHJhbnNpdGlvbnMgdG8gYmUgc2V0IG9uIHRoZSBlbGVtZW50IHZpYSBDU1MuIFRvIHJlbW92ZQ0KCQkJLy8gYW5ub3lpbmcgYmFja2dyb3VuZCBzbGlkZS1pbiBlZmZlY3Qgd2hlbiB0aGUgcHJlc2VudGF0aW9uIHN0YXJ0cywgYXBwbHkNCgkJCS8vIHRoZXNlIHByb3BlcnRpZXMgYWZ0ZXIgc2hvcnQgdGltZSBkZWxheQ0KCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7DQoJCQkJZG9tLndyYXBwZXIuY2xhc3NMaXN0LmFkZCggJ2hhcy1wYXJhbGxheC1iYWNrZ3JvdW5kJyApOw0KCQkJfSwgMSApOw0KDQoJCX0NCgkJZWxzZSB7DQoNCgkJCWRvbS5iYWNrZ3JvdW5kLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9ICcnOw0KCQkJZG9tLndyYXBwZXIuY2xhc3NMaXN0LnJlbW92ZSggJ2hhcy1wYXJhbGxheC1iYWNrZ3JvdW5kJyApOw0KDQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIENyZWF0ZXMgYSBiYWNrZ3JvdW5kIGZvciB0aGUgZ2l2ZW4gc2xpZGUuDQoJICoNCgkgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBzbGlkZQ0KCSAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGNvbnRhaW5lciBUaGUgZWxlbWVudCB0aGF0IHRoZSBiYWNrZ3JvdW5kDQoJICogc2hvdWxkIGJlIGFwcGVuZGVkIHRvDQoJICogQHJldHVybiB7SFRNTEVsZW1lbnR9IE5ldyBiYWNrZ3JvdW5kIGRpdg0KCSAqLw0KCWZ1bmN0aW9uIGNyZWF0ZUJhY2tncm91bmQoIHNsaWRlLCBjb250YWluZXIgKSB7DQoNCgkJdmFyIGRhdGEgPSB7DQoJCQliYWNrZ3JvdW5kOiBzbGlkZS5nZXRBdHRyaWJ1dGUoICdkYXRhLWJhY2tncm91bmQnICksDQoJCQliYWNrZ3JvdW5kU2l6ZTogc2xpZGUuZ2V0QXR0cmlidXRlKCAnZGF0YS1iYWNrZ3JvdW5kLXNpemUnICksDQoJCQliYWNrZ3JvdW5kSW1hZ2U6IHNsaWRlLmdldEF0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC1pbWFnZScgKSwNCgkJCWJhY2tncm91bmRWaWRlbzogc2xpZGUuZ2V0QXR0cmlidXRlKCAnZGF0YS1iYWNrZ3JvdW5kLXZpZGVvJyApLA0KCQkJYmFja2dyb3VuZElmcmFtZTogc2xpZGUuZ2V0QXR0cmlidXRlKCAnZGF0YS1iYWNrZ3JvdW5kLWlmcmFtZScgKSwNCgkJCWJhY2tncm91bmRDb2xvcjogc2xpZGUuZ2V0QXR0cmlidXRlKCAnZGF0YS1iYWNrZ3JvdW5kLWNvbG9yJyApLA0KCQkJYmFja2dyb3VuZFJlcGVhdDogc2xpZGUuZ2V0QXR0cmlidXRlKCAnZGF0YS1iYWNrZ3JvdW5kLXJlcGVhdCcgKSwNCgkJCWJhY2tncm91bmRQb3NpdGlvbjogc2xpZGUuZ2V0QXR0cmlidXRlKCAnZGF0YS1iYWNrZ3JvdW5kLXBvc2l0aW9uJyApLA0KCQkJYmFja2dyb3VuZFRyYW5zaXRpb246IHNsaWRlLmdldEF0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC10cmFuc2l0aW9uJyApDQoJCX07DQoNCgkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApOw0KDQoJCS8vIENhcnJ5IG92ZXIgY3VzdG9tIGNsYXNzZXMgZnJvbSB0aGUgc2xpZGUgdG8gdGhlIGJhY2tncm91bmQNCgkJZWxlbWVudC5jbGFzc05hbWUgPSAnc2xpZGUtYmFja2dyb3VuZCAnICsgc2xpZGUuY2xhc3NOYW1lLnJlcGxhY2UoIC9wcmVzZW50fHBhc3R8ZnV0dXJlLywgJycgKTsNCg0KCQlpZiggZGF0YS5iYWNrZ3JvdW5kICkgew0KCQkJLy8gQXV0by13cmFwIGltYWdlIHVybHMgaW4gdXJsKC4uLikNCgkJCWlmKCAvXihodHRwfGZpbGV8XC9cLykvZ2kudGVzdCggZGF0YS5iYWNrZ3JvdW5kICkgfHwgL1wuKHN2Z3xwbmd8anBnfGpwZWd8Z2lmfGJtcCkkL2dpLnRlc3QoIGRhdGEuYmFja2dyb3VuZCApICkgew0KCQkJCXNsaWRlLnNldEF0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC1pbWFnZScsIGRhdGEuYmFja2dyb3VuZCApOw0KCQkJfQ0KCQkJZWxzZSB7DQoJCQkJZWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kID0gZGF0YS5iYWNrZ3JvdW5kOw0KCQkJfQ0KCQl9DQoNCgkJLy8gQ3JlYXRlIGEgaGFzaCBmb3IgdGhpcyBjb21iaW5hdGlvbiBvZiBiYWNrZ3JvdW5kIHNldHRpbmdzLg0KCQkvLyBUaGlzIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIHdoZW4gdHdvIHNsaWRlIGJhY2tncm91bmRzIGFyZQ0KCQkvLyB0aGUgc2FtZS4NCgkJaWYoIGRhdGEuYmFja2dyb3VuZCB8fCBkYXRhLmJhY2tncm91bmRDb2xvciB8fCBkYXRhLmJhY2tncm91bmRJbWFnZSB8fCBkYXRhLmJhY2tncm91bmRWaWRlbyB8fCBkYXRhLmJhY2tncm91bmRJZnJhbWUgKSB7DQoJCQllbGVtZW50LnNldEF0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC1oYXNoJywgZGF0YS5iYWNrZ3JvdW5kICsNCgkJCQkJCQkJCQkJCQkJCWRhdGEuYmFja2dyb3VuZFNpemUgKw0KCQkJCQkJCQkJCQkJCQkJZGF0YS5iYWNrZ3JvdW5kSW1hZ2UgKw0KCQkJCQkJCQkJCQkJCQkJZGF0YS5iYWNrZ3JvdW5kVmlkZW8gKw0KCQkJCQkJCQkJCQkJCQkJZGF0YS5iYWNrZ3JvdW5kSWZyYW1lICsNCgkJCQkJCQkJCQkJCQkJCWRhdGEuYmFja2dyb3VuZENvbG9yICsNCgkJCQkJCQkJCQkJCQkJCWRhdGEuYmFja2dyb3VuZFJlcGVhdCArDQoJCQkJCQkJCQkJCQkJCQlkYXRhLmJhY2tncm91bmRQb3NpdGlvbiArDQoJCQkJCQkJCQkJCQkJCQlkYXRhLmJhY2tncm91bmRUcmFuc2l0aW9uICk7DQoJCX0NCg0KCQkvLyBBZGRpdGlvbmFsIGFuZCBvcHRpb25hbCBiYWNrZ3JvdW5kIHByb3BlcnRpZXMNCgkJaWYoIGRhdGEuYmFja2dyb3VuZFNpemUgKSBlbGVtZW50LnN0eWxlLmJhY2tncm91bmRTaXplID0gZGF0YS5iYWNrZ3JvdW5kU2l6ZTsNCgkJaWYoIGRhdGEuYmFja2dyb3VuZENvbG9yICkgZWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBkYXRhLmJhY2tncm91bmRDb2xvcjsNCgkJaWYoIGRhdGEuYmFja2dyb3VuZFJlcGVhdCApIGVsZW1lbnQuc3R5bGUuYmFja2dyb3VuZFJlcGVhdCA9IGRhdGEuYmFja2dyb3VuZFJlcGVhdDsNCgkJaWYoIGRhdGEuYmFja2dyb3VuZFBvc2l0aW9uICkgZWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kUG9zaXRpb24gPSBkYXRhLmJhY2tncm91bmRQb3NpdGlvbjsNCgkJaWYoIGRhdGEuYmFja2dyb3VuZFRyYW5zaXRpb24gKSBlbGVtZW50LnNldEF0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC10cmFuc2l0aW9uJywgZGF0YS5iYWNrZ3JvdW5kVHJhbnNpdGlvbiApOw0KDQoJCWNvbnRhaW5lci5hcHBlbmRDaGlsZCggZWxlbWVudCApOw0KDQoJCS8vIElmIGJhY2tncm91bmRzIGFyZSBiZWluZyByZWNyZWF0ZWQsIGNsZWFyIG9sZCBjbGFzc2VzDQoJCXNsaWRlLmNsYXNzTGlzdC5yZW1vdmUoICdoYXMtZGFyay1iYWNrZ3JvdW5kJyApOw0KCQlzbGlkZS5jbGFzc0xpc3QucmVtb3ZlKCAnaGFzLWxpZ2h0LWJhY2tncm91bmQnICk7DQoNCgkJc2xpZGUuc2xpZGVCYWNrZ3JvdW5kRWxlbWVudCA9IGVsZW1lbnQ7DQoNCgkJLy8gSWYgdGhpcyBzbGlkZSBoYXMgYSBiYWNrZ3JvdW5kIGNvbG9yLCBhZGQgYSBjbGFzcyB0aGF0DQoJCS8vIHNpZ25hbHMgaWYgaXQgaXMgbGlnaHQgb3IgZGFyay4gSWYgdGhlIHNsaWRlIGhhcyBubyBiYWNrZ3JvdW5kDQoJCS8vIGNvbG9yLCBubyBjbGFzcyB3aWxsIGJlIHNldA0KCQl2YXIgY29tcHV0ZWRCYWNrZ3JvdW5kU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbWVudCApOw0KCQlpZiggY29tcHV0ZWRCYWNrZ3JvdW5kU3R5bGUgJiYgY29tcHV0ZWRCYWNrZ3JvdW5kU3R5bGUuYmFja2dyb3VuZENvbG9yICkgew0KCQkJdmFyIHJnYiA9IGNvbG9yVG9SZ2IoIGNvbXB1dGVkQmFja2dyb3VuZFN0eWxlLmJhY2tncm91bmRDb2xvciApOw0KDQoJCQkvLyBJZ25vcmUgZnVsbHkgdHJhbnNwYXJlbnQgYmFja2dyb3VuZHMuIFNvbWUgYnJvd3NlcnMgcmV0dXJuDQoJCQkvLyByZ2JhKDAsMCwwLDApIHdoZW4gcmVhZGluZyB0aGUgY29tcHV0ZWQgYmFja2dyb3VuZCBjb2xvciBvZg0KCQkJLy8gYW4gZWxlbWVudCB3aXRoIG5vIGJhY2tncm91bmQNCgkJCWlmKCByZ2IgJiYgcmdiLmEgIT09IDAgKSB7DQoJCQkJaWYoIGNvbG9yQnJpZ2h0bmVzcyggY29tcHV0ZWRCYWNrZ3JvdW5kU3R5bGUuYmFja2dyb3VuZENvbG9yICkgPCAxMjggKSB7DQoJCQkJCXNsaWRlLmNsYXNzTGlzdC5hZGQoICdoYXMtZGFyay1iYWNrZ3JvdW5kJyApOw0KCQkJCX0NCgkJCQllbHNlIHsNCgkJCQkJc2xpZGUuY2xhc3NMaXN0LmFkZCggJ2hhcy1saWdodC1iYWNrZ3JvdW5kJyApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCXJldHVybiBlbGVtZW50Ow0KDQoJfQ0KDQoJLyoqDQoJICogUmVnaXN0ZXJzIGEgbGlzdGVuZXIgdG8gcG9zdE1lc3NhZ2UgZXZlbnRzLCB0aGlzIG1ha2VzIGl0DQoJICogcG9zc2libGUgdG8gY2FsbCBhbGwgcmV2ZWFsLmpzIEFQSSBtZXRob2RzIGZyb20gYW5vdGhlcg0KCSAqIHdpbmRvdy4gRm9yIGV4YW1wbGU6DQoJICoNCgkgKiByZXZlYWxXaW5kb3cucG9zdE1lc3NhZ2UoIEpTT04uc3RyaW5naWZ5KHsNCgkgKiAgIG1ldGhvZDogJ3NsaWRlJywNCgkgKiAgIGFyZ3M6IFsgMiBdDQoJICogfSksICcqJyApOw0KCSAqLw0KCWZ1bmN0aW9uIHNldHVwUG9zdE1lc3NhZ2UoKSB7DQoNCgkJaWYoIGNvbmZpZy5wb3N0TWVzc2FnZSApIHsNCgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAnbWVzc2FnZScsIGZ1bmN0aW9uICggZXZlbnQgKSB7DQoJCQkJdmFyIGRhdGEgPSBldmVudC5kYXRhOw0KDQoJCQkJLy8gTWFrZSBzdXJlIHdlJ3JlIGRlYWxpbmcgd2l0aCBKU09ODQoJCQkJaWYoIHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJyAmJiBkYXRhLmNoYXJBdCggMCApID09PSAneycgJiYgZGF0YS5jaGFyQXQoIGRhdGEubGVuZ3RoIC0gMSApID09PSAnfScgKSB7DQoJCQkJCWRhdGEgPSBKU09OLnBhcnNlKCBkYXRhICk7DQoNCgkJCQkJLy8gQ2hlY2sgaWYgdGhlIHJlcXVlc3RlZCBtZXRob2QgY2FuIGJlIGZvdW5kDQoJCQkJCWlmKCBkYXRhLm1ldGhvZCAmJiB0eXBlb2YgUmV2ZWFsW2RhdGEubWV0aG9kXSA9PT0gJ2Z1bmN0aW9uJyApIHsNCgkJCQkJCVJldmVhbFtkYXRhLm1ldGhvZF0uYXBwbHkoIFJldmVhbCwgZGF0YS5hcmdzICk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9LCBmYWxzZSApOw0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBBcHBsaWVzIHRoZSBjb25maWd1cmF0aW9uIHNldHRpbmdzIGZyb20gdGhlIGNvbmZpZw0KCSAqIG9iamVjdC4gTWF5IGJlIGNhbGxlZCBtdWx0aXBsZSB0aW1lcy4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zDQoJICovDQoJZnVuY3Rpb24gY29uZmlndXJlKCBvcHRpb25zICkgew0KDQoJCXZhciBudW1iZXJPZlNsaWRlcyA9IGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIFNMSURFU19TRUxFQ1RPUiApLmxlbmd0aDsNCg0KCQlkb20ud3JhcHBlci5jbGFzc0xpc3QucmVtb3ZlKCBjb25maWcudHJhbnNpdGlvbiApOw0KDQoJCS8vIE5ldyBjb25maWcgb3B0aW9ucyBtYXkgYmUgcGFzc2VkIHdoZW4gdGhpcyBtZXRob2QNCgkJLy8gaXMgaW52b2tlZCB0aHJvdWdoIHRoZSBBUEkgYWZ0ZXIgaW5pdGlhbGl6YXRpb24NCgkJaWYoIHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JyApIGV4dGVuZCggY29uZmlnLCBvcHRpb25zICk7DQoNCgkJLy8gRm9yY2UgbGluZWFyIHRyYW5zaXRpb24gYmFzZWQgb24gYnJvd3NlciBjYXBhYmlsaXRpZXMNCgkJaWYoIGZlYXR1cmVzLnRyYW5zZm9ybXMzZCA9PT0gZmFsc2UgKSBjb25maWcudHJhbnNpdGlvbiA9ICdsaW5lYXInOw0KDQoJCWRvbS53cmFwcGVyLmNsYXNzTGlzdC5hZGQoIGNvbmZpZy50cmFuc2l0aW9uICk7DQoNCgkJZG9tLndyYXBwZXIuc2V0QXR0cmlidXRlKCAnZGF0YS10cmFuc2l0aW9uLXNwZWVkJywgY29uZmlnLnRyYW5zaXRpb25TcGVlZCApOw0KCQlkb20ud3JhcHBlci5zZXRBdHRyaWJ1dGUoICdkYXRhLWJhY2tncm91bmQtdHJhbnNpdGlvbicsIGNvbmZpZy5iYWNrZ3JvdW5kVHJhbnNpdGlvbiApOw0KDQoJCWRvbS5jb250cm9scy5zdHlsZS5kaXNwbGF5ID0gY29uZmlnLmNvbnRyb2xzID8gJ2Jsb2NrJyA6ICdub25lJzsNCgkJZG9tLnByb2dyZXNzLnN0eWxlLmRpc3BsYXkgPSBjb25maWcucHJvZ3Jlc3MgPyAnYmxvY2snIDogJ25vbmUnOw0KCQlkb20uc2xpZGVOdW1iZXIuc3R5bGUuZGlzcGxheSA9IGNvbmZpZy5zbGlkZU51bWJlciAmJiAhaXNQcmludGluZ1BERigpID8gJ2Jsb2NrJyA6ICdub25lJzsNCg0KCQlpZiggY29uZmlnLnNodWZmbGUgKSB7DQoJCQlzaHVmZmxlKCk7DQoJCX0NCg0KCQlpZiggY29uZmlnLnJ0bCApIHsNCgkJCWRvbS53cmFwcGVyLmNsYXNzTGlzdC5hZGQoICdydGwnICk7DQoJCX0NCgkJZWxzZSB7DQoJCQlkb20ud3JhcHBlci5jbGFzc0xpc3QucmVtb3ZlKCAncnRsJyApOw0KCQl9DQoNCgkJaWYoIGNvbmZpZy5jZW50ZXIgKSB7DQoJCQlkb20ud3JhcHBlci5jbGFzc0xpc3QuYWRkKCAnY2VudGVyJyApOw0KCQl9DQoJCWVsc2Ugew0KCQkJZG9tLndyYXBwZXIuY2xhc3NMaXN0LnJlbW92ZSggJ2NlbnRlcicgKTsNCgkJfQ0KDQoJCS8vIEV4aXQgdGhlIHBhdXNlZCBtb2RlIGlmIGl0IHdhcyBjb25maWd1cmVkIG9mZg0KCQlpZiggY29uZmlnLnBhdXNlID09PSBmYWxzZSApIHsNCgkJCXJlc3VtZSgpOw0KCQl9DQoNCgkJaWYoIGNvbmZpZy5zaG93Tm90ZXMgKSB7DQoJCQlkb20uc3BlYWtlck5vdGVzLmNsYXNzTGlzdC5hZGQoICd2aXNpYmxlJyApOw0KCQkJZG9tLnNwZWFrZXJOb3Rlcy5zZXRBdHRyaWJ1dGUoICdkYXRhLWxheW91dCcsIHR5cGVvZiBjb25maWcuc2hvd05vdGVzID09PSAnc3RyaW5nJyA/IGNvbmZpZy5zaG93Tm90ZXMgOiAnaW5saW5lJyApOw0KCQl9DQoJCWVsc2Ugew0KCQkJZG9tLnNwZWFrZXJOb3Rlcy5jbGFzc0xpc3QucmVtb3ZlKCAndmlzaWJsZScgKTsNCgkJfQ0KDQoJCWlmKCBjb25maWcubW91c2VXaGVlbCApIHsNCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdET01Nb3VzZVNjcm9sbCcsIG9uRG9jdW1lbnRNb3VzZVNjcm9sbCwgZmFsc2UgKTsgLy8gRkYNCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdtb3VzZXdoZWVsJywgb25Eb2N1bWVudE1vdXNlU2Nyb2xsLCBmYWxzZSApOw0KCQl9DQoJCWVsc2Ugew0KCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ0RPTU1vdXNlU2Nyb2xsJywgb25Eb2N1bWVudE1vdXNlU2Nyb2xsLCBmYWxzZSApOyAvLyBGRg0KCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ21vdXNld2hlZWwnLCBvbkRvY3VtZW50TW91c2VTY3JvbGwsIGZhbHNlICk7DQoJCX0NCg0KCQkvLyBSb2xsaW5nIDNEIGxpbmtzDQoJCWlmKCBjb25maWcucm9sbGluZ0xpbmtzICkgew0KCQkJZW5hYmxlUm9sbGluZ0xpbmtzKCk7DQoJCX0NCgkJZWxzZSB7DQoJCQlkaXNhYmxlUm9sbGluZ0xpbmtzKCk7DQoJCX0NCg0KCQkvLyBJZnJhbWUgbGluayBwcmV2aWV3cw0KCQlpZiggY29uZmlnLnByZXZpZXdMaW5rcyApIHsNCgkJCWVuYWJsZVByZXZpZXdMaW5rcygpOw0KCQl9DQoJCWVsc2Ugew0KCQkJZGlzYWJsZVByZXZpZXdMaW5rcygpOw0KCQkJZW5hYmxlUHJldmlld0xpbmtzKCAnW2RhdGEtcHJldmlldy1saW5rXScgKTsNCgkJfQ0KDQoJCS8vIFJlbW92ZSBleGlzdGluZyBhdXRvLXNsaWRlIGNvbnRyb2xzDQoJCWlmKCBhdXRvU2xpZGVQbGF5ZXIgKSB7DQoJCQlhdXRvU2xpZGVQbGF5ZXIuZGVzdHJveSgpOw0KCQkJYXV0b1NsaWRlUGxheWVyID0gbnVsbDsNCgkJfQ0KDQoJCS8vIEdlbmVyYXRlIGF1dG8tc2xpZGUgY29udHJvbHMgaWYgbmVlZGVkDQoJCWlmKCBudW1iZXJPZlNsaWRlcyA+IDEgJiYgY29uZmlnLmF1dG9TbGlkZSAmJiBjb25maWcuYXV0b1NsaWRlU3RvcHBhYmxlICYmIGZlYXR1cmVzLmNhbnZhcyAmJiBmZWF0dXJlcy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgKSB7DQoJCQlhdXRvU2xpZGVQbGF5ZXIgPSBuZXcgUGxheWJhY2soIGRvbS53cmFwcGVyLCBmdW5jdGlvbigpIHsNCgkJCQlyZXR1cm4gTWF0aC5taW4oIE1hdGgubWF4KCAoIERhdGUubm93KCkgLSBhdXRvU2xpZGVTdGFydFRpbWUgKSAvIGF1dG9TbGlkZSwgMCApLCAxICk7DQoJCQl9ICk7DQoNCgkJCWF1dG9TbGlkZVBsYXllci5vbiggJ2NsaWNrJywgb25BdXRvU2xpZGVQbGF5ZXJDbGljayApOw0KCQkJYXV0b1NsaWRlUGF1c2VkID0gZmFsc2U7DQoJCX0NCg0KCQkvLyBXaGVuIGZyYWdtZW50cyBhcmUgdHVybmVkIG9mZiB0aGV5IHNob3VsZCBiZSB2aXNpYmxlDQoJCWlmKCBjb25maWcuZnJhZ21lbnRzID09PSBmYWxzZSApIHsNCgkJCXRvQXJyYXkoIGRvbS5zbGlkZXMucXVlcnlTZWxlY3RvckFsbCggJy5mcmFnbWVudCcgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQkJCWVsZW1lbnQuY2xhc3NMaXN0LmFkZCggJ3Zpc2libGUnICk7DQoJCQkJZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCAnY3VycmVudC1mcmFnbWVudCcgKTsNCgkJCX0gKTsNCgkJfQ0KDQoJCXN5bmMoKTsNCg0KCX0NCg0KCS8qKg0KCSAqIEJpbmRzIGFsbCBldmVudCBsaXN0ZW5lcnMuDQoJICovDQoJZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcnMoKSB7DQoNCgkJZXZlbnRzQXJlQm91bmQgPSB0cnVlOw0KDQoJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAnaGFzaGNoYW5nZScsIG9uV2luZG93SGFzaENoYW5nZSwgZmFsc2UgKTsNCgkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICdyZXNpemUnLCBvbldpbmRvd1Jlc2l6ZSwgZmFsc2UgKTsNCg0KCQlpZiggY29uZmlnLnRvdWNoICkgew0KCQkJZG9tLndyYXBwZXIuYWRkRXZlbnRMaXN0ZW5lciggJ3RvdWNoc3RhcnQnLCBvblRvdWNoU3RhcnQsIGZhbHNlICk7DQoJCQlkb20ud3JhcHBlci5hZGRFdmVudExpc3RlbmVyKCAndG91Y2htb3ZlJywgb25Ub3VjaE1vdmUsIGZhbHNlICk7DQoJCQlkb20ud3JhcHBlci5hZGRFdmVudExpc3RlbmVyKCAndG91Y2hlbmQnLCBvblRvdWNoRW5kLCBmYWxzZSApOw0KDQoJCQkvLyBTdXBwb3J0IHBvaW50ZXItc3R5bGUgdG91Y2ggaW50ZXJhY3Rpb24gYXMgd2VsbA0KCQkJaWYoIHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgKSB7DQoJCQkJLy8gSUUgMTEgdXNlcyB1bi1wcmVmaXhlZCB2ZXJzaW9uIG9mIHBvaW50ZXIgZXZlbnRzDQoJCQkJZG9tLndyYXBwZXIuYWRkRXZlbnRMaXN0ZW5lciggJ3BvaW50ZXJkb3duJywgb25Qb2ludGVyRG93biwgZmFsc2UgKTsNCgkJCQlkb20ud3JhcHBlci5hZGRFdmVudExpc3RlbmVyKCAncG9pbnRlcm1vdmUnLCBvblBvaW50ZXJNb3ZlLCBmYWxzZSApOw0KCQkJCWRvbS53cmFwcGVyLmFkZEV2ZW50TGlzdGVuZXIoICdwb2ludGVydXAnLCBvblBvaW50ZXJVcCwgZmFsc2UgKTsNCgkJCX0NCgkJCWVsc2UgaWYoIHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCApIHsNCgkJCQkvLyBJRSAxMCB1c2VzIHByZWZpeGVkIHZlcnNpb24gb2YgcG9pbnRlciBldmVudHMNCgkJCQlkb20ud3JhcHBlci5hZGRFdmVudExpc3RlbmVyKCAnTVNQb2ludGVyRG93bicsIG9uUG9pbnRlckRvd24sIGZhbHNlICk7DQoJCQkJZG9tLndyYXBwZXIuYWRkRXZlbnRMaXN0ZW5lciggJ01TUG9pbnRlck1vdmUnLCBvblBvaW50ZXJNb3ZlLCBmYWxzZSApOw0KCQkJCWRvbS53cmFwcGVyLmFkZEV2ZW50TGlzdGVuZXIoICdNU1BvaW50ZXJVcCcsIG9uUG9pbnRlclVwLCBmYWxzZSApOw0KCQkJfQ0KCQl9DQoNCgkJaWYoIGNvbmZpZy5rZXlib2FyZCApIHsNCgkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdrZXlkb3duJywgb25Eb2N1bWVudEtleURvd24sIGZhbHNlICk7DQoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAna2V5cHJlc3MnLCBvbkRvY3VtZW50S2V5UHJlc3MsIGZhbHNlICk7DQoJCX0NCg0KCQlpZiggY29uZmlnLnByb2dyZXNzICYmIGRvbS5wcm9ncmVzcyApIHsNCgkJCWRvbS5wcm9ncmVzcy5hZGRFdmVudExpc3RlbmVyKCAnY2xpY2snLCBvblByb2dyZXNzQ2xpY2tlZCwgZmFsc2UgKTsNCgkJfQ0KDQoJCWlmKCBjb25maWcuZm9jdXNCb2R5T25QYWdlVmlzaWJpbGl0eUNoYW5nZSApIHsNCgkJCXZhciB2aXNpYmlsaXR5Q2hhbmdlOw0KDQoJCQlpZiggJ2hpZGRlbicgaW4gZG9jdW1lbnQgKSB7DQoJCQkJdmlzaWJpbGl0eUNoYW5nZSA9ICd2aXNpYmlsaXR5Y2hhbmdlJzsNCgkJCX0NCgkJCWVsc2UgaWYoICdtc0hpZGRlbicgaW4gZG9jdW1lbnQgKSB7DQoJCQkJdmlzaWJpbGl0eUNoYW5nZSA9ICdtc3Zpc2liaWxpdHljaGFuZ2UnOw0KCQkJfQ0KCQkJZWxzZSBpZiggJ3dlYmtpdEhpZGRlbicgaW4gZG9jdW1lbnQgKSB7DQoJCQkJdmlzaWJpbGl0eUNoYW5nZSA9ICd3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlJzsNCgkJCX0NCg0KCQkJaWYoIHZpc2liaWxpdHlDaGFuZ2UgKSB7DQoJCQkJZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciggdmlzaWJpbGl0eUNoYW5nZSwgb25QYWdlVmlzaWJpbGl0eUNoYW5nZSwgZmFsc2UgKTsNCgkJCX0NCgkJfQ0KDQoJCS8vIExpc3RlbiB0byBib3RoIHRvdWNoIGFuZCBjbGljayBldmVudHMsIGluIGNhc2UgdGhlIGRldmljZQ0KCQkvLyBzdXBwb3J0cyBib3RoDQoJCXZhciBwb2ludGVyRXZlbnRzID0gWyAndG91Y2hzdGFydCcsICdjbGljaycgXTsNCg0KCQkvLyBPbmx5IHN1cHBvcnQgdG91Y2ggZm9yIEFuZHJvaWQsIGZpeGVzIGRvdWJsZSBuYXZpZ2F0aW9ucyBpbg0KCQkvLyBzdG9jayBicm93c2VyDQoJCWlmKCBVQS5tYXRjaCggL2FuZHJvaWQvZ2kgKSApIHsNCgkJCXBvaW50ZXJFdmVudHMgPSBbICd0b3VjaHN0YXJ0JyBdOw0KCQl9DQoNCgkJcG9pbnRlckV2ZW50cy5mb3JFYWNoKCBmdW5jdGlvbiggZXZlbnROYW1lICkgew0KCQkJZG9tLmNvbnRyb2xzTGVmdC5mb3JFYWNoKCBmdW5jdGlvbiggZWwgKSB7IGVsLmFkZEV2ZW50TGlzdGVuZXIoIGV2ZW50TmFtZSwgb25OYXZpZ2F0ZUxlZnRDbGlja2VkLCBmYWxzZSApOyB9ICk7DQoJCQlkb20uY29udHJvbHNSaWdodC5mb3JFYWNoKCBmdW5jdGlvbiggZWwgKSB7IGVsLmFkZEV2ZW50TGlzdGVuZXIoIGV2ZW50TmFtZSwgb25OYXZpZ2F0ZVJpZ2h0Q2xpY2tlZCwgZmFsc2UgKTsgfSApOw0KCQkJZG9tLmNvbnRyb2xzVXAuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5hZGRFdmVudExpc3RlbmVyKCBldmVudE5hbWUsIG9uTmF2aWdhdGVVcENsaWNrZWQsIGZhbHNlICk7IH0gKTsNCgkJCWRvbS5jb250cm9sc0Rvd24uZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5hZGRFdmVudExpc3RlbmVyKCBldmVudE5hbWUsIG9uTmF2aWdhdGVEb3duQ2xpY2tlZCwgZmFsc2UgKTsgfSApOw0KCQkJZG9tLmNvbnRyb2xzUHJldi5mb3JFYWNoKCBmdW5jdGlvbiggZWwgKSB7IGVsLmFkZEV2ZW50TGlzdGVuZXIoIGV2ZW50TmFtZSwgb25OYXZpZ2F0ZVByZXZDbGlja2VkLCBmYWxzZSApOyB9ICk7DQoJCQlkb20uY29udHJvbHNOZXh0LmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsgZWwuYWRkRXZlbnRMaXN0ZW5lciggZXZlbnROYW1lLCBvbk5hdmlnYXRlTmV4dENsaWNrZWQsIGZhbHNlICk7IH0gKTsNCgkJfSApOw0KDQoJfQ0KDQoJLyoqDQoJICogVW5iaW5kcyBhbGwgZXZlbnQgbGlzdGVuZXJzLg0KCSAqLw0KCWZ1bmN0aW9uIHJlbW92ZUV2ZW50TGlzdGVuZXJzKCkgew0KDQoJCWV2ZW50c0FyZUJvdW5kID0gZmFsc2U7DQoNCgkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2tleWRvd24nLCBvbkRvY3VtZW50S2V5RG93biwgZmFsc2UgKTsNCgkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2tleXByZXNzJywgb25Eb2N1bWVudEtleVByZXNzLCBmYWxzZSApOw0KCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2hhc2hjaGFuZ2UnLCBvbldpbmRvd0hhc2hDaGFuZ2UsIGZhbHNlICk7DQoJCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCAncmVzaXplJywgb25XaW5kb3dSZXNpemUsIGZhbHNlICk7DQoNCgkJZG9tLndyYXBwZXIucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3RvdWNoc3RhcnQnLCBvblRvdWNoU3RhcnQsIGZhbHNlICk7DQoJCWRvbS53cmFwcGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoICd0b3VjaG1vdmUnLCBvblRvdWNoTW92ZSwgZmFsc2UgKTsNCgkJZG9tLndyYXBwZXIucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3RvdWNoZW5kJywgb25Ub3VjaEVuZCwgZmFsc2UgKTsNCg0KCQkvLyBJRTExDQoJCWlmKCB3aW5kb3cubmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkICkgew0KCQkJZG9tLndyYXBwZXIucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3BvaW50ZXJkb3duJywgb25Qb2ludGVyRG93biwgZmFsc2UgKTsNCgkJCWRvbS53cmFwcGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdwb2ludGVybW92ZScsIG9uUG9pbnRlck1vdmUsIGZhbHNlICk7DQoJCQlkb20ud3JhcHBlci5yZW1vdmVFdmVudExpc3RlbmVyKCAncG9pbnRlcnVwJywgb25Qb2ludGVyVXAsIGZhbHNlICk7DQoJCX0NCgkJLy8gSUUxMA0KCQllbHNlIGlmKCB3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQgKSB7DQoJCQlkb20ud3JhcHBlci5yZW1vdmVFdmVudExpc3RlbmVyKCAnTVNQb2ludGVyRG93bicsIG9uUG9pbnRlckRvd24sIGZhbHNlICk7DQoJCQlkb20ud3JhcHBlci5yZW1vdmVFdmVudExpc3RlbmVyKCAnTVNQb2ludGVyTW92ZScsIG9uUG9pbnRlck1vdmUsIGZhbHNlICk7DQoJCQlkb20ud3JhcHBlci5yZW1vdmVFdmVudExpc3RlbmVyKCAnTVNQb2ludGVyVXAnLCBvblBvaW50ZXJVcCwgZmFsc2UgKTsNCgkJfQ0KDQoJCWlmICggY29uZmlnLnByb2dyZXNzICYmIGRvbS5wcm9ncmVzcyApIHsNCgkJCWRvbS5wcm9ncmVzcy5yZW1vdmVFdmVudExpc3RlbmVyKCAnY2xpY2snLCBvblByb2dyZXNzQ2xpY2tlZCwgZmFsc2UgKTsNCgkJfQ0KDQoJCVsgJ3RvdWNoc3RhcnQnLCAnY2xpY2snIF0uZm9yRWFjaCggZnVuY3Rpb24oIGV2ZW50TmFtZSApIHsNCgkJCWRvbS5jb250cm9sc0xlZnQuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCBldmVudE5hbWUsIG9uTmF2aWdhdGVMZWZ0Q2xpY2tlZCwgZmFsc2UgKTsgfSApOw0KCQkJZG9tLmNvbnRyb2xzUmlnaHQuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCBldmVudE5hbWUsIG9uTmF2aWdhdGVSaWdodENsaWNrZWQsIGZhbHNlICk7IH0gKTsNCgkJCWRvbS5jb250cm9sc1VwLmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lciggZXZlbnROYW1lLCBvbk5hdmlnYXRlVXBDbGlja2VkLCBmYWxzZSApOyB9ICk7DQoJCQlkb20uY29udHJvbHNEb3duLmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lciggZXZlbnROYW1lLCBvbk5hdmlnYXRlRG93bkNsaWNrZWQsIGZhbHNlICk7IH0gKTsNCgkJCWRvbS5jb250cm9sc1ByZXYuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCBldmVudE5hbWUsIG9uTmF2aWdhdGVQcmV2Q2xpY2tlZCwgZmFsc2UgKTsgfSApOw0KCQkJZG9tLmNvbnRyb2xzTmV4dC5mb3JFYWNoKCBmdW5jdGlvbiggZWwgKSB7IGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoIGV2ZW50TmFtZSwgb25OYXZpZ2F0ZU5leHRDbGlja2VkLCBmYWxzZSApOyB9ICk7DQoJCX0gKTsNCg0KCX0NCg0KCS8qKg0KCSAqIEV4dGVuZCBvYmplY3QgYSB3aXRoIHRoZSBwcm9wZXJ0aWVzIG9mIG9iamVjdCBiLg0KCSAqIElmIHRoZXJlJ3MgYSBjb25mbGljdCwgb2JqZWN0IGIgdGFrZXMgcHJlY2VkZW5jZS4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBhDQoJICogQHBhcmFtIHtvYmplY3R9IGINCgkgKi8NCglmdW5jdGlvbiBleHRlbmQoIGEsIGIgKSB7DQoNCgkJZm9yKCB2YXIgaSBpbiBiICkgew0KCQkJYVsgaSBdID0gYlsgaSBdOw0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBDb252ZXJ0cyB0aGUgdGFyZ2V0IG9iamVjdCB0byBhbiBhcnJheS4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBvDQoJICogQHJldHVybiB7b2JqZWN0W119DQoJICovDQoJZnVuY3Rpb24gdG9BcnJheSggbyApIHsNCg0KCQlyZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoIG8gKTsNCg0KCX0NCg0KCS8qKg0KCSAqIFV0aWxpdHkgZm9yIGRlc2VyaWFsaXppbmcgYSB2YWx1ZS4NCgkgKg0KCSAqIEBwYXJhbSB7Kn0gdmFsdWUNCgkgKiBAcmV0dXJuIHsqfQ0KCSAqLw0KCWZ1bmN0aW9uIGRlc2VyaWFsaXplKCB2YWx1ZSApIHsNCg0KCQlpZiggdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyApIHsNCgkJCWlmKCB2YWx1ZSA9PT0gJ251bGwnICkgcmV0dXJuIG51bGw7DQoJCQllbHNlIGlmKCB2YWx1ZSA9PT0gJ3RydWUnICkgcmV0dXJuIHRydWU7DQoJCQllbHNlIGlmKCB2YWx1ZSA9PT0gJ2ZhbHNlJyApIHJldHVybiBmYWxzZTsNCgkJCWVsc2UgaWYoIHZhbHVlLm1hdGNoKCAvXlxkKyQvICkgKSByZXR1cm4gcGFyc2VGbG9hdCggdmFsdWUgKTsNCgkJfQ0KDQoJCXJldHVybiB2YWx1ZTsNCg0KCX0NCg0KCS8qKg0KCSAqIE1lYXN1cmVzIHRoZSBkaXN0YW5jZSBpbiBwaXhlbHMgYmV0d2VlbiBwb2ludCBhDQoJICogYW5kIHBvaW50IGIuDQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gYSBwb2ludCB3aXRoIHgveSBwcm9wZXJ0aWVzDQoJICogQHBhcmFtIHtvYmplY3R9IGIgcG9pbnQgd2l0aCB4L3kgcHJvcGVydGllcw0KCSAqDQoJICogQHJldHVybiB7bnVtYmVyfQ0KCSAqLw0KCWZ1bmN0aW9uIGRpc3RhbmNlQmV0d2VlbiggYSwgYiApIHsNCg0KCQl2YXIgZHggPSBhLnggLSBiLngsDQoJCQlkeSA9IGEueSAtIGIueTsNCg0KCQlyZXR1cm4gTWF0aC5zcXJ0KCBkeCpkeCArIGR5KmR5ICk7DQoNCgl9DQoNCgkvKioNCgkgKiBBcHBsaWVzIGEgQ1NTIHRyYW5zZm9ybSB0byB0aGUgdGFyZ2V0IGVsZW1lbnQuDQoJICoNCgkgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBlbGVtZW50DQoJICogQHBhcmFtIHtzdHJpbmd9IHRyYW5zZm9ybQ0KCSAqLw0KCWZ1bmN0aW9uIHRyYW5zZm9ybUVsZW1lbnQoIGVsZW1lbnQsIHRyYW5zZm9ybSApIHsNCg0KCQllbGVtZW50LnN0eWxlLldlYmtpdFRyYW5zZm9ybSA9IHRyYW5zZm9ybTsNCgkJZWxlbWVudC5zdHlsZS5Nb3pUcmFuc2Zvcm0gPSB0cmFuc2Zvcm07DQoJCWVsZW1lbnQuc3R5bGUubXNUcmFuc2Zvcm0gPSB0cmFuc2Zvcm07DQoJCWVsZW1lbnQuc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOw0KDQoJfQ0KDQoJLyoqDQoJICogQXBwbGllcyBDU1MgdHJhbnNmb3JtcyB0byB0aGUgc2xpZGVzIGNvbnRhaW5lci4gVGhlIGNvbnRhaW5lcg0KCSAqIGlzIHRyYW5zZm9ybWVkIGZyb20gdHdvIHNlcGFyYXRlIHNvdXJjZXM6IGxheW91dCBhbmQgdGhlIG92ZXJ2aWV3DQoJICogbW9kZS4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSB0cmFuc2Zvcm1zDQoJICovDQoJZnVuY3Rpb24gdHJhbnNmb3JtU2xpZGVzKCB0cmFuc2Zvcm1zICkgew0KDQoJCS8vIFBpY2sgdXAgbmV3IHRyYW5zZm9ybXMgZnJvbSBhcmd1bWVudHMNCgkJaWYoIHR5cGVvZiB0cmFuc2Zvcm1zLmxheW91dCA9PT0gJ3N0cmluZycgKSBzbGlkZXNUcmFuc2Zvcm0ubGF5b3V0ID0gdHJhbnNmb3Jtcy5sYXlvdXQ7DQoJCWlmKCB0eXBlb2YgdHJhbnNmb3Jtcy5vdmVydmlldyA9PT0gJ3N0cmluZycgKSBzbGlkZXNUcmFuc2Zvcm0ub3ZlcnZpZXcgPSB0cmFuc2Zvcm1zLm92ZXJ2aWV3Ow0KDQoJCS8vIEFwcGx5IHRoZSB0cmFuc2Zvcm1zIHRvIHRoZSBzbGlkZXMgY29udGFpbmVyDQoJCWlmKCBzbGlkZXNUcmFuc2Zvcm0ubGF5b3V0ICkgew0KCQkJdHJhbnNmb3JtRWxlbWVudCggZG9tLnNsaWRlcywgc2xpZGVzVHJhbnNmb3JtLmxheW91dCArICcgJyArIHNsaWRlc1RyYW5zZm9ybS5vdmVydmlldyApOw0KCQl9DQoJCWVsc2Ugew0KCQkJdHJhbnNmb3JtRWxlbWVudCggZG9tLnNsaWRlcywgc2xpZGVzVHJhbnNmb3JtLm92ZXJ2aWV3ICk7DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIEluamVjdHMgdGhlIGdpdmVuIENTUyBzdHlsZXMgaW50byB0aGUgRE9NLg0KCSAqDQoJICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlDQoJICovDQoJZnVuY3Rpb24gaW5qZWN0U3R5bGVTaGVldCggdmFsdWUgKSB7DQoNCgkJdmFyIHRhZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdzdHlsZScgKTsNCgkJdGFnLnR5cGUgPSAndGV4dC9jc3MnOw0KCQlpZiggdGFnLnN0eWxlU2hlZXQgKSB7DQoJCQl0YWcuc3R5bGVTaGVldC5jc3NUZXh0ID0gdmFsdWU7DQoJCX0NCgkJZWxzZSB7DQoJCQl0YWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB2YWx1ZSApICk7DQoJCX0NCgkJZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICdoZWFkJyApWzBdLmFwcGVuZENoaWxkKCB0YWcgKTsNCg0KCX0NCg0KCS8qKg0KCSAqIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHRoYXQgbWF0Y2hlcyB0aGUgZ2l2ZW4NCgkgKiBzZWxlY3Rvci4NCgkgKg0KCSAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IHRhcmdldCBUaGUgY2hpbGQgZWxlbWVudA0KCSAqIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciBUaGUgQ1NTIHNlbGVjdG9yIHRvIG1hdGNoDQoJICogdGhlIHBhcmVudHMgYWdhaW5zdA0KCSAqDQoJICogQHJldHVybiB7SFRNTEVsZW1lbnR9IFRoZSBtYXRjaGVkIHBhcmVudCBvciBudWxsDQoJICogaWYgbm8gbWF0Y2hpbmcgcGFyZW50IHdhcyBmb3VuZA0KCSAqLw0KCWZ1bmN0aW9uIGNsb3Nlc3RQYXJlbnQoIHRhcmdldCwgc2VsZWN0b3IgKSB7DQoNCgkJdmFyIHBhcmVudCA9IHRhcmdldC5wYXJlbnROb2RlOw0KDQoJCXdoaWxlKCBwYXJlbnQgKSB7DQoNCgkJCS8vIFRoZXJlJ3Mgc29tZSBvdmVyaGVhZCBkb2luZyB0aGlzIGVhY2ggdGltZSwgd2UgZG9uJ3QNCgkJCS8vIHdhbnQgdG8gcmV3cml0ZSB0aGUgZWxlbWVudCBwcm90b3R5cGUgYnV0IHNob3VsZCBzdGlsbA0KCQkJLy8gYmUgZW5vdWdoIHRvIGZlYXR1cmUgZGV0ZWN0IG9uY2UgYXQgc3RhcnR1cC4uLg0KCQkJdmFyIG1hdGNoZXNNZXRob2QgPSBwYXJlbnQubWF0Y2hlcyB8fCBwYXJlbnQubWF0Y2hlc1NlbGVjdG9yIHx8IHBhcmVudC5tc01hdGNoZXNTZWxlY3RvcjsNCg0KCQkJLy8gSWYgd2UgZmluZCBhIG1hdGNoLCB3ZSdyZSBhbGwgc2V0DQoJCQlpZiggbWF0Y2hlc01ldGhvZCAmJiBtYXRjaGVzTWV0aG9kLmNhbGwoIHBhcmVudCwgc2VsZWN0b3IgKSApIHsNCgkJCQlyZXR1cm4gcGFyZW50Ow0KCQkJfQ0KDQoJCQkvLyBLZWVwIHNlYXJjaGluZw0KCQkJcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGU7DQoNCgkJfQ0KDQoJCXJldHVybiBudWxsOw0KDQoJfQ0KDQoJLyoqDQoJICogQ29udmVydHMgdmFyaW91cyBjb2xvciBpbnB1dCBmb3JtYXRzIHRvIGFuIHtyOjAsZzowLGI6MH0gb2JqZWN0Lg0KCSAqDQoJICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIFRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgYSBjb2xvcg0KCSAqIEBleGFtcGxlDQoJICogY29sb3JUb1JnYignIzAwMCcpOw0KCSAqIEBleGFtcGxlDQoJICogY29sb3JUb1JnYignIzAwMDAwMCcpOw0KCSAqIEBleGFtcGxlDQoJICogY29sb3JUb1JnYigncmdiKDAsMCwwKScpOw0KCSAqIEBleGFtcGxlDQoJICogY29sb3JUb1JnYigncmdiYSgwLDAsMCknKTsNCgkgKg0KCSAqIEByZXR1cm4ge3tyOiBudW1iZXIsIGc6IG51bWJlciwgYjogbnVtYmVyLCBbYV06IG51bWJlcn18bnVsbH0NCgkgKi8NCglmdW5jdGlvbiBjb2xvclRvUmdiKCBjb2xvciApIHsNCg0KCQl2YXIgaGV4MyA9IGNvbG9yLm1hdGNoKCAvXiMoWzAtOWEtZl17M30pJC9pICk7DQoJCWlmKCBoZXgzICYmIGhleDNbMV0gKSB7DQoJCQloZXgzID0gaGV4M1sxXTsNCgkJCXJldHVybiB7DQoJCQkJcjogcGFyc2VJbnQoIGhleDMuY2hhckF0KCAwICksIDE2ICkgKiAweDExLA0KCQkJCWc6IHBhcnNlSW50KCBoZXgzLmNoYXJBdCggMSApLCAxNiApICogMHgxMSwNCgkJCQliOiBwYXJzZUludCggaGV4My5jaGFyQXQoIDIgKSwgMTYgKSAqIDB4MTENCgkJCX07DQoJCX0NCg0KCQl2YXIgaGV4NiA9IGNvbG9yLm1hdGNoKCAvXiMoWzAtOWEtZl17Nn0pJC9pICk7DQoJCWlmKCBoZXg2ICYmIGhleDZbMV0gKSB7DQoJCQloZXg2ID0gaGV4NlsxXTsNCgkJCXJldHVybiB7DQoJCQkJcjogcGFyc2VJbnQoIGhleDYuc3Vic3RyKCAwLCAyICksIDE2ICksDQoJCQkJZzogcGFyc2VJbnQoIGhleDYuc3Vic3RyKCAyLCAyICksIDE2ICksDQoJCQkJYjogcGFyc2VJbnQoIGhleDYuc3Vic3RyKCA0LCAyICksIDE2ICkNCgkJCX07DQoJCX0NCg0KCQl2YXIgcmdiID0gY29sb3IubWF0Y2goIC9ecmdiXHMqXChccyooXGQrKVxzKixccyooXGQrKVxzKixccyooXGQrKVxzKlwpJC9pICk7DQoJCWlmKCByZ2IgKSB7DQoJCQlyZXR1cm4gew0KCQkJCXI6IHBhcnNlSW50KCByZ2JbMV0sIDEwICksDQoJCQkJZzogcGFyc2VJbnQoIHJnYlsyXSwgMTAgKSwNCgkJCQliOiBwYXJzZUludCggcmdiWzNdLCAxMCApDQoJCQl9Ow0KCQl9DQoNCgkJdmFyIHJnYmEgPSBjb2xvci5tYXRjaCggL15yZ2JhXHMqXChccyooXGQrKVxzKixccyooXGQrKVxzKixccyooXGQrKVxzKlwsXHMqKFtcZF0rfFtcZF0qLltcZF0rKVxzKlwpJC9pICk7DQoJCWlmKCByZ2JhICkgew0KCQkJcmV0dXJuIHsNCgkJCQlyOiBwYXJzZUludCggcmdiYVsxXSwgMTAgKSwNCgkJCQlnOiBwYXJzZUludCggcmdiYVsyXSwgMTAgKSwNCgkJCQliOiBwYXJzZUludCggcmdiYVszXSwgMTAgKSwNCgkJCQlhOiBwYXJzZUZsb2F0KCByZ2JhWzRdICkNCgkJCX07DQoJCX0NCg0KCQlyZXR1cm4gbnVsbDsNCg0KCX0NCg0KCS8qKg0KCSAqIENhbGN1bGF0ZXMgYnJpZ2h0bmVzcyBvbiBhIHNjYWxlIG9mIDAtMjU1Lg0KCSAqDQoJICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIFNlZSBjb2xvclRvUmdiIGZvciBzdXBwb3J0ZWQgZm9ybWF0cy4NCgkgKiBAc2VlIHtAbGluayBjb2xvclRvUmdifQ0KCSAqLw0KCWZ1bmN0aW9uIGNvbG9yQnJpZ2h0bmVzcyggY29sb3IgKSB7DQoNCgkJaWYoIHR5cGVvZiBjb2xvciA9PT0gJ3N0cmluZycgKSBjb2xvciA9IGNvbG9yVG9SZ2IoIGNvbG9yICk7DQoNCgkJaWYoIGNvbG9yICkgew0KCQkJcmV0dXJuICggY29sb3IuciAqIDI5OSArIGNvbG9yLmcgKiA1ODcgKyBjb2xvci5iICogMTE0ICkgLyAxMDAwOw0KCQl9DQoNCgkJcmV0dXJuIG51bGw7DQoNCgl9DQoNCgkvKioNCgkgKiBSZXR1cm5zIHRoZSByZW1haW5pbmcgaGVpZ2h0IHdpdGhpbiB0aGUgcGFyZW50IG9mIHRoZQ0KCSAqIHRhcmdldCBlbGVtZW50Lg0KCSAqDQoJICogcmVtYWluaW5nIGhlaWdodCA9IFsgY29uZmlndXJlZCBwYXJlbnQgaGVpZ2h0IF0gLSBbIGN1cnJlbnQgcGFyZW50IGhlaWdodCBdDQoJICogDQoJICogQHBhcmFtIHtIVE1MRWxlbWVudH0gZWxlbWVudA0KCSAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0XQ0KCSAqLw0KCWZ1bmN0aW9uIGdldFJlbWFpbmluZ0hlaWdodCggZWxlbWVudCwgaGVpZ2h0ICkgew0KDQoJCWhlaWdodCA9IGhlaWdodCB8fCAwOw0KDQoJCWlmKCBlbGVtZW50ICkgew0KCQkJdmFyIG5ld0hlaWdodCwgb2xkSGVpZ2h0ID0gZWxlbWVudC5zdHlsZS5oZWlnaHQ7DQoNCgkJCS8vIENoYW5nZSB0aGUgLnN0cmV0Y2ggZWxlbWVudCBoZWlnaHQgdG8gMCBpbiBvcmRlciBmaW5kIHRoZSBoZWlnaHQgb2YgYWxsDQoJCQkvLyB0aGUgb3RoZXIgZWxlbWVudHMNCgkJCWVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzBweCc7DQoJCQluZXdIZWlnaHQgPSBoZWlnaHQgLSBlbGVtZW50LnBhcmVudE5vZGUub2Zmc2V0SGVpZ2h0Ow0KDQoJCQkvLyBSZXN0b3JlIHRoZSBvbGQgaGVpZ2h0LCBqdXN0IGluIGNhc2UNCgkJCWVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gb2xkSGVpZ2h0ICsgJ3B4JzsNCg0KCQkJcmV0dXJuIG5ld0hlaWdodDsNCgkJfQ0KDQoJCXJldHVybiBoZWlnaHQ7DQoNCgl9DQoNCgkvKioNCgkgKiBDaGVja3MgaWYgdGhpcyBpbnN0YW5jZSBpcyBiZWluZyB1c2VkIHRvIHByaW50IGEgUERGLg0KCSAqLw0KCWZ1bmN0aW9uIGlzUHJpbnRpbmdQREYoKSB7DQoNCgkJcmV0dXJuICggL3ByaW50LXBkZi9naSApLnRlc3QoIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2ggKTsNCg0KCX0NCg0KCS8qKg0KCSAqIEhpZGVzIHRoZSBhZGRyZXNzIGJhciBpZiB3ZSdyZSBvbiBhIG1vYmlsZSBkZXZpY2UuDQoJICovDQoJZnVuY3Rpb24gaGlkZUFkZHJlc3NCYXIoKSB7DQoNCgkJaWYoIGNvbmZpZy5oaWRlQWRkcmVzc0JhciAmJiBpc01vYmlsZURldmljZSApIHsNCgkJCS8vIEV2ZW50cyB0aGF0IHNob3VsZCB0cmlnZ2VyIHRoZSBhZGRyZXNzIGJhciB0byBoaWRlDQoJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciggJ2xvYWQnLCByZW1vdmVBZGRyZXNzQmFyLCBmYWxzZSApOw0KCQkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoICdvcmllbnRhdGlvbmNoYW5nZScsIHJlbW92ZUFkZHJlc3NCYXIsIGZhbHNlICk7DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIENhdXNlcyB0aGUgYWRkcmVzcyBiYXIgdG8gaGlkZSBvbiBtb2JpbGUgZGV2aWNlcywNCgkgKiBtb3JlIHZlcnRpY2FsIHNwYWNlIGZ0dy4NCgkgKi8NCglmdW5jdGlvbiByZW1vdmVBZGRyZXNzQmFyKCkgew0KDQoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgew0KCQkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7DQoJCX0sIDEwICk7DQoNCgl9DQoNCgkvKioNCgkgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IG9mIHRoZSBzcGVjaWZpZWQgdHlwZSBmcm9tIHRoZQ0KCSAqIHJldmVhbCBET00gZWxlbWVudC4NCgkgKi8NCglmdW5jdGlvbiBkaXNwYXRjaEV2ZW50KCB0eXBlLCBhcmdzICkgew0KDQoJCXZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCAnSFRNTEV2ZW50cycsIDEsIDIgKTsNCgkJZXZlbnQuaW5pdEV2ZW50KCB0eXBlLCB0cnVlLCB0cnVlICk7DQoJCWV4dGVuZCggZXZlbnQsIGFyZ3MgKTsNCgkJZG9tLndyYXBwZXIuZGlzcGF0Y2hFdmVudCggZXZlbnQgKTsNCg0KCQkvLyBJZiB3ZSdyZSBpbiBhbiBpZnJhbWUsIHBvc3QgZWFjaCByZXZlYWwuanMgZXZlbnQgdG8gdGhlDQoJCS8vIHBhcmVudCB3aW5kb3cuIFVzZWQgYnkgdGhlIG5vdGVzIHBsdWdpbg0KCQlpZiggY29uZmlnLnBvc3RNZXNzYWdlRXZlbnRzICYmIHdpbmRvdy5wYXJlbnQgIT09IHdpbmRvdy5zZWxmICkgew0KCQkJd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSggSlNPTi5zdHJpbmdpZnkoeyBuYW1lc3BhY2U6ICdyZXZlYWwnLCBldmVudE5hbWU6IHR5cGUsIHN0YXRlOiBnZXRTdGF0ZSgpIH0pLCAnKicgKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogV3JhcCBhbGwgbGlua3MgaW4gM0QgZ29vZG5lc3MuDQoJICovDQoJZnVuY3Rpb24gZW5hYmxlUm9sbGluZ0xpbmtzKCkgew0KDQoJCWlmKCBmZWF0dXJlcy50cmFuc2Zvcm1zM2QgJiYgISggJ21zUGVyc3BlY3RpdmUnIGluIGRvY3VtZW50LmJvZHkuc3R5bGUgKSApIHsNCgkJCXZhciBhbmNob3JzID0gZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggU0xJREVTX1NFTEVDVE9SICsgJyBhJyApOw0KDQoJCQlmb3IoIHZhciBpID0gMCwgbGVuID0gYW5jaG9ycy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsNCgkJCQl2YXIgYW5jaG9yID0gYW5jaG9yc1tpXTsNCg0KCQkJCWlmKCBhbmNob3IudGV4dENvbnRlbnQgJiYgIWFuY2hvci5xdWVyeVNlbGVjdG9yKCAnKicgKSAmJiAoICFhbmNob3IuY2xhc3NOYW1lIHx8ICFhbmNob3IuY2xhc3NMaXN0LmNvbnRhaW5zKCBhbmNob3IsICdyb2xsJyApICkgKSB7DQoJCQkJCXZhciBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOw0KCQkJCQlzcGFuLnNldEF0dHJpYnV0ZSgnZGF0YS10aXRsZScsIGFuY2hvci50ZXh0KTsNCgkJCQkJc3Bhbi5pbm5lckhUTUwgPSBhbmNob3IuaW5uZXJIVE1MOw0KDQoJCQkJCWFuY2hvci5jbGFzc0xpc3QuYWRkKCAncm9sbCcgKTsNCgkJCQkJYW5jaG9yLmlubmVySFRNTCA9ICcnOw0KCQkJCQlhbmNob3IuYXBwZW5kQ2hpbGQoc3Bhbik7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBVbndyYXAgYWxsIDNEIGxpbmtzLg0KCSAqLw0KCWZ1bmN0aW9uIGRpc2FibGVSb2xsaW5nTGlua3MoKSB7DQoNCgkJdmFyIGFuY2hvcnMgPSBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBTTElERVNfU0VMRUNUT1IgKyAnIGEucm9sbCcgKTsNCg0KCQlmb3IoIHZhciBpID0gMCwgbGVuID0gYW5jaG9ycy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsNCgkJCXZhciBhbmNob3IgPSBhbmNob3JzW2ldOw0KCQkJdmFyIHNwYW4gPSBhbmNob3IucXVlcnlTZWxlY3RvciggJ3NwYW4nICk7DQoNCgkJCWlmKCBzcGFuICkgew0KCQkJCWFuY2hvci5jbGFzc0xpc3QucmVtb3ZlKCAncm9sbCcgKTsNCgkJCQlhbmNob3IuaW5uZXJIVE1MID0gc3Bhbi5pbm5lckhUTUw7DQoJCQl9DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIEJpbmQgcHJldmlldyBmcmFtZSBsaW5rcy4NCgkgKg0KCSAqIEBwYXJhbSB7c3RyaW5nfSBbc2VsZWN0b3I9YV0gLSBzZWxlY3RvciBmb3IgYW5jaG9ycw0KCSAqLw0KCWZ1bmN0aW9uIGVuYWJsZVByZXZpZXdMaW5rcyggc2VsZWN0b3IgKSB7DQoNCgkJdmFyIGFuY2hvcnMgPSB0b0FycmF5KCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCBzZWxlY3RvciA/IHNlbGVjdG9yIDogJ2EnICkgKTsNCg0KCQlhbmNob3JzLmZvckVhY2goIGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQkJaWYoIC9eKGh0dHB8d3d3KS9naS50ZXN0KCBlbGVtZW50LmdldEF0dHJpYnV0ZSggJ2hyZWYnICkgKSApIHsNCgkJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdjbGljaycsIG9uUHJldmlld0xpbmtDbGlja2VkLCBmYWxzZSApOw0KCQkJfQ0KCQl9ICk7DQoNCgl9DQoNCgkvKioNCgkgKiBVbmJpbmQgcHJldmlldyBmcmFtZSBsaW5rcy4NCgkgKi8NCglmdW5jdGlvbiBkaXNhYmxlUHJldmlld0xpbmtzKCkgew0KDQoJCXZhciBhbmNob3JzID0gdG9BcnJheSggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggJ2EnICkgKTsNCg0KCQlhbmNob3JzLmZvckVhY2goIGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQkJaWYoIC9eKGh0dHB8d3d3KS9naS50ZXN0KCBlbGVtZW50LmdldEF0dHJpYnV0ZSggJ2hyZWYnICkgKSApIHsNCgkJCQllbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoICdjbGljaycsIG9uUHJldmlld0xpbmtDbGlja2VkLCBmYWxzZSApOw0KCQkJfQ0KCQl9ICk7DQoNCgl9DQoNCgkvKioNCgkgKiBPcGVucyBhIHByZXZpZXcgd2luZG93IGZvciB0aGUgdGFyZ2V0IFVSTC4NCgkgKg0KCSAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSB1cmwgZm9yIHByZXZpZXcgaWZyYW1lIHNyYw0KCSAqLw0KCWZ1bmN0aW9uIHNob3dQcmV2aWV3KCB1cmwgKSB7DQoNCgkJY2xvc2VPdmVybGF5KCk7DQoNCgkJZG9tLm92ZXJsYXkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApOw0KCQlkb20ub3ZlcmxheS5jbGFzc0xpc3QuYWRkKCAnb3ZlcmxheScgKTsNCgkJZG9tLm92ZXJsYXkuY2xhc3NMaXN0LmFkZCggJ292ZXJsYXktcHJldmlldycgKTsNCgkJZG9tLndyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbS5vdmVybGF5ICk7DQoNCgkJZG9tLm92ZXJsYXkuaW5uZXJIVE1MID0gWw0KCQkJJzxoZWFkZXI+JywNCgkJCQknPGEgY2xhc3M9ImNsb3NlIiBocmVmPSIjIj48c3BhbiBjbGFzcz0iaWNvbiI+PC9zcGFuPjwvYT4nLA0KCQkJCSc8YSBjbGFzcz0iZXh0ZXJuYWwiIGhyZWY9IicrIHVybCArJyIgdGFyZ2V0PSJfYmxhbmsiPjxzcGFuIGNsYXNzPSJpY29uIj48L3NwYW4+PC9hPicsDQoJCQknPC9oZWFkZXI+JywNCgkJCSc8ZGl2IGNsYXNzPSJzcGlubmVyIj48L2Rpdj4nLA0KCQkJJzxkaXYgY2xhc3M9InZpZXdwb3J0Ij4nLA0KCQkJCSc8aWZyYW1lIHNyYz0iJysgdXJsICsnIj48L2lmcmFtZT4nLA0KCQkJCSc8c21hbGwgY2xhc3M9InZpZXdwb3J0LWlubmVyIj4nLA0KCQkJCQknPHNwYW4gY2xhc3M9IngtZnJhbWUtZXJyb3IiPlVuYWJsZSB0byBsb2FkIGlmcmFtZS4gVGhpcyBpcyBsaWtlbHkgZHVlIHRvIHRoZSBzaXRlXCdzIHBvbGljeSAoeC1mcmFtZS1vcHRpb25zKS48L3NwYW4+JywNCgkJCQknPC9zbWFsbD4nLA0KCQkJJzwvZGl2PicNCgkJXS5qb2luKCcnKTsNCg0KCQlkb20ub3ZlcmxheS5xdWVyeVNlbGVjdG9yKCAnaWZyYW1lJyApLmFkZEV2ZW50TGlzdGVuZXIoICdsb2FkJywgZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJZG9tLm92ZXJsYXkuY2xhc3NMaXN0LmFkZCggJ2xvYWRlZCcgKTsNCgkJfSwgZmFsc2UgKTsNCg0KCQlkb20ub3ZlcmxheS5xdWVyeVNlbGVjdG9yKCAnLmNsb3NlJyApLmFkZEV2ZW50TGlzdGVuZXIoICdjbGljaycsIGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCWNsb3NlT3ZlcmxheSgpOw0KCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJfSwgZmFsc2UgKTsNCg0KCQlkb20ub3ZlcmxheS5xdWVyeVNlbGVjdG9yKCAnLmV4dGVybmFsJyApLmFkZEV2ZW50TGlzdGVuZXIoICdjbGljaycsIGZ1bmN0aW9uKCBldmVudCApIHsNCgkJCWNsb3NlT3ZlcmxheSgpOw0KCQl9LCBmYWxzZSApOw0KDQoJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgew0KCQkJZG9tLm92ZXJsYXkuY2xhc3NMaXN0LmFkZCggJ3Zpc2libGUnICk7DQoJCX0sIDEgKTsNCg0KCX0NCg0KCS8qKg0KCSAqIE9wZW5zIGFuIG92ZXJsYXkgd2luZG93IHdpdGggaGVscCBtYXRlcmlhbC4NCgkgKi8NCglmdW5jdGlvbiBzaG93SGVscCgpIHsNCg0KCQlpZiggY29uZmlnLmhlbHAgKSB7DQoNCgkJCWNsb3NlT3ZlcmxheSgpOw0KDQoJCQlkb20ub3ZlcmxheSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICk7DQoJCQlkb20ub3ZlcmxheS5jbGFzc0xpc3QuYWRkKCAnb3ZlcmxheScgKTsNCgkJCWRvbS5vdmVybGF5LmNsYXNzTGlzdC5hZGQoICdvdmVybGF5LWhlbHAnICk7DQoJCQlkb20ud3JhcHBlci5hcHBlbmRDaGlsZCggZG9tLm92ZXJsYXkgKTsNCg0KCQkJdmFyIGh0bWwgPSAnPHAgY2xhc3M9InRpdGxlIj5LZXlib2FyZCBTaG9ydGN1dHM8L3A+PGJyLz4nOw0KDQoJCQlodG1sICs9ICc8dGFibGU+PHRoPktFWTwvdGg+PHRoPkFDVElPTjwvdGg+JzsNCgkJCWZvciggdmFyIGtleSBpbiBrZXlib2FyZFNob3J0Y3V0cyApIHsNCgkJCQlodG1sICs9ICc8dHI+PHRkPicgKyBrZXkgKyAnPC90ZD48dGQ+JyArIGtleWJvYXJkU2hvcnRjdXRzWyBrZXkgXSArICc8L3RkPjwvdHI+JzsNCgkJCX0NCg0KCQkJaHRtbCArPSAnPC90YWJsZT4nOw0KDQoJCQlkb20ub3ZlcmxheS5pbm5lckhUTUwgPSBbDQoJCQkJJzxoZWFkZXI+JywNCgkJCQkJJzxhIGNsYXNzPSJjbG9zZSIgaHJlZj0iIyI+PHNwYW4gY2xhc3M9Imljb24iPjwvc3Bhbj48L2E+JywNCgkJCQknPC9oZWFkZXI+JywNCgkJCQknPGRpdiBjbGFzcz0idmlld3BvcnQiPicsDQoJCQkJCSc8ZGl2IGNsYXNzPSJ2aWV3cG9ydC1pbm5lciI+JysgaHRtbCArJzwvZGl2PicsDQoJCQkJJzwvZGl2PicNCgkJCV0uam9pbignJyk7DQoNCgkJCWRvbS5vdmVybGF5LnF1ZXJ5U2VsZWN0b3IoICcuY2xvc2UnICkuYWRkRXZlbnRMaXN0ZW5lciggJ2NsaWNrJywgZnVuY3Rpb24oIGV2ZW50ICkgew0KCQkJCWNsb3NlT3ZlcmxheSgpOw0KCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQl9LCBmYWxzZSApOw0KDQoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsNCgkJCQlkb20ub3ZlcmxheS5jbGFzc0xpc3QuYWRkKCAndmlzaWJsZScgKTsNCgkJCX0sIDEgKTsNCg0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBDbG9zZXMgYW55IGN1cnJlbnRseSBvcGVuIG92ZXJsYXkuDQoJICovDQoJZnVuY3Rpb24gY2xvc2VPdmVybGF5KCkgew0KDQoJCWlmKCBkb20ub3ZlcmxheSApIHsNCgkJCWRvbS5vdmVybGF5LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIGRvbS5vdmVybGF5ICk7DQoJCQlkb20ub3ZlcmxheSA9IG51bGw7DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIEFwcGxpZXMgSmF2YVNjcmlwdC1jb250cm9sbGVkIGxheW91dCBydWxlcyB0byB0aGUNCgkgKiBwcmVzZW50YXRpb24uDQoJICovDQoJZnVuY3Rpb24gbGF5b3V0KCkgew0KDQoJCWlmKCBkb20ud3JhcHBlciAmJiAhaXNQcmludGluZ1BERigpICkgew0KDQoJCQl2YXIgc2l6ZSA9IGdldENvbXB1dGVkU2xpZGVTaXplKCk7DQoNCgkJCS8vIExheW91dCB0aGUgY29udGVudHMgb2YgdGhlIHNsaWRlcw0KCQkJbGF5b3V0U2xpZGVDb250ZW50cyggY29uZmlnLndpZHRoLCBjb25maWcuaGVpZ2h0ICk7DQoNCgkJCWRvbS5zbGlkZXMuc3R5bGUud2lkdGggPSBzaXplLndpZHRoICsgJ3B4JzsNCgkJCWRvbS5zbGlkZXMuc3R5bGUuaGVpZ2h0ID0gc2l6ZS5oZWlnaHQgKyAncHgnOw0KDQoJCQkvLyBEZXRlcm1pbmUgc2NhbGUgb2YgY29udGVudCB0byBmaXQgd2l0aGluIGF2YWlsYWJsZSBzcGFjZQ0KCQkJc2NhbGUgPSBNYXRoLm1pbiggc2l6ZS5wcmVzZW50YXRpb25XaWR0aCAvIHNpemUud2lkdGgsIHNpemUucHJlc2VudGF0aW9uSGVpZ2h0IC8gc2l6ZS5oZWlnaHQgKTsNCg0KCQkJLy8gUmVzcGVjdCBtYXgvbWluIHNjYWxlIHNldHRpbmdzDQoJCQlzY2FsZSA9IE1hdGgubWF4KCBzY2FsZSwgY29uZmlnLm1pblNjYWxlICk7DQoJCQlzY2FsZSA9IE1hdGgubWluKCBzY2FsZSwgY29uZmlnLm1heFNjYWxlICk7DQoNCgkJCS8vIERvbid0IGFwcGx5IGFueSBzY2FsaW5nIHN0eWxlcyBpZiBzY2FsZSBpcyAxDQoJCQlpZiggc2NhbGUgPT09IDEgKSB7DQoJCQkJZG9tLnNsaWRlcy5zdHlsZS56b29tID0gJyc7DQoJCQkJZG9tLnNsaWRlcy5zdHlsZS5sZWZ0ID0gJyc7DQoJCQkJZG9tLnNsaWRlcy5zdHlsZS50b3AgPSAnJzsNCgkJCQlkb20uc2xpZGVzLnN0eWxlLmJvdHRvbSA9ICcnOw0KCQkJCWRvbS5zbGlkZXMuc3R5bGUucmlnaHQgPSAnJzsNCgkJCQl0cmFuc2Zvcm1TbGlkZXMoIHsgbGF5b3V0OiAnJyB9ICk7DQoJCQl9DQoJCQllbHNlIHsNCgkJCQkvLyBQcmVmZXIgem9vbSBmb3Igc2NhbGluZyB1cCBzbyB0aGF0IGNvbnRlbnQgcmVtYWlucyBjcmlzcC4NCgkJCQkvLyBEb24ndCB1c2Ugem9vbSB0byBzY2FsZSBkb3duIHNpbmNlIHRoYXQgY2FuIGxlYWQgdG8gc2hpZnRzDQoJCQkJLy8gaW4gdGV4dCBsYXlvdXQvbGluZSBicmVha3MuDQoJCQkJaWYoIHNjYWxlID4gMSAmJiBmZWF0dXJlcy56b29tICkgew0KCQkJCQlkb20uc2xpZGVzLnN0eWxlLnpvb20gPSBzY2FsZTsNCgkJCQkJZG9tLnNsaWRlcy5zdHlsZS5sZWZ0ID0gJyc7DQoJCQkJCWRvbS5zbGlkZXMuc3R5bGUudG9wID0gJyc7DQoJCQkJCWRvbS5zbGlkZXMuc3R5bGUuYm90dG9tID0gJyc7DQoJCQkJCWRvbS5zbGlkZXMuc3R5bGUucmlnaHQgPSAnJzsNCgkJCQkJdHJhbnNmb3JtU2xpZGVzKCB7IGxheW91dDogJycgfSApOw0KCQkJCX0NCgkJCQkvLyBBcHBseSBzY2FsZSB0cmFuc2Zvcm0gYXMgYSBmYWxsYmFjaw0KCQkJCWVsc2Ugew0KCQkJCQlkb20uc2xpZGVzLnN0eWxlLnpvb20gPSAnJzsNCgkJCQkJZG9tLnNsaWRlcy5zdHlsZS5sZWZ0ID0gJzUwJSc7DQoJCQkJCWRvbS5zbGlkZXMuc3R5bGUudG9wID0gJzUwJSc7DQoJCQkJCWRvbS5zbGlkZXMuc3R5bGUuYm90dG9tID0gJ2F1dG8nOw0KCQkJCQlkb20uc2xpZGVzLnN0eWxlLnJpZ2h0ID0gJ2F1dG8nOw0KCQkJCQl0cmFuc2Zvcm1TbGlkZXMoIHsgbGF5b3V0OiAndHJhbnNsYXRlKC01MCUsIC01MCUpIHNjYWxlKCcrIHNjYWxlICsnKScgfSApOw0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gU2VsZWN0IGFsbCBzbGlkZXMsIHZlcnRpY2FsIGFuZCBob3Jpem9udGFsDQoJCQl2YXIgc2xpZGVzID0gdG9BcnJheSggZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggU0xJREVTX1NFTEVDVE9SICkgKTsNCg0KCQkJZm9yKCB2YXIgaSA9IDAsIGxlbiA9IHNsaWRlcy5sZW5ndGg7IGkgPCBsZW47IGkrKyApIHsNCgkJCQl2YXIgc2xpZGUgPSBzbGlkZXNbIGkgXTsNCg0KCQkJCS8vIERvbid0IGJvdGhlciB1cGRhdGluZyBpbnZpc2libGUgc2xpZGVzDQoJCQkJaWYoIHNsaWRlLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyApIHsNCgkJCQkJY29udGludWU7DQoJCQkJfQ0KDQoJCQkJaWYoIGNvbmZpZy5jZW50ZXIgfHwgc2xpZGUuY2xhc3NMaXN0LmNvbnRhaW5zKCAnY2VudGVyJyApICkgew0KCQkJCQkvLyBWZXJ0aWNhbCBzdGFja3MgYXJlIG5vdCBjZW50cmVkIHNpbmNlIHRoZWlyIHNlY3Rpb24NCgkJCQkJLy8gY2hpbGRyZW4gd2lsbCBiZQ0KCQkJCQlpZiggc2xpZGUuY2xhc3NMaXN0LmNvbnRhaW5zKCAnc3RhY2snICkgKSB7DQoJCQkJCQlzbGlkZS5zdHlsZS50b3AgPSAwOw0KCQkJCQl9DQoJCQkJCWVsc2Ugew0KCQkJCQkJc2xpZGUuc3R5bGUudG9wID0gTWF0aC5tYXgoICggc2l6ZS5oZWlnaHQgLSBzbGlkZS5zY3JvbGxIZWlnaHQgKSAvIDIsIDAgKSArICdweCc7DQoJCQkJCX0NCgkJCQl9DQoJCQkJZWxzZSB7DQoJCQkJCXNsaWRlLnN0eWxlLnRvcCA9ICcnOw0KCQkJCX0NCg0KCQkJfQ0KDQoJCQl1cGRhdGVQcm9ncmVzcygpOw0KCQkJdXBkYXRlUGFyYWxsYXgoKTsNCg0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBBcHBsaWVzIGxheW91dCBsb2dpYyB0byB0aGUgY29udGVudHMgb2YgYWxsIHNsaWRlcyBpbg0KCSAqIHRoZSBwcmVzZW50YXRpb24uDQoJICoNCgkgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IHdpZHRoDQoJICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBoZWlnaHQNCgkgKi8NCglmdW5jdGlvbiBsYXlvdXRTbGlkZUNvbnRlbnRzKCB3aWR0aCwgaGVpZ2h0ICkgew0KDQoJCS8vIEhhbmRsZSBzaXppbmcgb2YgZWxlbWVudHMgd2l0aCB0aGUgJ3N0cmV0Y2gnIGNsYXNzDQoJCXRvQXJyYXkoIGRvbS5zbGlkZXMucXVlcnlTZWxlY3RvckFsbCggJ3NlY3Rpb24gPiAuc3RyZXRjaCcgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KDQoJCQkvLyBEZXRlcm1pbmUgaG93IG11Y2ggdmVydGljYWwgc3BhY2Ugd2UgY2FuIHVzZQ0KCQkJdmFyIHJlbWFpbmluZ0hlaWdodCA9IGdldFJlbWFpbmluZ0hlaWdodCggZWxlbWVudCwgaGVpZ2h0ICk7DQoNCgkJCS8vIENvbnNpZGVyIHRoZSBhc3BlY3QgcmF0aW8gb2YgbWVkaWEgZWxlbWVudHMNCgkJCWlmKCAvKGltZ3x2aWRlbykvZ2kudGVzdCggZWxlbWVudC5ub2RlTmFtZSApICkgew0KCQkJCXZhciBudyA9IGVsZW1lbnQubmF0dXJhbFdpZHRoIHx8IGVsZW1lbnQudmlkZW9XaWR0aCwNCgkJCQkJbmggPSBlbGVtZW50Lm5hdHVyYWxIZWlnaHQgfHwgZWxlbWVudC52aWRlb0hlaWdodDsNCg0KCQkJCXZhciBlcyA9IE1hdGgubWluKCB3aWR0aCAvIG53LCByZW1haW5pbmdIZWlnaHQgLyBuaCApOw0KDQoJCQkJZWxlbWVudC5zdHlsZS53aWR0aCA9ICggbncgKiBlcyApICsgJ3B4JzsNCgkJCQllbGVtZW50LnN0eWxlLmhlaWdodCA9ICggbmggKiBlcyApICsgJ3B4JzsNCg0KCQkJfQ0KCQkJZWxzZSB7DQoJCQkJZWxlbWVudC5zdHlsZS53aWR0aCA9IHdpZHRoICsgJ3B4JzsNCgkJCQllbGVtZW50LnN0eWxlLmhlaWdodCA9IHJlbWFpbmluZ0hlaWdodCArICdweCc7DQoJCQl9DQoNCgkJfSApOw0KDQoJfQ0KDQoJLyoqDQoJICogQ2FsY3VsYXRlcyB0aGUgY29tcHV0ZWQgcGl4ZWwgc2l6ZSBvZiBvdXIgc2xpZGVzLiBUaGVzZQ0KCSAqIHZhbHVlcyBhcmUgYmFzZWQgb24gdGhlIHdpZHRoIGFuZCBoZWlnaHQgY29uZmlndXJhdGlvbg0KCSAqIG9wdGlvbnMuDQoJICoNCgkgKiBAcGFyYW0ge251bWJlcn0gW3ByZXNlbnRhdGlvbldpZHRoPWRvbS53cmFwcGVyLm9mZnNldFdpZHRoXQ0KCSAqIEBwYXJhbSB7bnVtYmVyfSBbcHJlc2VudGF0aW9uSGVpZ2h0PWRvbS53cmFwcGVyLm9mZnNldEhlaWdodF0NCgkgKi8NCglmdW5jdGlvbiBnZXRDb21wdXRlZFNsaWRlU2l6ZSggcHJlc2VudGF0aW9uV2lkdGgsIHByZXNlbnRhdGlvbkhlaWdodCApIHsNCg0KCQl2YXIgc2l6ZSA9IHsNCgkJCS8vIFNsaWRlIHNpemUNCgkJCXdpZHRoOiBjb25maWcud2lkdGgsDQoJCQloZWlnaHQ6IGNvbmZpZy5oZWlnaHQsDQoNCgkJCS8vIFByZXNlbnRhdGlvbiBzaXplDQoJCQlwcmVzZW50YXRpb25XaWR0aDogcHJlc2VudGF0aW9uV2lkdGggfHwgZG9tLndyYXBwZXIub2Zmc2V0V2lkdGgsDQoJCQlwcmVzZW50YXRpb25IZWlnaHQ6IHByZXNlbnRhdGlvbkhlaWdodCB8fCBkb20ud3JhcHBlci5vZmZzZXRIZWlnaHQNCgkJfTsNCg0KCQkvLyBSZWR1Y2UgYXZhaWxhYmxlIHNwYWNlIGJ5IG1hcmdpbg0KCQlzaXplLnByZXNlbnRhdGlvbldpZHRoIC09ICggc2l6ZS5wcmVzZW50YXRpb25XaWR0aCAqIGNvbmZpZy5tYXJnaW4gKTsNCgkJc2l6ZS5wcmVzZW50YXRpb25IZWlnaHQgLT0gKCBzaXplLnByZXNlbnRhdGlvbkhlaWdodCAqIGNvbmZpZy5tYXJnaW4gKTsNCg0KCQkvLyBTbGlkZSB3aWR0aCBtYXkgYmUgYSBwZXJjZW50YWdlIG9mIGF2YWlsYWJsZSB3aWR0aA0KCQlpZiggdHlwZW9mIHNpemUud2lkdGggPT09ICdzdHJpbmcnICYmIC8lJC8udGVzdCggc2l6ZS53aWR0aCApICkgew0KCQkJc2l6ZS53aWR0aCA9IHBhcnNlSW50KCBzaXplLndpZHRoLCAxMCApIC8gMTAwICogc2l6ZS5wcmVzZW50YXRpb25XaWR0aDsNCgkJfQ0KDQoJCS8vIFNsaWRlIGhlaWdodCBtYXkgYmUgYSBwZXJjZW50YWdlIG9mIGF2YWlsYWJsZSBoZWlnaHQNCgkJaWYoIHR5cGVvZiBzaXplLmhlaWdodCA9PT0gJ3N0cmluZycgJiYgLyUkLy50ZXN0KCBzaXplLmhlaWdodCApICkgew0KCQkJc2l6ZS5oZWlnaHQgPSBwYXJzZUludCggc2l6ZS5oZWlnaHQsIDEwICkgLyAxMDAgKiBzaXplLnByZXNlbnRhdGlvbkhlaWdodDsNCgkJfQ0KDQoJCXJldHVybiBzaXplOw0KDQoJfQ0KDQoJLyoqDQoJICogU3RvcmVzIHRoZSB2ZXJ0aWNhbCBpbmRleCBvZiBhIHN0YWNrIHNvIHRoYXQgdGhlIHNhbWUNCgkgKiB2ZXJ0aWNhbCBzbGlkZSBjYW4gYmUgc2VsZWN0ZWQgd2hlbiBuYXZpZ2F0aW5nIHRvIGFuZA0KCSAqIGZyb20gdGhlIHN0YWNrLg0KCSAqDQoJICogQHBhcmFtIHtIVE1MRWxlbWVudH0gc3RhY2sgVGhlIHZlcnRpY2FsIHN0YWNrIGVsZW1lbnQNCgkgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFt2PTBdIEluZGV4IHRvIG1lbW9yaXplDQoJICovDQoJZnVuY3Rpb24gc2V0UHJldmlvdXNWZXJ0aWNhbEluZGV4KCBzdGFjaywgdiApIHsNCg0KCQlpZiggdHlwZW9mIHN0YWNrID09PSAnb2JqZWN0JyAmJiB0eXBlb2Ygc3RhY2suc2V0QXR0cmlidXRlID09PSAnZnVuY3Rpb24nICkgew0KCQkJc3RhY2suc2V0QXR0cmlidXRlKCAnZGF0YS1wcmV2aW91cy1pbmRleHYnLCB2IHx8IDAgKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogUmV0cmlldmVzIHRoZSB2ZXJ0aWNhbCBpbmRleCB3aGljaCB3YXMgc3RvcmVkIHVzaW5nDQoJICogI3NldFByZXZpb3VzVmVydGljYWxJbmRleCgpIG9yIDAgaWYgbm8gcHJldmlvdXMgaW5kZXgNCgkgKiBleGlzdHMuDQoJICoNCgkgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBzdGFjayBUaGUgdmVydGljYWwgc3RhY2sgZWxlbWVudA0KCSAqLw0KCWZ1bmN0aW9uIGdldFByZXZpb3VzVmVydGljYWxJbmRleCggc3RhY2sgKSB7DQoNCgkJaWYoIHR5cGVvZiBzdGFjayA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHN0YWNrLnNldEF0dHJpYnV0ZSA9PT0gJ2Z1bmN0aW9uJyAmJiBzdGFjay5jbGFzc0xpc3QuY29udGFpbnMoICdzdGFjaycgKSApIHsNCgkJCS8vIFByZWZlciBtYW51YWxseSBkZWZpbmVkIHN0YXJ0LWluZGV4dg0KCQkJdmFyIGF0dHJpYnV0ZU5hbWUgPSBzdGFjay5oYXNBdHRyaWJ1dGUoICdkYXRhLXN0YXJ0LWluZGV4dicgKSA/ICdkYXRhLXN0YXJ0LWluZGV4dicgOiAnZGF0YS1wcmV2aW91cy1pbmRleHYnOw0KDQoJCQlyZXR1cm4gcGFyc2VJbnQoIHN0YWNrLmdldEF0dHJpYnV0ZSggYXR0cmlidXRlTmFtZSApIHx8IDAsIDEwICk7DQoJCX0NCg0KCQlyZXR1cm4gMDsNCg0KCX0NCg0KCS8qKg0KCSAqIERpc3BsYXlzIHRoZSBvdmVydmlldyBvZiBzbGlkZXMgKHF1aWNrIG5hdikgYnkgc2NhbGluZw0KCSAqIGRvd24gYW5kIGFycmFuZ2luZyBhbGwgc2xpZGUgZWxlbWVudHMuDQoJICovDQoJZnVuY3Rpb24gYWN0aXZhdGVPdmVydmlldygpIHsNCg0KCQkvLyBPbmx5IHByb2NlZWQgaWYgZW5hYmxlZCBpbiBjb25maWcNCgkJaWYoIGNvbmZpZy5vdmVydmlldyAmJiAhaXNPdmVydmlldygpICkgew0KDQoJCQlvdmVydmlldyA9IHRydWU7DQoNCgkJCWRvbS53cmFwcGVyLmNsYXNzTGlzdC5hZGQoICdvdmVydmlldycgKTsNCgkJCWRvbS53cmFwcGVyLmNsYXNzTGlzdC5yZW1vdmUoICdvdmVydmlldy1kZWFjdGl2YXRpbmcnICk7DQoNCgkJCWlmKCBmZWF0dXJlcy5vdmVydmlld1RyYW5zaXRpb25zICkgew0KCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgew0KCQkJCQlkb20ud3JhcHBlci5jbGFzc0xpc3QuYWRkKCAnb3ZlcnZpZXctYW5pbWF0ZWQnICk7DQoJCQkJfSwgMSApOw0KCQkJfQ0KDQoJCQkvLyBEb24ndCBhdXRvLXNsaWRlIHdoaWxlIGluIG92ZXJ2aWV3IG1vZGUNCgkJCWNhbmNlbEF1dG9TbGlkZSgpOw0KDQoJCQkvLyBNb3ZlIHRoZSBiYWNrZ3JvdW5kcyBlbGVtZW50IGludG8gdGhlIHNsaWRlIGNvbnRhaW5lciB0bw0KCQkJLy8gdGhhdCB0aGUgc2FtZSBzY2FsaW5nIGlzIGFwcGxpZWQNCgkJCWRvbS5zbGlkZXMuYXBwZW5kQ2hpbGQoIGRvbS5iYWNrZ3JvdW5kICk7DQoNCgkJCS8vIENsaWNraW5nIG9uIGFuIG92ZXJ2aWV3IHNsaWRlIG5hdmlnYXRlcyB0byBpdA0KCQkJdG9BcnJheSggZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggU0xJREVTX1NFTEVDVE9SICkgKS5mb3JFYWNoKCBmdW5jdGlvbiggc2xpZGUgKSB7DQoJCQkJaWYoICFzbGlkZS5jbGFzc0xpc3QuY29udGFpbnMoICdzdGFjaycgKSApIHsNCgkJCQkJc2xpZGUuYWRkRXZlbnRMaXN0ZW5lciggJ2NsaWNrJywgb25PdmVydmlld1NsaWRlQ2xpY2tlZCwgdHJ1ZSApOw0KCQkJCX0NCgkJCX0gKTsNCg0KCQkJLy8gQ2FsY3VsYXRlIHNsaWRlIHNpemVzDQoJCQl2YXIgbWFyZ2luID0gNzA7DQoJCQl2YXIgc2xpZGVTaXplID0gZ2V0Q29tcHV0ZWRTbGlkZVNpemUoKTsNCgkJCW92ZXJ2aWV3U2xpZGVXaWR0aCA9IHNsaWRlU2l6ZS53aWR0aCArIG1hcmdpbjsNCgkJCW92ZXJ2aWV3U2xpZGVIZWlnaHQgPSBzbGlkZVNpemUuaGVpZ2h0ICsgbWFyZ2luOw0KDQoJCQkvLyBSZXZlcnNlIGluIFJUTCBtb2RlDQoJCQlpZiggY29uZmlnLnJ0bCApIHsNCgkJCQlvdmVydmlld1NsaWRlV2lkdGggPSAtb3ZlcnZpZXdTbGlkZVdpZHRoOw0KCQkJfQ0KDQoJCQl1cGRhdGVTbGlkZXNWaXNpYmlsaXR5KCk7DQoJCQlsYXlvdXRPdmVydmlldygpOw0KCQkJdXBkYXRlT3ZlcnZpZXcoKTsNCg0KCQkJbGF5b3V0KCk7DQoNCgkJCS8vIE5vdGlmeSBvYnNlcnZlcnMgb2YgdGhlIG92ZXJ2aWV3IHNob3dpbmcNCgkJCWRpc3BhdGNoRXZlbnQoICdvdmVydmlld3Nob3duJywgew0KCQkJCSdpbmRleGgnOiBpbmRleGgsDQoJCQkJJ2luZGV4dic6IGluZGV4diwNCgkJCQknY3VycmVudFNsaWRlJzogY3VycmVudFNsaWRlDQoJCQl9ICk7DQoNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogVXNlcyBDU1MgdHJhbnNmb3JtcyB0byBwb3NpdGlvbiBhbGwgc2xpZGVzIGluIGEgZ3JpZCBmb3INCgkgKiBkaXNwbGF5IGluc2lkZSBvZiB0aGUgb3ZlcnZpZXcgbW9kZS4NCgkgKi8NCglmdW5jdGlvbiBsYXlvdXRPdmVydmlldygpIHsNCg0KCQkvLyBMYXlvdXQgc2xpZGVzDQoJCXRvQXJyYXkoIGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIEhPUklaT05UQUxfU0xJREVTX1NFTEVDVE9SICkgKS5mb3JFYWNoKCBmdW5jdGlvbiggaHNsaWRlLCBoICkgew0KCQkJaHNsaWRlLnNldEF0dHJpYnV0ZSggJ2RhdGEtaW5kZXgtaCcsIGggKTsNCgkJCXRyYW5zZm9ybUVsZW1lbnQoIGhzbGlkZSwgJ3RyYW5zbGF0ZTNkKCcgKyAoIGggKiBvdmVydmlld1NsaWRlV2lkdGggKSArICdweCwgMCwgMCknICk7DQoNCgkJCWlmKCBoc2xpZGUuY2xhc3NMaXN0LmNvbnRhaW5zKCAnc3RhY2snICkgKSB7DQoNCgkJCQl0b0FycmF5KCBoc2xpZGUucXVlcnlTZWxlY3RvckFsbCggJ3NlY3Rpb24nICkgKS5mb3JFYWNoKCBmdW5jdGlvbiggdnNsaWRlLCB2ICkgew0KCQkJCQl2c2xpZGUuc2V0QXR0cmlidXRlKCAnZGF0YS1pbmRleC1oJywgaCApOw0KCQkJCQl2c2xpZGUuc2V0QXR0cmlidXRlKCAnZGF0YS1pbmRleC12JywgdiApOw0KDQoJCQkJCXRyYW5zZm9ybUVsZW1lbnQoIHZzbGlkZSwgJ3RyYW5zbGF0ZTNkKDAsICcgKyAoIHYgKiBvdmVydmlld1NsaWRlSGVpZ2h0ICkgKyAncHgsIDApJyApOw0KCQkJCX0gKTsNCg0KCQkJfQ0KCQl9ICk7DQoNCgkJLy8gTGF5b3V0IHNsaWRlIGJhY2tncm91bmRzDQoJCXRvQXJyYXkoIGRvbS5iYWNrZ3JvdW5kLmNoaWxkTm9kZXMgKS5mb3JFYWNoKCBmdW5jdGlvbiggaGJhY2tncm91bmQsIGggKSB7DQoJCQl0cmFuc2Zvcm1FbGVtZW50KCBoYmFja2dyb3VuZCwgJ3RyYW5zbGF0ZTNkKCcgKyAoIGggKiBvdmVydmlld1NsaWRlV2lkdGggKSArICdweCwgMCwgMCknICk7DQoNCgkJCXRvQXJyYXkoIGhiYWNrZ3JvdW5kLnF1ZXJ5U2VsZWN0b3JBbGwoICcuc2xpZGUtYmFja2dyb3VuZCcgKSApLmZvckVhY2goIGZ1bmN0aW9uKCB2YmFja2dyb3VuZCwgdiApIHsNCgkJCQl0cmFuc2Zvcm1FbGVtZW50KCB2YmFja2dyb3VuZCwgJ3RyYW5zbGF0ZTNkKDAsICcgKyAoIHYgKiBvdmVydmlld1NsaWRlSGVpZ2h0ICkgKyAncHgsIDApJyApOw0KCQkJfSApOw0KCQl9ICk7DQoNCgl9DQoNCgkvKioNCgkgKiBNb3ZlcyB0aGUgb3ZlcnZpZXcgdmlld3BvcnQgdG8gdGhlIGN1cnJlbnQgc2xpZGVzLg0KCSAqIENhbGxlZCBlYWNoIHRpbWUgdGhlIGN1cnJlbnQgc2xpZGUgY2hhbmdlcy4NCgkgKi8NCglmdW5jdGlvbiB1cGRhdGVPdmVydmlldygpIHsNCg0KCQl0cmFuc2Zvcm1TbGlkZXMoIHsNCgkJCW92ZXJ2aWV3OiBbDQoJCQkJJ3RyYW5zbGF0ZVgoJysgKCAtaW5kZXhoICogb3ZlcnZpZXdTbGlkZVdpZHRoICkgKydweCknLA0KCQkJCSd0cmFuc2xhdGVZKCcrICggLWluZGV4diAqIG92ZXJ2aWV3U2xpZGVIZWlnaHQgKSArJ3B4KScsDQoJCQkJJ3RyYW5zbGF0ZVooJysgKCB3aW5kb3cuaW5uZXJXaWR0aCA8IDQwMCA/IC0xMDAwIDogLTI1MDAgKSArJ3B4KScNCgkJCV0uam9pbiggJyAnICkNCgkJfSApOw0KDQoJfQ0KDQoJLyoqDQoJICogRXhpdHMgdGhlIHNsaWRlIG92ZXJ2aWV3IGFuZCBlbnRlcnMgdGhlIGN1cnJlbnRseQ0KCSAqIGFjdGl2ZSBzbGlkZS4NCgkgKi8NCglmdW5jdGlvbiBkZWFjdGl2YXRlT3ZlcnZpZXcoKSB7DQoNCgkJLy8gT25seSBwcm9jZWVkIGlmIGVuYWJsZWQgaW4gY29uZmlnDQoJCWlmKCBjb25maWcub3ZlcnZpZXcgKSB7DQoNCgkJCW92ZXJ2aWV3ID0gZmFsc2U7DQoNCgkJCWRvbS53cmFwcGVyLmNsYXNzTGlzdC5yZW1vdmUoICdvdmVydmlldycgKTsNCgkJCWRvbS53cmFwcGVyLmNsYXNzTGlzdC5yZW1vdmUoICdvdmVydmlldy1hbmltYXRlZCcgKTsNCg0KCQkJLy8gVGVtcG9yYXJpbHkgYWRkIGEgY2xhc3Mgc28gdGhhdCB0cmFuc2l0aW9ucyBjYW4gZG8gZGlmZmVyZW50IHRoaW5ncw0KCQkJLy8gZGVwZW5kaW5nIG9uIHdoZXRoZXIgdGhleSBhcmUgZXhpdGluZy9lbnRlcmluZyBvdmVydmlldywgb3IganVzdA0KCQkJLy8gbW92aW5nIGZyb20gc2xpZGUgdG8gc2xpZGUNCgkJCWRvbS53cmFwcGVyLmNsYXNzTGlzdC5hZGQoICdvdmVydmlldy1kZWFjdGl2YXRpbmcnICk7DQoNCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uICgpIHsNCgkJCQlkb20ud3JhcHBlci5jbGFzc0xpc3QucmVtb3ZlKCAnb3ZlcnZpZXctZGVhY3RpdmF0aW5nJyApOw0KCQkJfSwgMSApOw0KDQoJCQkvLyBNb3ZlIHRoZSBiYWNrZ3JvdW5kIGVsZW1lbnQgYmFjayBvdXQNCgkJCWRvbS53cmFwcGVyLmFwcGVuZENoaWxkKCBkb20uYmFja2dyb3VuZCApOw0KDQoJCQkvLyBDbGVhbiB1cCBjaGFuZ2VzIG1hZGUgdG8gc2xpZGVzDQoJCQl0b0FycmF5KCBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBTTElERVNfU0VMRUNUT1IgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBzbGlkZSApIHsNCgkJCQl0cmFuc2Zvcm1FbGVtZW50KCBzbGlkZSwgJycgKTsNCg0KCQkJCXNsaWRlLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdjbGljaycsIG9uT3ZlcnZpZXdTbGlkZUNsaWNrZWQsIHRydWUgKTsNCgkJCX0gKTsNCg0KCQkJLy8gQ2xlYW4gdXAgY2hhbmdlcyBtYWRlIHRvIGJhY2tncm91bmRzDQoJCQl0b0FycmF5KCBkb20uYmFja2dyb3VuZC5xdWVyeVNlbGVjdG9yQWxsKCAnLnNsaWRlLWJhY2tncm91bmQnICkgKS5mb3JFYWNoKCBmdW5jdGlvbiggYmFja2dyb3VuZCApIHsNCgkJCQl0cmFuc2Zvcm1FbGVtZW50KCBiYWNrZ3JvdW5kLCAnJyApOw0KCQkJfSApOw0KDQoJCQl0cmFuc2Zvcm1TbGlkZXMoIHsgb3ZlcnZpZXc6ICcnIH0gKTsNCg0KCQkJc2xpZGUoIGluZGV4aCwgaW5kZXh2ICk7DQoNCgkJCWxheW91dCgpOw0KDQoJCQljdWVBdXRvU2xpZGUoKTsNCg0KCQkJLy8gTm90aWZ5IG9ic2VydmVycyBvZiB0aGUgb3ZlcnZpZXcgaGlkaW5nDQoJCQlkaXNwYXRjaEV2ZW50KCAnb3ZlcnZpZXdoaWRkZW4nLCB7DQoJCQkJJ2luZGV4aCc6IGluZGV4aCwNCgkJCQknaW5kZXh2JzogaW5kZXh2LA0KCQkJCSdjdXJyZW50U2xpZGUnOiBjdXJyZW50U2xpZGUNCgkJCX0gKTsNCg0KCQl9DQoJfQ0KDQoJLyoqDQoJICogVG9nZ2xlcyB0aGUgc2xpZGUgb3ZlcnZpZXcgbW9kZSBvbiBhbmQgb2ZmLg0KCSAqDQoJICogQHBhcmFtIHtCb29sZWFufSBbb3ZlcnJpZGVdIEZsYWcgd2hpY2ggb3ZlcnJpZGVzIHRoZQ0KCSAqIHRvZ2dsZSBsb2dpYyBhbmQgZm9yY2libHkgc2V0cyB0aGUgZGVzaXJlZCBzdGF0ZS4gVHJ1ZSBtZWFucw0KCSAqIG92ZXJ2aWV3IGlzIG9wZW4sIGZhbHNlIG1lYW5zIGl0J3MgY2xvc2VkLg0KCSAqLw0KCWZ1bmN0aW9uIHRvZ2dsZU92ZXJ2aWV3KCBvdmVycmlkZSApIHsNCg0KCQlpZiggdHlwZW9mIG92ZXJyaWRlID09PSAnYm9vbGVhbicgKSB7DQoJCQlvdmVycmlkZSA/IGFjdGl2YXRlT3ZlcnZpZXcoKSA6IGRlYWN0aXZhdGVPdmVydmlldygpOw0KCQl9DQoJCWVsc2Ugew0KCQkJaXNPdmVydmlldygpID8gZGVhY3RpdmF0ZU92ZXJ2aWV3KCkgOiBhY3RpdmF0ZU92ZXJ2aWV3KCk7DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIENoZWNrcyBpZiB0aGUgb3ZlcnZpZXcgaXMgY3VycmVudGx5IGFjdGl2ZS4NCgkgKg0KCSAqIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgdGhlIG92ZXJ2aWV3IGlzIGFjdGl2ZSwNCgkgKiBmYWxzZSBvdGhlcndpc2UNCgkgKi8NCglmdW5jdGlvbiBpc092ZXJ2aWV3KCkgew0KDQoJCXJldHVybiBvdmVydmlldzsNCg0KCX0NCg0KCS8qKg0KCSAqIENoZWNrcyBpZiB0aGUgY3VycmVudCBvciBzcGVjaWZpZWQgc2xpZGUgaXMgdmVydGljYWwNCgkgKiAobmVzdGVkIHdpdGhpbiBhbm90aGVyIHNsaWRlKS4NCgkgKg0KCSAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IFtzbGlkZT1jdXJyZW50U2xpZGVdIFRoZSBzbGlkZSB0byBjaGVjaw0KCSAqIG9yaWVudGF0aW9uIG9mDQoJICogQHJldHVybiB7Qm9vbGVhbn0NCgkgKi8NCglmdW5jdGlvbiBpc1ZlcnRpY2FsU2xpZGUoIHNsaWRlICkgew0KDQoJCS8vIFByZWZlciBzbGlkZSBhcmd1bWVudCwgb3RoZXJ3aXNlIHVzZSBjdXJyZW50IHNsaWRlDQoJCXNsaWRlID0gc2xpZGUgPyBzbGlkZSA6IGN1cnJlbnRTbGlkZTsNCg0KCQlyZXR1cm4gc2xpZGUgJiYgc2xpZGUucGFyZW50Tm9kZSAmJiAhIXNsaWRlLnBhcmVudE5vZGUubm9kZU5hbWUubWF0Y2goIC9zZWN0aW9uL2kgKTsNCg0KCX0NCg0KCS8qKg0KCSAqIEhhbmRsaW5nIHRoZSBmdWxsc2NyZWVuIGZ1bmN0aW9uYWxpdHkgdmlhIHRoZSBmdWxsc2NyZWVuIEFQSQ0KCSAqDQoJICogQHNlZSBodHRwOi8vZnVsbHNjcmVlbi5zcGVjLndoYXR3Zy5vcmcvDQoJICogQHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS9Vc2luZ19mdWxsc2NyZWVuX21vZGUNCgkgKi8NCglmdW5jdGlvbiBlbnRlckZ1bGxzY3JlZW4oKSB7DQoNCgkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7DQoNCgkJLy8gQ2hlY2sgd2hpY2ggaW1wbGVtZW50YXRpb24gaXMgYXZhaWxhYmxlDQoJCXZhciByZXF1ZXN0TWV0aG9kID0gZWxlbWVudC5yZXF1ZXN0RnVsbHNjcmVlbiB8fA0KCQkJCQkJCWVsZW1lbnQud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4gfHwNCgkJCQkJCQllbGVtZW50LndlYmtpdFJlcXVlc3RGdWxsU2NyZWVuIHx8DQoJCQkJCQkJZWxlbWVudC5tb3pSZXF1ZXN0RnVsbFNjcmVlbiB8fA0KCQkJCQkJCWVsZW1lbnQubXNSZXF1ZXN0RnVsbHNjcmVlbjsNCg0KCQlpZiggcmVxdWVzdE1ldGhvZCApIHsNCgkJCXJlcXVlc3RNZXRob2QuYXBwbHkoIGVsZW1lbnQgKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogRW50ZXJzIHRoZSBwYXVzZWQgbW9kZSB3aGljaCBmYWRlcyBldmVyeXRoaW5nIG9uIHNjcmVlbiB0bw0KCSAqIGJsYWNrLg0KCSAqLw0KCWZ1bmN0aW9uIHBhdXNlKCkgew0KDQoJCWlmKCBjb25maWcucGF1c2UgKSB7DQoJCQl2YXIgd2FzUGF1c2VkID0gZG9tLndyYXBwZXIuY2xhc3NMaXN0LmNvbnRhaW5zKCAncGF1c2VkJyApOw0KDQoJCQljYW5jZWxBdXRvU2xpZGUoKTsNCgkJCWRvbS53cmFwcGVyLmNsYXNzTGlzdC5hZGQoICdwYXVzZWQnICk7DQoNCgkJCWlmKCB3YXNQYXVzZWQgPT09IGZhbHNlICkgew0KCQkJCWRpc3BhdGNoRXZlbnQoICdwYXVzZWQnICk7DQoJCQl9DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIEV4aXRzIGZyb20gdGhlIHBhdXNlZCBtb2RlLg0KCSAqLw0KCWZ1bmN0aW9uIHJlc3VtZSgpIHsNCg0KCQl2YXIgd2FzUGF1c2VkID0gZG9tLndyYXBwZXIuY2xhc3NMaXN0LmNvbnRhaW5zKCAncGF1c2VkJyApOw0KCQlkb20ud3JhcHBlci5jbGFzc0xpc3QucmVtb3ZlKCAncGF1c2VkJyApOw0KDQoJCWN1ZUF1dG9TbGlkZSgpOw0KDQoJCWlmKCB3YXNQYXVzZWQgKSB7DQoJCQlkaXNwYXRjaEV2ZW50KCAncmVzdW1lZCcgKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogVG9nZ2xlcyB0aGUgcGF1c2VkIG1vZGUgb24gYW5kIG9mZi4NCgkgKi8NCglmdW5jdGlvbiB0b2dnbGVQYXVzZSggb3ZlcnJpZGUgKSB7DQoNCgkJaWYoIHR5cGVvZiBvdmVycmlkZSA9PT0gJ2Jvb2xlYW4nICkgew0KCQkJb3ZlcnJpZGUgPyBwYXVzZSgpIDogcmVzdW1lKCk7DQoJCX0NCgkJZWxzZSB7DQoJCQlpc1BhdXNlZCgpID8gcmVzdW1lKCkgOiBwYXVzZSgpOw0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBDaGVja3MgaWYgd2UgYXJlIGN1cnJlbnRseSBpbiB0aGUgcGF1c2VkIG1vZGUuDQoJICoNCgkgKiBAcmV0dXJuIHtCb29sZWFufQ0KCSAqLw0KCWZ1bmN0aW9uIGlzUGF1c2VkKCkgew0KDQoJCXJldHVybiBkb20ud3JhcHBlci5jbGFzc0xpc3QuY29udGFpbnMoICdwYXVzZWQnICk7DQoNCgl9DQoNCgkvKioNCgkgKiBUb2dnbGVzIHRoZSBhdXRvIHNsaWRlIG1vZGUgb24gYW5kIG9mZi4NCgkgKg0KCSAqIEBwYXJhbSB7Qm9vbGVhbn0gW292ZXJyaWRlXSBGbGFnIHdoaWNoIHNldHMgdGhlIGRlc2lyZWQgc3RhdGUuDQoJICogVHJ1ZSBtZWFucyBhdXRvcGxheSBzdGFydHMsIGZhbHNlIG1lYW5zIGl0IHN0b3BzLg0KCSAqLw0KDQoJZnVuY3Rpb24gdG9nZ2xlQXV0b1NsaWRlKCBvdmVycmlkZSApIHsNCg0KCQlpZiggdHlwZW9mIG92ZXJyaWRlID09PSAnYm9vbGVhbicgKSB7DQoJCQlvdmVycmlkZSA/IHJlc3VtZUF1dG9TbGlkZSgpIDogcGF1c2VBdXRvU2xpZGUoKTsNCgkJfQ0KDQoJCWVsc2Ugew0KCQkJYXV0b1NsaWRlUGF1c2VkID8gcmVzdW1lQXV0b1NsaWRlKCkgOiBwYXVzZUF1dG9TbGlkZSgpOw0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBDaGVja3MgaWYgdGhlIGF1dG8gc2xpZGUgbW9kZSBpcyBjdXJyZW50bHkgb24uDQoJICoNCgkgKiBAcmV0dXJuIHtCb29sZWFufQ0KCSAqLw0KCWZ1bmN0aW9uIGlzQXV0b1NsaWRpbmcoKSB7DQoNCgkJcmV0dXJuICEhKCBhdXRvU2xpZGUgJiYgIWF1dG9TbGlkZVBhdXNlZCApOw0KDQoJfQ0KDQoJLyoqDQoJICogU3RlcHMgZnJvbSB0aGUgY3VycmVudCBwb2ludCBpbiB0aGUgcHJlc2VudGF0aW9uIHRvIHRoZQ0KCSAqIHNsaWRlIHdoaWNoIG1hdGNoZXMgdGhlIHNwZWNpZmllZCBob3Jpem9udGFsIGFuZCB2ZXJ0aWNhbA0KCSAqIGluZGljZXMuDQoJICoNCgkgKiBAcGFyYW0ge251bWJlcn0gW2g9aW5kZXhoXSBIb3Jpem9udGFsIGluZGV4IG9mIHRoZSB0YXJnZXQgc2xpZGUNCgkgKiBAcGFyYW0ge251bWJlcn0gW3Y9aW5kZXh2XSBWZXJ0aWNhbCBpbmRleCBvZiB0aGUgdGFyZ2V0IHNsaWRlDQoJICogQHBhcmFtIHtudW1iZXJ9IFtmXSBJbmRleCBvZiBhIGZyYWdtZW50IHdpdGhpbiB0aGUNCgkgKiB0YXJnZXQgc2xpZGUgdG8gYWN0aXZhdGUNCgkgKiBAcGFyYW0ge251bWJlcn0gW29dIE9yaWdpbiBmb3IgdXNlIGluIG11bHRpbWFzdGVyIGVudmlyb25tZW50cw0KCSAqLw0KCWZ1bmN0aW9uIHNsaWRlKCBoLCB2LCBmLCBvICkgew0KDQoJCS8vIFJlbWVtYmVyIHdoZXJlIHdlIHdlcmUgYXQgYmVmb3JlDQoJCXByZXZpb3VzU2xpZGUgPSBjdXJyZW50U2xpZGU7DQoNCgkJLy8gUXVlcnkgYWxsIGhvcml6b250YWwgc2xpZGVzIGluIHRoZSBkZWNrDQoJCXZhciBob3Jpem9udGFsU2xpZGVzID0gZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggSE9SSVpPTlRBTF9TTElERVNfU0VMRUNUT1IgKTsNCg0KCQkvLyBBYm9ydCBpZiB0aGVyZSBhcmUgbm8gc2xpZGVzDQoJCWlmKCBob3Jpem9udGFsU2xpZGVzLmxlbmd0aCA9PT0gMCApIHJldHVybjsNCg0KCQkvLyBJZiBubyB2ZXJ0aWNhbCBpbmRleCBpcyBzcGVjaWZpZWQgYW5kIHRoZSB1cGNvbWluZyBzbGlkZSBpcyBhDQoJCS8vIHN0YWNrLCByZXN1bWUgYXQgaXRzIHByZXZpb3VzIHZlcnRpY2FsIGluZGV4DQoJCWlmKCB2ID09PSB1bmRlZmluZWQgJiYgIWlzT3ZlcnZpZXcoKSApIHsNCgkJCXYgPSBnZXRQcmV2aW91c1ZlcnRpY2FsSW5kZXgoIGhvcml6b250YWxTbGlkZXNbIGggXSApOw0KCQl9DQoNCgkJLy8gSWYgd2Ugd2VyZSBvbiBhIHZlcnRpY2FsIHN0YWNrLCByZW1lbWJlciB3aGF0IHZlcnRpY2FsIGluZGV4DQoJCS8vIGl0IHdhcyBvbiBzbyB3ZSBjYW4gcmVzdW1lIGF0IHRoZSBzYW1lIHBvc2l0aW9uIHdoZW4gcmV0dXJuaW5nDQoJCWlmKCBwcmV2aW91c1NsaWRlICYmIHByZXZpb3VzU2xpZGUucGFyZW50Tm9kZSAmJiBwcmV2aW91c1NsaWRlLnBhcmVudE5vZGUuY2xhc3NMaXN0LmNvbnRhaW5zKCAnc3RhY2snICkgKSB7DQoJCQlzZXRQcmV2aW91c1ZlcnRpY2FsSW5kZXgoIHByZXZpb3VzU2xpZGUucGFyZW50Tm9kZSwgaW5kZXh2ICk7DQoJCX0NCg0KCQkvLyBSZW1lbWJlciB0aGUgc3RhdGUgYmVmb3JlIHRoaXMgc2xpZGUNCgkJdmFyIHN0YXRlQmVmb3JlID0gc3RhdGUuY29uY2F0KCk7DQoNCgkJLy8gUmVzZXQgdGhlIHN0YXRlIGFycmF5DQoJCXN0YXRlLmxlbmd0aCA9IDA7DQoNCgkJdmFyIGluZGV4aEJlZm9yZSA9IGluZGV4aCB8fCAwLA0KCQkJaW5kZXh2QmVmb3JlID0gaW5kZXh2IHx8IDA7DQoNCgkJLy8gQWN0aXZhdGUgYW5kIHRyYW5zaXRpb24gdG8gdGhlIG5ldyBzbGlkZQ0KCQlpbmRleGggPSB1cGRhdGVTbGlkZXMoIEhPUklaT05UQUxfU0xJREVTX1NFTEVDVE9SLCBoID09PSB1bmRlZmluZWQgPyBpbmRleGggOiBoICk7DQoJCWluZGV4diA9IHVwZGF0ZVNsaWRlcyggVkVSVElDQUxfU0xJREVTX1NFTEVDVE9SLCB2ID09PSB1bmRlZmluZWQgPyBpbmRleHYgOiB2ICk7DQoNCgkJLy8gVXBkYXRlIHRoZSB2aXNpYmlsaXR5IG9mIHNsaWRlcyBub3cgdGhhdCB0aGUgaW5kaWNlcyBoYXZlIGNoYW5nZWQNCgkJdXBkYXRlU2xpZGVzVmlzaWJpbGl0eSgpOw0KDQoJCWxheW91dCgpOw0KDQoJCS8vIEFwcGx5IHRoZSBuZXcgc3RhdGUNCgkJc3RhdGVMb29wOiBmb3IoIHZhciBpID0gMCwgbGVuID0gc3RhdGUubGVuZ3RoOyBpIDwgbGVuOyBpKysgKSB7DQoJCQkvLyBDaGVjayBpZiB0aGlzIHN0YXRlIGV4aXN0ZWQgb24gdGhlIHByZXZpb3VzIHNsaWRlLiBJZiBpdA0KCQkJLy8gZGlkLCB3ZSB3aWxsIGF2b2lkIGFkZGluZyBpdCByZXBlYXRlZGx5DQoJCQlmb3IoIHZhciBqID0gMDsgaiA8IHN0YXRlQmVmb3JlLmxlbmd0aDsgaisrICkgew0KCQkJCWlmKCBzdGF0ZUJlZm9yZVtqXSA9PT0gc3RhdGVbaV0gKSB7DQoJCQkJCXN0YXRlQmVmb3JlLnNwbGljZSggaiwgMSApOw0KCQkJCQljb250aW51ZSBzdGF0ZUxvb3A7DQoJCQkJfQ0KCQkJfQ0KDQoJCQlkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xhc3NMaXN0LmFkZCggc3RhdGVbaV0gKTsNCg0KCQkJLy8gRGlzcGF0Y2ggY3VzdG9tIGV2ZW50IG1hdGNoaW5nIHRoZSBzdGF0ZSdzIG5hbWUNCgkJCWRpc3BhdGNoRXZlbnQoIHN0YXRlW2ldICk7DQoJCX0NCg0KCQkvLyBDbGVhbiB1cCB0aGUgcmVtYWlucyBvZiB0aGUgcHJldmlvdXMgc3RhdGUNCgkJd2hpbGUoIHN0YXRlQmVmb3JlLmxlbmd0aCApIHsNCgkJCWRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCBzdGF0ZUJlZm9yZS5wb3AoKSApOw0KCQl9DQoNCgkJLy8gVXBkYXRlIHRoZSBvdmVydmlldyBpZiBpdCdzIGN1cnJlbnRseSBhY3RpdmUNCgkJaWYoIGlzT3ZlcnZpZXcoKSApIHsNCgkJCXVwZGF0ZU92ZXJ2aWV3KCk7DQoJCX0NCg0KCQkvLyBGaW5kIHRoZSBjdXJyZW50IGhvcml6b250YWwgc2xpZGUgYW5kIGFueSBwb3NzaWJsZSB2ZXJ0aWNhbCBzbGlkZXMNCgkJLy8gd2l0aGluIGl0DQoJCXZhciBjdXJyZW50SG9yaXpvbnRhbFNsaWRlID0gaG9yaXpvbnRhbFNsaWRlc1sgaW5kZXhoIF0sDQoJCQljdXJyZW50VmVydGljYWxTbGlkZXMgPSBjdXJyZW50SG9yaXpvbnRhbFNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICdzZWN0aW9uJyApOw0KDQoJCS8vIFN0b3JlIHJlZmVyZW5jZXMgdG8gdGhlIHByZXZpb3VzIGFuZCBjdXJyZW50IHNsaWRlcw0KCQljdXJyZW50U2xpZGUgPSBjdXJyZW50VmVydGljYWxTbGlkZXNbIGluZGV4diBdIHx8IGN1cnJlbnRIb3Jpem9udGFsU2xpZGU7DQoNCgkJLy8gU2hvdyBmcmFnbWVudCwgaWYgc3BlY2lmaWVkDQoJCWlmKCB0eXBlb2YgZiAhPT0gJ3VuZGVmaW5lZCcgKSB7DQoJCQluYXZpZ2F0ZUZyYWdtZW50KCBmICk7DQoJCX0NCg0KCQkvLyBEaXNwYXRjaCBhbiBldmVudCBpZiB0aGUgc2xpZGUgY2hhbmdlZA0KCQl2YXIgc2xpZGVDaGFuZ2VkID0gKCBpbmRleGggIT09IGluZGV4aEJlZm9yZSB8fCBpbmRleHYgIT09IGluZGV4dkJlZm9yZSApOw0KCQlpZiggc2xpZGVDaGFuZ2VkICkgew0KCQkJZGlzcGF0Y2hFdmVudCggJ3NsaWRlY2hhbmdlZCcsIHsNCgkJCQknaW5kZXhoJzogaW5kZXhoLA0KCQkJCSdpbmRleHYnOiBpbmRleHYsDQoJCQkJJ3ByZXZpb3VzU2xpZGUnOiBwcmV2aW91c1NsaWRlLA0KCQkJCSdjdXJyZW50U2xpZGUnOiBjdXJyZW50U2xpZGUsDQoJCQkJJ29yaWdpbic6IG8NCgkJCX0gKTsNCgkJfQ0KCQllbHNlIHsNCgkJCS8vIEVuc3VyZSB0aGF0IHRoZSBwcmV2aW91cyBzbGlkZSBpcyBuZXZlciB0aGUgc2FtZSBhcyB0aGUgY3VycmVudA0KCQkJcHJldmlvdXNTbGlkZSA9IG51bGw7DQoJCX0NCg0KCQkvLyBTb2x2ZXMgYW4gZWRnZSBjYXNlIHdoZXJlIHRoZSBwcmV2aW91cyBzbGlkZSBtYWludGFpbnMgdGhlDQoJCS8vICdwcmVzZW50JyBjbGFzcyB3aGVuIG5hdmlnYXRpbmcgYmV0d2VlbiBhZGphY2VudCB2ZXJ0aWNhbA0KCQkvLyBzdGFja3MNCgkJaWYoIHByZXZpb3VzU2xpZGUgKSB7DQoJCQlwcmV2aW91c1NsaWRlLmNsYXNzTGlzdC5yZW1vdmUoICdwcmVzZW50JyApOw0KCQkJcHJldmlvdXNTbGlkZS5zZXRBdHRyaWJ1dGUoICdhcmlhLWhpZGRlbicsICd0cnVlJyApOw0KDQoJCQkvLyBSZXNldCBhbGwgc2xpZGVzIHVwb24gbmF2aWdhdGUgdG8gaG9tZQ0KCQkJLy8gSXNzdWU6ICMyODUNCgkJCWlmICggZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvciggSE9NRV9TTElERV9TRUxFQ1RPUiApLmNsYXNzTGlzdC5jb250YWlucyggJ3ByZXNlbnQnICkgKSB7DQoJCQkJLy8gTGF1bmNoIGFzeW5jIHRhc2sNCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbiAoKSB7DQoJCQkJCXZhciBzbGlkZXMgPSB0b0FycmF5KCBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBIT1JJWk9OVEFMX1NMSURFU19TRUxFQ1RPUiArICcuc3RhY2snKSApLCBpOw0KCQkJCQlmb3IoIGkgaW4gc2xpZGVzICkgew0KCQkJCQkJaWYoIHNsaWRlc1tpXSApIHsNCgkJCQkJCQkvLyBSZXNldCBzdGFjaw0KCQkJCQkJCXNldFByZXZpb3VzVmVydGljYWxJbmRleCggc2xpZGVzW2ldLCAwICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9LCAwICk7DQoJCQl9DQoJCX0NCg0KCQkvLyBIYW5kbGUgZW1iZWRkZWQgY29udGVudA0KCQlpZiggc2xpZGVDaGFuZ2VkIHx8ICFwcmV2aW91c1NsaWRlICkgew0KCQkJc3RvcEVtYmVkZGVkQ29udGVudCggcHJldmlvdXNTbGlkZSApOw0KCQkJc3RhcnRFbWJlZGRlZENvbnRlbnQoIGN1cnJlbnRTbGlkZSApOw0KCQl9DQoNCgkJLy8gQW5ub3VuY2UgdGhlIGN1cnJlbnQgc2xpZGUgY29udGVudHMsIGZvciBzY3JlZW4gcmVhZGVycw0KCQlkb20uc3RhdHVzRGl2LnRleHRDb250ZW50ID0gZ2V0U3RhdHVzVGV4dCggY3VycmVudFNsaWRlICk7DQoNCgkJdXBkYXRlQ29udHJvbHMoKTsNCgkJdXBkYXRlUHJvZ3Jlc3MoKTsNCgkJdXBkYXRlQmFja2dyb3VuZCgpOw0KCQl1cGRhdGVQYXJhbGxheCgpOw0KCQl1cGRhdGVTbGlkZU51bWJlcigpOw0KCQl1cGRhdGVOb3RlcygpOw0KDQoJCS8vIFVwZGF0ZSB0aGUgVVJMIGhhc2gNCgkJd3JpdGVVUkwoKTsNCg0KCQljdWVBdXRvU2xpZGUoKTsNCg0KCX0NCg0KCS8qKg0KCSAqIFN5bmNzIHRoZSBwcmVzZW50YXRpb24gd2l0aCB0aGUgY3VycmVudCBET00uIFVzZWZ1bA0KCSAqIHdoZW4gbmV3IHNsaWRlcyBvciBjb250cm9sIGVsZW1lbnRzIGFyZSBhZGRlZCBvciB3aGVuDQoJICogdGhlIGNvbmZpZ3VyYXRpb24gaGFzIGNoYW5nZWQuDQoJICovDQoJZnVuY3Rpb24gc3luYygpIHsNCg0KCQkvLyBTdWJzY3JpYmUgdG8gaW5wdXQNCgkJcmVtb3ZlRXZlbnRMaXN0ZW5lcnMoKTsNCgkJYWRkRXZlbnRMaXN0ZW5lcnMoKTsNCg0KCQkvLyBGb3JjZSBhIGxheW91dCB0byBtYWtlIHN1cmUgdGhlIGN1cnJlbnQgY29uZmlnIGlzIGFjY291bnRlZCBmb3INCgkJbGF5b3V0KCk7DQoNCgkJLy8gUmVmbGVjdCB0aGUgY3VycmVudCBhdXRvU2xpZGUgdmFsdWUNCgkJYXV0b1NsaWRlID0gY29uZmlnLmF1dG9TbGlkZTsNCg0KCQkvLyBTdGFydCBhdXRvLXNsaWRpbmcgaWYgaXQncyBlbmFibGVkDQoJCWN1ZUF1dG9TbGlkZSgpOw0KDQoJCS8vIFJlLWNyZWF0ZSB0aGUgc2xpZGUgYmFja2dyb3VuZHMNCgkJY3JlYXRlQmFja2dyb3VuZHMoKTsNCg0KCQkvLyBXcml0ZSB0aGUgY3VycmVudCBoYXNoIHRvIHRoZSBVUkwNCgkJd3JpdGVVUkwoKTsNCg0KCQlzb3J0QWxsRnJhZ21lbnRzKCk7DQoNCgkJdXBkYXRlQ29udHJvbHMoKTsNCgkJdXBkYXRlUHJvZ3Jlc3MoKTsNCgkJdXBkYXRlQmFja2dyb3VuZCggdHJ1ZSApOw0KCQl1cGRhdGVTbGlkZU51bWJlcigpOw0KCQl1cGRhdGVTbGlkZXNWaXNpYmlsaXR5KCk7DQoJCXVwZGF0ZU5vdGVzKCk7DQoNCgkJZm9ybWF0RW1iZWRkZWRDb250ZW50KCk7DQoJCXN0YXJ0RW1iZWRkZWRDb250ZW50KCBjdXJyZW50U2xpZGUgKTsNCg0KCQlpZiggaXNPdmVydmlldygpICkgew0KCQkJbGF5b3V0T3ZlcnZpZXcoKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogUmVzZXRzIGFsbCB2ZXJ0aWNhbCBzbGlkZXMgc28gdGhhdCBvbmx5IHRoZSBmaXJzdA0KCSAqIGlzIHZpc2libGUuDQoJICovDQoJZnVuY3Rpb24gcmVzZXRWZXJ0aWNhbFNsaWRlcygpIHsNCg0KCQl2YXIgaG9yaXpvbnRhbFNsaWRlcyA9IHRvQXJyYXkoIGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIEhPUklaT05UQUxfU0xJREVTX1NFTEVDVE9SICkgKTsNCgkJaG9yaXpvbnRhbFNsaWRlcy5mb3JFYWNoKCBmdW5jdGlvbiggaG9yaXpvbnRhbFNsaWRlICkgew0KDQoJCQl2YXIgdmVydGljYWxTbGlkZXMgPSB0b0FycmF5KCBob3Jpem9udGFsU2xpZGUucXVlcnlTZWxlY3RvckFsbCggJ3NlY3Rpb24nICkgKTsNCgkJCXZlcnRpY2FsU2xpZGVzLmZvckVhY2goIGZ1bmN0aW9uKCB2ZXJ0aWNhbFNsaWRlLCB5ICkgew0KDQoJCQkJaWYoIHkgPiAwICkgew0KCQkJCQl2ZXJ0aWNhbFNsaWRlLmNsYXNzTGlzdC5yZW1vdmUoICdwcmVzZW50JyApOw0KCQkJCQl2ZXJ0aWNhbFNsaWRlLmNsYXNzTGlzdC5yZW1vdmUoICdwYXN0JyApOw0KCQkJCQl2ZXJ0aWNhbFNsaWRlLmNsYXNzTGlzdC5hZGQoICdmdXR1cmUnICk7DQoJCQkJCXZlcnRpY2FsU2xpZGUuc2V0QXR0cmlidXRlKCAnYXJpYS1oaWRkZW4nLCAndHJ1ZScgKTsNCgkJCQl9DQoNCgkJCX0gKTsNCg0KCQl9ICk7DQoNCgl9DQoNCgkvKioNCgkgKiBTb3J0cyBhbmQgZm9ybWF0cyBhbGwgb2YgZnJhZ21lbnRzIGluIHRoZQ0KCSAqIHByZXNlbnRhdGlvbi4NCgkgKi8NCglmdW5jdGlvbiBzb3J0QWxsRnJhZ21lbnRzKCkgew0KDQoJCXZhciBob3Jpem9udGFsU2xpZGVzID0gdG9BcnJheSggZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggSE9SSVpPTlRBTF9TTElERVNfU0VMRUNUT1IgKSApOw0KCQlob3Jpem9udGFsU2xpZGVzLmZvckVhY2goIGZ1bmN0aW9uKCBob3Jpem9udGFsU2xpZGUgKSB7DQoNCgkJCXZhciB2ZXJ0aWNhbFNsaWRlcyA9IHRvQXJyYXkoIGhvcml6b250YWxTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnc2VjdGlvbicgKSApOw0KCQkJdmVydGljYWxTbGlkZXMuZm9yRWFjaCggZnVuY3Rpb24oIHZlcnRpY2FsU2xpZGUsIHkgKSB7DQoNCgkJCQlzb3J0RnJhZ21lbnRzKCB2ZXJ0aWNhbFNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICcuZnJhZ21lbnQnICkgKTsNCg0KCQkJfSApOw0KDQoJCQlpZiggdmVydGljYWxTbGlkZXMubGVuZ3RoID09PSAwICkgc29ydEZyYWdtZW50cyggaG9yaXpvbnRhbFNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICcuZnJhZ21lbnQnICkgKTsNCg0KCQl9ICk7DQoNCgl9DQoNCgkvKioNCgkgKiBSYW5kb21seSBzaHVmZmxlcyBhbGwgc2xpZGVzIGluIHRoZSBkZWNrLg0KCSAqLw0KCWZ1bmN0aW9uIHNodWZmbGUoKSB7DQoNCgkJdmFyIHNsaWRlcyA9IHRvQXJyYXkoIGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIEhPUklaT05UQUxfU0xJREVTX1NFTEVDVE9SICkgKTsNCg0KCQlzbGlkZXMuZm9yRWFjaCggZnVuY3Rpb24oIHNsaWRlICkgew0KDQoJCQkvLyBJbnNlcnQgdGhpcyBzbGlkZSBuZXh0IHRvIGFub3RoZXIgcmFuZG9tIHNsaWRlLiBUaGlzIG1heQ0KCQkJLy8gY2F1c2UgdGhlIHNsaWRlIHRvIGluc2VydCBiZWZvcmUgaXRzZWxmIGJ1dCB0aGF0J3MgZmluZS4NCgkJCWRvbS5zbGlkZXMuaW5zZXJ0QmVmb3JlKCBzbGlkZSwgc2xpZGVzWyBNYXRoLmZsb29yKCBNYXRoLnJhbmRvbSgpICogc2xpZGVzLmxlbmd0aCApIF0gKTsNCg0KCQl9ICk7DQoNCgl9DQoNCgkvKioNCgkgKiBVcGRhdGVzIG9uZSBkaW1lbnNpb24gb2Ygc2xpZGVzIGJ5IHNob3dpbmcgdGhlIHNsaWRlDQoJICogd2l0aCB0aGUgc3BlY2lmaWVkIGluZGV4Lg0KCSAqDQoJICogQHBhcmFtIHtzdHJpbmd9IHNlbGVjdG9yIEEgQ1NTIHNlbGVjdG9yIHRoYXQgd2lsbCBmZXRjaA0KCSAqIHRoZSBncm91cCBvZiBzbGlkZXMgd2UgYXJlIHdvcmtpbmcgd2l0aA0KCSAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCBUaGUgaW5kZXggb2YgdGhlIHNsaWRlIHRoYXQgc2hvdWxkIGJlDQoJICogc2hvd24NCgkgKg0KCSAqIEByZXR1cm4ge251bWJlcn0gVGhlIGluZGV4IG9mIHRoZSBzbGlkZSB0aGF0IGlzIG5vdyBzaG93biwNCgkgKiBtaWdodCBkaWZmZXIgZnJvbSB0aGUgcGFzc2VkIGluIGluZGV4IGlmIGl0IHdhcyBvdXQgb2YNCgkgKiBib3VuZHMuDQoJICovDQoJZnVuY3Rpb24gdXBkYXRlU2xpZGVzKCBzZWxlY3RvciwgaW5kZXggKSB7DQoNCgkJLy8gU2VsZWN0IGFsbCBzbGlkZXMgYW5kIGNvbnZlcnQgdGhlIE5vZGVMaXN0IHJlc3VsdCB0bw0KCQkvLyBhbiBhcnJheQ0KCQl2YXIgc2xpZGVzID0gdG9BcnJheSggZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggc2VsZWN0b3IgKSApLA0KCQkJc2xpZGVzTGVuZ3RoID0gc2xpZGVzLmxlbmd0aDsNCg0KCQl2YXIgcHJpbnRNb2RlID0gaXNQcmludGluZ1BERigpOw0KDQoJCWlmKCBzbGlkZXNMZW5ndGggKSB7DQoNCgkJCS8vIFNob3VsZCB0aGUgaW5kZXggbG9vcD8NCgkJCWlmKCBjb25maWcubG9vcCApIHsNCgkJCQlpbmRleCAlPSBzbGlkZXNMZW5ndGg7DQoNCgkJCQlpZiggaW5kZXggPCAwICkgew0KCQkJCQlpbmRleCA9IHNsaWRlc0xlbmd0aCArIGluZGV4Ow0KCQkJCX0NCgkJCX0NCg0KCQkJLy8gRW5mb3JjZSBtYXggYW5kIG1pbmltdW0gaW5kZXggYm91bmRzDQoJCQlpbmRleCA9IE1hdGgubWF4KCBNYXRoLm1pbiggaW5kZXgsIHNsaWRlc0xlbmd0aCAtIDEgKSwgMCApOw0KDQoJCQlmb3IoIHZhciBpID0gMDsgaSA8IHNsaWRlc0xlbmd0aDsgaSsrICkgew0KCQkJCXZhciBlbGVtZW50ID0gc2xpZGVzW2ldOw0KDQoJCQkJdmFyIHJldmVyc2UgPSBjb25maWcucnRsICYmICFpc1ZlcnRpY2FsU2xpZGUoIGVsZW1lbnQgKTsNCg0KCQkJCWVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSggJ3Bhc3QnICk7DQoJCQkJZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCAncHJlc2VudCcgKTsNCgkJCQllbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoICdmdXR1cmUnICk7DQoNCgkJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9odG1sL3dnL2RyYWZ0cy9odG1sL21hc3Rlci9lZGl0aW5nLmh0bWwjdGhlLWhpZGRlbi1hdHRyaWJ1dGUNCgkJCQllbGVtZW50LnNldEF0dHJpYnV0ZSggJ2hpZGRlbicsICcnICk7DQoJCQkJZWxlbWVudC5zZXRBdHRyaWJ1dGUoICdhcmlhLWhpZGRlbicsICd0cnVlJyApOw0KDQoJCQkJLy8gSWYgdGhpcyBlbGVtZW50IGNvbnRhaW5zIHZlcnRpY2FsIHNsaWRlcw0KCQkJCWlmKCBlbGVtZW50LnF1ZXJ5U2VsZWN0b3IoICdzZWN0aW9uJyApICkgew0KCQkJCQllbGVtZW50LmNsYXNzTGlzdC5hZGQoICdzdGFjaycgKTsNCgkJCQl9DQoNCgkJCQkvLyBJZiB3ZSdyZSBwcmludGluZyBzdGF0aWMgc2xpZGVzLCBhbGwgc2xpZGVzIGFyZSAicHJlc2VudCINCgkJCQlpZiggcHJpbnRNb2RlICkgew0KCQkJCQllbGVtZW50LmNsYXNzTGlzdC5hZGQoICdwcmVzZW50JyApOw0KCQkJCQljb250aW51ZTsNCgkJCQl9DQoNCgkJCQlpZiggaSA8IGluZGV4ICkgew0KCQkJCQkvLyBBbnkgZWxlbWVudCBwcmV2aW91cyB0byBpbmRleCBpcyBnaXZlbiB0aGUgJ3Bhc3QnIGNsYXNzDQoJCQkJCWVsZW1lbnQuY2xhc3NMaXN0LmFkZCggcmV2ZXJzZSA/ICdmdXR1cmUnIDogJ3Bhc3QnICk7DQoNCgkJCQkJaWYoIGNvbmZpZy5mcmFnbWVudHMgKSB7DQoJCQkJCQl2YXIgcGFzdEZyYWdtZW50cyA9IHRvQXJyYXkoIGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCggJy5mcmFnbWVudCcgKSApOw0KDQoJCQkJCQkvLyBTaG93IGFsbCBmcmFnbWVudHMgb24gcHJpb3Igc2xpZGVzDQoJCQkJCQl3aGlsZSggcGFzdEZyYWdtZW50cy5sZW5ndGggKSB7DQoJCQkJCQkJdmFyIHBhc3RGcmFnbWVudCA9IHBhc3RGcmFnbWVudHMucG9wKCk7DQoJCQkJCQkJcGFzdEZyYWdtZW50LmNsYXNzTGlzdC5hZGQoICd2aXNpYmxlJyApOw0KCQkJCQkJCXBhc3RGcmFnbWVudC5jbGFzc0xpc3QucmVtb3ZlKCAnY3VycmVudC1mcmFnbWVudCcgKTsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCX0NCgkJCQllbHNlIGlmKCBpID4gaW5kZXggKSB7DQoJCQkJCS8vIEFueSBlbGVtZW50IHN1YnNlcXVlbnQgdG8gaW5kZXggaXMgZ2l2ZW4gdGhlICdmdXR1cmUnIGNsYXNzDQoJCQkJCWVsZW1lbnQuY2xhc3NMaXN0LmFkZCggcmV2ZXJzZSA/ICdwYXN0JyA6ICdmdXR1cmUnICk7DQoNCgkJCQkJaWYoIGNvbmZpZy5mcmFnbWVudHMgKSB7DQoJCQkJCQl2YXIgZnV0dXJlRnJhZ21lbnRzID0gdG9BcnJheSggZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCAnLmZyYWdtZW50LnZpc2libGUnICkgKTsNCg0KCQkJCQkJLy8gTm8gZnJhZ21lbnRzIGluIGZ1dHVyZSBzbGlkZXMgc2hvdWxkIGJlIHZpc2libGUgYWhlYWQgb2YgdGltZQ0KCQkJCQkJd2hpbGUoIGZ1dHVyZUZyYWdtZW50cy5sZW5ndGggKSB7DQoJCQkJCQkJdmFyIGZ1dHVyZUZyYWdtZW50ID0gZnV0dXJlRnJhZ21lbnRzLnBvcCgpOw0KCQkJCQkJCWZ1dHVyZUZyYWdtZW50LmNsYXNzTGlzdC5yZW1vdmUoICd2aXNpYmxlJyApOw0KCQkJCQkJCWZ1dHVyZUZyYWdtZW50LmNsYXNzTGlzdC5yZW1vdmUoICdjdXJyZW50LWZyYWdtZW50JyApOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KCQkJfQ0KDQoJCQkvLyBNYXJrIHRoZSBjdXJyZW50IHNsaWRlIGFzIHByZXNlbnQNCgkJCXNsaWRlc1tpbmRleF0uY2xhc3NMaXN0LmFkZCggJ3ByZXNlbnQnICk7DQoJCQlzbGlkZXNbaW5kZXhdLnJlbW92ZUF0dHJpYnV0ZSggJ2hpZGRlbicgKTsNCgkJCXNsaWRlc1tpbmRleF0ucmVtb3ZlQXR0cmlidXRlKCAnYXJpYS1oaWRkZW4nICk7DQoNCgkJCS8vIElmIHRoaXMgc2xpZGUgaGFzIGEgc3RhdGUgYXNzb2NpYXRlZCB3aXRoIGl0LCBhZGQgaXQNCgkJCS8vIG9udG8gdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGRlY2sNCgkJCXZhciBzbGlkZVN0YXRlID0gc2xpZGVzW2luZGV4XS5nZXRBdHRyaWJ1dGUoICdkYXRhLXN0YXRlJyApOw0KCQkJaWYoIHNsaWRlU3RhdGUgKSB7DQoJCQkJc3RhdGUgPSBzdGF0ZS5jb25jYXQoIHNsaWRlU3RhdGUuc3BsaXQoICcgJyApICk7DQoJCQl9DQoNCgkJfQ0KCQllbHNlIHsNCgkJCS8vIFNpbmNlIHRoZXJlIGFyZSBubyBzbGlkZXMgd2UgY2FuJ3QgYmUgYW55d2hlcmUgYmV5b25kIHRoZQ0KCQkJLy8gemVyb3RoIGluZGV4DQoJCQlpbmRleCA9IDA7DQoJCX0NCg0KCQlyZXR1cm4gaW5kZXg7DQoNCgl9DQoNCgkvKioNCgkgKiBPcHRpbWl6YXRpb24gbWV0aG9kOyBoaWRlIGFsbCBzbGlkZXMgdGhhdCBhcmUgZmFyIGF3YXkNCgkgKiBmcm9tIHRoZSBwcmVzZW50IHNsaWRlLg0KCSAqLw0KCWZ1bmN0aW9uIHVwZGF0ZVNsaWRlc1Zpc2liaWxpdHkoKSB7DQoNCgkJLy8gU2VsZWN0IGFsbCBzbGlkZXMgYW5kIGNvbnZlcnQgdGhlIE5vZGVMaXN0IHJlc3VsdCB0bw0KCQkvLyBhbiBhcnJheQ0KCQl2YXIgaG9yaXpvbnRhbFNsaWRlcyA9IHRvQXJyYXkoIGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIEhPUklaT05UQUxfU0xJREVTX1NFTEVDVE9SICkgKSwNCgkJCWhvcml6b250YWxTbGlkZXNMZW5ndGggPSBob3Jpem9udGFsU2xpZGVzLmxlbmd0aCwNCgkJCWRpc3RhbmNlWCwNCgkJCWRpc3RhbmNlWTsNCg0KCQlpZiggaG9yaXpvbnRhbFNsaWRlc0xlbmd0aCAmJiB0eXBlb2YgaW5kZXhoICE9PSAndW5kZWZpbmVkJyApIHsNCg0KCQkJLy8gVGhlIG51bWJlciBvZiBzdGVwcyBhd2F5IGZyb20gdGhlIHByZXNlbnQgc2xpZGUgdGhhdCB3aWxsDQoJCQkvLyBiZSB2aXNpYmxlDQoJCQl2YXIgdmlld0Rpc3RhbmNlID0gaXNPdmVydmlldygpID8gMTAgOiBjb25maWcudmlld0Rpc3RhbmNlOw0KDQoJCQkvLyBMaW1pdCB2aWV3IGRpc3RhbmNlIG9uIHdlYWtlciBkZXZpY2VzDQoJCQlpZiggaXNNb2JpbGVEZXZpY2UgKSB7DQoJCQkJdmlld0Rpc3RhbmNlID0gaXNPdmVydmlldygpID8gNiA6IDI7DQoJCQl9DQoNCgkJCS8vIEFsbCBzbGlkZXMgbmVlZCB0byBiZSB2aXNpYmxlIHdoZW4gZXhwb3J0aW5nIHRvIFBERg0KCQkJaWYoIGlzUHJpbnRpbmdQREYoKSApIHsNCgkJCQl2aWV3RGlzdGFuY2UgPSBOdW1iZXIuTUFYX1ZBTFVFOw0KCQkJfQ0KDQoJCQlmb3IoIHZhciB4ID0gMDsgeCA8IGhvcml6b250YWxTbGlkZXNMZW5ndGg7IHgrKyApIHsNCgkJCQl2YXIgaG9yaXpvbnRhbFNsaWRlID0gaG9yaXpvbnRhbFNsaWRlc1t4XTsNCg0KCQkJCXZhciB2ZXJ0aWNhbFNsaWRlcyA9IHRvQXJyYXkoIGhvcml6b250YWxTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnc2VjdGlvbicgKSApLA0KCQkJCQl2ZXJ0aWNhbFNsaWRlc0xlbmd0aCA9IHZlcnRpY2FsU2xpZGVzLmxlbmd0aDsNCg0KCQkJCS8vIERldGVybWluZSBob3cgZmFyIGF3YXkgdGhpcyBzbGlkZSBpcyBmcm9tIHRoZSBwcmVzZW50DQoJCQkJZGlzdGFuY2VYID0gTWF0aC5hYnMoICggaW5kZXhoIHx8IDAgKSAtIHggKSB8fCAwOw0KDQoJCQkJLy8gSWYgdGhlIHByZXNlbnRhdGlvbiBpcyBsb29wZWQsIGRpc3RhbmNlIHNob3VsZCBtZWFzdXJlDQoJCQkJLy8gMSBiZXR3ZWVuIHRoZSBmaXJzdCBhbmQgbGFzdCBzbGlkZXMNCgkJCQlpZiggY29uZmlnLmxvb3AgKSB7DQoJCQkJCWRpc3RhbmNlWCA9IE1hdGguYWJzKCAoICggaW5kZXhoIHx8IDAgKSAtIHggKSAlICggaG9yaXpvbnRhbFNsaWRlc0xlbmd0aCAtIHZpZXdEaXN0YW5jZSApICkgfHwgMDsNCgkJCQl9DQoNCgkJCQkvLyBTaG93IHRoZSBob3Jpem9udGFsIHNsaWRlIGlmIGl0J3Mgd2l0aGluIHRoZSB2aWV3IGRpc3RhbmNlDQoJCQkJaWYoIGRpc3RhbmNlWCA8IHZpZXdEaXN0YW5jZSApIHsNCgkJCQkJc2hvd1NsaWRlKCBob3Jpem9udGFsU2xpZGUgKTsNCgkJCQl9DQoJCQkJZWxzZSB7DQoJCQkJCWhpZGVTbGlkZSggaG9yaXpvbnRhbFNsaWRlICk7DQoJCQkJfQ0KDQoJCQkJaWYoIHZlcnRpY2FsU2xpZGVzTGVuZ3RoICkgew0KDQoJCQkJCXZhciBveSA9IGdldFByZXZpb3VzVmVydGljYWxJbmRleCggaG9yaXpvbnRhbFNsaWRlICk7DQoNCgkJCQkJZm9yKCB2YXIgeSA9IDA7IHkgPCB2ZXJ0aWNhbFNsaWRlc0xlbmd0aDsgeSsrICkgew0KCQkJCQkJdmFyIHZlcnRpY2FsU2xpZGUgPSB2ZXJ0aWNhbFNsaWRlc1t5XTsNCg0KCQkJCQkJZGlzdGFuY2VZID0geCA9PT0gKCBpbmRleGggfHwgMCApID8gTWF0aC5hYnMoICggaW5kZXh2IHx8IDAgKSAtIHkgKSA6IE1hdGguYWJzKCB5IC0gb3kgKTsNCg0KCQkJCQkJaWYoIGRpc3RhbmNlWCArIGRpc3RhbmNlWSA8IHZpZXdEaXN0YW5jZSApIHsNCgkJCQkJCQlzaG93U2xpZGUoIHZlcnRpY2FsU2xpZGUgKTsNCgkJCQkJCX0NCgkJCQkJCWVsc2Ugew0KCQkJCQkJCWhpZGVTbGlkZSggdmVydGljYWxTbGlkZSApOw0KCQkJCQkJfQ0KCQkJCQl9DQoNCgkJCQl9DQoJCQl9DQoNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogUGljayB1cCBub3RlcyBmcm9tIHRoZSBjdXJyZW50IHNsaWRlIGFuZCBkaXNwbGF5IHRoZW0NCgkgKiB0byB0aGUgdmlld2VyLg0KCSAqDQoJICogQHNlZSB7QGxpbmsgY29uZmlnLnNob3dOb3Rlc30NCgkgKi8NCglmdW5jdGlvbiB1cGRhdGVOb3RlcygpIHsNCg0KCQlpZiggY29uZmlnLnNob3dOb3RlcyAmJiBkb20uc3BlYWtlck5vdGVzICYmIGN1cnJlbnRTbGlkZSAmJiAhaXNQcmludGluZ1BERigpICkgew0KDQoJCQlkb20uc3BlYWtlck5vdGVzLmlubmVySFRNTCA9IGdldFNsaWRlTm90ZXMoKSB8fCAnJzsNCg0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBVcGRhdGVzIHRoZSBwcm9ncmVzcyBiYXIgdG8gcmVmbGVjdCB0aGUgY3VycmVudCBzbGlkZS4NCgkgKi8NCglmdW5jdGlvbiB1cGRhdGVQcm9ncmVzcygpIHsNCg0KCQkvLyBVcGRhdGUgcHJvZ3Jlc3MgaWYgZW5hYmxlZA0KCQlpZiggY29uZmlnLnByb2dyZXNzICYmIGRvbS5wcm9ncmVzc2JhciApIHsNCg0KCQkJZG9tLnByb2dyZXNzYmFyLnN0eWxlLndpZHRoID0gZ2V0UHJvZ3Jlc3MoKSAqIGRvbS53cmFwcGVyLm9mZnNldFdpZHRoICsgJ3B4JzsNCg0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBVcGRhdGVzIHRoZSBzbGlkZSBudW1iZXIgZGl2IHRvIHJlZmxlY3QgdGhlIGN1cnJlbnQgc2xpZGUuDQoJICoNCgkgKiBUaGUgZm9sbG93aW5nIHNsaWRlIG51bWJlciBmb3JtYXRzIGFyZSBhdmFpbGFibGU6DQoJICogICJoLnYiOglob3Jpem9udGFsIC4gdmVydGljYWwgc2xpZGUgbnVtYmVyIChkZWZhdWx0KQ0KCSAqICAiaC92IjoJaG9yaXpvbnRhbCAvIHZlcnRpY2FsIHNsaWRlIG51bWJlcg0KCSAqICAgICJjIjoJZmxhdHRlbmVkIHNsaWRlIG51bWJlcg0KCSAqICAiYy90IjoJZmxhdHRlbmVkIHNsaWRlIG51bWJlciAvIHRvdGFsIHNsaWRlcw0KCSAqLw0KCWZ1bmN0aW9uIHVwZGF0ZVNsaWRlTnVtYmVyKCkgew0KDQoJCS8vIFVwZGF0ZSBzbGlkZSBudW1iZXIgaWYgZW5hYmxlZA0KCQlpZiggY29uZmlnLnNsaWRlTnVtYmVyICYmIGRvbS5zbGlkZU51bWJlciApIHsNCg0KCQkJdmFyIHZhbHVlID0gW107DQoJCQl2YXIgZm9ybWF0ID0gJ2gudic7DQoNCgkJCS8vIENoZWNrIGlmIGEgY3VzdG9tIG51bWJlciBmb3JtYXQgaXMgYXZhaWxhYmxlDQoJCQlpZiggdHlwZW9mIGNvbmZpZy5zbGlkZU51bWJlciA9PT0gJ3N0cmluZycgKSB7DQoJCQkJZm9ybWF0ID0gY29uZmlnLnNsaWRlTnVtYmVyOw0KCQkJfQ0KDQoJCQlzd2l0Y2goIGZvcm1hdCApIHsNCgkJCQljYXNlICdjJzoNCgkJCQkJdmFsdWUucHVzaCggZ2V0U2xpZGVQYXN0Q291bnQoKSArIDEgKTsNCgkJCQkJYnJlYWs7DQoJCQkJY2FzZSAnYy90JzoNCgkJCQkJdmFsdWUucHVzaCggZ2V0U2xpZGVQYXN0Q291bnQoKSArIDEsICcvJywgZ2V0VG90YWxTbGlkZXMoKSApOw0KCQkJCQlicmVhazsNCgkJCQljYXNlICdoL3YnOg0KCQkJCQl2YWx1ZS5wdXNoKCBpbmRleGggKyAxICk7DQoJCQkJCWlmKCBpc1ZlcnRpY2FsU2xpZGUoKSApIHZhbHVlLnB1c2goICcvJywgaW5kZXh2ICsgMSApOw0KCQkJCQlicmVhazsNCgkJCQlkZWZhdWx0Og0KCQkJCQl2YWx1ZS5wdXNoKCBpbmRleGggKyAxICk7DQoJCQkJCWlmKCBpc1ZlcnRpY2FsU2xpZGUoKSApIHZhbHVlLnB1c2goICcuJywgaW5kZXh2ICsgMSApOw0KCQkJfQ0KDQoJCQlkb20uc2xpZGVOdW1iZXIuaW5uZXJIVE1MID0gZm9ybWF0U2xpZGVOdW1iZXIoIHZhbHVlWzBdLCB2YWx1ZVsxXSwgdmFsdWVbMl0gKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogQXBwbGllcyBIVE1MIGZvcm1hdHRpbmcgdG8gYSBzbGlkZSBudW1iZXIgYmVmb3JlIGl0J3MNCgkgKiB3cml0dGVuIHRvIHRoZSBET00uDQoJICoNCgkgKiBAcGFyYW0ge251bWJlcn0gYSBDdXJyZW50IHNsaWRlDQoJICogQHBhcmFtIHtzdHJpbmd9IGRlbGltaXRlciBDaGFyYWN0ZXIgdG8gc2VwYXJhdGUgc2xpZGUgbnVtYmVycw0KCSAqIEBwYXJhbSB7KG51bWJlcnwqKX0gYiBUb3RhbCBzbGlkZXMNCgkgKiBAcmV0dXJuIHtzdHJpbmd9IEhUTUwgc3RyaW5nIGZyYWdtZW50DQoJICovDQoJZnVuY3Rpb24gZm9ybWF0U2xpZGVOdW1iZXIoIGEsIGRlbGltaXRlciwgYiApIHsNCg0KCQlpZiggdHlwZW9mIGIgPT09ICdudW1iZXInICYmICFpc05hTiggYiApICkgew0KCQkJcmV0dXJuICAnPHNwYW4gY2xhc3M9InNsaWRlLW51bWJlci1hIj4nKyBhICsnPC9zcGFuPicgKw0KCQkJCQknPHNwYW4gY2xhc3M9InNsaWRlLW51bWJlci1kZWxpbWl0ZXIiPicrIGRlbGltaXRlciArJzwvc3Bhbj4nICsNCgkJCQkJJzxzcGFuIGNsYXNzPSJzbGlkZS1udW1iZXItYiI+JysgYiArJzwvc3Bhbj4nOw0KCQl9DQoJCWVsc2Ugew0KCQkJcmV0dXJuICc8c3BhbiBjbGFzcz0ic2xpZGUtbnVtYmVyLWEiPicrIGEgKyc8L3NwYW4+JzsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogVXBkYXRlcyB0aGUgc3RhdGUgb2YgYWxsIGNvbnRyb2wvbmF2aWdhdGlvbiBhcnJvd3MuDQoJICovDQoJZnVuY3Rpb24gdXBkYXRlQ29udHJvbHMoKSB7DQoNCgkJdmFyIHJvdXRlcyA9IGF2YWlsYWJsZVJvdXRlcygpOw0KCQl2YXIgZnJhZ21lbnRzID0gYXZhaWxhYmxlRnJhZ21lbnRzKCk7DQoNCgkJLy8gUmVtb3ZlIHRoZSAnZW5hYmxlZCcgY2xhc3MgZnJvbSBhbGwgZGlyZWN0aW9ucw0KCQlkb20uY29udHJvbHNMZWZ0LmNvbmNhdCggZG9tLmNvbnRyb2xzUmlnaHQgKQ0KCQkJCQkJLmNvbmNhdCggZG9tLmNvbnRyb2xzVXAgKQ0KCQkJCQkJLmNvbmNhdCggZG9tLmNvbnRyb2xzRG93biApDQoJCQkJCQkuY29uY2F0KCBkb20uY29udHJvbHNQcmV2ICkNCgkJCQkJCS5jb25jYXQoIGRvbS5jb250cm9sc05leHQgKS5mb3JFYWNoKCBmdW5jdGlvbiggbm9kZSApIHsNCgkJCW5vZGUuY2xhc3NMaXN0LnJlbW92ZSggJ2VuYWJsZWQnICk7DQoJCQlub2RlLmNsYXNzTGlzdC5yZW1vdmUoICdmcmFnbWVudGVkJyApOw0KDQoJCQkvLyBTZXQgJ2Rpc2FibGVkJyBhdHRyaWJ1dGUgb24gYWxsIGRpcmVjdGlvbnMNCgkJCW5vZGUuc2V0QXR0cmlidXRlKCAnZGlzYWJsZWQnLCAnZGlzYWJsZWQnICk7DQoJCX0gKTsNCg0KCQkvLyBBZGQgdGhlICdlbmFibGVkJyBjbGFzcyB0byB0aGUgYXZhaWxhYmxlIHJvdXRlczsgcmVtb3ZlICdkaXNhYmxlZCcgYXR0cmlidXRlIHRvIGVuYWJsZSBidXR0b25zDQoJCWlmKCByb3V0ZXMubGVmdCApIGRvbS5jb250cm9sc0xlZnQuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5jbGFzc0xpc3QuYWRkKCAnZW5hYmxlZCcgKTsgZWwucmVtb3ZlQXR0cmlidXRlKCAnZGlzYWJsZWQnICk7IH0gKTsNCgkJaWYoIHJvdXRlcy5yaWdodCApIGRvbS5jb250cm9sc1JpZ2h0LmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsgZWwuY2xhc3NMaXN0LmFkZCggJ2VuYWJsZWQnICk7IGVsLnJlbW92ZUF0dHJpYnV0ZSggJ2Rpc2FibGVkJyApOyB9ICk7DQoJCWlmKCByb3V0ZXMudXAgKSBkb20uY29udHJvbHNVcC5mb3JFYWNoKCBmdW5jdGlvbiggZWwgKSB7IGVsLmNsYXNzTGlzdC5hZGQoICdlbmFibGVkJyApOyBlbC5yZW1vdmVBdHRyaWJ1dGUoICdkaXNhYmxlZCcgKTsgfSApOw0KCQlpZiggcm91dGVzLmRvd24gKSBkb20uY29udHJvbHNEb3duLmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsgZWwuY2xhc3NMaXN0LmFkZCggJ2VuYWJsZWQnICk7IGVsLnJlbW92ZUF0dHJpYnV0ZSggJ2Rpc2FibGVkJyApOyB9ICk7DQoNCgkJLy8gUHJldi9uZXh0IGJ1dHRvbnMNCgkJaWYoIHJvdXRlcy5sZWZ0IHx8IHJvdXRlcy51cCApIGRvbS5jb250cm9sc1ByZXYuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5jbGFzc0xpc3QuYWRkKCAnZW5hYmxlZCcgKTsgZWwucmVtb3ZlQXR0cmlidXRlKCAnZGlzYWJsZWQnICk7IH0gKTsNCgkJaWYoIHJvdXRlcy5yaWdodCB8fCByb3V0ZXMuZG93biApIGRvbS5jb250cm9sc05leHQuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5jbGFzc0xpc3QuYWRkKCAnZW5hYmxlZCcgKTsgZWwucmVtb3ZlQXR0cmlidXRlKCAnZGlzYWJsZWQnICk7IH0gKTsNCg0KCQkvLyBIaWdobGlnaHQgZnJhZ21lbnQgZGlyZWN0aW9ucw0KCQlpZiggY3VycmVudFNsaWRlICkgew0KDQoJCQkvLyBBbHdheXMgYXBwbHkgZnJhZ21lbnQgZGVjb3JhdG9yIHRvIHByZXYvbmV4dCBidXR0b25zDQoJCQlpZiggZnJhZ21lbnRzLnByZXYgKSBkb20uY29udHJvbHNQcmV2LmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsgZWwuY2xhc3NMaXN0LmFkZCggJ2ZyYWdtZW50ZWQnLCAnZW5hYmxlZCcgKTsgZWwucmVtb3ZlQXR0cmlidXRlKCAnZGlzYWJsZWQnICk7IH0gKTsNCgkJCWlmKCBmcmFnbWVudHMubmV4dCApIGRvbS5jb250cm9sc05leHQuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5jbGFzc0xpc3QuYWRkKCAnZnJhZ21lbnRlZCcsICdlbmFibGVkJyApOyBlbC5yZW1vdmVBdHRyaWJ1dGUoICdkaXNhYmxlZCcgKTsgfSApOw0KDQoJCQkvLyBBcHBseSBmcmFnbWVudCBkZWNvcmF0b3JzIHRvIGRpcmVjdGlvbmFsIGJ1dHRvbnMgYmFzZWQgb24NCgkJCS8vIHdoYXQgc2xpZGUgYXhpcyB0aGV5IGFyZSBpbg0KCQkJaWYoIGlzVmVydGljYWxTbGlkZSggY3VycmVudFNsaWRlICkgKSB7DQoJCQkJaWYoIGZyYWdtZW50cy5wcmV2ICkgZG9tLmNvbnRyb2xzVXAuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5jbGFzc0xpc3QuYWRkKCAnZnJhZ21lbnRlZCcsICdlbmFibGVkJyApOyBlbC5yZW1vdmVBdHRyaWJ1dGUoICdkaXNhYmxlZCcgKTsgfSApOw0KCQkJCWlmKCBmcmFnbWVudHMubmV4dCApIGRvbS5jb250cm9sc0Rvd24uZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5jbGFzc0xpc3QuYWRkKCAnZnJhZ21lbnRlZCcsICdlbmFibGVkJyApOyBlbC5yZW1vdmVBdHRyaWJ1dGUoICdkaXNhYmxlZCcgKTsgfSApOw0KCQkJfQ0KCQkJZWxzZSB7DQoJCQkJaWYoIGZyYWdtZW50cy5wcmV2ICkgZG9tLmNvbnRyb2xzTGVmdC5mb3JFYWNoKCBmdW5jdGlvbiggZWwgKSB7IGVsLmNsYXNzTGlzdC5hZGQoICdmcmFnbWVudGVkJywgJ2VuYWJsZWQnICk7IGVsLnJlbW92ZUF0dHJpYnV0ZSggJ2Rpc2FibGVkJyApOyB9ICk7DQoJCQkJaWYoIGZyYWdtZW50cy5uZXh0ICkgZG9tLmNvbnRyb2xzUmlnaHQuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgeyBlbC5jbGFzc0xpc3QuYWRkKCAnZnJhZ21lbnRlZCcsICdlbmFibGVkJyApOyBlbC5yZW1vdmVBdHRyaWJ1dGUoICdkaXNhYmxlZCcgKTsgfSApOw0KCQkJfQ0KDQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIFVwZGF0ZXMgdGhlIGJhY2tncm91bmQgZWxlbWVudHMgdG8gcmVmbGVjdCB0aGUgY3VycmVudA0KCSAqIHNsaWRlLg0KCSAqDQoJICogQHBhcmFtIHtib29sZWFufSBpbmNsdWRlQWxsIElmIHRydWUsIHRoZSBiYWNrZ3JvdW5kcyBvZg0KCSAqIGFsbCB2ZXJ0aWNhbCBzbGlkZXMgKG5vdCBqdXN0IHRoZSBwcmVzZW50KSB3aWxsIGJlIHVwZGF0ZWQuDQoJICovDQoJZnVuY3Rpb24gdXBkYXRlQmFja2dyb3VuZCggaW5jbHVkZUFsbCApIHsNCg0KCQl2YXIgY3VycmVudEJhY2tncm91bmQgPSBudWxsOw0KDQoJCS8vIFJldmVyc2UgcGFzdC9mdXR1cmUgY2xhc3NlcyB3aGVuIGluIFJUTCBtb2RlDQoJCXZhciBob3Jpem9udGFsUGFzdCA9IGNvbmZpZy5ydGwgPyAnZnV0dXJlJyA6ICdwYXN0JywNCgkJCWhvcml6b250YWxGdXR1cmUgPSBjb25maWcucnRsID8gJ3Bhc3QnIDogJ2Z1dHVyZSc7DQoNCgkJLy8gVXBkYXRlIHRoZSBjbGFzc2VzIG9mIGFsbCBiYWNrZ3JvdW5kcyB0byBtYXRjaCB0aGUNCgkJLy8gc3RhdGVzIG9mIHRoZWlyIHNsaWRlcyAocGFzdC9wcmVzZW50L2Z1dHVyZSkNCgkJdG9BcnJheSggZG9tLmJhY2tncm91bmQuY2hpbGROb2RlcyApLmZvckVhY2goIGZ1bmN0aW9uKCBiYWNrZ3JvdW5kaCwgaCApIHsNCg0KCQkJYmFja2dyb3VuZGguY2xhc3NMaXN0LnJlbW92ZSggJ3Bhc3QnICk7DQoJCQliYWNrZ3JvdW5kaC5jbGFzc0xpc3QucmVtb3ZlKCAncHJlc2VudCcgKTsNCgkJCWJhY2tncm91bmRoLmNsYXNzTGlzdC5yZW1vdmUoICdmdXR1cmUnICk7DQoNCgkJCWlmKCBoIDwgaW5kZXhoICkgew0KCQkJCWJhY2tncm91bmRoLmNsYXNzTGlzdC5hZGQoIGhvcml6b250YWxQYXN0ICk7DQoJCQl9DQoJCQllbHNlIGlmICggaCA+IGluZGV4aCApIHsNCgkJCQliYWNrZ3JvdW5kaC5jbGFzc0xpc3QuYWRkKCBob3Jpem9udGFsRnV0dXJlICk7DQoJCQl9DQoJCQllbHNlIHsNCgkJCQliYWNrZ3JvdW5kaC5jbGFzc0xpc3QuYWRkKCAncHJlc2VudCcgKTsNCg0KCQkJCS8vIFN0b3JlIGEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IGJhY2tncm91bmQgZWxlbWVudA0KCQkJCWN1cnJlbnRCYWNrZ3JvdW5kID0gYmFja2dyb3VuZGg7DQoJCQl9DQoNCgkJCWlmKCBpbmNsdWRlQWxsIHx8IGggPT09IGluZGV4aCApIHsNCgkJCQl0b0FycmF5KCBiYWNrZ3JvdW5kaC5xdWVyeVNlbGVjdG9yQWxsKCAnLnNsaWRlLWJhY2tncm91bmQnICkgKS5mb3JFYWNoKCBmdW5jdGlvbiggYmFja2dyb3VuZHYsIHYgKSB7DQoNCgkJCQkJYmFja2dyb3VuZHYuY2xhc3NMaXN0LnJlbW92ZSggJ3Bhc3QnICk7DQoJCQkJCWJhY2tncm91bmR2LmNsYXNzTGlzdC5yZW1vdmUoICdwcmVzZW50JyApOw0KCQkJCQliYWNrZ3JvdW5kdi5jbGFzc0xpc3QucmVtb3ZlKCAnZnV0dXJlJyApOw0KDQoJCQkJCWlmKCB2IDwgaW5kZXh2ICkgew0KCQkJCQkJYmFja2dyb3VuZHYuY2xhc3NMaXN0LmFkZCggJ3Bhc3QnICk7DQoJCQkJCX0NCgkJCQkJZWxzZSBpZiAoIHYgPiBpbmRleHYgKSB7DQoJCQkJCQliYWNrZ3JvdW5kdi5jbGFzc0xpc3QuYWRkKCAnZnV0dXJlJyApOw0KCQkJCQl9DQoJCQkJCWVsc2Ugew0KCQkJCQkJYmFja2dyb3VuZHYuY2xhc3NMaXN0LmFkZCggJ3ByZXNlbnQnICk7DQoNCgkJCQkJCS8vIE9ubHkgaWYgdGhpcyBpcyB0aGUgcHJlc2VudCBob3Jpem9udGFsIGFuZCB2ZXJ0aWNhbCBzbGlkZQ0KCQkJCQkJaWYoIGggPT09IGluZGV4aCApIGN1cnJlbnRCYWNrZ3JvdW5kID0gYmFja2dyb3VuZHY7DQoJCQkJCX0NCg0KCQkJCX0gKTsNCgkJCX0NCg0KCQl9ICk7DQoNCgkJLy8gU3RvcCBhbnkgY3VycmVudGx5IHBsYXlpbmcgdmlkZW8gYmFja2dyb3VuZA0KCQlpZiggcHJldmlvdXNCYWNrZ3JvdW5kICkgew0KDQoJCQl2YXIgcHJldmlvdXNWaWRlbyA9IHByZXZpb3VzQmFja2dyb3VuZC5xdWVyeVNlbGVjdG9yKCAndmlkZW8nICk7DQoJCQlpZiggcHJldmlvdXNWaWRlbyApIHByZXZpb3VzVmlkZW8ucGF1c2UoKTsNCg0KCQl9DQoNCgkJaWYoIGN1cnJlbnRCYWNrZ3JvdW5kICkgew0KDQoJCQkvLyBTdGFydCB2aWRlbyBwbGF5YmFjaw0KCQkJdmFyIGN1cnJlbnRWaWRlbyA9IGN1cnJlbnRCYWNrZ3JvdW5kLnF1ZXJ5U2VsZWN0b3IoICd2aWRlbycgKTsNCgkJCWlmKCBjdXJyZW50VmlkZW8gKSB7DQoNCgkJCQl2YXIgc3RhcnRWaWRlbyA9IGZ1bmN0aW9uKCkgew0KCQkJCQljdXJyZW50VmlkZW8uY3VycmVudFRpbWUgPSAwOw0KCQkJCQljdXJyZW50VmlkZW8ucGxheSgpOw0KCQkJCQljdXJyZW50VmlkZW8ucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2xvYWRlZGRhdGEnLCBzdGFydFZpZGVvICk7DQoJCQkJfTsNCg0KCQkJCWlmKCBjdXJyZW50VmlkZW8ucmVhZHlTdGF0ZSA+IDEgKSB7DQoJCQkJCXN0YXJ0VmlkZW8oKTsNCgkJCQl9DQoJCQkJZWxzZSB7DQoJCQkJCWN1cnJlbnRWaWRlby5hZGRFdmVudExpc3RlbmVyKCAnbG9hZGVkZGF0YScsIHN0YXJ0VmlkZW8gKTsNCgkJCQl9DQoNCgkJCX0NCg0KCQkJdmFyIGJhY2tncm91bmRJbWFnZVVSTCA9IGN1cnJlbnRCYWNrZ3JvdW5kLnN0eWxlLmJhY2tncm91bmRJbWFnZSB8fCAnJzsNCg0KCQkJLy8gUmVzdGFydCBHSUZzIChkb2Vzbid0IHdvcmsgaW4gRmlyZWZveCkNCgkJCWlmKCAvXC5naWYvaS50ZXN0KCBiYWNrZ3JvdW5kSW1hZ2VVUkwgKSApIHsNCgkJCQljdXJyZW50QmFja2dyb3VuZC5zdHlsZS5iYWNrZ3JvdW5kSW1hZ2UgPSAnJzsNCgkJCQl3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggY3VycmVudEJhY2tncm91bmQgKS5vcGFjaXR5Ow0KCQkJCWN1cnJlbnRCYWNrZ3JvdW5kLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IGJhY2tncm91bmRJbWFnZVVSTDsNCgkJCX0NCg0KCQkJLy8gRG9uJ3QgdHJhbnNpdGlvbiBiZXR3ZWVuIGlkZW50aWNhbCBiYWNrZ3JvdW5kcy4gVGhpcw0KCQkJLy8gcHJldmVudHMgdW53YW50ZWQgZmxpY2tlci4NCgkJCXZhciBwcmV2aW91c0JhY2tncm91bmRIYXNoID0gcHJldmlvdXNCYWNrZ3JvdW5kID8gcHJldmlvdXNCYWNrZ3JvdW5kLmdldEF0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC1oYXNoJyApIDogbnVsbDsNCgkJCXZhciBjdXJyZW50QmFja2dyb3VuZEhhc2ggPSBjdXJyZW50QmFja2dyb3VuZC5nZXRBdHRyaWJ1dGUoICdkYXRhLWJhY2tncm91bmQtaGFzaCcgKTsNCgkJCWlmKCBjdXJyZW50QmFja2dyb3VuZEhhc2ggJiYgY3VycmVudEJhY2tncm91bmRIYXNoID09PSBwcmV2aW91c0JhY2tncm91bmRIYXNoICYmIGN1cnJlbnRCYWNrZ3JvdW5kICE9PSBwcmV2aW91c0JhY2tncm91bmQgKSB7DQoJCQkJZG9tLmJhY2tncm91bmQuY2xhc3NMaXN0LmFkZCggJ25vLXRyYW5zaXRpb24nICk7DQoJCQl9DQoNCgkJCXByZXZpb3VzQmFja2dyb3VuZCA9IGN1cnJlbnRCYWNrZ3JvdW5kOw0KDQoJCX0NCg0KCQkvLyBJZiB0aGVyZSdzIGEgYmFja2dyb3VuZCBicmlnaHRuZXNzIGZsYWcgZm9yIHRoaXMgc2xpZGUsDQoJCS8vIGJ1YmJsZSBpdCB0byB0aGUgLnJldmVhbCBjb250YWluZXINCgkJaWYoIGN1cnJlbnRTbGlkZSApIHsNCgkJCVsgJ2hhcy1saWdodC1iYWNrZ3JvdW5kJywgJ2hhcy1kYXJrLWJhY2tncm91bmQnIF0uZm9yRWFjaCggZnVuY3Rpb24oIGNsYXNzVG9CdWJibGUgKSB7DQoJCQkJaWYoIGN1cnJlbnRTbGlkZS5jbGFzc0xpc3QuY29udGFpbnMoIGNsYXNzVG9CdWJibGUgKSApIHsNCgkJCQkJZG9tLndyYXBwZXIuY2xhc3NMaXN0LmFkZCggY2xhc3NUb0J1YmJsZSApOw0KCQkJCX0NCgkJCQllbHNlIHsNCgkJCQkJZG9tLndyYXBwZXIuY2xhc3NMaXN0LnJlbW92ZSggY2xhc3NUb0J1YmJsZSApOw0KCQkJCX0NCgkJCX0gKTsNCgkJfQ0KDQoJCS8vIEFsbG93IHRoZSBmaXJzdCBiYWNrZ3JvdW5kIHRvIGFwcGx5IHdpdGhvdXQgdHJhbnNpdGlvbg0KCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsNCgkJCWRvbS5iYWNrZ3JvdW5kLmNsYXNzTGlzdC5yZW1vdmUoICduby10cmFuc2l0aW9uJyApOw0KCQl9LCAxICk7DQoNCgl9DQoNCgkvKioNCgkgKiBVcGRhdGVzIHRoZSBwb3NpdGlvbiBvZiB0aGUgcGFyYWxsYXggYmFja2dyb3VuZCBiYXNlZA0KCSAqIG9uIHRoZSBjdXJyZW50IHNsaWRlIGluZGV4Lg0KCSAqLw0KCWZ1bmN0aW9uIHVwZGF0ZVBhcmFsbGF4KCkgew0KDQoJCWlmKCBjb25maWcucGFyYWxsYXhCYWNrZ3JvdW5kSW1hZ2UgKSB7DQoNCgkJCXZhciBob3Jpem9udGFsU2xpZGVzID0gZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggSE9SSVpPTlRBTF9TTElERVNfU0VMRUNUT1IgKSwNCgkJCQl2ZXJ0aWNhbFNsaWRlcyA9IGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIFZFUlRJQ0FMX1NMSURFU19TRUxFQ1RPUiApOw0KDQoJCQl2YXIgYmFja2dyb3VuZFNpemUgPSBkb20uYmFja2dyb3VuZC5zdHlsZS5iYWNrZ3JvdW5kU2l6ZS5zcGxpdCggJyAnICksDQoJCQkJYmFja2dyb3VuZFdpZHRoLCBiYWNrZ3JvdW5kSGVpZ2h0Ow0KDQoJCQlpZiggYmFja2dyb3VuZFNpemUubGVuZ3RoID09PSAxICkgew0KCQkJCWJhY2tncm91bmRXaWR0aCA9IGJhY2tncm91bmRIZWlnaHQgPSBwYXJzZUludCggYmFja2dyb3VuZFNpemVbMF0sIDEwICk7DQoJCQl9DQoJCQllbHNlIHsNCgkJCQliYWNrZ3JvdW5kV2lkdGggPSBwYXJzZUludCggYmFja2dyb3VuZFNpemVbMF0sIDEwICk7DQoJCQkJYmFja2dyb3VuZEhlaWdodCA9IHBhcnNlSW50KCBiYWNrZ3JvdW5kU2l6ZVsxXSwgMTAgKTsNCgkJCX0NCg0KCQkJdmFyIHNsaWRlV2lkdGggPSBkb20uYmFja2dyb3VuZC5vZmZzZXRXaWR0aCwNCgkJCQlob3Jpem9udGFsU2xpZGVDb3VudCA9IGhvcml6b250YWxTbGlkZXMubGVuZ3RoLA0KCQkJCWhvcml6b250YWxPZmZzZXRNdWx0aXBsaWVyLA0KCQkJCWhvcml6b250YWxPZmZzZXQ7DQoNCgkJCWlmKCB0eXBlb2YgY29uZmlnLnBhcmFsbGF4QmFja2dyb3VuZEhvcml6b250YWwgPT09ICdudW1iZXInICkgew0KCQkJCWhvcml6b250YWxPZmZzZXRNdWx0aXBsaWVyID0gY29uZmlnLnBhcmFsbGF4QmFja2dyb3VuZEhvcml6b250YWw7DQoJCQl9DQoJCQllbHNlIHsNCgkJCQlob3Jpem9udGFsT2Zmc2V0TXVsdGlwbGllciA9IGhvcml6b250YWxTbGlkZUNvdW50ID4gMSA/ICggYmFja2dyb3VuZFdpZHRoIC0gc2xpZGVXaWR0aCApIC8gKCBob3Jpem9udGFsU2xpZGVDb3VudC0xICkgOiAwOw0KCQkJfQ0KDQoJCQlob3Jpem9udGFsT2Zmc2V0ID0gaG9yaXpvbnRhbE9mZnNldE11bHRpcGxpZXIgKiBpbmRleGggKiAtMTsNCg0KCQkJdmFyIHNsaWRlSGVpZ2h0ID0gZG9tLmJhY2tncm91bmQub2Zmc2V0SGVpZ2h0LA0KCQkJCXZlcnRpY2FsU2xpZGVDb3VudCA9IHZlcnRpY2FsU2xpZGVzLmxlbmd0aCwNCgkJCQl2ZXJ0aWNhbE9mZnNldE11bHRpcGxpZXIsDQoJCQkJdmVydGljYWxPZmZzZXQ7DQoNCgkJCWlmKCB0eXBlb2YgY29uZmlnLnBhcmFsbGF4QmFja2dyb3VuZFZlcnRpY2FsID09PSAnbnVtYmVyJyApIHsNCgkJCQl2ZXJ0aWNhbE9mZnNldE11bHRpcGxpZXIgPSBjb25maWcucGFyYWxsYXhCYWNrZ3JvdW5kVmVydGljYWw7DQoJCQl9DQoJCQllbHNlIHsNCgkJCQl2ZXJ0aWNhbE9mZnNldE11bHRpcGxpZXIgPSAoIGJhY2tncm91bmRIZWlnaHQgLSBzbGlkZUhlaWdodCApIC8gKCB2ZXJ0aWNhbFNsaWRlQ291bnQtMSApOw0KCQkJfQ0KDQoJCQl2ZXJ0aWNhbE9mZnNldCA9IHZlcnRpY2FsU2xpZGVDb3VudCA+IDAgPyAgdmVydGljYWxPZmZzZXRNdWx0aXBsaWVyICogaW5kZXh2IDogMDsNCg0KCQkJZG9tLmJhY2tncm91bmQuc3R5bGUuYmFja2dyb3VuZFBvc2l0aW9uID0gaG9yaXpvbnRhbE9mZnNldCArICdweCAnICsgLXZlcnRpY2FsT2Zmc2V0ICsgJ3B4JzsNCg0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBDYWxsZWQgd2hlbiB0aGUgZ2l2ZW4gc2xpZGUgaXMgd2l0aGluIHRoZSBjb25maWd1cmVkIHZpZXcNCgkgKiBkaXN0YW5jZS4gU2hvd3MgdGhlIHNsaWRlIGVsZW1lbnQgYW5kIGxvYWRzIGFueSBjb250ZW50DQoJICogdGhhdCBpcyBzZXQgdG8gbG9hZCBsYXppbHkgKGRhdGEtc3JjKS4NCgkgKg0KCSAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IHNsaWRlIFNsaWRlIHRvIHNob3cNCgkgKi8NCglmdW5jdGlvbiBzaG93U2xpZGUoIHNsaWRlICkgew0KDQoJCS8vIFNob3cgdGhlIHNsaWRlIGVsZW1lbnQNCgkJc2xpZGUuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7DQoNCgkJLy8gTWVkaWEgZWxlbWVudHMgd2l0aCBkYXRhLXNyYyBhdHRyaWJ1dGVzDQoJCXRvQXJyYXkoIHNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICdpbWdbZGF0YS1zcmNdLCB2aWRlb1tkYXRhLXNyY10sIGF1ZGlvW2RhdGEtc3JjXScgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBlbGVtZW50ICkgew0KCQkJZWxlbWVudC5zZXRBdHRyaWJ1dGUoICdzcmMnLCBlbGVtZW50LmdldEF0dHJpYnV0ZSggJ2RhdGEtc3JjJyApICk7DQoJCQllbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSggJ2RhdGEtc3JjJyApOw0KCQl9ICk7DQoNCgkJLy8gTWVkaWEgZWxlbWVudHMgd2l0aCA8c291cmNlPiBjaGlsZHJlbg0KCQl0b0FycmF5KCBzbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAndmlkZW8sIGF1ZGlvJyApICkuZm9yRWFjaCggZnVuY3Rpb24oIG1lZGlhICkgew0KCQkJdmFyIHNvdXJjZXMgPSAwOw0KDQoJCQl0b0FycmF5KCBtZWRpYS5xdWVyeVNlbGVjdG9yQWxsKCAnc291cmNlW2RhdGEtc3JjXScgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBzb3VyY2UgKSB7DQoJCQkJc291cmNlLnNldEF0dHJpYnV0ZSggJ3NyYycsIHNvdXJjZS5nZXRBdHRyaWJ1dGUoICdkYXRhLXNyYycgKSApOw0KCQkJCXNvdXJjZS5yZW1vdmVBdHRyaWJ1dGUoICdkYXRhLXNyYycgKTsNCgkJCQlzb3VyY2VzICs9IDE7DQoJCQl9ICk7DQoNCgkJCS8vIElmIHdlIHJld3JvdGUgc291cmNlcyBmb3IgdGhpcyB2aWRlby9hdWRpbyBlbGVtZW50LCB3ZSBuZWVkDQoJCQkvLyB0byBtYW51YWxseSB0ZWxsIGl0IHRvIGxvYWQgZnJvbSBpdHMgbmV3IG9yaWdpbg0KCQkJaWYoIHNvdXJjZXMgPiAwICkgew0KCQkJCW1lZGlhLmxvYWQoKTsNCgkJCX0NCgkJfSApOw0KDQoNCgkJLy8gU2hvdyB0aGUgY29ycmVzcG9uZGluZyBiYWNrZ3JvdW5kIGVsZW1lbnQNCgkJdmFyIGluZGljZXMgPSBnZXRJbmRpY2VzKCBzbGlkZSApOw0KCQl2YXIgYmFja2dyb3VuZCA9IGdldFNsaWRlQmFja2dyb3VuZCggaW5kaWNlcy5oLCBpbmRpY2VzLnYgKTsNCgkJaWYoIGJhY2tncm91bmQgKSB7DQoJCQliYWNrZ3JvdW5kLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOw0KDQoJCQkvLyBJZiB0aGUgYmFja2dyb3VuZCBjb250YWlucyBtZWRpYSwgbG9hZCBpdA0KCQkJaWYoIGJhY2tncm91bmQuaGFzQXR0cmlidXRlKCAnZGF0YS1sb2FkZWQnICkgPT09IGZhbHNlICkgew0KCQkJCWJhY2tncm91bmQuc2V0QXR0cmlidXRlKCAnZGF0YS1sb2FkZWQnLCAndHJ1ZScgKTsNCg0KCQkJCXZhciBiYWNrZ3JvdW5kSW1hZ2UgPSBzbGlkZS5nZXRBdHRyaWJ1dGUoICdkYXRhLWJhY2tncm91bmQtaW1hZ2UnICksDQoJCQkJCWJhY2tncm91bmRWaWRlbyA9IHNsaWRlLmdldEF0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC12aWRlbycgKSwNCgkJCQkJYmFja2dyb3VuZFZpZGVvTG9vcCA9IHNsaWRlLmhhc0F0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC12aWRlby1sb29wJyApLA0KCQkJCQliYWNrZ3JvdW5kVmlkZW9NdXRlZCA9IHNsaWRlLmhhc0F0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC12aWRlby1tdXRlZCcgKSwNCgkJCQkJYmFja2dyb3VuZElmcmFtZSA9IHNsaWRlLmdldEF0dHJpYnV0ZSggJ2RhdGEtYmFja2dyb3VuZC1pZnJhbWUnICk7DQoNCgkJCQkvLyBJbWFnZXMNCgkJCQlpZiggYmFja2dyb3VuZEltYWdlICkgew0KCQkJCQliYWNrZ3JvdW5kLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9ICd1cmwoJysgYmFja2dyb3VuZEltYWdlICsnKSc7DQoJCQkJfQ0KCQkJCS8vIFZpZGVvcw0KCQkJCWVsc2UgaWYgKCBiYWNrZ3JvdW5kVmlkZW8gJiYgIWlzU3BlYWtlck5vdGVzKCkgKSB7DQoJCQkJCXZhciB2aWRlbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICd2aWRlbycgKTsNCg0KCQkJCQlpZiggYmFja2dyb3VuZFZpZGVvTG9vcCApIHsNCgkJCQkJCXZpZGVvLnNldEF0dHJpYnV0ZSggJ2xvb3AnLCAnJyApOw0KCQkJCQl9DQoNCgkJCQkJaWYoIGJhY2tncm91bmRWaWRlb011dGVkICkgew0KCQkJCQkJdmlkZW8ubXV0ZWQgPSB0cnVlOw0KCQkJCQl9DQoNCgkJCQkJLy8gU3VwcG9ydCBjb21tYSBzZXBhcmF0ZWQgbGlzdHMgb2YgdmlkZW8gc291cmNlcw0KCQkJCQliYWNrZ3JvdW5kVmlkZW8uc3BsaXQoICcsJyApLmZvckVhY2goIGZ1bmN0aW9uKCBzb3VyY2UgKSB7DQoJCQkJCQl2aWRlby5pbm5lckhUTUwgKz0gJzxzb3VyY2Ugc3JjPSInKyBzb3VyY2UgKyciPic7DQoJCQkJCX0gKTsNCg0KCQkJCQliYWNrZ3JvdW5kLmFwcGVuZENoaWxkKCB2aWRlbyApOw0KCQkJCX0NCgkJCQkvLyBJZnJhbWVzDQoJCQkJZWxzZSBpZiggYmFja2dyb3VuZElmcmFtZSApIHsNCgkJCQkJdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdpZnJhbWUnICk7DQoJCQkJCQlpZnJhbWUuc2V0QXR0cmlidXRlKCAnc3JjJywgYmFja2dyb3VuZElmcmFtZSApOw0KCQkJCQkJaWZyYW1lLnN0eWxlLndpZHRoICA9ICcxMDAlJzsNCgkJCQkJCWlmcmFtZS5zdHlsZS5oZWlnaHQgPSAnMTAwJSc7DQoJCQkJCQlpZnJhbWUuc3R5bGUubWF4SGVpZ2h0ID0gJzEwMCUnOw0KCQkJCQkJaWZyYW1lLnN0eWxlLm1heFdpZHRoID0gJzEwMCUnOw0KDQoJCQkJCWJhY2tncm91bmQuYXBwZW5kQ2hpbGQoIGlmcmFtZSApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogQ2FsbGVkIHdoZW4gdGhlIGdpdmVuIHNsaWRlIGlzIG1vdmVkIG91dHNpZGUgb2YgdGhlDQoJICogY29uZmlndXJlZCB2aWV3IGRpc3RhbmNlLg0KCSAqDQoJICogQHBhcmFtIHtIVE1MRWxlbWVudH0gc2xpZGUNCgkgKi8NCglmdW5jdGlvbiBoaWRlU2xpZGUoIHNsaWRlICkgew0KDQoJCS8vIEhpZGUgdGhlIHNsaWRlIGVsZW1lbnQNCgkJc2xpZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsNCg0KCQkvLyBIaWRlIHRoZSBjb3JyZXNwb25kaW5nIGJhY2tncm91bmQgZWxlbWVudA0KCQl2YXIgaW5kaWNlcyA9IGdldEluZGljZXMoIHNsaWRlICk7DQoJCXZhciBiYWNrZ3JvdW5kID0gZ2V0U2xpZGVCYWNrZ3JvdW5kKCBpbmRpY2VzLmgsIGluZGljZXMudiApOw0KCQlpZiggYmFja2dyb3VuZCApIHsNCgkJCWJhY2tncm91bmQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogRGV0ZXJtaW5lIHdoYXQgYXZhaWxhYmxlIHJvdXRlcyB0aGVyZSBhcmUgZm9yIG5hdmlnYXRpb24uDQoJICoNCgkgKiBAcmV0dXJuIHt7bGVmdDogYm9vbGVhbiwgcmlnaHQ6IGJvb2xlYW4sIHVwOiBib29sZWFuLCBkb3duOiBib29sZWFufX0NCgkgKi8NCglmdW5jdGlvbiBhdmFpbGFibGVSb3V0ZXMoKSB7DQoNCgkJdmFyIGhvcml6b250YWxTbGlkZXMgPSBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBIT1JJWk9OVEFMX1NMSURFU19TRUxFQ1RPUiApLA0KCQkJdmVydGljYWxTbGlkZXMgPSBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBWRVJUSUNBTF9TTElERVNfU0VMRUNUT1IgKTsNCg0KCQl2YXIgcm91dGVzID0gew0KCQkJbGVmdDogaW5kZXhoID4gMCB8fCBjb25maWcubG9vcCwNCgkJCXJpZ2h0OiBpbmRleGggPCBob3Jpem9udGFsU2xpZGVzLmxlbmd0aCAtIDEgfHwgY29uZmlnLmxvb3AsDQoJCQl1cDogaW5kZXh2ID4gMCwNCgkJCWRvd246IGluZGV4diA8IHZlcnRpY2FsU2xpZGVzLmxlbmd0aCAtIDENCgkJfTsNCg0KCQkvLyByZXZlcnNlIGhvcml6b250YWwgY29udHJvbHMgZm9yIHJ0bA0KCQlpZiggY29uZmlnLnJ0bCApIHsNCgkJCXZhciBsZWZ0ID0gcm91dGVzLmxlZnQ7DQoJCQlyb3V0ZXMubGVmdCA9IHJvdXRlcy5yaWdodDsNCgkJCXJvdXRlcy5yaWdodCA9IGxlZnQ7DQoJCX0NCg0KCQlyZXR1cm4gcm91dGVzOw0KDQoJfQ0KDQoJLyoqDQoJICogUmV0dXJucyBhbiBvYmplY3QgZGVzY3JpYmluZyB0aGUgYXZhaWxhYmxlIGZyYWdtZW50DQoJICogZGlyZWN0aW9ucy4NCgkgKg0KCSAqIEByZXR1cm4ge3twcmV2OiBib29sZWFuLCBuZXh0OiBib29sZWFufX0NCgkgKi8NCglmdW5jdGlvbiBhdmFpbGFibGVGcmFnbWVudHMoKSB7DQoNCgkJaWYoIGN1cnJlbnRTbGlkZSAmJiBjb25maWcuZnJhZ21lbnRzICkgew0KCQkJdmFyIGZyYWdtZW50cyA9IGN1cnJlbnRTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnLmZyYWdtZW50JyApOw0KCQkJdmFyIGhpZGRlbkZyYWdtZW50cyA9IGN1cnJlbnRTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnLmZyYWdtZW50Om5vdCgudmlzaWJsZSknICk7DQoNCgkJCXJldHVybiB7DQoJCQkJcHJldjogZnJhZ21lbnRzLmxlbmd0aCAtIGhpZGRlbkZyYWdtZW50cy5sZW5ndGggPiAwLA0KCQkJCW5leHQ6ICEhaGlkZGVuRnJhZ21lbnRzLmxlbmd0aA0KCQkJfTsNCgkJfQ0KCQllbHNlIHsNCgkJCXJldHVybiB7IHByZXY6IGZhbHNlLCBuZXh0OiBmYWxzZSB9Ow0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBFbmZvcmNlcyBvcmlnaW4tc3BlY2lmaWMgZm9ybWF0IHJ1bGVzIGZvciBlbWJlZGRlZCBtZWRpYS4NCgkgKi8NCglmdW5jdGlvbiBmb3JtYXRFbWJlZGRlZENvbnRlbnQoKSB7DQoNCgkJdmFyIF9hcHBlbmRQYXJhbVRvSWZyYW1lU291cmNlID0gZnVuY3Rpb24oIHNvdXJjZUF0dHJpYnV0ZSwgc291cmNlVVJMLCBwYXJhbSApIHsNCgkJCXRvQXJyYXkoIGRvbS5zbGlkZXMucXVlcnlTZWxlY3RvckFsbCggJ2lmcmFtZVsnKyBzb3VyY2VBdHRyaWJ1dGUgKycqPSInKyBzb3VyY2VVUkwgKyciXScgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsNCgkJCQl2YXIgc3JjID0gZWwuZ2V0QXR0cmlidXRlKCBzb3VyY2VBdHRyaWJ1dGUgKTsNCgkJCQlpZiggc3JjICYmIHNyYy5pbmRleE9mKCBwYXJhbSApID09PSAtMSApIHsNCgkJCQkJZWwuc2V0QXR0cmlidXRlKCBzb3VyY2VBdHRyaWJ1dGUsIHNyYyArICggIS9cPy8udGVzdCggc3JjICkgPyAnPycgOiAnJicgKSArIHBhcmFtICk7DQoJCQkJfQ0KCQkJfSk7DQoJCX07DQoNCgkJLy8gWW91VHViZSBmcmFtZXMgbXVzdCBpbmNsdWRlICI/ZW5hYmxlanNhcGk9MSINCgkJX2FwcGVuZFBhcmFtVG9JZnJhbWVTb3VyY2UoICdzcmMnLCAneW91dHViZS5jb20vZW1iZWQvJywgJ2VuYWJsZWpzYXBpPTEnICk7DQoJCV9hcHBlbmRQYXJhbVRvSWZyYW1lU291cmNlKCAnZGF0YS1zcmMnLCAneW91dHViZS5jb20vZW1iZWQvJywgJ2VuYWJsZWpzYXBpPTEnICk7DQoNCgkJLy8gVmltZW8gZnJhbWVzIG11c3QgaW5jbHVkZSAiP2FwaT0xIg0KCQlfYXBwZW5kUGFyYW1Ub0lmcmFtZVNvdXJjZSggJ3NyYycsICdwbGF5ZXIudmltZW8uY29tLycsICdhcGk9MScgKTsNCgkJX2FwcGVuZFBhcmFtVG9JZnJhbWVTb3VyY2UoICdkYXRhLXNyYycsICdwbGF5ZXIudmltZW8uY29tLycsICdhcGk9MScgKTsNCg0KCX0NCg0KCS8qKg0KCSAqIFN0YXJ0IHBsYXliYWNrIG9mIGFueSBlbWJlZGRlZCBjb250ZW50IGluc2lkZSBvZg0KCSAqIHRoZSBnaXZlbiBlbGVtZW50Lg0KCSAqDQoJICogQHBhcmFtIHtIVE1MRWxlbWVudH0gc2xpZGUNCgkgKi8NCglmdW5jdGlvbiBzdGFydEVtYmVkZGVkQ29udGVudCggZWxlbWVudCApIHsNCg0KCQlpZiggZWxlbWVudCAmJiAhaXNTcGVha2VyTm90ZXMoKSApIHsNCgkJCS8vIFJlc3RhcnQgR0lGcw0KCQkJdG9BcnJheSggZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCAnaW1nW3NyYyQ9Ii5naWYiXScgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsNCgkJCQkvLyBTZXR0aW5nIHRoZSBzYW1lIHVuY2hhbmdlZCBzb3VyY2UgbGlrZSB0aGlzIHdhcyBjb25maXJtZWQNCgkJCQkvLyB0byB3b3JrIGluIENocm9tZSwgRkYgJiBTYWZhcmkNCgkJCQllbC5zZXRBdHRyaWJ1dGUoICdzcmMnLCBlbC5nZXRBdHRyaWJ1dGUoICdzcmMnICkgKTsNCgkJCX0gKTsNCg0KCQkJLy8gSFRNTDUgbWVkaWEgZWxlbWVudHMNCgkJCXRvQXJyYXkoIGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCggJ3ZpZGVvLCBhdWRpbycgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsNCgkJCQlpZiggY2xvc2VzdFBhcmVudCggZWwsICcuZnJhZ21lbnQnICkgJiYgIWNsb3Nlc3RQYXJlbnQoIGVsLCAnLmZyYWdtZW50LnZpc2libGUnICkgKSB7DQoJCQkJCXJldHVybjsNCgkJCQl9DQoNCgkJCQlpZiggZWwuaGFzQXR0cmlidXRlKCAnZGF0YS1hdXRvcGxheScgKSAmJiB0eXBlb2YgZWwucGxheSA9PT0gJ2Z1bmN0aW9uJyApIHsNCgkJCQkJZWwucGxheSgpOw0KCQkJCX0NCgkJCX0gKTsNCg0KCQkJLy8gTm9ybWFsIGlmcmFtZXMNCgkJCXRvQXJyYXkoIGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCggJ2lmcmFtZVtzcmNdJyApICkuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgew0KCQkJCWlmKCBjbG9zZXN0UGFyZW50KCBlbCwgJy5mcmFnbWVudCcgKSAmJiAhY2xvc2VzdFBhcmVudCggZWwsICcuZnJhZ21lbnQudmlzaWJsZScgKSApIHsNCgkJCQkJcmV0dXJuOw0KCQkJCX0NCg0KCQkJCXN0YXJ0RW1iZWRkZWRJZnJhbWUoIHsgdGFyZ2V0OiBlbCB9ICk7DQoJCQl9ICk7DQoNCgkJCS8vIExhenkgbG9hZGluZyBpZnJhbWVzDQoJCQl0b0FycmF5KCBlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoICdpZnJhbWVbZGF0YS1zcmNdJyApICkuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgew0KCQkJCWlmKCBjbG9zZXN0UGFyZW50KCBlbCwgJy5mcmFnbWVudCcgKSAmJiAhY2xvc2VzdFBhcmVudCggZWwsICcuZnJhZ21lbnQudmlzaWJsZScgKSApIHsNCgkJCQkJcmV0dXJuOw0KCQkJCX0NCg0KCQkJCWlmKCBlbC5nZXRBdHRyaWJ1dGUoICdzcmMnICkgIT09IGVsLmdldEF0dHJpYnV0ZSggJ2RhdGEtc3JjJyApICkgew0KCQkJCQllbC5yZW1vdmVFdmVudExpc3RlbmVyKCAnbG9hZCcsIHN0YXJ0RW1iZWRkZWRJZnJhbWUgKTsgLy8gcmVtb3ZlIGZpcnN0IHRvIGF2b2lkIGR1cGVzDQoJCQkJCWVsLmFkZEV2ZW50TGlzdGVuZXIoICdsb2FkJywgc3RhcnRFbWJlZGRlZElmcmFtZSApOw0KCQkJCQllbC5zZXRBdHRyaWJ1dGUoICdzcmMnLCBlbC5nZXRBdHRyaWJ1dGUoICdkYXRhLXNyYycgKSApOw0KCQkJCX0NCgkJCX0gKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogIlN0YXJ0cyIgdGhlIGNvbnRlbnQgb2YgYW4gZW1iZWRkZWQgaWZyYW1lIHVzaW5nIHRoZQ0KCSAqIHBvc3RNZXNzYWdlIEFQSS4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBldmVudCAtIHBvc3RNZXNzYWdlIEFQSSBldmVudA0KCSAqLw0KCWZ1bmN0aW9uIHN0YXJ0RW1iZWRkZWRJZnJhbWUoIGV2ZW50ICkgew0KDQoJCXZhciBpZnJhbWUgPSBldmVudC50YXJnZXQ7DQoNCgkJaWYoIGlmcmFtZSAmJiBpZnJhbWUuY29udGVudFdpbmRvdyApIHsNCg0KCQkJLy8gWW91VHViZSBwb3N0TWVzc2FnZSBBUEkNCgkJCWlmKCAveW91dHViZVwuY29tXC9lbWJlZFwvLy50ZXN0KCBpZnJhbWUuZ2V0QXR0cmlidXRlKCAnc3JjJyApICkgJiYgaWZyYW1lLmhhc0F0dHJpYnV0ZSggJ2RhdGEtYXV0b3BsYXknICkgKSB7DQoJCQkJaWZyYW1lLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UoICd7ImV2ZW50IjoiY29tbWFuZCIsImZ1bmMiOiJwbGF5VmlkZW8iLCJhcmdzIjoiIn0nLCAnKicgKTsNCgkJCX0NCgkJCS8vIFZpbWVvIHBvc3RNZXNzYWdlIEFQSQ0KCQkJZWxzZSBpZiggL3BsYXllclwudmltZW9cLmNvbVwvLy50ZXN0KCBpZnJhbWUuZ2V0QXR0cmlidXRlKCAnc3JjJyApICkgJiYgaWZyYW1lLmhhc0F0dHJpYnV0ZSggJ2RhdGEtYXV0b3BsYXknICkgKSB7DQoJCQkJaWZyYW1lLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UoICd7Im1ldGhvZCI6InBsYXkifScsICcqJyApOw0KCQkJfQ0KCQkJLy8gR2VuZXJpYyBwb3N0TWVzc2FnZSBBUEkNCgkJCWVsc2Ugew0KCQkJCWlmcmFtZS5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKCAnc2xpZGU6c3RhcnQnLCAnKicgKTsNCgkJCX0NCg0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBTdG9wIHBsYXliYWNrIG9mIGFueSBlbWJlZGRlZCBjb250ZW50IGluc2lkZSBvZg0KCSAqIHRoZSB0YXJnZXRlZCBzbGlkZS4NCgkgKg0KCSAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IHNsaWRlDQoJICovDQoJZnVuY3Rpb24gc3RvcEVtYmVkZGVkQ29udGVudCggc2xpZGUgKSB7DQoNCgkJaWYoIHNsaWRlICYmIHNsaWRlLnBhcmVudE5vZGUgKSB7DQoJCQkvLyBIVE1MNSBtZWRpYSBlbGVtZW50cw0KCQkJdG9BcnJheSggc2xpZGUucXVlcnlTZWxlY3RvckFsbCggJ3ZpZGVvLCBhdWRpbycgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsNCgkJCQlpZiggIWVsLmhhc0F0dHJpYnV0ZSggJ2RhdGEtaWdub3JlJyApICYmIHR5cGVvZiBlbC5wYXVzZSA9PT0gJ2Z1bmN0aW9uJyApIHsNCgkJCQkJZWwucGF1c2UoKTsNCgkJCQl9DQoJCQl9ICk7DQoNCgkJCS8vIEdlbmVyaWMgcG9zdE1lc3NhZ2UgQVBJIGZvciBub24tbGF6eSBsb2FkZWQgaWZyYW1lcw0KCQkJdG9BcnJheSggc2xpZGUucXVlcnlTZWxlY3RvckFsbCggJ2lmcmFtZScgKSApLmZvckVhY2goIGZ1bmN0aW9uKCBlbCApIHsNCgkJCQllbC5jb250ZW50V2luZG93LnBvc3RNZXNzYWdlKCAnc2xpZGU6c3RvcCcsICcqJyApOw0KCQkJCWVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdsb2FkJywgc3RhcnRFbWJlZGRlZElmcmFtZSApOw0KCQkJfSk7DQoNCgkJCS8vIFlvdVR1YmUgcG9zdE1lc3NhZ2UgQVBJDQoJCQl0b0FycmF5KCBzbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnaWZyYW1lW3NyYyo9InlvdXR1YmUuY29tL2VtYmVkLyJdJyApICkuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgew0KCQkJCWlmKCAhZWwuaGFzQXR0cmlidXRlKCAnZGF0YS1pZ25vcmUnICkgJiYgdHlwZW9mIGVsLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UgPT09ICdmdW5jdGlvbicgKSB7DQoJCQkJCWVsLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UoICd7ImV2ZW50IjoiY29tbWFuZCIsImZ1bmMiOiJwYXVzZVZpZGVvIiwiYXJncyI6IiJ9JywgJyonICk7DQoJCQkJfQ0KCQkJfSk7DQoNCgkJCS8vIFZpbWVvIHBvc3RNZXNzYWdlIEFQSQ0KCQkJdG9BcnJheSggc2xpZGUucXVlcnlTZWxlY3RvckFsbCggJ2lmcmFtZVtzcmMqPSJwbGF5ZXIudmltZW8uY29tLyJdJyApICkuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgew0KCQkJCWlmKCAhZWwuaGFzQXR0cmlidXRlKCAnZGF0YS1pZ25vcmUnICkgJiYgdHlwZW9mIGVsLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UgPT09ICdmdW5jdGlvbicgKSB7DQoJCQkJCWVsLmNvbnRlbnRXaW5kb3cucG9zdE1lc3NhZ2UoICd7Im1ldGhvZCI6InBhdXNlIn0nLCAnKicgKTsNCgkJCQl9DQoJCQl9KTsNCg0KCQkJLy8gTGF6eSBsb2FkaW5nIGlmcmFtZXMNCgkJCXRvQXJyYXkoIHNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICdpZnJhbWVbZGF0YS1zcmNdJyApICkuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgew0KCQkJCS8vIE9ubHkgcmVtb3ZpbmcgdGhlIHNyYyBkb2Vzbid0IGFjdHVhbGx5IHVubG9hZCB0aGUgZnJhbWUNCgkJCQkvLyBpbiBhbGwgYnJvd3NlcnMgKEZpcmVmb3gpIHNvIHdlIHNldCBpdCB0byBibGFuayBmaXJzdA0KCQkJCWVsLnNldEF0dHJpYnV0ZSggJ3NyYycsICdhYm91dDpibGFuaycgKTsNCgkJCQllbC5yZW1vdmVBdHRyaWJ1dGUoICdzcmMnICk7DQoJCQl9ICk7DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIFJldHVybnMgdGhlIG51bWJlciBvZiBwYXN0IHNsaWRlcy4gVGhpcyBjYW4gYmUgdXNlZCBhcyBhIGdsb2JhbA0KCSAqIGZsYXR0ZW5lZCBpbmRleCBmb3Igc2xpZGVzLg0KCSAqDQoJICogQHJldHVybiB7bnVtYmVyfSBQYXN0IHNsaWRlIGNvdW50DQoJICovDQoJZnVuY3Rpb24gZ2V0U2xpZGVQYXN0Q291bnQoKSB7DQoNCgkJdmFyIGhvcml6b250YWxTbGlkZXMgPSB0b0FycmF5KCBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBIT1JJWk9OVEFMX1NMSURFU19TRUxFQ1RPUiApICk7DQoNCgkJLy8gVGhlIG51bWJlciBvZiBwYXN0IHNsaWRlcw0KCQl2YXIgcGFzdENvdW50ID0gMDsNCg0KCQkvLyBTdGVwIHRocm91Z2ggYWxsIHNsaWRlcyBhbmQgY291bnQgdGhlIHBhc3Qgb25lcw0KCQltYWluTG9vcDogZm9yKCB2YXIgaSA9IDA7IGkgPCBob3Jpem9udGFsU2xpZGVzLmxlbmd0aDsgaSsrICkgew0KDQoJCQl2YXIgaG9yaXpvbnRhbFNsaWRlID0gaG9yaXpvbnRhbFNsaWRlc1tpXTsNCgkJCXZhciB2ZXJ0aWNhbFNsaWRlcyA9IHRvQXJyYXkoIGhvcml6b250YWxTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnc2VjdGlvbicgKSApOw0KDQoJCQlmb3IoIHZhciBqID0gMDsgaiA8IHZlcnRpY2FsU2xpZGVzLmxlbmd0aDsgaisrICkgew0KDQoJCQkJLy8gU3RvcCBhcyBzb29uIGFzIHdlIGFycml2ZSBhdCB0aGUgcHJlc2VudA0KCQkJCWlmKCB2ZXJ0aWNhbFNsaWRlc1tqXS5jbGFzc0xpc3QuY29udGFpbnMoICdwcmVzZW50JyApICkgew0KCQkJCQlicmVhayBtYWluTG9vcDsNCgkJCQl9DQoNCgkJCQlwYXN0Q291bnQrKzsNCg0KCQkJfQ0KDQoJCQkvLyBTdG9wIGFzIHNvb24gYXMgd2UgYXJyaXZlIGF0IHRoZSBwcmVzZW50DQoJCQlpZiggaG9yaXpvbnRhbFNsaWRlLmNsYXNzTGlzdC5jb250YWlucyggJ3ByZXNlbnQnICkgKSB7DQoJCQkJYnJlYWs7DQoJCQl9DQoNCgkJCS8vIERvbid0IGNvdW50IHRoZSB3cmFwcGluZyBzZWN0aW9uIGZvciB2ZXJ0aWNhbCBzbGlkZXMNCgkJCWlmKCBob3Jpem9udGFsU2xpZGUuY2xhc3NMaXN0LmNvbnRhaW5zKCAnc3RhY2snICkgPT09IGZhbHNlICkgew0KCQkJCXBhc3RDb3VudCsrOw0KCQkJfQ0KDQoJCX0NCg0KCQlyZXR1cm4gcGFzdENvdW50Ow0KDQoJfQ0KDQoJLyoqDQoJICogUmV0dXJucyBhIHZhbHVlIHJhbmdpbmcgZnJvbSAwLTEgdGhhdCByZXByZXNlbnRzDQoJICogaG93IGZhciBpbnRvIHRoZSBwcmVzZW50YXRpb24gd2UgaGF2ZSBuYXZpZ2F0ZWQuDQoJICoNCgkgKiBAcmV0dXJuIHtudW1iZXJ9DQoJICovDQoJZnVuY3Rpb24gZ2V0UHJvZ3Jlc3MoKSB7DQoNCgkJLy8gVGhlIG51bWJlciBvZiBwYXN0IGFuZCB0b3RhbCBzbGlkZXMNCgkJdmFyIHRvdGFsQ291bnQgPSBnZXRUb3RhbFNsaWRlcygpOw0KCQl2YXIgcGFzdENvdW50ID0gZ2V0U2xpZGVQYXN0Q291bnQoKTsNCg0KCQlpZiggY3VycmVudFNsaWRlICkgew0KDQoJCQl2YXIgYWxsRnJhZ21lbnRzID0gY3VycmVudFNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICcuZnJhZ21lbnQnICk7DQoNCgkJCS8vIElmIHRoZXJlIGFyZSBmcmFnbWVudHMgaW4gdGhlIGN1cnJlbnQgc2xpZGUgdGhvc2Ugc2hvdWxkIGJlDQoJCQkvLyBhY2NvdW50ZWQgZm9yIGluIHRoZSBwcm9ncmVzcy4NCgkJCWlmKCBhbGxGcmFnbWVudHMubGVuZ3RoID4gMCApIHsNCgkJCQl2YXIgdmlzaWJsZUZyYWdtZW50cyA9IGN1cnJlbnRTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnLmZyYWdtZW50LnZpc2libGUnICk7DQoNCgkJCQkvLyBUaGlzIHZhbHVlIHJlcHJlc2VudHMgaG93IGJpZyBhIHBvcnRpb24gb2YgdGhlIHNsaWRlIHByb2dyZXNzDQoJCQkJLy8gdGhhdCBpcyBtYWRlIHVwIGJ5IGl0cyBmcmFnbWVudHMgKDAtMSkNCgkJCQl2YXIgZnJhZ21lbnRXZWlnaHQgPSAwLjk7DQoNCgkJCQkvLyBBZGQgZnJhZ21lbnQgcHJvZ3Jlc3MgdG8gdGhlIHBhc3Qgc2xpZGUgY291bnQNCgkJCQlwYXN0Q291bnQgKz0gKCB2aXNpYmxlRnJhZ21lbnRzLmxlbmd0aCAvIGFsbEZyYWdtZW50cy5sZW5ndGggKSAqIGZyYWdtZW50V2VpZ2h0Ow0KCQkJfQ0KDQoJCX0NCg0KCQlyZXR1cm4gcGFzdENvdW50IC8gKCB0b3RhbENvdW50IC0gMSApOw0KDQoJfQ0KDQoJLyoqDQoJICogQ2hlY2tzIGlmIHRoaXMgcHJlc2VudGF0aW9uIGlzIHJ1bm5pbmcgaW5zaWRlIG9mIHRoZQ0KCSAqIHNwZWFrZXIgbm90ZXMgd2luZG93Lg0KCSAqDQoJICogQHJldHVybiB7Ym9vbGVhbn0NCgkgKi8NCglmdW5jdGlvbiBpc1NwZWFrZXJOb3RlcygpIHsNCg0KCQlyZXR1cm4gISF3aW5kb3cubG9jYXRpb24uc2VhcmNoLm1hdGNoKCAvcmVjZWl2ZXIvZ2kgKTsNCg0KCX0NCg0KCS8qKg0KCSAqIFJlYWRzIHRoZSBjdXJyZW50IFVSTCAoaGFzaCkgYW5kIG5hdmlnYXRlcyBhY2NvcmRpbmdseS4NCgkgKi8NCglmdW5jdGlvbiByZWFkVVJMKCkgew0KDQoJCXZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7DQoNCgkJLy8gQXR0ZW1wdCB0byBwYXJzZSB0aGUgaGFzaCBhcyBlaXRoZXIgYW4gaW5kZXggb3IgbmFtZQ0KCQl2YXIgYml0cyA9IGhhc2guc2xpY2UoIDIgKS5zcGxpdCggJy8nICksDQoJCQluYW1lID0gaGFzaC5yZXBsYWNlKCAvI3xcLy9naSwgJycgKTsNCg0KCQkvLyBJZiB0aGUgZmlyc3QgYml0IGlzIGludmFsaWQgYW5kIHRoZXJlIGlzIGEgbmFtZSB3ZSBjYW4NCgkJLy8gYXNzdW1lIHRoYXQgdGhpcyBpcyBhIG5hbWVkIGxpbmsNCgkJaWYoIGlzTmFOKCBwYXJzZUludCggYml0c1swXSwgMTAgKSApICYmIG5hbWUubGVuZ3RoICkgew0KCQkJdmFyIGVsZW1lbnQ7DQoNCgkJCS8vIEVuc3VyZSB0aGUgbmFtZWQgbGluayBpcyBhIHZhbGlkIEhUTUwgSUQgYXR0cmlidXRlDQoJCQlpZiggL15bYS16QS1aXVtcdzouLV0qJC8udGVzdCggbmFtZSApICkgew0KCQkJCS8vIEZpbmQgdGhlIHNsaWRlIHdpdGggdGhlIHNwZWNpZmllZCBJRA0KCQkJCWVsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbmFtZSApOw0KCQkJfQ0KDQoJCQlpZiggZWxlbWVudCApIHsNCgkJCQkvLyBGaW5kIHRoZSBwb3NpdGlvbiBvZiB0aGUgbmFtZWQgc2xpZGUgYW5kIG5hdmlnYXRlIHRvIGl0DQoJCQkJdmFyIGluZGljZXMgPSBSZXZlYWwuZ2V0SW5kaWNlcyggZWxlbWVudCApOw0KCQkJCXNsaWRlKCBpbmRpY2VzLmgsIGluZGljZXMudiApOw0KCQkJfQ0KCQkJLy8gSWYgdGhlIHNsaWRlIGRvZXNuJ3QgZXhpc3QsIG5hdmlnYXRlIHRvIHRoZSBjdXJyZW50IHNsaWRlDQoJCQllbHNlIHsNCgkJCQlzbGlkZSggaW5kZXhoIHx8IDAsIGluZGV4diB8fCAwICk7DQoJCQl9DQoJCX0NCgkJZWxzZSB7DQoJCQkvLyBSZWFkIHRoZSBpbmRleCBjb21wb25lbnRzIG9mIHRoZSBoYXNoDQoJCQl2YXIgaCA9IHBhcnNlSW50KCBiaXRzWzBdLCAxMCApIHx8IDAsDQoJCQkJdiA9IHBhcnNlSW50KCBiaXRzWzFdLCAxMCApIHx8IDA7DQoNCgkJCWlmKCBoICE9PSBpbmRleGggfHwgdiAhPT0gaW5kZXh2ICkgew0KCQkJCXNsaWRlKCBoLCB2ICk7DQoJCQl9DQoJCX0NCg0KCX0NCg0KCS8qKg0KCSAqIFVwZGF0ZXMgdGhlIHBhZ2UgVVJMIChoYXNoKSB0byByZWZsZWN0IHRoZSBjdXJyZW50DQoJICogc3RhdGUuDQoJICoNCgkgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgVGhlIHRpbWUgaW4gbXMgdG8gd2FpdCBiZWZvcmUNCgkgKiB3cml0aW5nIHRoZSBoYXNoDQoJICovDQoJZnVuY3Rpb24gd3JpdGVVUkwoIGRlbGF5ICkgew0KDQoJCWlmKCBjb25maWcuaGlzdG9yeSApIHsNCg0KCQkJLy8gTWFrZSBzdXJlIHRoZXJlJ3MgbmV2ZXIgbW9yZSB0aGFuIG9uZSB0aW1lb3V0IHJ1bm5pbmcNCgkJCWNsZWFyVGltZW91dCggd3JpdGVVUkxUaW1lb3V0ICk7DQoNCgkJCS8vIElmIGEgZGVsYXkgaXMgc3BlY2lmaWVkLCB0aW1lb3V0IHRoaXMgY2FsbA0KCQkJaWYoIHR5cGVvZiBkZWxheSA9PT0gJ251bWJlcicgKSB7DQoJCQkJd3JpdGVVUkxUaW1lb3V0ID0gc2V0VGltZW91dCggd3JpdGVVUkwsIGRlbGF5ICk7DQoJCQl9DQoJCQllbHNlIGlmKCBjdXJyZW50U2xpZGUgKSB7DQoJCQkJdmFyIHVybCA9ICcvJzsNCg0KCQkJCS8vIEF0dGVtcHQgdG8gY3JlYXRlIGEgbmFtZWQgbGluayBiYXNlZCBvbiB0aGUgc2xpZGUncyBJRA0KCQkJCXZhciBpZCA9IGN1cnJlbnRTbGlkZS5nZXRBdHRyaWJ1dGUoICdpZCcgKTsNCgkJCQlpZiggaWQgKSB7DQoJCQkJCWlkID0gaWQucmVwbGFjZSggL1teYS16QS1aMC05XC1cX1w6XC5dL2csICcnICk7DQoJCQkJfQ0KDQoJCQkJLy8gSWYgdGhlIGN1cnJlbnQgc2xpZGUgaGFzIGFuIElELCB1c2UgdGhhdCBhcyBhIG5hbWVkIGxpbmsNCgkJCQlpZiggdHlwZW9mIGlkID09PSAnc3RyaW5nJyAmJiBpZC5sZW5ndGggKSB7DQoJCQkJCXVybCA9ICcvJyArIGlkOw0KCQkJCX0NCgkJCQkvLyBPdGhlcndpc2UgdXNlIHRoZSAvaC92IGluZGV4DQoJCQkJZWxzZSB7DQoJCQkJCWlmKCBpbmRleGggPiAwIHx8IGluZGV4diA+IDAgKSB1cmwgKz0gaW5kZXhoOw0KCQkJCQlpZiggaW5kZXh2ID4gMCApIHVybCArPSAnLycgKyBpbmRleHY7DQoJCQkJfQ0KDQoJCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmw7DQoJCQl9DQoJCX0NCg0KCX0NCgkvKioNCgkgKiBSZXRyaWV2ZXMgdGhlIGgvdiBsb2NhdGlvbiBhbmQgZnJhZ21lbnQgb2YgdGhlIGN1cnJlbnQsDQoJICogb3Igc3BlY2lmaWVkLCBzbGlkZS4NCgkgKg0KCSAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IFtzbGlkZV0gSWYgc3BlY2lmaWVkLCB0aGUgcmV0dXJuZWQNCgkgKiBpbmRleCB3aWxsIGJlIGZvciB0aGlzIHNsaWRlIHJhdGhlciB0aGFuIHRoZSBjdXJyZW50bHkNCgkgKiBhY3RpdmUgb25lDQoJICoNCgkgKiBAcmV0dXJuIHt7aDogbnVtYmVyLCB2OiBudW1iZXIsIGY6IG51bWJlcn19DQoJICovDQoJZnVuY3Rpb24gZ2V0SW5kaWNlcyggc2xpZGUgKSB7DQoNCgkJLy8gQnkgZGVmYXVsdCwgcmV0dXJuIHRoZSBjdXJyZW50IGluZGljZXMNCgkJdmFyIGggPSBpbmRleGgsDQoJCQl2ID0gaW5kZXh2LA0KCQkJZjsNCg0KCQkvLyBJZiBhIHNsaWRlIGlzIHNwZWNpZmllZCwgcmV0dXJuIHRoZSBpbmRpY2VzIG9mIHRoYXQgc2xpZGUNCgkJaWYoIHNsaWRlICkgew0KCQkJdmFyIGlzVmVydGljYWwgPSBpc1ZlcnRpY2FsU2xpZGUoIHNsaWRlICk7DQoJCQl2YXIgc2xpZGVoID0gaXNWZXJ0aWNhbCA/IHNsaWRlLnBhcmVudE5vZGUgOiBzbGlkZTsNCg0KCQkJLy8gU2VsZWN0IGFsbCBob3Jpem9udGFsIHNsaWRlcw0KCQkJdmFyIGhvcml6b250YWxTbGlkZXMgPSB0b0FycmF5KCBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBIT1JJWk9OVEFMX1NMSURFU19TRUxFQ1RPUiApICk7DQoNCgkJCS8vIE5vdyB0aGF0IHdlIGtub3cgd2hpY2ggdGhlIGhvcml6b250YWwgc2xpZGUgaXMsIGdldCBpdHMgaW5kZXgNCgkJCWggPSBNYXRoLm1heCggaG9yaXpvbnRhbFNsaWRlcy5pbmRleE9mKCBzbGlkZWggKSwgMCApOw0KDQoJCQkvLyBBc3N1bWUgd2UncmUgbm90IHZlcnRpY2FsDQoJCQl2ID0gdW5kZWZpbmVkOw0KDQoJCQkvLyBJZiB0aGlzIGlzIGEgdmVydGljYWwgc2xpZGUsIGdyYWIgdGhlIHZlcnRpY2FsIGluZGV4DQoJCQlpZiggaXNWZXJ0aWNhbCApIHsNCgkJCQl2ID0gTWF0aC5tYXgoIHRvQXJyYXkoIHNsaWRlLnBhcmVudE5vZGUucXVlcnlTZWxlY3RvckFsbCggJ3NlY3Rpb24nICkgKS5pbmRleE9mKCBzbGlkZSApLCAwICk7DQoJCQl9DQoJCX0NCg0KCQlpZiggIXNsaWRlICYmIGN1cnJlbnRTbGlkZSApIHsNCgkJCXZhciBoYXNGcmFnbWVudHMgPSBjdXJyZW50U2xpZGUucXVlcnlTZWxlY3RvckFsbCggJy5mcmFnbWVudCcgKS5sZW5ndGggPiAwOw0KCQkJaWYoIGhhc0ZyYWdtZW50cyApIHsNCgkJCQl2YXIgY3VycmVudEZyYWdtZW50ID0gY3VycmVudFNsaWRlLnF1ZXJ5U2VsZWN0b3IoICcuY3VycmVudC1mcmFnbWVudCcgKTsNCgkJCQlpZiggY3VycmVudEZyYWdtZW50ICYmIGN1cnJlbnRGcmFnbWVudC5oYXNBdHRyaWJ1dGUoICdkYXRhLWZyYWdtZW50LWluZGV4JyApICkgew0KCQkJCQlmID0gcGFyc2VJbnQoIGN1cnJlbnRGcmFnbWVudC5nZXRBdHRyaWJ1dGUoICdkYXRhLWZyYWdtZW50LWluZGV4JyApLCAxMCApOw0KCQkJCX0NCgkJCQllbHNlIHsNCgkJCQkJZiA9IGN1cnJlbnRTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnLmZyYWdtZW50LnZpc2libGUnICkubGVuZ3RoIC0gMTsNCgkJCQl9DQoJCQl9DQoJCX0NCg0KCQlyZXR1cm4geyBoOiBoLCB2OiB2LCBmOiBmIH07DQoNCgl9DQoNCgkvKioNCgkgKiBSZXRyaWV2ZXMgdGhlIHRvdGFsIG51bWJlciBvZiBzbGlkZXMgaW4gdGhpcyBwcmVzZW50YXRpb24uDQoJICoNCgkgKiBAcmV0dXJuIHtudW1iZXJ9DQoJICovDQoJZnVuY3Rpb24gZ2V0VG90YWxTbGlkZXMoKSB7DQoNCgkJcmV0dXJuIGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIFNMSURFU19TRUxFQ1RPUiArICc6bm90KC5zdGFjayknICkubGVuZ3RoOw0KDQoJfQ0KDQoJLyoqDQoJICogUmV0dXJucyB0aGUgc2xpZGUgZWxlbWVudCBtYXRjaGluZyB0aGUgc3BlY2lmaWVkIGluZGV4Lg0KCSAqDQoJICogQHJldHVybiB7SFRNTEVsZW1lbnR9DQoJICovDQoJZnVuY3Rpb24gZ2V0U2xpZGUoIHgsIHkgKSB7DQoNCgkJdmFyIGhvcml6b250YWxTbGlkZSA9IGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIEhPUklaT05UQUxfU0xJREVTX1NFTEVDVE9SIClbIHggXTsNCgkJdmFyIHZlcnRpY2FsU2xpZGVzID0gaG9yaXpvbnRhbFNsaWRlICYmIGhvcml6b250YWxTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnc2VjdGlvbicgKTsNCg0KCQlpZiggdmVydGljYWxTbGlkZXMgJiYgdmVydGljYWxTbGlkZXMubGVuZ3RoICYmIHR5cGVvZiB5ID09PSAnbnVtYmVyJyApIHsNCgkJCXJldHVybiB2ZXJ0aWNhbFNsaWRlcyA/IHZlcnRpY2FsU2xpZGVzWyB5IF0gOiB1bmRlZmluZWQ7DQoJCX0NCg0KCQlyZXR1cm4gaG9yaXpvbnRhbFNsaWRlOw0KDQoJfQ0KDQoJLyoqDQoJICogUmV0dXJucyB0aGUgYmFja2dyb3VuZCBlbGVtZW50IGZvciB0aGUgZ2l2ZW4gc2xpZGUuDQoJICogQWxsIHNsaWRlcywgZXZlbiB0aGUgb25lcyB3aXRoIG5vIGJhY2tncm91bmQgcHJvcGVydGllcw0KCSAqIGRlZmluZWQsIGhhdmUgYSBiYWNrZ3JvdW5kIGVsZW1lbnQgc28gYXMgbG9uZyBhcyB0aGUNCgkgKiBpbmRleCBpcyB2YWxpZCBhbiBlbGVtZW50IHdpbGwgYmUgcmV0dXJuZWQuDQoJICoNCgkgKiBAcGFyYW0ge251bWJlcn0geCBIb3Jpem9udGFsIGJhY2tncm91bmQgaW5kZXgNCgkgKiBAcGFyYW0ge251bWJlcn0geSBWZXJ0aWNhbCBiYWNrZ3JvdW5kIGluZGV4DQoJICogQHJldHVybiB7KEhUTUxFbGVtZW50W118Kil9DQoJICovDQoJZnVuY3Rpb24gZ2V0U2xpZGVCYWNrZ3JvdW5kKCB4LCB5ICkgew0KDQoJCS8vIFdoZW4gcHJpbnRpbmcgdG8gUERGIHRoZSBzbGlkZSBiYWNrZ3JvdW5kcyBhcmUgbmVzdGVkDQoJCS8vIGluc2lkZSBvZiB0aGUgc2xpZGVzDQoJCWlmKCBpc1ByaW50aW5nUERGKCkgKSB7DQoJCQl2YXIgc2xpZGUgPSBnZXRTbGlkZSggeCwgeSApOw0KCQkJaWYoIHNsaWRlICkgew0KCQkJCXJldHVybiBzbGlkZS5zbGlkZUJhY2tncm91bmRFbGVtZW50Ow0KCQkJfQ0KDQoJCQlyZXR1cm4gdW5kZWZpbmVkOw0KCQl9DQoNCgkJdmFyIGhvcml6b250YWxCYWNrZ3JvdW5kID0gZG9tLndyYXBwZXIucXVlcnlTZWxlY3RvckFsbCggJy5iYWNrZ3JvdW5kcz4uc2xpZGUtYmFja2dyb3VuZCcgKVsgeCBdOw0KCQl2YXIgdmVydGljYWxCYWNrZ3JvdW5kcyA9IGhvcml6b250YWxCYWNrZ3JvdW5kICYmIGhvcml6b250YWxCYWNrZ3JvdW5kLnF1ZXJ5U2VsZWN0b3JBbGwoICcuc2xpZGUtYmFja2dyb3VuZCcgKTsNCg0KCQlpZiggdmVydGljYWxCYWNrZ3JvdW5kcyAmJiB2ZXJ0aWNhbEJhY2tncm91bmRzLmxlbmd0aCAmJiB0eXBlb2YgeSA9PT0gJ251bWJlcicgKSB7DQoJCQlyZXR1cm4gdmVydGljYWxCYWNrZ3JvdW5kcyA/IHZlcnRpY2FsQmFja2dyb3VuZHNbIHkgXSA6IHVuZGVmaW5lZDsNCgkJfQ0KDQoJCXJldHVybiBob3Jpem9udGFsQmFja2dyb3VuZDsNCg0KCX0NCg0KCS8qKg0KCSAqIFJldHJpZXZlcyB0aGUgc3BlYWtlciBub3RlcyBmcm9tIGEgc2xpZGUuIE5vdGVzIGNhbiBiZQ0KCSAqIGRlZmluZWQgaW4gdHdvIHdheXM6DQoJICogMS4gQXMgYSBkYXRhLW5vdGVzIGF0dHJpYnV0ZSBvbiB0aGUgc2xpZGUgPHNlY3Rpb24+DQoJICogMi4gQXMgYW4gPGFzaWRlIGNsYXNzPSJub3RlcyI+IGluc2lkZSBvZiB0aGUgc2xpZGUNCgkgKg0KCSAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IFtzbGlkZT1jdXJyZW50U2xpZGVdDQoJICogQHJldHVybiB7KHN0cmluZ3xudWxsKX0NCgkgKi8NCglmdW5jdGlvbiBnZXRTbGlkZU5vdGVzKCBzbGlkZSApIHsNCg0KCQkvLyBEZWZhdWx0IHRvIHRoZSBjdXJyZW50IHNsaWRlDQoJCXNsaWRlID0gc2xpZGUgfHwgY3VycmVudFNsaWRlOw0KDQoJCS8vIE5vdGVzIGNhbiBiZSBzcGVjaWZpZWQgdmlhIHRoZSBkYXRhLW5vdGVzIGF0dHJpYnV0ZS4uLg0KCQlpZiggc2xpZGUuaGFzQXR0cmlidXRlKCAnZGF0YS1ub3RlcycgKSApIHsNCgkJCXJldHVybiBzbGlkZS5nZXRBdHRyaWJ1dGUoICdkYXRhLW5vdGVzJyApOw0KCQl9DQoNCgkJLy8gLi4uIG9yIHVzaW5nIGFuIDxhc2lkZSBjbGFzcz0ibm90ZXMiPiBlbGVtZW50DQoJCXZhciBub3Rlc0VsZW1lbnQgPSBzbGlkZS5xdWVyeVNlbGVjdG9yKCAnYXNpZGUubm90ZXMnICk7DQoJCWlmKCBub3Rlc0VsZW1lbnQgKSB7DQoJCQlyZXR1cm4gbm90ZXNFbGVtZW50LmlubmVySFRNTDsNCgkJfQ0KDQoJCXJldHVybiBudWxsOw0KDQoJfQ0KDQoJLyoqDQoJICogUmV0cmlldmVzIHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBwcmVzZW50YXRpb24gYXMNCgkgKiBhbiBvYmplY3QuIFRoaXMgc3RhdGUgY2FuIHRoZW4gYmUgcmVzdG9yZWQgYXQgYW55DQoJICogdGltZS4NCgkgKg0KCSAqIEByZXR1cm4ge3tpbmRleGg6IG51bWJlciwgaW5kZXh2OiBudW1iZXIsIGluZGV4ZjogbnVtYmVyLCBwYXVzZWQ6IGJvb2xlYW4sIG92ZXJ2aWV3OiBib29sZWFufX0NCgkgKi8NCglmdW5jdGlvbiBnZXRTdGF0ZSgpIHsNCg0KCQl2YXIgaW5kaWNlcyA9IGdldEluZGljZXMoKTsNCg0KCQlyZXR1cm4gew0KCQkJaW5kZXhoOiBpbmRpY2VzLmgsDQoJCQlpbmRleHY6IGluZGljZXMudiwNCgkJCWluZGV4ZjogaW5kaWNlcy5mLA0KCQkJcGF1c2VkOiBpc1BhdXNlZCgpLA0KCQkJb3ZlcnZpZXc6IGlzT3ZlcnZpZXcoKQ0KCQl9Ow0KDQoJfQ0KDQoJLyoqDQoJICogUmVzdG9yZXMgdGhlIHByZXNlbnRhdGlvbiB0byB0aGUgZ2l2ZW4gc3RhdGUuDQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gc3RhdGUgQXMgZ2VuZXJhdGVkIGJ5IGdldFN0YXRlKCkNCgkgKiBAc2VlIHtAbGluayBnZXRTdGF0ZX0gZ2VuZXJhdGVzIHRoZSBwYXJhbWV0ZXIgYHN0YXRlYA0KCSAqLw0KCWZ1bmN0aW9uIHNldFN0YXRlKCBzdGF0ZSApIHsNCg0KCQlpZiggdHlwZW9mIHN0YXRlID09PSAnb2JqZWN0JyApIHsNCgkJCXNsaWRlKCBkZXNlcmlhbGl6ZSggc3RhdGUuaW5kZXhoICksIGRlc2VyaWFsaXplKCBzdGF0ZS5pbmRleHYgKSwgZGVzZXJpYWxpemUoIHN0YXRlLmluZGV4ZiApICk7DQoNCgkJCXZhciBwYXVzZWRGbGFnID0gZGVzZXJpYWxpemUoIHN0YXRlLnBhdXNlZCApLA0KCQkJCW92ZXJ2aWV3RmxhZyA9IGRlc2VyaWFsaXplKCBzdGF0ZS5vdmVydmlldyApOw0KDQoJCQlpZiggdHlwZW9mIHBhdXNlZEZsYWcgPT09ICdib29sZWFuJyAmJiBwYXVzZWRGbGFnICE9PSBpc1BhdXNlZCgpICkgew0KCQkJCXRvZ2dsZVBhdXNlKCBwYXVzZWRGbGFnICk7DQoJCQl9DQoNCgkJCWlmKCB0eXBlb2Ygb3ZlcnZpZXdGbGFnID09PSAnYm9vbGVhbicgJiYgb3ZlcnZpZXdGbGFnICE9PSBpc092ZXJ2aWV3KCkgKSB7DQoJCQkJdG9nZ2xlT3ZlcnZpZXcoIG92ZXJ2aWV3RmxhZyApOw0KCQkJfQ0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBSZXR1cm4gYSBzb3J0ZWQgZnJhZ21lbnRzIGxpc3QsIG9yZGVyZWQgYnkgYW4gaW5jcmVhc2luZw0KCSAqICJkYXRhLWZyYWdtZW50LWluZGV4IiBhdHRyaWJ1dGUuDQoJICoNCgkgKiBGcmFnbWVudHMgd2lsbCBiZSByZXZlYWxlZCBpbiB0aGUgb3JkZXIgdGhhdCB0aGV5IGFyZSByZXR1cm5lZCBieQ0KCSAqIHRoaXMgZnVuY3Rpb24sIHNvIHlvdSBjYW4gdXNlIHRoZSBpbmRleCBhdHRyaWJ1dGVzIHRvIGNvbnRyb2wgdGhlDQoJICogb3JkZXIgb2YgZnJhZ21lbnQgYXBwZWFyYW5jZS4NCgkgKg0KCSAqIFRvIG1haW50YWluIGEgc2Vuc2libGUgZGVmYXVsdCBmcmFnbWVudCBvcmRlciwgZnJhZ21lbnRzIGFyZSBwcmVzdW1lZA0KCSAqIHRvIGJlIHBhc3NlZCBpbiBkb2N1bWVudCBvcmRlci4gVGhpcyBmdW5jdGlvbiBhZGRzIGEgImZyYWdtZW50LWluZGV4Ig0KCSAqIGF0dHJpYnV0ZSB0byBlYWNoIG5vZGUgaWYgc3VjaCBhbiBhdHRyaWJ1dGUgaXMgbm90IGFscmVhZHkgcHJlc2VudCwNCgkgKiBhbmQgc2V0cyB0aGF0IGF0dHJpYnV0ZSB0byBhbiBpbnRlZ2VyIHZhbHVlIHdoaWNoIGlzIHRoZSBwb3NpdGlvbiBvZg0KCSAqIHRoZSBmcmFnbWVudCB3aXRoaW4gdGhlIGZyYWdtZW50cyBsaXN0Lg0KCSAqDQoJICogQHBhcmFtIHtvYmplY3RbXXwqfSBmcmFnbWVudHMNCgkgKiBAcmV0dXJuIHtvYmplY3RbXX0gc29ydGVkIFNvcnRlZCBhcnJheSBvZiBmcmFnbWVudHMNCgkgKi8NCglmdW5jdGlvbiBzb3J0RnJhZ21lbnRzKCBmcmFnbWVudHMgKSB7DQoNCgkJZnJhZ21lbnRzID0gdG9BcnJheSggZnJhZ21lbnRzICk7DQoNCgkJdmFyIG9yZGVyZWQgPSBbXSwNCgkJCXVub3JkZXJlZCA9IFtdLA0KCQkJc29ydGVkID0gW107DQoNCgkJLy8gR3JvdXAgb3JkZXJlZCBhbmQgdW5vcmRlcmVkIGVsZW1lbnRzDQoJCWZyYWdtZW50cy5mb3JFYWNoKCBmdW5jdGlvbiggZnJhZ21lbnQsIGkgKSB7DQoJCQlpZiggZnJhZ21lbnQuaGFzQXR0cmlidXRlKCAnZGF0YS1mcmFnbWVudC1pbmRleCcgKSApIHsNCgkJCQl2YXIgaW5kZXggPSBwYXJzZUludCggZnJhZ21lbnQuZ2V0QXR0cmlidXRlKCAnZGF0YS1mcmFnbWVudC1pbmRleCcgKSwgMTAgKTsNCg0KCQkJCWlmKCAhb3JkZXJlZFtpbmRleF0gKSB7DQoJCQkJCW9yZGVyZWRbaW5kZXhdID0gW107DQoJCQkJfQ0KDQoJCQkJb3JkZXJlZFtpbmRleF0ucHVzaCggZnJhZ21lbnQgKTsNCgkJCX0NCgkJCWVsc2Ugew0KCQkJCXVub3JkZXJlZC5wdXNoKCBbIGZyYWdtZW50IF0gKTsNCgkJCX0NCgkJfSApOw0KDQoJCS8vIEFwcGVuZCBmcmFnbWVudHMgd2l0aG91dCBleHBsaWNpdCBpbmRpY2VzIGluIHRoZWlyDQoJCS8vIERPTSBvcmRlcg0KCQlvcmRlcmVkID0gb3JkZXJlZC5jb25jYXQoIHVub3JkZXJlZCApOw0KDQoJCS8vIE1hbnVhbGx5IGNvdW50IHRoZSBpbmRleCB1cCBwZXIgZ3JvdXAgdG8gZW5zdXJlIHRoZXJlDQoJCS8vIGFyZSBubyBnYXBzDQoJCXZhciBpbmRleCA9IDA7DQoNCgkJLy8gUHVzaCBhbGwgZnJhZ21lbnRzIGluIHRoZWlyIHNvcnRlZCBvcmRlciB0byBhbiBhcnJheSwNCgkJLy8gdGhpcyBmbGF0dGVucyB0aGUgZ3JvdXBzDQoJCW9yZGVyZWQuZm9yRWFjaCggZnVuY3Rpb24oIGdyb3VwICkgew0KCQkJZ3JvdXAuZm9yRWFjaCggZnVuY3Rpb24oIGZyYWdtZW50ICkgew0KCQkJCXNvcnRlZC5wdXNoKCBmcmFnbWVudCApOw0KCQkJCWZyYWdtZW50LnNldEF0dHJpYnV0ZSggJ2RhdGEtZnJhZ21lbnQtaW5kZXgnLCBpbmRleCApOw0KCQkJfSApOw0KDQoJCQlpbmRleCArKzsNCgkJfSApOw0KDQoJCXJldHVybiBzb3J0ZWQ7DQoNCgl9DQoNCgkvKioNCgkgKiBOYXZpZ2F0ZSB0byB0aGUgc3BlY2lmaWVkIHNsaWRlIGZyYWdtZW50Lg0KCSAqDQoJICogQHBhcmFtIHs/bnVtYmVyfSBpbmRleCBUaGUgaW5kZXggb2YgdGhlIGZyYWdtZW50IHRoYXQNCgkgKiBzaG91bGQgYmUgc2hvd24sIC0xIG1lYW5zIGFsbCBhcmUgaW52aXNpYmxlDQoJICogQHBhcmFtIHtudW1iZXJ9IG9mZnNldCBJbnRlZ2VyIG9mZnNldCB0byBhcHBseSB0byB0aGUNCgkgKiBmcmFnbWVudCBpbmRleA0KCSAqDQoJICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiBhIGNoYW5nZSB3YXMgbWFkZSBpbiBhbnkNCgkgKiBmcmFnbWVudHMgdmlzaWJpbGl0eSBhcyBwYXJ0IG9mIHRoaXMgY2FsbA0KCSAqLw0KCWZ1bmN0aW9uIG5hdmlnYXRlRnJhZ21lbnQoIGluZGV4LCBvZmZzZXQgKSB7DQoNCgkJaWYoIGN1cnJlbnRTbGlkZSAmJiBjb25maWcuZnJhZ21lbnRzICkgew0KDQoJCQl2YXIgZnJhZ21lbnRzID0gc29ydEZyYWdtZW50cyggY3VycmVudFNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICcuZnJhZ21lbnQnICkgKTsNCgkJCWlmKCBmcmFnbWVudHMubGVuZ3RoICkgew0KDQoJCQkJLy8gSWYgbm8gaW5kZXggaXMgc3BlY2lmaWVkLCBmaW5kIHRoZSBjdXJyZW50DQoJCQkJaWYoIHR5cGVvZiBpbmRleCAhPT0gJ251bWJlcicgKSB7DQoJCQkJCXZhciBsYXN0VmlzaWJsZUZyYWdtZW50ID0gc29ydEZyYWdtZW50cyggY3VycmVudFNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICcuZnJhZ21lbnQudmlzaWJsZScgKSApLnBvcCgpOw0KDQoJCQkJCWlmKCBsYXN0VmlzaWJsZUZyYWdtZW50ICkgew0KCQkJCQkJaW5kZXggPSBwYXJzZUludCggbGFzdFZpc2libGVGcmFnbWVudC5nZXRBdHRyaWJ1dGUoICdkYXRhLWZyYWdtZW50LWluZGV4JyApIHx8IDAsIDEwICk7DQoJCQkJCX0NCgkJCQkJZWxzZSB7DQoJCQkJCQlpbmRleCA9IC0xOw0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJLy8gSWYgYW4gb2Zmc2V0IGlzIHNwZWNpZmllZCwgYXBwbHkgaXQgdG8gdGhlIGluZGV4DQoJCQkJaWYoIHR5cGVvZiBvZmZzZXQgPT09ICdudW1iZXInICkgew0KCQkJCQlpbmRleCArPSBvZmZzZXQ7DQoJCQkJfQ0KDQoJCQkJdmFyIGZyYWdtZW50c1Nob3duID0gW10sDQoJCQkJCWZyYWdtZW50c0hpZGRlbiA9IFtdOw0KDQoJCQkJdG9BcnJheSggZnJhZ21lbnRzICkuZm9yRWFjaCggZnVuY3Rpb24oIGVsZW1lbnQsIGkgKSB7DQoNCgkJCQkJaWYoIGVsZW1lbnQuaGFzQXR0cmlidXRlKCAnZGF0YS1mcmFnbWVudC1pbmRleCcgKSApIHsNCgkJCQkJCWkgPSBwYXJzZUludCggZWxlbWVudC5nZXRBdHRyaWJ1dGUoICdkYXRhLWZyYWdtZW50LWluZGV4JyApLCAxMCApOw0KCQkJCQl9DQoNCgkJCQkJLy8gVmlzaWJsZSBmcmFnbWVudHMNCgkJCQkJaWYoIGkgPD0gaW5kZXggKSB7DQoJCQkJCQlpZiggIWVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCAndmlzaWJsZScgKSApIGZyYWdtZW50c1Nob3duLnB1c2goIGVsZW1lbnQgKTsNCgkJCQkJCWVsZW1lbnQuY2xhc3NMaXN0LmFkZCggJ3Zpc2libGUnICk7DQoJCQkJCQllbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoICdjdXJyZW50LWZyYWdtZW50JyApOw0KDQoJCQkJCQkvLyBBbm5vdW5jZSB0aGUgZnJhZ21lbnRzIG9uZSBieSBvbmUgdG8gdGhlIFNjcmVlbiBSZWFkZXINCgkJCQkJCWRvbS5zdGF0dXNEaXYudGV4dENvbnRlbnQgPSBnZXRTdGF0dXNUZXh0KCBlbGVtZW50ICk7DQoNCgkJCQkJCWlmKCBpID09PSBpbmRleCApIHsNCgkJCQkJCQllbGVtZW50LmNsYXNzTGlzdC5hZGQoICdjdXJyZW50LWZyYWdtZW50JyApOw0KCQkJCQkJCXN0YXJ0RW1iZWRkZWRDb250ZW50KCBlbGVtZW50ICk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQkJLy8gSGlkZGVuIGZyYWdtZW50cw0KCQkJCQllbHNlIHsNCgkJCQkJCWlmKCBlbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyggJ3Zpc2libGUnICkgKSBmcmFnbWVudHNIaWRkZW4ucHVzaCggZWxlbWVudCApOw0KCQkJCQkJZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCAndmlzaWJsZScgKTsNCgkJCQkJCWVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSggJ2N1cnJlbnQtZnJhZ21lbnQnICk7DQoJCQkJCX0NCg0KCQkJCX0gKTsNCg0KCQkJCWlmKCBmcmFnbWVudHNIaWRkZW4ubGVuZ3RoICkgew0KCQkJCQlkaXNwYXRjaEV2ZW50KCAnZnJhZ21lbnRoaWRkZW4nLCB7IGZyYWdtZW50OiBmcmFnbWVudHNIaWRkZW5bMF0sIGZyYWdtZW50czogZnJhZ21lbnRzSGlkZGVuIH0gKTsNCgkJCQl9DQoNCgkJCQlpZiggZnJhZ21lbnRzU2hvd24ubGVuZ3RoICkgew0KCQkJCQlkaXNwYXRjaEV2ZW50KCAnZnJhZ21lbnRzaG93bicsIHsgZnJhZ21lbnQ6IGZyYWdtZW50c1Nob3duWzBdLCBmcmFnbWVudHM6IGZyYWdtZW50c1Nob3duIH0gKTsNCgkJCQl9DQoNCgkJCQl1cGRhdGVDb250cm9scygpOw0KCQkJCXVwZGF0ZVByb2dyZXNzKCk7DQoNCgkJCQlyZXR1cm4gISEoIGZyYWdtZW50c1Nob3duLmxlbmd0aCB8fCBmcmFnbWVudHNIaWRkZW4ubGVuZ3RoICk7DQoNCgkJCX0NCg0KCQl9DQoNCgkJcmV0dXJuIGZhbHNlOw0KDQoJfQ0KDQoJLyoqDQoJICogTmF2aWdhdGUgdG8gdGhlIG5leHQgc2xpZGUgZnJhZ21lbnQuDQoJICoNCgkgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZXJlIHdhcyBhIG5leHQgZnJhZ21lbnQsDQoJICogZmFsc2Ugb3RoZXJ3aXNlDQoJICovDQoJZnVuY3Rpb24gbmV4dEZyYWdtZW50KCkgew0KDQoJCXJldHVybiBuYXZpZ2F0ZUZyYWdtZW50KCBudWxsLCAxICk7DQoNCgl9DQoNCgkvKioNCgkgKiBOYXZpZ2F0ZSB0byB0aGUgcHJldmlvdXMgc2xpZGUgZnJhZ21lbnQuDQoJICoNCgkgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZXJlIHdhcyBhIHByZXZpb3VzIGZyYWdtZW50LA0KCSAqIGZhbHNlIG90aGVyd2lzZQ0KCSAqLw0KCWZ1bmN0aW9uIHByZXZpb3VzRnJhZ21lbnQoKSB7DQoNCgkJcmV0dXJuIG5hdmlnYXRlRnJhZ21lbnQoIG51bGwsIC0xICk7DQoNCgl9DQoNCgkvKioNCgkgKiBDdWVzIGEgbmV3IGF1dG9tYXRlZCBzbGlkZSBpZiBlbmFibGVkIGluIHRoZSBjb25maWcuDQoJICovDQoJZnVuY3Rpb24gY3VlQXV0b1NsaWRlKCkgew0KDQoJCWNhbmNlbEF1dG9TbGlkZSgpOw0KDQoJCWlmKCBjdXJyZW50U2xpZGUgKSB7DQoNCgkJCXZhciBmcmFnbWVudCA9IGN1cnJlbnRTbGlkZS5xdWVyeVNlbGVjdG9yKCAnLmN1cnJlbnQtZnJhZ21lbnQnICk7DQoNCgkJCS8vIFdoZW4gdGhlIHNsaWRlIGZpcnN0IGFwcGVhcnMgdGhlcmUgaXMgbm8gImN1cnJlbnQiIGZyYWdtZW50IHNvDQoJCQkvLyB3ZSBsb29rIGZvciBhIGRhdGEtYXV0b3NsaWRlIHRpbWluZyBvbiB0aGUgZmlyc3QgZnJhZ21lbnQNCgkJCWlmKCAhZnJhZ21lbnQgKSBmcmFnbWVudCA9IGN1cnJlbnRTbGlkZS5xdWVyeVNlbGVjdG9yKCAnLmZyYWdtZW50JyApOw0KDQoJCQl2YXIgZnJhZ21lbnRBdXRvU2xpZGUgPSBmcmFnbWVudCA/IGZyYWdtZW50LmdldEF0dHJpYnV0ZSggJ2RhdGEtYXV0b3NsaWRlJyApIDogbnVsbDsNCgkJCXZhciBwYXJlbnRBdXRvU2xpZGUgPSBjdXJyZW50U2xpZGUucGFyZW50Tm9kZSA/IGN1cnJlbnRTbGlkZS5wYXJlbnROb2RlLmdldEF0dHJpYnV0ZSggJ2RhdGEtYXV0b3NsaWRlJyApIDogbnVsbDsNCgkJCXZhciBzbGlkZUF1dG9TbGlkZSA9IGN1cnJlbnRTbGlkZS5nZXRBdHRyaWJ1dGUoICdkYXRhLWF1dG9zbGlkZScgKTsNCg0KCQkJLy8gUGljayB2YWx1ZSBpbiB0aGUgZm9sbG93aW5nIHByaW9yaXR5IG9yZGVyOg0KCQkJLy8gMS4gQ3VycmVudCBmcmFnbWVudCdzIGRhdGEtYXV0b3NsaWRlDQoJCQkvLyAyLiBDdXJyZW50IHNsaWRlJ3MgZGF0YS1hdXRvc2xpZGUNCgkJCS8vIDMuIFBhcmVudCBzbGlkZSdzIGRhdGEtYXV0b3NsaWRlDQoJCQkvLyA0LiBHbG9iYWwgYXV0b1NsaWRlIHNldHRpbmcNCgkJCWlmKCBmcmFnbWVudEF1dG9TbGlkZSApIHsNCgkJCQlhdXRvU2xpZGUgPSBwYXJzZUludCggZnJhZ21lbnRBdXRvU2xpZGUsIDEwICk7DQoJCQl9DQoJCQllbHNlIGlmKCBzbGlkZUF1dG9TbGlkZSApIHsNCgkJCQlhdXRvU2xpZGUgPSBwYXJzZUludCggc2xpZGVBdXRvU2xpZGUsIDEwICk7DQoJCQl9DQoJCQllbHNlIGlmKCBwYXJlbnRBdXRvU2xpZGUgKSB7DQoJCQkJYXV0b1NsaWRlID0gcGFyc2VJbnQoIHBhcmVudEF1dG9TbGlkZSwgMTAgKTsNCgkJCX0NCgkJCWVsc2Ugew0KCQkJCWF1dG9TbGlkZSA9IGNvbmZpZy5hdXRvU2xpZGU7DQoJCQl9DQoNCgkJCS8vIElmIHRoZXJlIGFyZSBtZWRpYSBlbGVtZW50cyB3aXRoIGRhdGEtYXV0b3BsYXksDQoJCQkvLyBhdXRvbWF0aWNhbGx5IHNldCB0aGUgYXV0b1NsaWRlIGR1cmF0aW9uIHRvIHRoZQ0KCQkJLy8gbGVuZ3RoIG9mIHRoYXQgbWVkaWEuIE5vdCBhcHBsaWNhYmxlIGlmIHRoZSBzbGlkZQ0KCQkJLy8gaXMgZGl2aWRlZCB1cCBpbnRvIGZyYWdtZW50cy4gDQoJCQkvLyBwbGF5YmFja1JhdGUgaXMgYWNjb3VudGVkIGZvciBpbiB0aGUgZHVyYXRpb24uDQoJCQlpZiggY3VycmVudFNsaWRlLnF1ZXJ5U2VsZWN0b3JBbGwoICcuZnJhZ21lbnQnICkubGVuZ3RoID09PSAwICkgew0KCQkJCXRvQXJyYXkoIGN1cnJlbnRTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAndmlkZW8sIGF1ZGlvJyApICkuZm9yRWFjaCggZnVuY3Rpb24oIGVsICkgew0KCQkJCQlpZiggZWwuaGFzQXR0cmlidXRlKCAnZGF0YS1hdXRvcGxheScgKSApIHsNCgkJCQkJCWlmKCBhdXRvU2xpZGUgJiYgKGVsLmR1cmF0aW9uICogMTAwMCAvIGVsLnBsYXliYWNrUmF0ZSApID4gYXV0b1NsaWRlICkgew0KCQkJCQkJCWF1dG9TbGlkZSA9ICggZWwuZHVyYXRpb24gKiAxMDAwIC8gZWwucGxheWJhY2tSYXRlICkgKyAxMDAwOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfSApOw0KCQkJfQ0KDQoJCQkvLyBDdWUgdGhlIG5leHQgYXV0by1zbGlkZSBpZjoNCgkJCS8vIC0gVGhlcmUgaXMgYW4gYXV0b1NsaWRlIHZhbHVlDQoJCQkvLyAtIEF1dG8tc2xpZGluZyBpc24ndCBwYXVzZWQgYnkgdGhlIHVzZXINCgkJCS8vIC0gVGhlIHByZXNlbnRhdGlvbiBpc24ndCBwYXVzZWQNCgkJCS8vIC0gVGhlIG92ZXJ2aWV3IGlzbid0IGFjdGl2ZQ0KCQkJLy8gLSBUaGUgcHJlc2VudGF0aW9uIGlzbid0IG92ZXINCgkJCWlmKCBhdXRvU2xpZGUgJiYgIWF1dG9TbGlkZVBhdXNlZCAmJiAhaXNQYXVzZWQoKSAmJiAhaXNPdmVydmlldygpICYmICggIVJldmVhbC5pc0xhc3RTbGlkZSgpIHx8IGF2YWlsYWJsZUZyYWdtZW50cygpLm5leHQgfHwgY29uZmlnLmxvb3AgPT09IHRydWUgKSApIHsNCgkJCQlhdXRvU2xpZGVUaW1lb3V0ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7DQoJCQkJCXR5cGVvZiBjb25maWcuYXV0b1NsaWRlTWV0aG9kID09PSAnZnVuY3Rpb24nID8gY29uZmlnLmF1dG9TbGlkZU1ldGhvZCgpIDogbmF2aWdhdGVOZXh0KCk7DQoJCQkJCWN1ZUF1dG9TbGlkZSgpOw0KCQkJCX0sIGF1dG9TbGlkZSApOw0KCQkJCWF1dG9TbGlkZVN0YXJ0VGltZSA9IERhdGUubm93KCk7DQoJCQl9DQoNCgkJCWlmKCBhdXRvU2xpZGVQbGF5ZXIgKSB7DQoJCQkJYXV0b1NsaWRlUGxheWVyLnNldFBsYXlpbmcoIGF1dG9TbGlkZVRpbWVvdXQgIT09IC0xICk7DQoJCQl9DQoNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogQ2FuY2VscyBhbnkgb25nb2luZyByZXF1ZXN0IHRvIGF1dG8tc2xpZGUuDQoJICovDQoJZnVuY3Rpb24gY2FuY2VsQXV0b1NsaWRlKCkgew0KDQoJCWNsZWFyVGltZW91dCggYXV0b1NsaWRlVGltZW91dCApOw0KCQlhdXRvU2xpZGVUaW1lb3V0ID0gLTE7DQoNCgl9DQoNCglmdW5jdGlvbiBwYXVzZUF1dG9TbGlkZSgpIHsNCg0KCQlpZiggYXV0b1NsaWRlICYmICFhdXRvU2xpZGVQYXVzZWQgKSB7DQoJCQlhdXRvU2xpZGVQYXVzZWQgPSB0cnVlOw0KCQkJZGlzcGF0Y2hFdmVudCggJ2F1dG9zbGlkZXBhdXNlZCcgKTsNCgkJCWNsZWFyVGltZW91dCggYXV0b1NsaWRlVGltZW91dCApOw0KDQoJCQlpZiggYXV0b1NsaWRlUGxheWVyICkgew0KCQkJCWF1dG9TbGlkZVBsYXllci5zZXRQbGF5aW5nKCBmYWxzZSApOw0KCQkJfQ0KCQl9DQoNCgl9DQoNCglmdW5jdGlvbiByZXN1bWVBdXRvU2xpZGUoKSB7DQoNCgkJaWYoIGF1dG9TbGlkZSAmJiBhdXRvU2xpZGVQYXVzZWQgKSB7DQoJCQlhdXRvU2xpZGVQYXVzZWQgPSBmYWxzZTsNCgkJCWRpc3BhdGNoRXZlbnQoICdhdXRvc2xpZGVyZXN1bWVkJyApOw0KCQkJY3VlQXV0b1NsaWRlKCk7DQoJCX0NCg0KCX0NCg0KCWZ1bmN0aW9uIG5hdmlnYXRlTGVmdCgpIHsNCg0KCQkvLyBSZXZlcnNlIGZvciBSVEwNCgkJaWYoIGNvbmZpZy5ydGwgKSB7DQoJCQlpZiggKCBpc092ZXJ2aWV3KCkgfHwgbmV4dEZyYWdtZW50KCkgPT09IGZhbHNlICkgJiYgYXZhaWxhYmxlUm91dGVzKCkubGVmdCApIHsNCgkJCQlzbGlkZSggaW5kZXhoICsgMSApOw0KCQkJfQ0KCQl9DQoJCS8vIE5vcm1hbCBuYXZpZ2F0aW9uDQoJCWVsc2UgaWYoICggaXNPdmVydmlldygpIHx8IHByZXZpb3VzRnJhZ21lbnQoKSA9PT0gZmFsc2UgKSAmJiBhdmFpbGFibGVSb3V0ZXMoKS5sZWZ0ICkgew0KCQkJc2xpZGUoIGluZGV4aCAtIDEgKTsNCgkJfQ0KDQoJfQ0KDQoJZnVuY3Rpb24gbmF2aWdhdGVSaWdodCgpIHsNCg0KCQkvLyBSZXZlcnNlIGZvciBSVEwNCgkJaWYoIGNvbmZpZy5ydGwgKSB7DQoJCQlpZiggKCBpc092ZXJ2aWV3KCkgfHwgcHJldmlvdXNGcmFnbWVudCgpID09PSBmYWxzZSApICYmIGF2YWlsYWJsZVJvdXRlcygpLnJpZ2h0ICkgew0KCQkJCXNsaWRlKCBpbmRleGggLSAxICk7DQoJCQl9DQoJCX0NCgkJLy8gTm9ybWFsIG5hdmlnYXRpb24NCgkJZWxzZSBpZiggKCBpc092ZXJ2aWV3KCkgfHwgbmV4dEZyYWdtZW50KCkgPT09IGZhbHNlICkgJiYgYXZhaWxhYmxlUm91dGVzKCkucmlnaHQgKSB7DQoJCQlzbGlkZSggaW5kZXhoICsgMSApOw0KCQl9DQoNCgl9DQoNCglmdW5jdGlvbiBuYXZpZ2F0ZVVwKCkgew0KDQoJCS8vIFByaW9yaXRpemUgaGlkaW5nIGZyYWdtZW50cw0KCQlpZiggKCBpc092ZXJ2aWV3KCkgfHwgcHJldmlvdXNGcmFnbWVudCgpID09PSBmYWxzZSApICYmIGF2YWlsYWJsZVJvdXRlcygpLnVwICkgew0KCQkJc2xpZGUoIGluZGV4aCwgaW5kZXh2IC0gMSApOw0KCQl9DQoNCgl9DQoNCglmdW5jdGlvbiBuYXZpZ2F0ZURvd24oKSB7DQoNCgkJLy8gUHJpb3JpdGl6ZSByZXZlYWxpbmcgZnJhZ21lbnRzDQoJCWlmKCAoIGlzT3ZlcnZpZXcoKSB8fCBuZXh0RnJhZ21lbnQoKSA9PT0gZmFsc2UgKSAmJiBhdmFpbGFibGVSb3V0ZXMoKS5kb3duICkgew0KCQkJc2xpZGUoIGluZGV4aCwgaW5kZXh2ICsgMSApOw0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBOYXZpZ2F0ZXMgYmFja3dhcmRzLCBwcmlvcml0aXplZCBpbiB0aGUgZm9sbG93aW5nIG9yZGVyOg0KCSAqIDEpIFByZXZpb3VzIGZyYWdtZW50DQoJICogMikgUHJldmlvdXMgdmVydGljYWwgc2xpZGUNCgkgKiAzKSBQcmV2aW91cyBob3Jpem9udGFsIHNsaWRlDQoJICovDQoJZnVuY3Rpb24gbmF2aWdhdGVQcmV2KCkgew0KDQoJCS8vIFByaW9yaXRpemUgcmV2ZWFsaW5nIGZyYWdtZW50cw0KCQlpZiggcHJldmlvdXNGcmFnbWVudCgpID09PSBmYWxzZSApIHsNCgkJCWlmKCBhdmFpbGFibGVSb3V0ZXMoKS51cCApIHsNCgkJCQluYXZpZ2F0ZVVwKCk7DQoJCQl9DQoJCQllbHNlIHsNCgkJCQkvLyBGZXRjaCB0aGUgcHJldmlvdXMgaG9yaXpvbnRhbCBzbGlkZSwgaWYgdGhlcmUgaXMgb25lDQoJCQkJdmFyIHByZXZpb3VzU2xpZGU7DQoNCgkJCQlpZiggY29uZmlnLnJ0bCApIHsNCgkJCQkJcHJldmlvdXNTbGlkZSA9IHRvQXJyYXkoIGRvbS53cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoIEhPUklaT05UQUxfU0xJREVTX1NFTEVDVE9SICsgJy5mdXR1cmUnICkgKS5wb3AoKTsNCgkJCQl9DQoJCQkJZWxzZSB7DQoJCQkJCXByZXZpb3VzU2xpZGUgPSB0b0FycmF5KCBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBIT1JJWk9OVEFMX1NMSURFU19TRUxFQ1RPUiArICcucGFzdCcgKSApLnBvcCgpOw0KCQkJCX0NCg0KCQkJCWlmKCBwcmV2aW91c1NsaWRlICkgew0KCQkJCQl2YXIgdiA9ICggcHJldmlvdXNTbGlkZS5xdWVyeVNlbGVjdG9yQWxsKCAnc2VjdGlvbicgKS5sZW5ndGggLSAxICkgfHwgdW5kZWZpbmVkOw0KCQkJCQl2YXIgaCA9IGluZGV4aCAtIDE7DQoJCQkJCXNsaWRlKCBoLCB2ICk7DQoJCQkJfQ0KCQkJfQ0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBUaGUgcmV2ZXJzZSBvZiAjbmF2aWdhdGVQcmV2KCkuDQoJICovDQoJZnVuY3Rpb24gbmF2aWdhdGVOZXh0KCkgew0KDQoJCS8vIFByaW9yaXRpemUgcmV2ZWFsaW5nIGZyYWdtZW50cw0KCQlpZiggbmV4dEZyYWdtZW50KCkgPT09IGZhbHNlICkgew0KCQkJaWYoIGF2YWlsYWJsZVJvdXRlcygpLmRvd24gKSB7DQoJCQkJbmF2aWdhdGVEb3duKCk7DQoJCQl9DQoJCQllbHNlIGlmKCBjb25maWcucnRsICkgew0KCQkJCW5hdmlnYXRlTGVmdCgpOw0KCQkJfQ0KCQkJZWxzZSB7DQoJCQkJbmF2aWdhdGVSaWdodCgpOw0KCQkJfQ0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBDaGVja3MgaWYgdGhlIHRhcmdldCBlbGVtZW50IHByZXZlbnRzIHRoZSB0cmlnZ2VyaW5nIG9mDQoJICogc3dpcGUgbmF2aWdhdGlvbi4NCgkgKi8NCglmdW5jdGlvbiBpc1N3aXBlUHJldmVudGVkKCB0YXJnZXQgKSB7DQoNCgkJd2hpbGUoIHRhcmdldCAmJiB0eXBlb2YgdGFyZ2V0Lmhhc0F0dHJpYnV0ZSA9PT0gJ2Z1bmN0aW9uJyApIHsNCgkJCWlmKCB0YXJnZXQuaGFzQXR0cmlidXRlKCAnZGF0YS1wcmV2ZW50LXN3aXBlJyApICkgcmV0dXJuIHRydWU7DQoJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsNCgkJfQ0KDQoJCXJldHVybiBmYWxzZTsNCg0KCX0NCg0KDQoJLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0vLw0KCS8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIEVWRU5UUyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLy8NCgkvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS8vDQoNCgkvKioNCgkgKiBDYWxsZWQgYnkgYWxsIGV2ZW50IGhhbmRsZXJzIHRoYXQgYXJlIGJhc2VkIG9uIHVzZXINCgkgKiBpbnB1dC4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBbZXZlbnRdDQoJICovDQoJZnVuY3Rpb24gb25Vc2VySW5wdXQoIGV2ZW50ICkgew0KDQoJCWlmKCBjb25maWcuYXV0b1NsaWRlU3RvcHBhYmxlICkgew0KCQkJcGF1c2VBdXRvU2xpZGUoKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogSGFuZGxlciBmb3IgdGhlIGRvY3VtZW50IGxldmVsICdrZXlwcmVzcycgZXZlbnQuDQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gZXZlbnQNCgkgKi8NCglmdW5jdGlvbiBvbkRvY3VtZW50S2V5UHJlc3MoIGV2ZW50ICkgew0KDQoJCS8vIENoZWNrIGlmIHRoZSBwcmVzc2VkIGtleSBpcyBxdWVzdGlvbiBtYXJrDQoJCWlmKCBldmVudC5zaGlmdEtleSAmJiBldmVudC5jaGFyQ29kZSA9PT0gNjMgKSB7DQoJCQlpZiggZG9tLm92ZXJsYXkgKSB7DQoJCQkJY2xvc2VPdmVybGF5KCk7DQoJCQl9DQoJCQllbHNlIHsNCgkJCQlzaG93SGVscCggdHJ1ZSApOw0KCQkJfQ0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBIYW5kbGVyIGZvciB0aGUgZG9jdW1lbnQgbGV2ZWwgJ2tleWRvd24nIGV2ZW50Lg0KCSAqDQoJICogQHBhcmFtIHtvYmplY3R9IGV2ZW50DQoJICovDQoJZnVuY3Rpb24gb25Eb2N1bWVudEtleURvd24oIGV2ZW50ICkgew0KDQoJCS8vIElmIHRoZXJlJ3MgYSBjb25kaXRpb24gc3BlY2lmaWVkIGFuZCBpdCByZXR1cm5zIGZhbHNlLA0KCQkvLyBpZ25vcmUgdGhpcyBldmVudA0KCQlpZiggdHlwZW9mIGNvbmZpZy5rZXlib2FyZENvbmRpdGlvbiA9PT0gJ2Z1bmN0aW9uJyAmJiBjb25maWcua2V5Ym9hcmRDb25kaXRpb24oKSA9PT0gZmFsc2UgKSB7DQoJCQlyZXR1cm4gdHJ1ZTsNCgkJfQ0KDQoJCS8vIFJlbWVtYmVyIGlmIGF1dG8tc2xpZGluZyB3YXMgcGF1c2VkIHNvIHdlIGNhbiB0b2dnbGUgaXQNCgkJdmFyIGF1dG9TbGlkZVdhc1BhdXNlZCA9IGF1dG9TbGlkZVBhdXNlZDsNCg0KCQlvblVzZXJJbnB1dCggZXZlbnQgKTsNCg0KCQkvLyBDaGVjayBpZiB0aGVyZSdzIGEgZm9jdXNlZCBlbGVtZW50IHRoYXQgY291bGQgYmUgdXNpbmcNCgkJLy8gdGhlIGtleWJvYXJkDQoJCXZhciBhY3RpdmVFbGVtZW50SXNDRSA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5jb250ZW50RWRpdGFibGUgIT09ICdpbmhlcml0JzsNCgkJdmFyIGFjdGl2ZUVsZW1lbnRJc0lucHV0ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50LnRhZ05hbWUgJiYgL2lucHV0fHRleHRhcmVhL2kudGVzdCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudC50YWdOYW1lICk7DQoJCXZhciBhY3RpdmVFbGVtZW50SXNOb3RlcyA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5jbGFzc05hbWUgJiYgL3NwZWFrZXItbm90ZXMvaS50ZXN0KCBkb2N1bWVudC5hY3RpdmVFbGVtZW50LmNsYXNzTmFtZSk7DQoNCgkJLy8gRGlzcmVnYXJkIHRoZSBldmVudCBpZiB0aGVyZSdzIGEgZm9jdXNlZCBlbGVtZW50IG9yIGENCgkJLy8ga2V5Ym9hcmQgbW9kaWZpZXIga2V5IGlzIHByZXNlbnQNCgkJaWYoIGFjdGl2ZUVsZW1lbnRJc0NFIHx8IGFjdGl2ZUVsZW1lbnRJc0lucHV0IHx8IGFjdGl2ZUVsZW1lbnRJc05vdGVzIHx8IChldmVudC5zaGlmdEtleSAmJiBldmVudC5rZXlDb2RlICE9PSAzMikgfHwgZXZlbnQuYWx0S2V5IHx8IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSApIHJldHVybjsNCg0KCQkvLyBXaGlsZSBwYXVzZWQgb25seSBhbGxvdyByZXN1bWUga2V5Ym9hcmQgZXZlbnRzOyAnYicsICd2JywgJy4nDQoJCXZhciByZXN1bWVLZXlDb2RlcyA9IFs2Niw4NiwxOTAsMTkxXTsNCgkJdmFyIGtleTsNCg0KCQkvLyBDdXN0b20ga2V5IGJpbmRpbmdzIGZvciB0b2dnbGVQYXVzZSBzaG91bGQgYmUgYWJsZSB0byByZXN1bWUNCgkJaWYoIHR5cGVvZiBjb25maWcua2V5Ym9hcmQgPT09ICdvYmplY3QnICkgew0KCQkJZm9yKCBrZXkgaW4gY29uZmlnLmtleWJvYXJkICkgew0KCQkJCWlmKCBjb25maWcua2V5Ym9hcmRba2V5XSA9PT0gJ3RvZ2dsZVBhdXNlJyApIHsNCgkJCQkJcmVzdW1lS2V5Q29kZXMucHVzaCggcGFyc2VJbnQoIGtleSwgMTAgKSApOw0KCQkJCX0NCgkJCX0NCgkJfQ0KDQoJCWlmKCBpc1BhdXNlZCgpICYmIHJlc3VtZUtleUNvZGVzLmluZGV4T2YoIGV2ZW50LmtleUNvZGUgKSA9PT0gLTEgKSB7DQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCg0KCQl2YXIgdHJpZ2dlcmVkID0gZmFsc2U7DQoNCgkJLy8gMS4gVXNlciBkZWZpbmVkIGtleSBiaW5kaW5ncw0KCQlpZiggdHlwZW9mIGNvbmZpZy5rZXlib2FyZCA9PT0gJ29iamVjdCcgKSB7DQoNCgkJCWZvcigga2V5IGluIGNvbmZpZy5rZXlib2FyZCApIHsNCg0KCQkJCS8vIENoZWNrIGlmIHRoaXMgYmluZGluZyBtYXRjaGVzIHRoZSBwcmVzc2VkIGtleQ0KCQkJCWlmKCBwYXJzZUludCgga2V5LCAxMCApID09PSBldmVudC5rZXlDb2RlICkgew0KDQoJCQkJCXZhciB2YWx1ZSA9IGNvbmZpZy5rZXlib2FyZFsga2V5IF07DQoNCgkJCQkJLy8gQ2FsbGJhY2sgZnVuY3Rpb24NCgkJCQkJaWYoIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyApIHsNCgkJCQkJCXZhbHVlLmFwcGx5KCBudWxsLCBbIGV2ZW50IF0gKTsNCgkJCQkJfQ0KCQkJCQkvLyBTdHJpbmcgc2hvcnRjdXRzIHRvIHJldmVhbC5qcyBBUEkNCgkJCQkJZWxzZSBpZiggdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgUmV2ZWFsWyB2YWx1ZSBdID09PSAnZnVuY3Rpb24nICkgew0KCQkJCQkJUmV2ZWFsWyB2YWx1ZSBdLmNhbGwoKTsNCgkJCQkJfQ0KDQoJCQkJCXRyaWdnZXJlZCA9IHRydWU7DQoNCgkJCQl9DQoNCgkJCX0NCg0KCQl9DQoNCgkJLy8gMi4gU3lzdGVtIGRlZmluZWQga2V5IGJpbmRpbmdzDQoJCWlmKCB0cmlnZ2VyZWQgPT09IGZhbHNlICkgew0KDQoJCQkvLyBBc3N1bWUgdHJ1ZSBhbmQgdHJ5IHRvIHByb3ZlIGZhbHNlDQoJCQl0cmlnZ2VyZWQgPSB0cnVlOw0KDQoJCQlzd2l0Y2goIGV2ZW50LmtleUNvZGUgKSB7DQoJCQkJLy8gcCwgcGFnZSB1cA0KCQkJCWNhc2UgODA6IGNhc2UgMzM6IG5hdmlnYXRlUHJldigpOyBicmVhazsNCgkJCQkvLyBuLCBwYWdlIGRvd24NCgkJCQljYXNlIDc4OiBjYXNlIDM0OiBuYXZpZ2F0ZU5leHQoKTsgYnJlYWs7DQoJCQkJLy8gaCwgbGVmdA0KCQkJCWNhc2UgNzI6IGNhc2UgMzc6IG5hdmlnYXRlTGVmdCgpOyBicmVhazsNCgkJCQkvLyBsLCByaWdodA0KCQkJCWNhc2UgNzY6IGNhc2UgMzk6IG5hdmlnYXRlUmlnaHQoKTsgYnJlYWs7DQoJCQkJLy8gaywgdXANCgkJCQljYXNlIDc1OiBjYXNlIDM4OiBuYXZpZ2F0ZVVwKCk7IGJyZWFrOw0KCQkJCS8vIGosIGRvd24NCgkJCQljYXNlIDc0OiBjYXNlIDQwOiBuYXZpZ2F0ZURvd24oKTsgYnJlYWs7DQoJCQkJLy8gaG9tZQ0KCQkJCWNhc2UgMzY6IHNsaWRlKCAwICk7IGJyZWFrOw0KCQkJCS8vIGVuZA0KCQkJCWNhc2UgMzU6IHNsaWRlKCBOdW1iZXIuTUFYX1ZBTFVFICk7IGJyZWFrOw0KCQkJCS8vIHNwYWNlDQoJCQkJY2FzZSAzMjogaXNPdmVydmlldygpID8gZGVhY3RpdmF0ZU92ZXJ2aWV3KCkgOiBldmVudC5zaGlmdEtleSA/IG5hdmlnYXRlUHJldigpIDogbmF2aWdhdGVOZXh0KCk7IGJyZWFrOw0KCQkJCS8vIHJldHVybg0KCQkJCWNhc2UgMTM6IGlzT3ZlcnZpZXcoKSA/IGRlYWN0aXZhdGVPdmVydmlldygpIDogdHJpZ2dlcmVkID0gZmFsc2U7IGJyZWFrOw0KCQkJCS8vIHR3by1zcG90LCBzZW1pY29sb24sIGIsIHYsIHBlcmlvZCwgTG9naXRlY2ggcHJlc2VudGVyIHRvb2xzICJibGFjayBzY3JlZW4iIGJ1dHRvbg0KCQkJCWNhc2UgNTg6IGNhc2UgNTk6IGNhc2UgNjY6IGNhc2UgODY6IGNhc2UgMTkwOiBjYXNlIDE5MTogdG9nZ2xlUGF1c2UoKTsgYnJlYWs7DQoJCQkJLy8gZg0KCQkJCWNhc2UgNzA6IGVudGVyRnVsbHNjcmVlbigpOyBicmVhazsNCgkJCQkvLyBhDQoJCQkJY2FzZSA2NTogaWYgKCBjb25maWcuYXV0b1NsaWRlU3RvcHBhYmxlICkgdG9nZ2xlQXV0b1NsaWRlKCBhdXRvU2xpZGVXYXNQYXVzZWQgKTsgYnJlYWs7DQoJCQkJZGVmYXVsdDoNCgkJCQkJdHJpZ2dlcmVkID0gZmFsc2U7DQoJCQl9DQoNCgkJfQ0KDQoJCS8vIElmIHRoZSBpbnB1dCByZXN1bHRlZCBpbiBhIHRyaWdnZXJlZCBhY3Rpb24gd2Ugc2hvdWxkIHByZXZlbnQNCgkJLy8gdGhlIGJyb3dzZXJzIGRlZmF1bHQgYmVoYXZpb3INCgkJaWYoIHRyaWdnZXJlZCApIHsNCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0ICYmIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCX0NCgkJLy8gRVNDIG9yIE8ga2V5DQoJCWVsc2UgaWYgKCAoIGV2ZW50LmtleUNvZGUgPT09IDI3IHx8IGV2ZW50LmtleUNvZGUgPT09IDc5ICkgJiYgZmVhdHVyZXMudHJhbnNmb3JtczNkICkgew0KCQkJaWYoIGRvbS5vdmVybGF5ICkgew0KCQkJCWNsb3NlT3ZlcmxheSgpOw0KCQkJfQ0KCQkJZWxzZSB7DQoJCQkJdG9nZ2xlT3ZlcnZpZXcoKTsNCgkJCX0NCg0KCQkJZXZlbnQucHJldmVudERlZmF1bHQgJiYgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJfQ0KDQoJCS8vIElmIGF1dG8tc2xpZGluZyBpcyBlbmFibGVkIHdlIG5lZWQgdG8gY3VlIHVwDQoJCS8vIGFub3RoZXIgdGltZW91dA0KCQljdWVBdXRvU2xpZGUoKTsNCg0KCX0NCg0KCS8qKg0KCSAqIEhhbmRsZXIgZm9yIHRoZSAndG91Y2hzdGFydCcgZXZlbnQsIGVuYWJsZXMgc3VwcG9ydCBmb3INCgkgKiBzd2lwZSBhbmQgcGluY2ggZ2VzdHVyZXMuDQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gZXZlbnQNCgkgKi8NCglmdW5jdGlvbiBvblRvdWNoU3RhcnQoIGV2ZW50ICkgew0KDQoJCWlmKCBpc1N3aXBlUHJldmVudGVkKCBldmVudC50YXJnZXQgKSApIHJldHVybiB0cnVlOw0KDQoJCXRvdWNoLnN0YXJ0WCA9IGV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WDsNCgkJdG91Y2guc3RhcnRZID0gZXZlbnQudG91Y2hlc1swXS5jbGllbnRZOw0KCQl0b3VjaC5zdGFydENvdW50ID0gZXZlbnQudG91Y2hlcy5sZW5ndGg7DQoNCgkJLy8gSWYgdGhlcmUncyB0d28gdG91Y2hlcyB3ZSBuZWVkIHRvIG1lbW9yaXplIHRoZSBkaXN0YW5jZQ0KCQkvLyBiZXR3ZWVuIHRob3NlIHR3byBwb2ludHMgdG8gZGV0ZWN0IHBpbmNoaW5nDQoJCWlmKCBldmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMiAmJiBjb25maWcub3ZlcnZpZXcgKSB7DQoJCQl0b3VjaC5zdGFydFNwYW4gPSBkaXN0YW5jZUJldHdlZW4oIHsNCgkJCQl4OiBldmVudC50b3VjaGVzWzFdLmNsaWVudFgsDQoJCQkJeTogZXZlbnQudG91Y2hlc1sxXS5jbGllbnRZDQoJCQl9LCB7DQoJCQkJeDogdG91Y2guc3RhcnRYLA0KCQkJCXk6IHRvdWNoLnN0YXJ0WQ0KCQkJfSApOw0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBIYW5kbGVyIGZvciB0aGUgJ3RvdWNobW92ZScgZXZlbnQuDQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gZXZlbnQNCgkgKi8NCglmdW5jdGlvbiBvblRvdWNoTW92ZSggZXZlbnQgKSB7DQoNCgkJaWYoIGlzU3dpcGVQcmV2ZW50ZWQoIGV2ZW50LnRhcmdldCApICkgcmV0dXJuIHRydWU7DQoNCgkJLy8gRWFjaCB0b3VjaCBzaG91bGQgb25seSB0cmlnZ2VyIG9uZSBhY3Rpb24NCgkJaWYoICF0b3VjaC5jYXB0dXJlZCApIHsNCgkJCW9uVXNlcklucHV0KCBldmVudCApOw0KDQoJCQl2YXIgY3VycmVudFggPSBldmVudC50b3VjaGVzWzBdLmNsaWVudFg7DQoJCQl2YXIgY3VycmVudFkgPSBldmVudC50b3VjaGVzWzBdLmNsaWVudFk7DQoNCgkJCS8vIElmIHRoZSB0b3VjaCBzdGFydGVkIHdpdGggdHdvIHBvaW50cyBhbmQgc3RpbGwgaGFzDQoJCQkvLyB0d28gYWN0aXZlIHRvdWNoZXM7IHRlc3QgZm9yIHRoZSBwaW5jaCBnZXN0dXJlDQoJCQlpZiggZXZlbnQudG91Y2hlcy5sZW5ndGggPT09IDIgJiYgdG91Y2guc3RhcnRDb3VudCA9PT0gMiAmJiBjb25maWcub3ZlcnZpZXcgKSB7DQoNCgkJCQkvLyBUaGUgY3VycmVudCBkaXN0YW5jZSBpbiBwaXhlbHMgYmV0d2VlbiB0aGUgdHdvIHRvdWNoIHBvaW50cw0KCQkJCXZhciBjdXJyZW50U3BhbiA9IGRpc3RhbmNlQmV0d2Vlbiggew0KCQkJCQl4OiBldmVudC50b3VjaGVzWzFdLmNsaWVudFgsDQoJCQkJCXk6IGV2ZW50LnRvdWNoZXNbMV0uY2xpZW50WQ0KCQkJCX0sIHsNCgkJCQkJeDogdG91Y2guc3RhcnRYLA0KCQkJCQl5OiB0b3VjaC5zdGFydFkNCgkJCQl9ICk7DQoNCgkJCQkvLyBJZiB0aGUgc3BhbiBpcyBsYXJnZXIgdGhhbiB0aGUgZGVzaXJlIGFtb3VudCB3ZSd2ZSBnb3QNCgkJCQkvLyBvdXJzZWx2ZXMgYSBwaW5jaA0KCQkJCWlmKCBNYXRoLmFicyggdG91Y2guc3RhcnRTcGFuIC0gY3VycmVudFNwYW4gKSA+IHRvdWNoLnRocmVzaG9sZCApIHsNCgkJCQkJdG91Y2guY2FwdHVyZWQgPSB0cnVlOw0KDQoJCQkJCWlmKCBjdXJyZW50U3BhbiA8IHRvdWNoLnN0YXJ0U3BhbiApIHsNCgkJCQkJCWFjdGl2YXRlT3ZlcnZpZXcoKTsNCgkJCQkJfQ0KCQkJCQllbHNlIHsNCgkJCQkJCWRlYWN0aXZhdGVPdmVydmlldygpOw0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCg0KCQkJfQ0KCQkJLy8gVGhlcmUgd2FzIG9ubHkgb25lIHRvdWNoIHBvaW50LCBsb29rIGZvciBhIHN3aXBlDQoJCQllbHNlIGlmKCBldmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMSAmJiB0b3VjaC5zdGFydENvdW50ICE9PSAyICkgew0KDQoJCQkJdmFyIGRlbHRhWCA9IGN1cnJlbnRYIC0gdG91Y2guc3RhcnRYLA0KCQkJCQlkZWx0YVkgPSBjdXJyZW50WSAtIHRvdWNoLnN0YXJ0WTsNCg0KCQkJCWlmKCBkZWx0YVggPiB0b3VjaC50aHJlc2hvbGQgJiYgTWF0aC5hYnMoIGRlbHRhWCApID4gTWF0aC5hYnMoIGRlbHRhWSApICkgew0KCQkJCQl0b3VjaC5jYXB0dXJlZCA9IHRydWU7DQoJCQkJCW5hdmlnYXRlTGVmdCgpOw0KCQkJCX0NCgkJCQllbHNlIGlmKCBkZWx0YVggPCAtdG91Y2gudGhyZXNob2xkICYmIE1hdGguYWJzKCBkZWx0YVggKSA+IE1hdGguYWJzKCBkZWx0YVkgKSApIHsNCgkJCQkJdG91Y2guY2FwdHVyZWQgPSB0cnVlOw0KCQkJCQluYXZpZ2F0ZVJpZ2h0KCk7DQoJCQkJfQ0KCQkJCWVsc2UgaWYoIGRlbHRhWSA+IHRvdWNoLnRocmVzaG9sZCApIHsNCgkJCQkJdG91Y2guY2FwdHVyZWQgPSB0cnVlOw0KCQkJCQluYXZpZ2F0ZVVwKCk7DQoJCQkJfQ0KCQkJCWVsc2UgaWYoIGRlbHRhWSA8IC10b3VjaC50aHJlc2hvbGQgKSB7DQoJCQkJCXRvdWNoLmNhcHR1cmVkID0gdHJ1ZTsNCgkJCQkJbmF2aWdhdGVEb3duKCk7DQoJCQkJfQ0KDQoJCQkJLy8gSWYgd2UncmUgZW1iZWRkZWQsIG9ubHkgYmxvY2sgdG91Y2ggZXZlbnRzIGlmIHRoZXkgaGF2ZQ0KCQkJCS8vIHRyaWdnZXJlZCBhbiBhY3Rpb24NCgkJCQlpZiggY29uZmlnLmVtYmVkZGVkICkgew0KCQkJCQlpZiggdG91Y2guY2FwdHVyZWQgfHwgaXNWZXJ0aWNhbFNsaWRlKCBjdXJyZW50U2xpZGUgKSApIHsNCgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoJCQkJCX0NCgkJCQl9DQoJCQkJLy8gTm90IGVtYmVkZGVkPyBCbG9jayB0aGVtIGFsbCB0byBhdm9pZCBuZWVkbGVzcyB0b3NzaW5nDQoJCQkJLy8gYXJvdW5kIG9mIHRoZSB2aWV3cG9ydCBpbiBpT1MNCgkJCQllbHNlIHsNCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCQl9DQoNCgkJCX0NCgkJfQ0KCQkvLyBUaGVyZSdzIGEgYnVnIHdpdGggc3dpcGluZyBvbiBzb21lIEFuZHJvaWQgZGV2aWNlcyB1bmxlc3MNCgkJLy8gdGhlIGRlZmF1bHQgYWN0aW9uIGlzIGFsd2F5cyBwcmV2ZW50ZWQNCgkJZWxzZSBpZiggVUEubWF0Y2goIC9hbmRyb2lkL2dpICkgKSB7DQoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOw0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBIYW5kbGVyIGZvciB0aGUgJ3RvdWNoZW5kJyBldmVudC4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBldmVudA0KCSAqLw0KCWZ1bmN0aW9uIG9uVG91Y2hFbmQoIGV2ZW50ICkgew0KDQoJCXRvdWNoLmNhcHR1cmVkID0gZmFsc2U7DQoNCgl9DQoNCgkvKioNCgkgKiBDb252ZXJ0IHBvaW50ZXIgZG93biB0byB0b3VjaCBzdGFydC4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBldmVudA0KCSAqLw0KCWZ1bmN0aW9uIG9uUG9pbnRlckRvd24oIGV2ZW50ICkgew0KDQoJCWlmKCBldmVudC5wb2ludGVyVHlwZSA9PT0gZXZlbnQuTVNQT0lOVEVSX1RZUEVfVE9VQ0ggfHwgZXZlbnQucG9pbnRlclR5cGUgPT09ICJ0b3VjaCIgKSB7DQoJCQlldmVudC50b3VjaGVzID0gW3sgY2xpZW50WDogZXZlbnQuY2xpZW50WCwgY2xpZW50WTogZXZlbnQuY2xpZW50WSB9XTsNCgkJCW9uVG91Y2hTdGFydCggZXZlbnQgKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogQ29udmVydCBwb2ludGVyIG1vdmUgdG8gdG91Y2ggbW92ZS4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBldmVudA0KCSAqLw0KCWZ1bmN0aW9uIG9uUG9pbnRlck1vdmUoIGV2ZW50ICkgew0KDQoJCWlmKCBldmVudC5wb2ludGVyVHlwZSA9PT0gZXZlbnQuTVNQT0lOVEVSX1RZUEVfVE9VQ0ggfHwgZXZlbnQucG9pbnRlclR5cGUgPT09ICJ0b3VjaCIgKSAgew0KCQkJZXZlbnQudG91Y2hlcyA9IFt7IGNsaWVudFg6IGV2ZW50LmNsaWVudFgsIGNsaWVudFk6IGV2ZW50LmNsaWVudFkgfV07DQoJCQlvblRvdWNoTW92ZSggZXZlbnQgKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogQ29udmVydCBwb2ludGVyIHVwIHRvIHRvdWNoIGVuZC4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBldmVudA0KCSAqLw0KCWZ1bmN0aW9uIG9uUG9pbnRlclVwKCBldmVudCApIHsNCg0KCQlpZiggZXZlbnQucG9pbnRlclR5cGUgPT09IGV2ZW50Lk1TUE9JTlRFUl9UWVBFX1RPVUNIIHx8IGV2ZW50LnBvaW50ZXJUeXBlID09PSAidG91Y2giICkgIHsNCgkJCWV2ZW50LnRvdWNoZXMgPSBbeyBjbGllbnRYOiBldmVudC5jbGllbnRYLCBjbGllbnRZOiBldmVudC5jbGllbnRZIH1dOw0KCQkJb25Ub3VjaEVuZCggZXZlbnQgKTsNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogSGFuZGxlcyBtb3VzZSB3aGVlbCBzY3JvbGxpbmcsIHRocm90dGxlZCB0byBhdm9pZCBza2lwcGluZw0KCSAqIG11bHRpcGxlIHNsaWRlcy4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBldmVudA0KCSAqLw0KCWZ1bmN0aW9uIG9uRG9jdW1lbnRNb3VzZVNjcm9sbCggZXZlbnQgKSB7DQoNCgkJaWYoIERhdGUubm93KCkgLSBsYXN0TW91c2VXaGVlbFN0ZXAgPiA2MDAgKSB7DQoNCgkJCWxhc3RNb3VzZVdoZWVsU3RlcCA9IERhdGUubm93KCk7DQoNCgkJCXZhciBkZWx0YSA9IGV2ZW50LmRldGFpbCB8fCAtZXZlbnQud2hlZWxEZWx0YTsNCgkJCWlmKCBkZWx0YSA+IDAgKSB7DQoJCQkJbmF2aWdhdGVOZXh0KCk7DQoJCQl9DQoJCQllbHNlIGlmKCBkZWx0YSA8IDAgKSB7DQoJCQkJbmF2aWdhdGVQcmV2KCk7DQoJCQl9DQoNCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogQ2xpY2tpbmcgb24gdGhlIHByb2dyZXNzIGJhciByZXN1bHRzIGluIGEgbmF2aWdhdGlvbiB0byB0aGUNCgkgKiBjbG9zZXN0IGFwcHJveGltYXRlIGhvcml6b250YWwgc2xpZGUgdXNpbmcgdGhpcyBlcXVhdGlvbjoNCgkgKg0KCSAqICggY2xpY2tYIC8gcHJlc2VudGF0aW9uV2lkdGggKSAqIG51bWJlck9mU2xpZGVzDQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gZXZlbnQNCgkgKi8NCglmdW5jdGlvbiBvblByb2dyZXNzQ2xpY2tlZCggZXZlbnQgKSB7DQoNCgkJb25Vc2VySW5wdXQoIGV2ZW50ICk7DQoNCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCg0KCQl2YXIgc2xpZGVzVG90YWwgPSB0b0FycmF5KCBkb20ud3JhcHBlci5xdWVyeVNlbGVjdG9yQWxsKCBIT1JJWk9OVEFMX1NMSURFU19TRUxFQ1RPUiApICkubGVuZ3RoOw0KCQl2YXIgc2xpZGVJbmRleCA9IE1hdGguZmxvb3IoICggZXZlbnQuY2xpZW50WCAvIGRvbS53cmFwcGVyLm9mZnNldFdpZHRoICkgKiBzbGlkZXNUb3RhbCApOw0KDQoJCWlmKCBjb25maWcucnRsICkgew0KCQkJc2xpZGVJbmRleCA9IHNsaWRlc1RvdGFsIC0gc2xpZGVJbmRleDsNCgkJfQ0KDQoJCXNsaWRlKCBzbGlkZUluZGV4ICk7DQoNCgl9DQoNCgkvKioNCgkgKiBFdmVudCBoYW5kbGVyIGZvciBuYXZpZ2F0aW9uIGNvbnRyb2wgYnV0dG9ucy4NCgkgKi8NCglmdW5jdGlvbiBvbk5hdmlnYXRlTGVmdENsaWNrZWQoIGV2ZW50ICkgeyBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyBvblVzZXJJbnB1dCgpOyBuYXZpZ2F0ZUxlZnQoKTsgfQ0KCWZ1bmN0aW9uIG9uTmF2aWdhdGVSaWdodENsaWNrZWQoIGV2ZW50ICkgeyBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyBvblVzZXJJbnB1dCgpOyBuYXZpZ2F0ZVJpZ2h0KCk7IH0NCglmdW5jdGlvbiBvbk5hdmlnYXRlVXBDbGlja2VkKCBldmVudCApIHsgZXZlbnQucHJldmVudERlZmF1bHQoKTsgb25Vc2VySW5wdXQoKTsgbmF2aWdhdGVVcCgpOyB9DQoJZnVuY3Rpb24gb25OYXZpZ2F0ZURvd25DbGlja2VkKCBldmVudCApIHsgZXZlbnQucHJldmVudERlZmF1bHQoKTsgb25Vc2VySW5wdXQoKTsgbmF2aWdhdGVEb3duKCk7IH0NCglmdW5jdGlvbiBvbk5hdmlnYXRlUHJldkNsaWNrZWQoIGV2ZW50ICkgeyBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyBvblVzZXJJbnB1dCgpOyBuYXZpZ2F0ZVByZXYoKTsgfQ0KCWZ1bmN0aW9uIG9uTmF2aWdhdGVOZXh0Q2xpY2tlZCggZXZlbnQgKSB7IGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IG9uVXNlcklucHV0KCk7IG5hdmlnYXRlTmV4dCgpOyB9DQoNCgkvKioNCgkgKiBIYW5kbGVyIGZvciB0aGUgd2luZG93IGxldmVsICdoYXNoY2hhbmdlJyBldmVudC4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBbZXZlbnRdDQoJICovDQoJZnVuY3Rpb24gb25XaW5kb3dIYXNoQ2hhbmdlKCBldmVudCApIHsNCg0KCQlyZWFkVVJMKCk7DQoNCgl9DQoNCgkvKioNCgkgKiBIYW5kbGVyIGZvciB0aGUgd2luZG93IGxldmVsICdyZXNpemUnIGV2ZW50Lg0KCSAqDQoJICogQHBhcmFtIHtvYmplY3R9IFtldmVudF0NCgkgKi8NCglmdW5jdGlvbiBvbldpbmRvd1Jlc2l6ZSggZXZlbnQgKSB7DQoNCgkJbGF5b3V0KCk7DQoNCgl9DQoNCgkvKioNCgkgKiBIYW5kbGUgZm9yIHRoZSB3aW5kb3cgbGV2ZWwgJ3Zpc2liaWxpdHljaGFuZ2UnIGV2ZW50Lg0KCSAqDQoJICogQHBhcmFtIHtvYmplY3R9IFtldmVudF0NCgkgKi8NCglmdW5jdGlvbiBvblBhZ2VWaXNpYmlsaXR5Q2hhbmdlKCBldmVudCApIHsNCg0KCQl2YXIgaXNIaWRkZW4gPSAgZG9jdW1lbnQud2Via2l0SGlkZGVuIHx8DQoJCQkJCQlkb2N1bWVudC5tc0hpZGRlbiB8fA0KCQkJCQkJZG9jdW1lbnQuaGlkZGVuOw0KDQoJCS8vIElmLCBhZnRlciBjbGlja2luZyBhIGxpbmsgb3Igc2ltaWxhciBhbmQgd2UncmUgY29taW5nIGJhY2ssDQoJCS8vIGZvY3VzIHRoZSBkb2N1bWVudC5ib2R5IHRvIGVuc3VyZSB3ZSBjYW4gdXNlIGtleWJvYXJkIHNob3J0Y3V0cw0KCQlpZiggaXNIaWRkZW4gPT09IGZhbHNlICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgIT09IGRvY3VtZW50LmJvZHkgKSB7DQoJCQkvLyBOb3QgYWxsIGVsZW1lbnRzIHN1cHBvcnQgLmJsdXIoKSAtIFNWR3MgYW1vbmcgdGhlbS4NCgkJCWlmKCB0eXBlb2YgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ibHVyID09PSAnZnVuY3Rpb24nICkgew0KCQkJCWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQuYmx1cigpOw0KCQkJfQ0KCQkJZG9jdW1lbnQuYm9keS5mb2N1cygpOw0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBJbnZva2VkIHdoZW4gYSBzbGlkZSBpcyBhbmQgd2UncmUgaW4gdGhlIG92ZXJ2aWV3Lg0KCSAqDQoJICogQHBhcmFtIHtvYmplY3R9IGV2ZW50DQoJICovDQoJZnVuY3Rpb24gb25PdmVydmlld1NsaWRlQ2xpY2tlZCggZXZlbnQgKSB7DQoNCgkJLy8gVE9ETyBUaGVyZSdzIGEgYnVnIGhlcmUgd2hlcmUgdGhlIGV2ZW50IGxpc3RlbmVycyBhcmUgbm90DQoJCS8vIHJlbW92ZWQgYWZ0ZXIgZGVhY3RpdmF0aW5nIHRoZSBvdmVydmlldy4NCgkJaWYoIGV2ZW50c0FyZUJvdW5kICYmIGlzT3ZlcnZpZXcoKSApIHsNCgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7DQoNCgkJCXZhciBlbGVtZW50ID0gZXZlbnQudGFyZ2V0Ow0KDQoJCQl3aGlsZSggZWxlbWVudCAmJiAhZWxlbWVudC5ub2RlTmFtZS5tYXRjaCggL3NlY3Rpb24vZ2kgKSApIHsNCgkJCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOw0KCQkJfQ0KDQoJCQlpZiggZWxlbWVudCAmJiAhZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoICdkaXNhYmxlZCcgKSApIHsNCg0KCQkJCWRlYWN0aXZhdGVPdmVydmlldygpOw0KDQoJCQkJaWYoIGVsZW1lbnQubm9kZU5hbWUubWF0Y2goIC9zZWN0aW9uL2dpICkgKSB7DQoJCQkJCXZhciBoID0gcGFyc2VJbnQoIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCAnZGF0YS1pbmRleC1oJyApLCAxMCApLA0KCQkJCQkJdiA9IHBhcnNlSW50KCBlbGVtZW50LmdldEF0dHJpYnV0ZSggJ2RhdGEtaW5kZXgtdicgKSwgMTAgKTsNCg0KCQkJCQlzbGlkZSggaCwgdiApOw0KCQkJCX0NCg0KCQkJfQ0KCQl9DQoNCgl9DQoNCgkvKioNCgkgKiBIYW5kbGVzIGNsaWNrcyBvbiBsaW5rcyB0aGF0IGFyZSBzZXQgdG8gcHJldmlldyBpbiB0aGUNCgkgKiBpZnJhbWUgb3ZlcmxheS4NCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBldmVudA0KCSAqLw0KCWZ1bmN0aW9uIG9uUHJldmlld0xpbmtDbGlja2VkKCBldmVudCApIHsNCg0KCQlpZiggZXZlbnQuY3VycmVudFRhcmdldCAmJiBldmVudC5jdXJyZW50VGFyZ2V0Lmhhc0F0dHJpYnV0ZSggJ2hyZWYnICkgKSB7DQoJCQl2YXIgdXJsID0gZXZlbnQuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoICdocmVmJyApOw0KCQkJaWYoIHVybCApIHsNCgkJCQlzaG93UHJldmlldyggdXJsICk7DQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsNCgkJCX0NCgkJfQ0KDQoJfQ0KDQoJLyoqDQoJICogSGFuZGxlcyBjbGljayBvbiB0aGUgYXV0by1zbGlkaW5nIGNvbnRyb2xzIGVsZW1lbnQuDQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gW2V2ZW50XQ0KCSAqLw0KCWZ1bmN0aW9uIG9uQXV0b1NsaWRlUGxheWVyQ2xpY2soIGV2ZW50ICkgew0KDQoJCS8vIFJlcGxheQ0KCQlpZiggUmV2ZWFsLmlzTGFzdFNsaWRlKCkgJiYgY29uZmlnLmxvb3AgPT09IGZhbHNlICkgew0KCQkJc2xpZGUoIDAsIDAgKTsNCgkJCXJlc3VtZUF1dG9TbGlkZSgpOw0KCQl9DQoJCS8vIFJlc3VtZQ0KCQllbHNlIGlmKCBhdXRvU2xpZGVQYXVzZWQgKSB7DQoJCQlyZXN1bWVBdXRvU2xpZGUoKTsNCgkJfQ0KCQkvLyBQYXVzZQ0KCQllbHNlIHsNCgkJCXBhdXNlQXV0b1NsaWRlKCk7DQoJCX0NCg0KCX0NCg0KDQoJLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0vLw0KCS8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBQTEFZQkFDSyBDT01QT05FTlQgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLy8NCgkvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS8vDQoNCg0KCS8qKg0KCSAqIENvbnN0cnVjdG9yIGZvciB0aGUgcGxheWJhY2sgY29tcG9uZW50LCB3aGljaCBkaXNwbGF5cw0KCSAqIHBsYXkvcGF1c2UvcHJvZ3Jlc3MgY29udHJvbHMuDQoJICoNCgkgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBjb250YWluZXIgVGhlIGNvbXBvbmVudCB3aWxsIGFwcGVuZA0KCSAqIGl0c2VsZiB0byB0aGlzDQoJICogQHBhcmFtIHtmdW5jdGlvbn0gcHJvZ3Jlc3NDaGVjayBBIG1ldGhvZCB3aGljaCB3aWxsIGJlDQoJICogY2FsbGVkIGZyZXF1ZW50bHkgdG8gZ2V0IHRoZSBjdXJyZW50IHByb2dyZXNzIG9uIGEgcmFuZ2UNCgkgKiBvZiAwLTENCgkgKi8NCglmdW5jdGlvbiBQbGF5YmFjayggY29udGFpbmVyLCBwcm9ncmVzc0NoZWNrICkgew0KDQoJCS8vIENvc21ldGljcw0KCQl0aGlzLmRpYW1ldGVyID0gMTAwOw0KCQl0aGlzLmRpYW1ldGVyMiA9IHRoaXMuZGlhbWV0ZXIvMjsNCgkJdGhpcy50aGlja25lc3MgPSA2Ow0KDQoJCS8vIEZsYWdzIGlmIHdlIGFyZSBjdXJyZW50bHkgcGxheWluZw0KCQl0aGlzLnBsYXlpbmcgPSBmYWxzZTsNCg0KCQkvLyBDdXJyZW50IHByb2dyZXNzIG9uIGEgMC0xIHJhbmdlDQoJCXRoaXMucHJvZ3Jlc3MgPSAwOw0KDQoJCS8vIFVzZWQgdG8gbG9vcCB0aGUgYW5pbWF0aW9uIHNtb290aGx5DQoJCXRoaXMucHJvZ3Jlc3NPZmZzZXQgPSAxOw0KDQoJCXRoaXMuY29udGFpbmVyID0gY29udGFpbmVyOw0KCQl0aGlzLnByb2dyZXNzQ2hlY2sgPSBwcm9ncmVzc0NoZWNrOw0KDQoJCXRoaXMuY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2NhbnZhcycgKTsNCgkJdGhpcy5jYW52YXMuY2xhc3NOYW1lID0gJ3BsYXliYWNrJzsNCgkJdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLmRpYW1ldGVyOw0KCQl0aGlzLmNhbnZhcy5oZWlnaHQgPSB0aGlzLmRpYW1ldGVyOw0KCQl0aGlzLmNhbnZhcy5zdHlsZS53aWR0aCA9IHRoaXMuZGlhbWV0ZXIyICsgJ3B4JzsNCgkJdGhpcy5jYW52YXMuc3R5bGUuaGVpZ2h0ID0gdGhpcy5kaWFtZXRlcjIgKyAncHgnOw0KCQl0aGlzLmNvbnRleHQgPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCAnMmQnICk7DQoNCgkJdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQoIHRoaXMuY2FudmFzICk7DQoNCgkJdGhpcy5yZW5kZXIoKTsNCg0KCX0NCg0KCS8qKg0KCSAqIEBwYXJhbSB2YWx1ZQ0KCSAqLw0KCVBsYXliYWNrLnByb3RvdHlwZS5zZXRQbGF5aW5nID0gZnVuY3Rpb24oIHZhbHVlICkgew0KDQoJCXZhciB3YXNQbGF5aW5nID0gdGhpcy5wbGF5aW5nOw0KDQoJCXRoaXMucGxheWluZyA9IHZhbHVlOw0KDQoJCS8vIFN0YXJ0IHJlcGFpbnRpbmcgaWYgd2Ugd2VyZW4ndCBhbHJlYWR5DQoJCWlmKCAhd2FzUGxheWluZyAmJiB0aGlzLnBsYXlpbmcgKSB7DQoJCQl0aGlzLmFuaW1hdGUoKTsNCgkJfQ0KCQllbHNlIHsNCgkJCXRoaXMucmVuZGVyKCk7DQoJCX0NCg0KCX07DQoNCglQbGF5YmFjay5wcm90b3R5cGUuYW5pbWF0ZSA9IGZ1bmN0aW9uKCkgew0KDQoJCXZhciBwcm9ncmVzc0JlZm9yZSA9IHRoaXMucHJvZ3Jlc3M7DQoNCgkJdGhpcy5wcm9ncmVzcyA9IHRoaXMucHJvZ3Jlc3NDaGVjaygpOw0KDQoJCS8vIFdoZW4gd2UgbG9vcCwgb2Zmc2V0IHRoZSBwcm9ncmVzcyBzbyB0aGF0IGl0IGVhc2VzDQoJCS8vIHNtb290aGx5IHJhdGhlciB0aGFuIGltbWVkaWF0ZWx5IHJlc2V0dGluZw0KCQlpZiggcHJvZ3Jlc3NCZWZvcmUgPiAwLjggJiYgdGhpcy5wcm9ncmVzcyA8IDAuMiApIHsNCgkJCXRoaXMucHJvZ3Jlc3NPZmZzZXQgPSB0aGlzLnByb2dyZXNzOw0KCQl9DQoNCgkJdGhpcy5yZW5kZXIoKTsNCg0KCQlpZiggdGhpcy5wbGF5aW5nICkgew0KCQkJZmVhdHVyZXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lTWV0aG9kLmNhbGwoIHdpbmRvdywgdGhpcy5hbmltYXRlLmJpbmQoIHRoaXMgKSApOw0KCQl9DQoNCgl9Ow0KDQoJLyoqDQoJICogUmVuZGVycyB0aGUgY3VycmVudCBwcm9ncmVzcyBhbmQgcGxheWJhY2sgc3RhdGUuDQoJICovDQoJUGxheWJhY2sucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKCkgew0KDQoJCXZhciBwcm9ncmVzcyA9IHRoaXMucGxheWluZyA/IHRoaXMucHJvZ3Jlc3MgOiAwLA0KCQkJcmFkaXVzID0gKCB0aGlzLmRpYW1ldGVyMiApIC0gdGhpcy50aGlja25lc3MsDQoJCQl4ID0gdGhpcy5kaWFtZXRlcjIsDQoJCQl5ID0gdGhpcy5kaWFtZXRlcjIsDQoJCQlpY29uU2l6ZSA9IDI4Ow0KDQoJCS8vIEVhc2UgdG93YXJkcyAxDQoJCXRoaXMucHJvZ3Jlc3NPZmZzZXQgKz0gKCAxIC0gdGhpcy5wcm9ncmVzc09mZnNldCApICogMC4xOw0KDQoJCXZhciBlbmRBbmdsZSA9ICggLSBNYXRoLlBJIC8gMiApICsgKCBwcm9ncmVzcyAqICggTWF0aC5QSSAqIDIgKSApOw0KCQl2YXIgc3RhcnRBbmdsZSA9ICggLSBNYXRoLlBJIC8gMiApICsgKCB0aGlzLnByb2dyZXNzT2Zmc2V0ICogKCBNYXRoLlBJICogMiApICk7DQoNCgkJdGhpcy5jb250ZXh0LnNhdmUoKTsNCgkJdGhpcy5jb250ZXh0LmNsZWFyUmVjdCggMCwgMCwgdGhpcy5kaWFtZXRlciwgdGhpcy5kaWFtZXRlciApOw0KDQoJCS8vIFNvbGlkIGJhY2tncm91bmQgY29sb3INCgkJdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOw0KCQl0aGlzLmNvbnRleHQuYXJjKCB4LCB5LCByYWRpdXMgKyA0LCAwLCBNYXRoLlBJICogMiwgZmFsc2UgKTsNCgkJdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9ICdyZ2JhKCAwLCAwLCAwLCAwLjQgKSc7DQoJCXRoaXMuY29udGV4dC5maWxsKCk7DQoNCgkJLy8gRHJhdyBwcm9ncmVzcyB0cmFjaw0KCQl0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7DQoJCXRoaXMuY29udGV4dC5hcmMoIHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIsIGZhbHNlICk7DQoJCXRoaXMuY29udGV4dC5saW5lV2lkdGggPSB0aGlzLnRoaWNrbmVzczsNCgkJdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gJyM2NjYnOw0KCQl0aGlzLmNvbnRleHQuc3Ryb2tlKCk7DQoNCgkJaWYoIHRoaXMucGxheWluZyApIHsNCgkJCS8vIERyYXcgcHJvZ3Jlc3Mgb24gdG9wIG9mIHRyYWNrDQoJCQl0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7DQoJCQl0aGlzLmNvbnRleHQuYXJjKCB4LCB5LCByYWRpdXMsIHN0YXJ0QW5nbGUsIGVuZEFuZ2xlLCBmYWxzZSApOw0KCQkJdGhpcy5jb250ZXh0LmxpbmVXaWR0aCA9IHRoaXMudGhpY2tuZXNzOw0KCQkJdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gJyNmZmYnOw0KCQkJdGhpcy5jb250ZXh0LnN0cm9rZSgpOw0KCQl9DQoNCgkJdGhpcy5jb250ZXh0LnRyYW5zbGF0ZSggeCAtICggaWNvblNpemUgLyAyICksIHkgLSAoIGljb25TaXplIC8gMiApICk7DQoNCgkJLy8gRHJhdyBwbGF5L3BhdXNlIGljb25zDQoJCWlmKCB0aGlzLnBsYXlpbmcgKSB7DQoJCQl0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gJyNmZmYnOw0KCQkJdGhpcy5jb250ZXh0LmZpbGxSZWN0KCAwLCAwLCBpY29uU2l6ZSAvIDIgLSA0LCBpY29uU2l6ZSApOw0KCQkJdGhpcy5jb250ZXh0LmZpbGxSZWN0KCBpY29uU2l6ZSAvIDIgKyA0LCAwLCBpY29uU2l6ZSAvIDIgLSA0LCBpY29uU2l6ZSApOw0KCQl9DQoJCWVsc2Ugew0KCQkJdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOw0KCQkJdGhpcy5jb250ZXh0LnRyYW5zbGF0ZSggNCwgMCApOw0KCQkJdGhpcy5jb250ZXh0Lm1vdmVUbyggMCwgMCApOw0KCQkJdGhpcy5jb250ZXh0LmxpbmVUbyggaWNvblNpemUgLSA0LCBpY29uU2l6ZSAvIDIgKTsNCgkJCXRoaXMuY29udGV4dC5saW5lVG8oIDAsIGljb25TaXplICk7DQoJCQl0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gJyNmZmYnOw0KCQkJdGhpcy5jb250ZXh0LmZpbGwoKTsNCgkJfQ0KDQoJCXRoaXMuY29udGV4dC5yZXN0b3JlKCk7DQoNCgl9Ow0KDQoJUGxheWJhY2sucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oIHR5cGUsIGxpc3RlbmVyICkgew0KCQl0aGlzLmNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBsaXN0ZW5lciwgZmFsc2UgKTsNCgl9Ow0KDQoJUGxheWJhY2sucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uKCB0eXBlLCBsaXN0ZW5lciApIHsNCgkJdGhpcy5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgbGlzdGVuZXIsIGZhbHNlICk7DQoJfTsNCg0KCVBsYXliYWNrLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7DQoNCgkJdGhpcy5wbGF5aW5nID0gZmFsc2U7DQoNCgkJaWYoIHRoaXMuY2FudmFzLnBhcmVudE5vZGUgKSB7DQoJCQl0aGlzLmNvbnRhaW5lci5yZW1vdmVDaGlsZCggdGhpcy5jYW52YXMgKTsNCgkJfQ0KDQoJfTsNCg0KDQoJLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0vLw0KCS8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gQVBJIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLy8NCgkvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS8vDQoNCg0KCVJldmVhbCA9IHsNCgkJVkVSU0lPTjogVkVSU0lPTiwNCg0KCQlpbml0aWFsaXplOiBpbml0aWFsaXplLA0KCQljb25maWd1cmU6IGNvbmZpZ3VyZSwNCgkJc3luYzogc3luYywNCg0KCQkvLyBOYXZpZ2F0aW9uIG1ldGhvZHMNCgkJc2xpZGU6IHNsaWRlLA0KCQlsZWZ0OiBuYXZpZ2F0ZUxlZnQsDQoJCXJpZ2h0OiBuYXZpZ2F0ZVJpZ2h0LA0KCQl1cDogbmF2aWdhdGVVcCwNCgkJZG93bjogbmF2aWdhdGVEb3duLA0KCQlwcmV2OiBuYXZpZ2F0ZVByZXYsDQoJCW5leHQ6IG5hdmlnYXRlTmV4dCwNCg0KCQkvLyBGcmFnbWVudCBtZXRob2RzDQoJCW5hdmlnYXRlRnJhZ21lbnQ6IG5hdmlnYXRlRnJhZ21lbnQsDQoJCXByZXZGcmFnbWVudDogcHJldmlvdXNGcmFnbWVudCwNCgkJbmV4dEZyYWdtZW50OiBuZXh0RnJhZ21lbnQsDQoNCgkJLy8gRGVwcmVjYXRlZCBhbGlhc2VzDQoJCW5hdmlnYXRlVG86IHNsaWRlLA0KCQluYXZpZ2F0ZUxlZnQ6IG5hdmlnYXRlTGVmdCwNCgkJbmF2aWdhdGVSaWdodDogbmF2aWdhdGVSaWdodCwNCgkJbmF2aWdhdGVVcDogbmF2aWdhdGVVcCwNCgkJbmF2aWdhdGVEb3duOiBuYXZpZ2F0ZURvd24sDQoJCW5hdmlnYXRlUHJldjogbmF2aWdhdGVQcmV2LA0KCQluYXZpZ2F0ZU5leHQ6IG5hdmlnYXRlTmV4dCwNCg0KCQkvLyBTaG93cyBhIGhlbHAgb3ZlcmxheSB3aXRoIGtleWJvYXJkIHNob3J0Y3V0cw0KCQlzaG93SGVscDogc2hvd0hlbHAsDQoNCgkJLy8gRm9yY2VzIGFuIHVwZGF0ZSBpbiBzbGlkZSBsYXlvdXQNCgkJbGF5b3V0OiBsYXlvdXQsDQoNCgkJLy8gUmFuZG9taXplcyB0aGUgb3JkZXIgb2Ygc2xpZGVzDQoJCXNodWZmbGU6IHNodWZmbGUsDQoNCgkJLy8gUmV0dXJucyBhbiBvYmplY3Qgd2l0aCB0aGUgYXZhaWxhYmxlIHJvdXRlcyBhcyBib29sZWFucyAobGVmdC9yaWdodC90b3AvYm90dG9tKQ0KCQlhdmFpbGFibGVSb3V0ZXM6IGF2YWlsYWJsZVJvdXRlcywNCg0KCQkvLyBSZXR1cm5zIGFuIG9iamVjdCB3aXRoIHRoZSBhdmFpbGFibGUgZnJhZ21lbnRzIGFzIGJvb2xlYW5zIChwcmV2L25leHQpDQoJCWF2YWlsYWJsZUZyYWdtZW50czogYXZhaWxhYmxlRnJhZ21lbnRzLA0KDQoJCS8vIFRvZ2dsZXMgdGhlIG92ZXJ2aWV3IG1vZGUgb24vb2ZmDQoJCXRvZ2dsZU92ZXJ2aWV3OiB0b2dnbGVPdmVydmlldywNCg0KCQkvLyBUb2dnbGVzIHRoZSAiYmxhY2sgc2NyZWVuIiBtb2RlIG9uL29mZg0KCQl0b2dnbGVQYXVzZTogdG9nZ2xlUGF1c2UsDQoNCgkJLy8gVG9nZ2xlcyB0aGUgYXV0byBzbGlkZSBtb2RlIG9uL29mZg0KCQl0b2dnbGVBdXRvU2xpZGU6IHRvZ2dsZUF1dG9TbGlkZSwNCg0KCQkvLyBTdGF0ZSBjaGVja3MNCgkJaXNPdmVydmlldzogaXNPdmVydmlldywNCgkJaXNQYXVzZWQ6IGlzUGF1c2VkLA0KCQlpc0F1dG9TbGlkaW5nOiBpc0F1dG9TbGlkaW5nLA0KDQoJCS8vIEFkZHMgb3IgcmVtb3ZlcyBhbGwgaW50ZXJuYWwgZXZlbnQgbGlzdGVuZXJzIChzdWNoIGFzIGtleWJvYXJkKQ0KCQlhZGRFdmVudExpc3RlbmVyczogYWRkRXZlbnRMaXN0ZW5lcnMsDQoJCXJlbW92ZUV2ZW50TGlzdGVuZXJzOiByZW1vdmVFdmVudExpc3RlbmVycywNCg0KCQkvLyBGYWNpbGl0eSBmb3IgcGVyc2lzdGluZyBhbmQgcmVzdG9yaW5nIHRoZSBwcmVzZW50YXRpb24gc3RhdGUNCgkJZ2V0U3RhdGU6IGdldFN0YXRlLA0KCQlzZXRTdGF0ZTogc2V0U3RhdGUsDQoNCgkJLy8gUHJlc2VudGF0aW9uIHByb2dyZXNzIG9uIHJhbmdlIG9mIDAtMQ0KCQlnZXRQcm9ncmVzczogZ2V0UHJvZ3Jlc3MsDQoNCgkJLy8gUmV0dXJucyB0aGUgaW5kaWNlcyBvZiB0aGUgY3VycmVudCwgb3Igc3BlY2lmaWVkLCBzbGlkZQ0KCQlnZXRJbmRpY2VzOiBnZXRJbmRpY2VzLA0KDQoJCWdldFRvdGFsU2xpZGVzOiBnZXRUb3RhbFNsaWRlcywNCg0KCQkvLyBSZXR1cm5zIHRoZSBzbGlkZSBlbGVtZW50IGF0IHRoZSBzcGVjaWZpZWQgaW5kZXgNCgkJZ2V0U2xpZGU6IGdldFNsaWRlLA0KDQoJCS8vIFJldHVybnMgdGhlIHNsaWRlIGJhY2tncm91bmQgZWxlbWVudCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4DQoJCWdldFNsaWRlQmFja2dyb3VuZDogZ2V0U2xpZGVCYWNrZ3JvdW5kLA0KDQoJCS8vIFJldHVybnMgdGhlIHNwZWFrZXIgbm90ZXMgc3RyaW5nIGZvciBhIHNsaWRlLCBvciBudWxsDQoJCWdldFNsaWRlTm90ZXM6IGdldFNsaWRlTm90ZXMsDQoNCgkJLy8gUmV0dXJucyB0aGUgcHJldmlvdXMgc2xpZGUgZWxlbWVudCwgbWF5IGJlIG51bGwNCgkJZ2V0UHJldmlvdXNTbGlkZTogZnVuY3Rpb24oKSB7DQoJCQlyZXR1cm4gcHJldmlvdXNTbGlkZTsNCgkJfSwNCg0KCQkvLyBSZXR1cm5zIHRoZSBjdXJyZW50IHNsaWRlIGVsZW1lbnQNCgkJZ2V0Q3VycmVudFNsaWRlOiBmdW5jdGlvbigpIHsNCgkJCXJldHVybiBjdXJyZW50U2xpZGU7DQoJCX0sDQoNCgkJLy8gUmV0dXJucyB0aGUgY3VycmVudCBzY2FsZSBvZiB0aGUgcHJlc2VudGF0aW9uIGNvbnRlbnQNCgkJZ2V0U2NhbGU6IGZ1bmN0aW9uKCkgew0KCQkJcmV0dXJuIHNjYWxlOw0KCQl9LA0KDQoJCS8vIFJldHVybnMgdGhlIGN1cnJlbnQgY29uZmlndXJhdGlvbiBvYmplY3QNCgkJZ2V0Q29uZmlnOiBmdW5jdGlvbigpIHsNCgkJCXJldHVybiBjb25maWc7DQoJCX0sDQoNCgkJLy8gSGVscGVyIG1ldGhvZCwgcmV0cmlldmVzIHF1ZXJ5IHN0cmluZyBhcyBhIGtleS92YWx1ZSBoYXNoDQoJCWdldFF1ZXJ5SGFzaDogZnVuY3Rpb24oKSB7DQoJCQl2YXIgcXVlcnkgPSB7fTsNCg0KCQkJbG9jYXRpb24uc2VhcmNoLnJlcGxhY2UoIC9bQS1aMC05XSs/PShbXHdcLiUtXSopL2dpLCBmdW5jdGlvbihhKSB7DQoJCQkJcXVlcnlbIGEuc3BsaXQoICc9JyApLnNoaWZ0KCkgXSA9IGEuc3BsaXQoICc9JyApLnBvcCgpOw0KCQkJfSApOw0KDQoJCQkvLyBCYXNpYyBkZXNlcmlhbGl6YXRpb24NCgkJCWZvciggdmFyIGkgaW4gcXVlcnkgKSB7DQoJCQkJdmFyIHZhbHVlID0gcXVlcnlbIGkgXTsNCg0KCQkJCXF1ZXJ5WyBpIF0gPSBkZXNlcmlhbGl6ZSggdW5lc2NhcGUoIHZhbHVlICkgKTsNCgkJCX0NCg0KCQkJcmV0dXJuIHF1ZXJ5Ow0KCQl9LA0KDQoJCS8vIFJldHVybnMgdHJ1ZSBpZiB3ZSdyZSBjdXJyZW50bHkgb24gdGhlIGZpcnN0IHNsaWRlDQoJCWlzRmlyc3RTbGlkZTogZnVuY3Rpb24oKSB7DQoJCQlyZXR1cm4gKCBpbmRleGggPT09IDAgJiYgaW5kZXh2ID09PSAwICk7DQoJCX0sDQoNCgkJLy8gUmV0dXJucyB0cnVlIGlmIHdlJ3JlIGN1cnJlbnRseSBvbiB0aGUgbGFzdCBzbGlkZQ0KCQlpc0xhc3RTbGlkZTogZnVuY3Rpb24oKSB7DQoJCQlpZiggY3VycmVudFNsaWRlICkgew0KCQkJCS8vIERvZXMgdGhpcyBzbGlkZSBoYXMgbmV4dCBhIHNpYmxpbmc/DQoJCQkJaWYoIGN1cnJlbnRTbGlkZS5uZXh0RWxlbWVudFNpYmxpbmcgKSByZXR1cm4gZmFsc2U7DQoNCgkJCQkvLyBJZiBpdCdzIHZlcnRpY2FsLCBkb2VzIGl0cyBwYXJlbnQgaGF2ZSBhIG5leHQgc2libGluZz8NCgkJCQlpZiggaXNWZXJ0aWNhbFNsaWRlKCBjdXJyZW50U2xpZGUgKSAmJiBjdXJyZW50U2xpZGUucGFyZW50Tm9kZS5uZXh0RWxlbWVudFNpYmxpbmcgKSByZXR1cm4gZmFsc2U7DQoNCgkJCQlyZXR1cm4gdHJ1ZTsNCgkJCX0NCg0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9LA0KDQoJCS8vIENoZWNrcyBpZiByZXZlYWwuanMgaGFzIGJlZW4gbG9hZGVkIGFuZCBpcyByZWFkeSBmb3IgdXNlDQoJCWlzUmVhZHk6IGZ1bmN0aW9uKCkgew0KCQkJcmV0dXJuIGxvYWRlZDsNCgkJfSwNCg0KCQkvLyBGb3J3YXJkIGV2ZW50IGJpbmRpbmcgdG8gdGhlIHJldmVhbCBET00gZWxlbWVudA0KCQlhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbiggdHlwZSwgbGlzdGVuZXIsIHVzZUNhcHR1cmUgKSB7DQoJCQlpZiggJ2FkZEV2ZW50TGlzdGVuZXInIGluIHdpbmRvdyApIHsNCgkJCQkoIGRvbS53cmFwcGVyIHx8IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICcucmV2ZWFsJyApICkuYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgbGlzdGVuZXIsIHVzZUNhcHR1cmUgKTsNCgkJCX0NCgkJfSwNCgkJcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oIHR5cGUsIGxpc3RlbmVyLCB1c2VDYXB0dXJlICkgew0KCQkJaWYoICdhZGRFdmVudExpc3RlbmVyJyBpbiB3aW5kb3cgKSB7DQoJCQkJKCBkb20ud3JhcHBlciB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAnLnJldmVhbCcgKSApLnJlbW92ZUV2ZW50TGlzdGVuZXIoIHR5cGUsIGxpc3RlbmVyLCB1c2VDYXB0dXJlICk7DQoJCQl9DQoJCX0sDQoNCgkJLy8gUHJvZ3JhbWF0aWNhbGx5IHRyaWdnZXJzIGEga2V5Ym9hcmQgZXZlbnQNCgkJdHJpZ2dlcktleTogZnVuY3Rpb24oIGtleUNvZGUgKSB7DQoJCQlvbkRvY3VtZW50S2V5RG93biggeyBrZXlDb2RlOiBrZXlDb2RlIH0gKTsNCgkJfSwNCg0KCQkvLyBSZWdpc3RlcnMgYSBuZXcgc2hvcnRjdXQgdG8gaW5jbHVkZSBpbiB0aGUgaGVscCBvdmVybGF5DQoJCXJlZ2lzdGVyS2V5Ym9hcmRTaG9ydGN1dDogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7DQoJCQlrZXlib2FyZFNob3J0Y3V0c1trZXldID0gdmFsdWU7DQoJCX0NCgl9Ow0KDQoJcmV0dXJuIFJldmVhbDsNCg0KfSkpOw0K"></script>

	<script>
		// requerido aunque este vacio
		Reveal.initialize({
      backgroundTransition: 'fade',
      transition: 'fade'
    });
    Reveal.configure({
      slideNumber: true

    });
	</script>
</body>
</html>
